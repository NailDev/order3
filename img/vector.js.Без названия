(self.__chunk_yandex_ymaps3=self.__chunk_yandex_ymaps3||[]).push([[154],{26259:e=>{var t,i,r=Object.create,s=Object.defineProperty,n=Object.defineProperties,o=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertyNames,d=Object.getOwnPropertySymbols,h=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,_=Reflect.get,p=Math.pow,m=(e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,f=(e,t)=>{for(var i in t||(t={}))c.call(t,i)&&m(e,i,t[i]);if(d)for(var i of d(t))u.call(t,i)&&m(e,i,t[i]);return e},g=(e,t)=>n(e,a(t)),v=(e,t)=>{for(var i in t)s(e,i,{get:t[i],enumerable:!0})},y=(e,t,i,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let n of l(t))!c.call(e,n)&&n!==i&&s(e,n,{get:()=>t[n],enumerable:!(r=o(t,n))||r.enumerable});return e},x=(e,t,i)=>new Promise(((r,s)=>{var n=e=>{try{a(i.next(e))}catch(e){s(e)}},o=e=>{try{a(i.throw(e))}catch(e){s(e)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(n,o);a((i=i.apply(e,t)).next())})),b=(t=(e,t)=>{var i=function(e){null==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,e.constructor==Array?this.init_by_array(e,e.length):this.init_seed(e)};i.prototype.init_seed=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++)e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30,this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0},i.prototype.init_by_array=function(e,t){var i,r,s;for(this.init_seed(19650218),i=1,r=0,s=this.N>t?this.N:t;s;s--){var n=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&n)>>>16)<<16)+1664525*(65535&n))+e[r]+r,this.mt[i]>>>=0,r++,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),r>=t&&(r=0)}for(s=this.N-1;s;s--)n=this.mt[i-1]^this.mt[i-1]>>>30,this.mt[i]=(this.mt[i]^(1566083941*((4294901760&n)>>>16)<<16)+1566083941*(65535&n))-i,this.mt[i]>>>=0,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1);this.mt[0]=2147483648},i.prototype.random_int=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_seed(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,(e^=e>>>18)>>>0},i.prototype.random_int31=function(){return this.random_int()>>>1},i.prototype.random_incl=function(){return this.random_int()*(1/4294967295)},i.prototype.random=function(){return this.random_int()*(1/4294967296)},i.prototype.random_excl=function(){return(this.random_int()+.5)*(1/4294967296)},i.prototype.random_long=function(){return(67108864*(this.random_int()>>>5)+(this.random_int()>>>6))*(1/9007199254740992)},t.exports=i},()=>(i||t((i={exports:{}}).exports,i),i.exports)),T={};v(T,{default:()=>Mm}),e.exports=(e=>y(s({},"__esModule",{value:!0}),e))(T);var w={};v(w,{BackgroundColor:()=>Vu,BackgroundRenderUnit:()=>Du,BuildingsRenderUnit:()=>Yu,Camera:()=>Mt,CenterWrapMode:()=>Ct,Cesium3DTile:()=>Uc,Cesium3DTileSet:()=>Vc,CollidingFriendIdRenderer:()=>Pm,CollidingPrimitiveColorIdRenderer:()=>Hs,CollidingPrimitivesResetRemovedRenderer:()=>qs,CollisionPriorityRank:()=>Iu,ColorIdGltfRenderer:()=>xm,ColorIdIconRenderer:()=>ym,ColorIdPointLabelRenderer:()=>pm,ColorIdPolylineLabelRenderer:()=>vm,ContentPortionPrimitiveProvider:()=>R_,ContentProviderPriority:()=>yc,ContentProviderType:()=>Su,Context:()=>za,CoveredByIndoorFilter:()=>Dd,DEFAULT_SCENARIO:()=>nu,DataSourceType:()=>xu,DebugFakePrimitiveRenderUnit:()=>dm,DepthClearStrategy:()=>Bu,Engine:()=>Ra,EventTrigger:()=>wt,ExternalRendererRenderUnit:()=>A_,FrameObjectType:()=>nn,FxaaRenderUnit:()=>ku,GlTFPrimitiveRenderUnit:()=>g_,GltfResetRemovedRenderer:()=>Cm,GraphicsContentProvider:()=>qd,GraphicsPolylineRenderUnit:()=>W_,GraphicsRenderUnit:()=>M_,GraphicsScenePrimitiveProvider:()=>L_,GroundCompositeRenderUnit:()=>hm,HybridMapContentProvider:()=>Qc,IconRenderUnit:()=>Rp,IndoorContentProvider:()=>Vd,IndoorPlan:()=>Ld,LabelCollidingFriendIdRenderer:()=>Sm,LabelResetRemovedRenderer:()=>gm,LayerRenderUnit:()=>Fu,METADATA_KEYS:()=>Bl,MainContentProvider:()=>Mu,MapMode:()=>td,MapType:()=>su,ModelRenderUnit:()=>qp,ModelsAnimationManager:()=>P_,PointLabelRenderUnit:()=>hp,PolygonRenderUnit:()=>Dp,PolylineLabelRenderUnit:()=>am,PolylineRenderUnit:()=>G_,RenderablePrimitive:()=>es,SceneObjectType:()=>rn,ScreenObjectType:()=>sn,TILE3D_MODEL_COLOR_DAY:()=>Hc,TILE3D_MODEL_COLOR_NIGHT:()=>jc,TexPolygonRenderUnit:()=>Np,Tile3DContentProvider:()=>kc,TileSize:()=>Fa,TransparentPolygonRenderUnit:()=>Bp,VECTOR_METADATA_PREFIX:()=>zl,VectorMapContentProvider:()=>Md,VectorPrimitiveTypes:()=>on,VerboseCesium3DTileSet:()=>Lu,VisibilityManager:()=>zr,Vmap3ContentProvider:()=>lu,createColorTransform:()=>C_,getPhonyFov:()=>Dt,isTile3DRenderable:()=>ah,mapTypeToString:()=>Au});var C=S(0,0,0),P=S(1,1,1);S(0,0,0,0);function S(e,t,i,r=1){return{r:e,g:t,b:i,a:r}}function M(e,t=S(0,0,0,0)){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t}function R(e,t,i,r){return 255*e|255*t<<8|255*i<<16|255*r<<24}function I(e){return R(e.r,e.g,e.b,e.a)}var L=/^(0x|#)?(([a-fA-F0-9]{3}){1,2}|([a-fA-F0-9]{4}){1,2})$/;function E(e,t,i){let r=e.substring(i*t,(i+1)*t),s=(1<<4*t)-1;return parseInt(r,16)/s}function A(e){let t=L.exec(e);if(!t)return null;let i=t[2],r=i.length>4?2:1;return S(E(i,r,0),E(i,r,1),E(i,r,2),i.length%4?1:E(i,r,3))}var U={blend:!0,blendFuncSrcRgb:770,blendFuncDstRgb:771,blendFuncSrcAlpha:1,blendFuncDstAlpha:771},O={blend:!0,blendFuncSrcRgb:1,blendFuncDstRgb:771,blendFuncSrcAlpha:1,blendFuncDstAlpha:771},V={depthTest:!0,depthFunc:518,blend:!0,blendFuncSrcRgb:771,blendFuncDstRgb:770,blendFuncSrcAlpha:771,blendFuncDstAlpha:770},D=class{constructor(...e){this.clearColor=S(0,0,0,0),this.clearDepth=1,this.clearStencil=0,this.colorMaskR=!0,this.colorMaskG=!0,this.colorMaskB=!0,this.colorMaskAlpha=!0,this.blend=!1,this.blendEquationRgb=32774,this.blendEquationAlpha=32774,this.blendFuncSrcRgb=1,this.blendFuncDstRgb=0,this.blendFuncSrcAlpha=1,this.blendFuncDstAlpha=0,this.cullFace=!1,this.cullFaceMode=1029,this.frontFaceMode=2305,this.depthTest=!1,this.depthFunc=513,this.depthRangeNear=0,this.depthRangeFar=1,this.depthMask=!0,this.dither=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.sampleAlphaToCoverage=!1,this.sampleCoverage=!1,this.sampleCoverageValue=1,this.sampleCoverageInvert=!1,this.scissorTest=!1,this.scissorX=0,this.scissorY=0,this.scissorWidth=-1,this.scissorHeight=-1,this.stencilTest=!1,this.stencilReference=0,this.stencilMask=255,this.stencilWriteMask=255,this.stencilFrontFunc=519,this.stencilFrontFailOp=7680,this.stencilFrontDepthFailOp=7680,this.stencilFrontDepthPassOp=7680,this.stencilBackFunc=519,this.stencilBackFailOp=7680,this.stencilBackDepthFailOp=7680,this.stencilBackDepthPassOp=7680,this.viewportX=0,this.viewportY=0,this.viewportWidth=-1,this.viewportHeight=-1,Object.assign(this,...e)}};function z(e,t,i=1e-6){let r=e-t;return-i<r&&r<i}function B(e,t){return{x:e,y:t}}function F(){return B(0,0)}function N(e,t,i){return i.x=e,i.y=t,i}var k=B(0,0);B(1,0),B(-1,0),B(0,1),B(0,-1);function H(e,t=B(0,0)){return t.x=e.x,t.y=e.y,t}function j(e,t){return e.x===t.x&&e.y===t.y}function G(e,t,i=B(0,0)){return i.x=e.x+t.x,i.y=e.y+t.y,i}function W(e,t,i=B(0,0)){return i.x=e.x-t.x,i.y=e.y-t.y,i}function Y(e,t,i=B(0,0)){return i.x=e.x*t,i.y=e.y*t,i}function q(e,t,i=B(0,0)){return i.x=e.x/t,i.y=e.y/t,i}function X(e,t,i,r=B(0,0)){return r.x=(1-i)*e.x+i*t.x,r.y=(1-i)*e.y+i*t.y,r}function Z(e){return Math.hypot(e.x,e.y)}function $(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}function Q(e,t,i=B(0,0)){return i.x=t(e.x),i.y=t(e.y),i}var K={minX:0,maxX:0,minY:0,maxY:0};function J(e,t,i,r){return{minX:e,maxX:t,minY:i,maxY:r}}function ee(){return{maxX:Number.NEGATIVE_INFINITY,maxY:Number.NEGATIVE_INFINITY,minX:Number.POSITIVE_INFINITY,minY:Number.POSITIVE_INFINITY}}function te(e){return e.minX>e.maxX||e.minY>e.maxY}function ie(e,t=J(0,0,0,0)){return t.minX=e.minX,t.maxX=e.maxX,t.minY=e.minY,t.maxY=e.maxY,t}function re(e,t,i=J(0,0,0,0)){return t>=0?(i.minX=e.minX*t,i.maxX=e.maxX*t,i.minY=e.minY*t,i.maxY=e.maxY*t):(i.maxX=e.minX*t,i.minX=e.maxX*t,i.maxY=e.minY*t,i.minY=e.maxY*t),i}function se(e,t){let i,r,s,n;return e.minX<t.minX?(i=e,r=t):(i=t,r=e),e.maxY>t.maxY?(s=e,n=t):(s=t,n=e),r.minX<i.maxX&&n.maxY>s.minY}function ne(e,t={minX:0,maxX:0,minY:0,maxY:0}){if(0===e.length)return t;t.minX=t.maxX=e[0].x,t.minY=t.maxY=e[0].y;for(let i=1;i<e.length;++i){let{x:r,y:s}=e[i];r<t.minX&&(t.minX=r),r>t.maxX&&(t.maxX=r),s<t.minY&&(t.minY=s),s>t.maxY&&(t.maxY=s)}return t}function oe(e,t,i={minX:0,maxX:0,minY:0,maxY:0}){return i.minX=Math.min(e.minX,t.x),i.minY=Math.min(e.minY,t.y),i.maxX=Math.max(e.maxX,t.x),i.maxY=Math.max(e.maxY,t.y),i}function ae(e,t,i={minX:0,maxX:0,minY:0,maxY:0}){return i.minX=Math.min(e.minX,t.minX),i.minY=Math.min(e.minY,t.minY),i.maxX=Math.max(e.maxX,t.maxX),i.maxY=Math.max(e.maxY,t.maxY),i}function le(e){return[B(e.minX,e.minY),B(e.maxX,e.minY),B(e.minX,e.maxY),B(e.maxX,e.maxY)]}var de=9;function he(){return new Array(de)}function ce(e=he()){for(let t=0;t<de;++t)e[t]=0;return e}he();function ue(e,t,i){return{x:e,y:t,z:i}}function _e(){return ue(0,0,0)}function pe(e,t,i,r){return r.x=e,r.y=t,r.z=i,r}var me=ue(0,0,0),fe=(ue(1,0,0),ue(-1,0,0),ue(0,1,0)),ge=(ue(0,-1,0),ue(0,0,1));ue(0,0,-1);function ve(e,t=ue(0,0,0)){return t.x=e.x,t.y=e.y,t.z=e.z,t}function ye(e,t,i=ue(0,0,0)){return i.x=e.x+t.x,i.y=e.y+t.y,i.z=e.z+t.z,i}function xe(e,t,i=ue(0,0,0)){return i.x=e.x-t.x,i.y=e.y-t.y,i.z=e.z-t.z,i}function be(e,t,i=ue(0,0,0)){return i.x=e.x*t.x,i.y=e.y*t.y,i.z=e.z*t.z,i}function Te(e,t,i=ue(0,0,0)){return i.x=e.x*t,i.y=e.y*t,i.z=e.z*t,i}function we(e){return Math.hypot(e.x,e.y,e.z)}function Ce(e,t=ue(0,0,0)){return function(e,t,i=ue(0,0,0)){return i.x=e.x/t,i.y=e.y/t,i.z=e.z/t,i}(e,we(e),t)}function Pe(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function Se(e,t,i=ue(0,0,0)){let r=e.y*t.z-e.z*t.y,s=e.z*t.x-e.x*t.z,n=e.x*t.y-e.y*t.x;return i.x=r,i.y=s,i.z=n,i}function Me(e,t,i=ue(0,0,0)){let r=Math.cos(t),s=Math.sin(t),n=e.y;return i.x=e.x,i.y=n*r-e.z*s,i.z=n*s+e.z*r,i}function Re(e,t,i=ue(0,0,0)){let r=Math.cos(t),s=Math.sin(t);return e=e===i?ve(e):e,i.x=e.x*r-e.y*s,i.y=e.x*s+e.y*r,i.z=e.z,i}function Ie(e,t,i,r=ue(0,0,0)){let s=(e-t.z)/(i.z-t.z);return 0<=s&&s<=1?function(e,t,i,r=ue(0,0,0)){return r.x=(1-i)*e.x+i*t.x,r.y=(1-i)*e.y+i*t.y,r.z=(1-i)*e.z+i*t.z,r}(t,i,s,r):null}function Le(e,t,i=ue(0,0,0)){let r=Pe(t.direction,e.normal);if(0===r)return null;let s=(e.distance-Pe(e.normal,t.origin))/r;return s<0?null:(ve(t.direction,i),Te(i,s,i),ye(i,t.origin,i),i)}function Ee(e,t=[ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0)]){return pe(e.minX,e.minY,e.minZ,t[0]),pe(e.minX,e.minY,e.maxZ,t[1]),pe(e.minX,e.maxY,e.minZ,t[2]),pe(e.minX,e.maxY,e.maxZ,t[3]),pe(e.maxX,e.minY,e.minZ,t[4]),pe(e.maxX,e.minY,e.maxZ,t[5]),pe(e.maxX,e.maxY,e.minZ,t[6]),pe(e.maxX,e.maxY,e.maxZ,t[7]),t}function Ae(e,t=ue(0,0,0)){return t.x=(e.minX+e.maxX)/2,t.y=(e.minY+e.maxY)/2,t.z=(e.minZ+e.maxZ)/2,t}function Ue(){return{maxX:Number.NEGATIVE_INFINITY,maxY:Number.NEGATIVE_INFINITY,maxZ:Number.NEGATIVE_INFINITY,minX:Number.POSITIVE_INFINITY,minY:Number.POSITIVE_INFINITY,minZ:Number.POSITIVE_INFINITY}}var Oe=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Ve=16;function De(){return new Array(Ve)}function ze(e,t=De()){for(let i=0;i<Ve;++i)t[i]=e[i];return t}function Be(e,t,i=De()){for(let r=0;r<Ve;r+=4){let s=i[r+3]=e[r+3];i[r]=e[r]+s*t.x,i[r+1]=e[r+1]+s*t.y,i[r+2]=e[r+2]+s*t.z}return i}var Fe=ze(Oe);function Ne(e,t,i=De()){for(let r=0;r<Ve;r+=4){let s=e[r],n=e[r+1],o=e[r+2],a=e[r+3];for(let e=0;e<4;++e)i[r+e]=s*t[e]+n*t[4+e]+o*t[8+e]+a*t[12+e]}return i}function ke(e,t,i=ue(0,0,0)){let r=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15],s=(e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12])/r,n=(e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13])/r,o=(e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14])/r;return i.x=s,i.y=n,i.z=o,i}function He(e,t=De()){for(let i=0;i<4;i++)for(let r=i;r<4;r++){let s=e[4*i+r];t[4*i+r]=e[4*r+i],t[4*r+i]=s}return t}var je=De(),Ge=1e-32,We=1e-32;function*Ye(e,t){for(let i of e)yield t(i)}function*qe(e,t){for(let i of e)t(i)&&(yield i)}function Xe(e,t){for(let i of e)if(!t(i))return!1;return!0}function Ze(e,t){let i=0;for(let r of e)(!t||t(r))&&i++;return i}function $e(e,t=4){let i=0;return{attributes:[...Ye(e,(([e,{type:r,size:s,normalized:n,divisor:o}])=>{let a=[e,{type:r,size:s,normalized:n,offset:i,divisor:o}],l=s*function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4}}(r);return i=function(e,t){return(e-1&t)-t}(i+l,-t),a}))],vertexByteSize:i}}function Qe(e){return 65535*e|0}function Ke(e){return 4294967295*e|0}function Je(e,t){return e>t?1:e<t?-1:0}function et(e){return e.length>0}function tt(e){return et(e)?e:void 0}function it(e){return e[e.length-1]}function rt(e,t,i){let r=e[t];e[t]=e[i],e[i]=r}function st(e,t,i=0,r=e.length,s=0){for(let n=i,o=s;n<r;++n,++o)t[o]=e[n]}function nt(e,t=Je,i=0,r=e.length){for(let s=i;s<r;++s)for(let r=s;r>i&&t(e[r-1],e[r])>0;--r)rt(e,r-1,r)}function ot(e,t,i,r,s,n,o){let a=o,l=r,d=s;for(;l<s&&d<n;)t[a++]=i(e[l],e[d])>0?e[d++]:e[l++];st(e,t,l,s,a),st(e,t,d,n,a)}var at=Symbol("filter_out_is_removed");function lt(e,t){for(let i=0;i<t.length;i++)for(let r=0;r<e.length;r++)if(e[r]===t[i]){t[i][at]=!0;break}let i=0;for(let t=0;t<e.length;t++)e[t][at]?e[t][at]=!1:(e[i]=e[t],i++);e.length=i}function*dt(e){for(let t=2;t<e;++t)yield 0,yield t-1,yield t}function*ht(e){yield 0,yield 1,yield 2;let t=1,i=2;for(let r=3;r<e;++r){yield r-t,yield r-i,yield r;let e=t;t=i,i=e}}var ct=class{constructor(e){this._nextWordOffset=0,this._initBuffers(e)}get isFull(){return this._nextWordOffset>=this._uint32View.length}get occupiedSize(){return this._nextWordOffset}get byteSize(){return this._uint32View.byteLength}extend(e){let t=this._uint32View;this._initBuffers(e),this._uint32View.set(t)}pushUint32(e){this._uint32View[this._nextWordOffset++]=e}pushFloat32(e){this._float32View[this._nextWordOffset++]=e}asUint32Array(){return this._uint32View.subarray(0,this.occupiedSize)}_initBuffers(e){let t=new ArrayBuffer(e);this._uint32View=new Uint32Array(t),this._float32View=new Float32Array(t)}static transferDataTail(e,t,i,r=0){let s=e.occupiedSize-i,n=e._uint32View.subarray(i,e.occupiedSize);t._uint32View.set(n,r),t._nextWordOffset=s,e._nextWordOffset=i}},ut=class{constructor(e){this._nextIndexOffset=0,this._uint16View=new Uint16Array(e)}get occupiedSize(){return this._nextIndexOffset}get size(){return this._uint16View.length}extend(e){let t=this._uint16View;this._uint16View=new Uint16Array(e),this._uint16View.set(t)}push(e){this._uint16View[this._nextIndexOffset++]=e}asUint16Array(){return new Uint16Array(this._uint16View.buffer,0,this.occupiedSize)}static transferDataTail(e,t,i,r,s=0){for(let n=r,o=s;n<e.occupiedSize;n++,o++)t._uint16View[o]=e._uint16View[n]-i;t._nextIndexOffset=e.occupiedSize-r,e._nextIndexOffset=r}},_t=class{constructor(e,t=1024,i=65536,r=3072){this._vertexByteSize=e,this._initVertexBufferByteSize=e*t,this._maxVertexBufferByteSize=e*i,this._initIndexBufferUint16Size=r,this._vertexBuffer=new ct(this._initVertexBufferByteSize),this._vertexBuffers=[this._vertexBuffer],this._indexBuffer=new ut(this._initIndexBufferUint16Size),this._indexBuffers=[this._indexBuffer],this._currentMeshVertexOffset=0,this._currentMeshIndexOffset=0,this._currentMeshBaseIndex=0}writeIndices(e){this._ensureEnoughIndexBufferSpace(e.length);let t=this._indexBuffer,i=this._currentMeshBaseIndex;for(let r=0;r<e.length;++r)t.push(i+e[r])}writeIndicesForStrip(e){this._ensureEnoughIndexBufferSpace(3*(e.length-2));let t=this._indexBuffer,i=this._currentMeshBaseIndex;for(let r of ht(e.length))t.push(i+e[r])}writeIndicesForContinuousStrip(e,t=0){this._ensureEnoughIndexBufferSpace(3*(e-2));let i=this._indexBuffer,r=this._currentMeshBaseIndex+t;for(let t of ht(e))i.push(r+t)}writeIndicesForFan(e){this._ensureEnoughIndexBufferSpace(3*(e.length-2));let t=this._indexBuffer,i=this._currentMeshBaseIndex;for(let r of dt(e.length))t.push(i+e[r])}writeIndicesForContinuousFan(e,t=0){this._ensureEnoughIndexBufferSpace(3*(e-2));let i=this._indexBuffer,r=t+this._currentMeshBaseIndex;for(let t of dt(e))i.push(r+t)}endMesh(){let e=this._currentMeshVertexOffset,t=this._vertexBuffer.occupiedSize;this._currentMeshVertexOffset=t,this._currentMeshBaseIndex=(t<<2)/this._vertexByteSize;let i=this._currentMeshIndexOffset,r=this._indexBuffer.occupiedSize;return this._currentMeshIndexOffset=r,{vertexByteOffset:e<<2,vertexByteLength:t-e<<2,indexByteOffset:i<<1,indexByteLength:r-i<<1,indexType:5123,bufferIndex:this._vertexBuffers.length-1}}getBuffers(){return function(e,t,i=((e,t)=>[e,t])){let r=Math.min(e.length,t.length),s=new Array(r);for(let n=0;n<r;++n)s[n]=i(e[n],t[n]);return s}(this._vertexBuffers,this._indexBuffers,((e,t)=>({vertexBuffer:e.asUint32Array(),indexBuffer:t.asUint16Array()})))}getCurrentVertexBufferByteOffset(){return this._vertexBuffer.occupiedSize<<2}getCurrentVertexIdx(){return((this._vertexBuffer.occupiedSize<<2)/this._vertexByteSize|0)-this._currentMeshBaseIndex}_writeFloat32(e){this._ensureEnoughVertexBufferSpace(),this._vertexBuffer.pushFloat32(e)}_writeWord(e){this._ensureEnoughVertexBufferSpace(),this._vertexBuffer.pushUint32(e)}_writeHalfWords(e,t){this._writeWord(t<<16|65535&e)}_writeBytes(e,t,i,r){this._writeWord(r<<24|(255&i)<<16|(255&t)<<8|255&e)}_writeWorldCoordinate(e){let t=Ke(.5*(e.x+1)),i=Ke(.5*(e.y+1));this._writeHalfWords(t>>>16,i>>>16),this._writeHalfWords(t,i)}_getNextVertexBufferByteSize(e){return e<<1}_getNextIndexBufferUint16Size(e){return e<<1}_ensureEnoughVertexBufferSpace(){let e=this._vertexBuffer;if(!e.isFull)return;if(e.byteSize<this._maxVertexBufferByteSize)return void this._vertexBuffer.extend(this._getNextVertexBufferByteSize(e.byteSize));let t=this._currentMeshVertexOffset,i=4*(e.occupiedSize-t);if(i===this._maxVertexBufferByteSize)throw new Error("Mesh is too big to fit in.");let r=this._initVertexBufferByteSize;for(;r<=i;)r=this._getNextVertexBufferByteSize(r);let s=new ct(r);ct.transferDataTail(e,s,t),this._vertexBuffer=s,this._vertexBuffers.push(s),this._currentMeshVertexOffset=0;let n=this._indexBuffer,o=this._currentMeshIndexOffset,a=n.occupiedSize-o,l=this._initIndexBufferUint16Size;for(;l<=a;)l=this._getNextIndexBufferUint16Size(l);let d=new ut(l);ut.transferDataTail(n,d,this._currentMeshBaseIndex,o),this._currentMeshBaseIndex=0,this._currentMeshIndexOffset=0,this._indexBuffer=d,this._indexBuffers.push(d)}_ensureEnoughIndexBufferSpace(e){let t=this._indexBuffer,i=t.occupiedSize+e;if(i<=t.size)return;let r=t.size;for(;i>r;)r=this._getNextIndexBufferUint16Size(r);this._indexBuffer.extend(r)}},pt=$e([[0,{size:2,type:5123,normalized:!0}]]),mt=class extends _t{constructor(e,t){let i=e*t;super(pt.vertexByteSize,i,void 0,0);let r=Qe(1/e),s=Qe(1/t),n=s/2;for(let i=0,o=r/2;i<e;i++,o+=r)for(let e=0,i=n;e<t;e++,i+=s)this._writeHalfWords(o,i);this.data=this.getBuffers()[0].vertexBuffer,this.numberOfSamplers=i}},ft=class{constructor(e,t,i,r,s){this._context=e,this._renderState=t,this._program=i,this._hitTestRenderState=r,this._hitTestProgram=s}render(e,...t){this._program&&this._prepareProgram(this._program,...t),this._prepareRenderTarget(e,...t),this._render(...t)}renderHitTestBuffer(e,...t){this._hitTestProgram&&(this._prepareHitTestProgram(this._hitTestProgram,...t),this._prepareHitTestTarget(e,...t),this._renderHitTestBuffer(...t))}destroy(){this._program&&this._program.destroy(),this._hitTestProgram&&this._hitTestProgram.destroy()}_prepareProgram(e,...t){this._context.bindProgram(e)}_prepareHitTestProgram(e,...t){this._context.bindProgram(e)}_prepareRenderTarget(e,...t){this._context.bindRenderState(this._renderState),this._context.bindRenderTarget(e)}_prepareHitTestTarget(e,...t){let i=this._context;this._hitTestRenderState&&i.bindRenderState(this._hitTestRenderState),i.bindRenderTarget(e)}_renderHitTestBuffer(...e){}},gt=class extends ft{constructor(e,t){super(e,t)}get target(){return this._target}get content(){return this._context.bindRenderTarget(this._target),this._target.readPixels()}get size(){return this._target.size}updateGrid(...e){return this.render(this._target,...e),this._texture}_render(e,t,i,r,s,n,o,a,l,d){for(let h of i)h.render(this._target,e,t,this._renderState,r,s,n,o,a,l,d)}setResolution(e,t){this._destroyResources(),this._depthBuffer=this._context.createRenderbuffer(e,t,34041),this._texture=this._context.createEmpty2DTexture(e,t,6408,5121),this._target=this._context.createFramebuffer({color:this._texture,depthStencil:this._depthBuffer})}destroy(){this._destroyResources()}_prepareRenderTarget(e,t,i,r,s,n,o,a,l,d,h,c){super._prepareRenderTarget(e,t,i,r,s,n,o,a,l,d,h,c),c&&this._context.clearCurrentTarget(16640)}_destroyResources(){this._target&&(this._target.destroy(),this._texture.destroy(),this._depthBuffer.destroy())}};function vt(e,t,i){return t<e?e<i?e:i:t}function yt(e,t,i){let r=(e-t)/(i-t);return t+(i-t)*(r-Math.floor(r))}var xt=Math.PI/180;function bt(e){return e*xt}var Tt,wt=class{constructor(){this._listenersBuffer=[],this._listeners=new Set}addListener(e){this._listeners.has(e)&&console.warn("Event listener already exists",e),this._listeners.add(e),this._syncListenersBuffer()}removeListener(e){this._listeners.delete(e),this._syncListenersBuffer()}fire(...e){for(let t of this._listenersBuffer)t(...e)}_syncListenersBuffer(){this._listenersBuffer=Array.from(this._listeners)}},Ct=((Tt=Ct||{})[Tt.NONE=0]="NONE",Tt[Tt.CLAMP_TO_EDGE=1]="CLAMP_TO_EDGE",Tt[Tt.REPEAT=2]="REPEAT",Tt),Pt={wrapModeX:1,wrapModeY:1,minZoom:0,maxZoom:24,fov:bt(30),maxTilt:bt(40),minTilt:bt(0),noTiltMaxZoom:1},St=class e{constructor(t){this.options=f(f({},Pt),t),this.center=new e._Center(this),this.onUpdate=this._onUpdate=new wt;let i=new e._ScreenSize(this);this.screenSize=i,this._zoom=this.options.minZoom,this._fov=this.options.fov,this._tilt=this._azimuth=0,this._pixelSize=B(0,0),this._updateVersion=0,this._updateVersionLastFlushed=0}get aspectRatio(){let{width:e,height:t}=this.screenSize;return e/t}get zoom(){return this._zoom}set zoom(e){(e=vt(e,this.options.minZoom,this.options.maxZoom))!==this._zoom&&(this._zoom=e,this.tilt=this._tilt,this._updateVersion++)}get fov(){return this._fov}get tilt(){return this._tilt}set tilt(e){let{minTilt:t,maxTilt:i,noTiltMaxZoom:r}=this.options,s=function(e,t,i){let r=vt((i-e)/(t-e),0,1);return r*r*(3-2*r)}(r,r+It,this._zoom);e=vt(e,t*s,i*s),this._tilt!==e&&(this._tilt=e,this._updateVersion++)}get azimuth(){return this._azimuth}set azimuth(e){e=yt(e,0,2*Math.PI),this._azimuth!==e&&(this._azimuth=e,this._updateVersion++)}get pixelSize(){return this._pixelSize}get updateVersion(){return this._updateVersion}flushUpdates(){this._updateVersionLastFlushed<this._updateVersion&&(this._onUpdate.fire(),this._updateVersionLastFlushed=this._updateVersion)}};St._Center=class{constructor(e){this._camera=e,this._x=this._y=0}get x(){return this._x}set x(e){e=Rt(this._camera.options.wrapModeX,e),this._x!==e&&(this._x=e,this._camera._updateVersion++)}get y(){return this._y}set y(e){e=Rt(this._camera.options.wrapModeY,e),this._y!==e&&(this._y=e,this._camera._updateVersion++)}},St._ScreenSize=class{constructor(e){this._camera=e,this._width=this._height=1}get width(){return this._width}set width(e){this._width!==e&&e>0&&(this._width=e,this._camera._pixelSize.x=2/this._width,this._camera._updateVersion++)}get height(){return this._height}set height(e){this._height!==e&&e>0&&(this._height=e,this._camera._pixelSize.y=2/this._height,this._camera._updateVersion++)}};var Mt=St;function Rt(e,t){switch(e){case 0:return t;case 1:return vt(t,-1,1);case 2:return yt(t,-1,1)}}var It=1,Lt=class{constructor(e){this._mins=new Array(e),this._maxs=new Array(e),this._mins.fill(Number.POSITIVE_INFINITY),this._maxs.fill(Number.NEGATIVE_INFINITY)}updateValue(e,t){this._mins[e]=Math.min(this._mins[e],t),this._maxs[e]=Math.max(this._maxs[e],t)}*values(){let e={min:0,max:0,index:-1};for(let t=0;t<this._mins.length;t++)e.min=this._mins[t],e.max=this._maxs[t],e.index=t,yield e}};function Et(e,t){return Number.isInteger(e)&&t===e?e-1:Math.floor(e)}function At(e){let t,i;return function(r){return(t!==r||void 0===t)&&(t=r,i=e(r)),i}}function Ut(e){let t,i;return function(...r){let s=void 0===t;if(s||(s=t.length!==r.length),!s)for(let e=0;e<r.length;++e)if(t[e]!==r[e]){s=!0;break}return s&&(t=r,i=e(...r)),i}}var Ot=19;function Vt(e){return Math.min(e.zoom,Ot)}function Dt(e){return e.zoom<=Ot?e.fov:zt(Bt(e.zoom)*Ft(e.fov))}var zt=At((e=>2*Math.atan(e))),Bt=At((e=>Math.pow(2,-(e-Ot)))),Ft=At((e=>Math.tan(.5*e)));function Nt(e,t,i){return e*Ht(i)*jt(t)*kt}var kt=1/256,Ht=At((e=>Math.pow(2,-e))),jt=At((e=>1/Math.tan(.5*e)));function Gt(e,t,i,r){return ve(Wt(e,t,i),r),r}var Wt=Ut(((e,t,i)=>{let r=Te(ge,e,Yt);return Me(r,i,r),Re(r,t,r),r})),Yt=ue(0,0,0);function qt(e,t,i){let r=t/2;return!i||e<=r?e:Math.max(e-Xt,r)}var Xt=bt(20);function Zt(e,t="key_"+Math.random().toFixed(10)){let i=Symbol(t);return function(t){let r=t[i];return r||(r={cameraUpdateVersion:t.updateVersion,data:e(t)},t[i]=r),r.cameraUpdateVersion<t.updateVersion&&(r.data=e(t,r.data),r.cameraUpdateVersion=t.updateVersion),r.data}}var $t=function(e){return null!=e};function Qt(e){let t;this.name="DeveloperError",this.message=e;try{throw new Error}catch(e){t=e.stack}this.stack=t}$t(Object.create)&&(Qt.prototype=Object.create(Error.prototype),Qt.prototype.constructor=Qt),Qt.prototype.toString=function(){let e=`${this.name}: ${this.message}`;return $t(this.stack)&&(e+=`\n${this.stack.toString()}`),e},Qt.throwInstantiationError=function(){throw new Qt("This function defines an interface and should not be called directly.")};var Kt=Qt,Jt={};function ei(e,t,i){return`Expected ${i} to be typeof ${t}, actual typeof was ${e}`}Jt.typeOf={},Jt.defined=function(e,t){if(!$t(t))throw new Kt(function(e){return`${e} is required, actual value was undefined`}(e))},Jt.typeOf.func=function(e,t){if("function"!=typeof t)throw new Kt(ei(typeof t,"function",e))},Jt.typeOf.string=function(e,t){if("string"!=typeof t)throw new Kt(ei(typeof t,"string",e))},Jt.typeOf.number=function(e,t){if("number"!=typeof t)throw new Kt(ei(typeof t,"number",e))},Jt.typeOf.number.lessThan=function(e,t,i){if(Jt.typeOf.number(e,t),t>=i)throw new Kt(`Expected ${e} to be less than ${i}, actual value was ${t}`)},Jt.typeOf.number.lessThanOrEquals=function(e,t,i){if(Jt.typeOf.number(e,t),t>i)throw new Kt(`Expected ${e} to be less than or equal to ${i}, actual value was ${t}`)},Jt.typeOf.number.greaterThan=function(e,t,i){if(Jt.typeOf.number(e,t),t<=i)throw new Kt(`Expected ${e} to be greater than ${i}, actual value was ${t}`)},Jt.typeOf.number.greaterThanOrEquals=function(e,t,i){if(Jt.typeOf.number(e,t),t<i)throw new Kt(`Expected ${e} to be greater than or equal to ${i}, actual value was ${t}`)},Jt.typeOf.object=function(e,t){if("object"!=typeof t)throw new Kt(ei(typeof t,"object",e))},Jt.typeOf.bool=function(e,t){if("boolean"!=typeof t)throw new Kt(ei(typeof t,"boolean",e))},Jt.typeOf.bigint=function(e,t){if("bigint"!=typeof t)throw new Kt(ei(typeof t,"bigint",e))},Jt.typeOf.number.equals=function(e,t,i,r){if(Jt.typeOf.number(e,i),Jt.typeOf.number(t,r),i!==r)throw new Kt(`${e} must be equal to ${t}, the actual values are ${i} and ${r}`)};var ti=Jt;function ii(e,t){return null!=e?e:t}ii.EMPTY_OBJECT=Object.freeze({});var ri=ii,si=((e,t,i)=>(i=null!=e?r(h(e)):{},y(!t&&e&&e.__esModule?i:s(i,"default",{value:e,enumerable:!0}),e)))(b(),1),ni={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,EPSILON21:1e-21,GRAVITATIONALPARAMETER:3986004418e5,SOLAR_RADIUS:6955e5,LUNAR_RADIUS:1737400,SIXTY_FOUR_KILOBYTES:65536,FOUR_GIGABYTES:4294967296};ni.sign=ri(Math.sign,(function(e){return 0===(e=+e)||e!=e?e:e>0?1:-1})),ni.signNotZero=function(e){return e<0?-1:1},ni.toSNorm=function(e,t){return t=ri(t,255),Math.round((.5*ni.clamp(e,-1,1)+.5)*t)},ni.fromSNorm=function(e,t){return t=ri(t,255),ni.clamp(e,0,t)/t*2-1},ni.normalize=function(e,t,i){return 0===(i=Math.max(i-t,0))?0:ni.clamp((e-t)/i,0,1)},ni.sinh=ri(Math.sinh,(function(e){return(Math.exp(e)-Math.exp(-e))/2})),ni.cosh=ri(Math.cosh,(function(e){return(Math.exp(e)+Math.exp(-e))/2})),ni.lerp=function(e,t,i){return(1-i)*e+i*t},ni.PI=Math.PI,ni.ONE_OVER_PI=1/Math.PI,ni.PI_OVER_TWO=Math.PI/2,ni.PI_OVER_THREE=Math.PI/3,ni.PI_OVER_FOUR=Math.PI/4,ni.PI_OVER_SIX=Math.PI/6,ni.THREE_PI_OVER_TWO=3*Math.PI/2,ni.TWO_PI=2*Math.PI,ni.ONE_OVER_TWO_PI=1/(2*Math.PI),ni.RADIANS_PER_DEGREE=Math.PI/180,ni.DEGREES_PER_RADIAN=180/Math.PI,ni.RADIANS_PER_ARCSECOND=ni.RADIANS_PER_DEGREE/3600,ni.toRadians=function(e){if(!$t(e))throw new Kt("degrees is required.");return e*ni.RADIANS_PER_DEGREE},ni.toDegrees=function(e){if(!$t(e))throw new Kt("radians is required.");return e*ni.DEGREES_PER_RADIAN},ni.convertLongitudeRange=function(e){if(!$t(e))throw new Kt("angle is required.");let t=ni.TWO_PI,i=e-Math.floor(e/t)*t;return i<-Math.PI?i+t:i>=Math.PI?i-t:i},ni.clampToLatitudeRange=function(e){if(!$t(e))throw new Kt("angle is required.");return ni.clamp(e,-1*ni.PI_OVER_TWO,ni.PI_OVER_TWO)},ni.negativePiToPi=function(e){if(!$t(e))throw new Kt("angle is required.");return e>=-ni.PI&&e<=ni.PI?e:ni.zeroToTwoPi(e+ni.PI)-ni.PI},ni.zeroToTwoPi=function(e){if(!$t(e))throw new Kt("angle is required.");if(e>=0&&e<=ni.TWO_PI)return e;let t=ni.mod(e,ni.TWO_PI);return Math.abs(t)<ni.EPSILON14&&Math.abs(e)>ni.EPSILON14?ni.TWO_PI:t},ni.mod=function(e,t){if(!$t(e))throw new Kt("m is required.");if(!$t(t))throw new Kt("n is required.");if(0===t)throw new Kt("divisor cannot be 0.");return ni.sign(e)===ni.sign(t)&&Math.abs(e)<Math.abs(t)?e:(e%t+t)%t},ni.equalsEpsilon=function(e,t,i,r){if(!$t(e))throw new Kt("left is required.");if(!$t(t))throw new Kt("right is required.");i=ri(i,0),r=ri(r,i);let s=Math.abs(e-t);return s<=r||s<=i*Math.max(Math.abs(e),Math.abs(t))},ni.lessThan=function(e,t,i){if(!$t(e))throw new Kt("first is required.");if(!$t(t))throw new Kt("second is required.");if(!$t(i))throw new Kt("absoluteEpsilon is required.");return e-t<-i},ni.lessThanOrEquals=function(e,t,i){if(!$t(e))throw new Kt("first is required.");if(!$t(t))throw new Kt("second is required.");if(!$t(i))throw new Kt("absoluteEpsilon is required.");return e-t<i},ni.greaterThan=function(e,t,i){if(!$t(e))throw new Kt("first is required.");if(!$t(t))throw new Kt("second is required.");if(!$t(i))throw new Kt("absoluteEpsilon is required.");return e-t>i},ni.greaterThanOrEquals=function(e,t,i){if(!$t(e))throw new Kt("first is required.");if(!$t(t))throw new Kt("second is required.");if(!$t(i))throw new Kt("absoluteEpsilon is required.");return e-t>-i};var oi=[1];ni.factorial=function(e){if("number"!=typeof e||e<0)throw new Kt("A number greater than or equal to 0 is required.");let t=oi.length;if(e>=t){let i=oi[t-1];for(let r=t;r<=e;r++){let e=i*r;oi.push(e),i=e}}return oi[e]},ni.incrementWrap=function(e,t,i){if(i=ri(i,0),!$t(e))throw new Kt("n is required.");if(t<=i)throw new Kt("maximumValue must be greater than minimumValue.");return++e>t&&(e=i),e},ni.isPowerOfTwo=function(e){if("number"!=typeof e||e<0||e>4294967295)throw new Kt("A number between 0 and (2^32)-1 is required.");return 0!==e&&0==(e&e-1)},ni.nextPowerOfTwo=function(e){if("number"!=typeof e||e<0||e>2147483648)throw new Kt("A number between 0 and 2^31 is required.");return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},ni.previousPowerOfTwo=function(e){if("number"!=typeof e||e<0||e>4294967295)throw new Kt("A number between 0 and (2^32)-1 is required.");return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e=((e|=e>>32)>>>0)-(e>>>1)},ni.clamp=function(e,t,i){return ti.typeOf.number("value",e),ti.typeOf.number("min",t),ti.typeOf.number("max",i),e<t?t:e>i?i:e};var ai=new si.default;ni.setRandomNumberSeed=function(e){if(!$t(e))throw new Kt("seed is required.");ai=new si.default(e)},ni.nextRandomNumber=function(){return ai.random()},ni.randomBetween=function(e,t){return ni.nextRandomNumber()*(t-e)+e},ni.acosClamped=function(e){if(!$t(e))throw new Kt("value is required.");return Math.acos(ni.clamp(e,-1,1))},ni.asinClamped=function(e){if(!$t(e))throw new Kt("value is required.");return Math.asin(ni.clamp(e,-1,1))},ni.chordLength=function(e,t){if(!$t(e))throw new Kt("angle is required.");if(!$t(t))throw new Kt("radius is required.");return 2*t*Math.sin(.5*e)},ni.logBase=function(e,t){if(!$t(e))throw new Kt("number is required.");if(!$t(t))throw new Kt("base is required.");return Math.log(e)/Math.log(t)},ni.cbrt=ri(Math.cbrt,(function(e){let t=Math.pow(Math.abs(e),.3333333333333333);return e<0?-t:t})),ni.log2=ri(Math.log2,(function(e){return Math.log(e)*Math.LOG2E})),ni.fog=function(e,t){let i=e*t;return 1-Math.exp(-i*i)},ni.fastApproximateAtan=function(e){return ti.typeOf.number("x",e),e*(-.1784*Math.abs(e)-.0663*e*e+1.0301)},ni.fastApproximateAtan2=function(e,t){ti.typeOf.number("x",e),ti.typeOf.number("y",t);let i,r=Math.abs(e);i=Math.abs(t);let s=Math.max(r,i);i=Math.min(r,i);let n=i/s;if(isNaN(n))throw new Kt("either x or y must be nonzero");return r=ni.fastApproximateAtan(n),r=Math.abs(t)>Math.abs(e)?ni.PI_OVER_TWO-r:r,r=e<0?ni.PI-r:r,r=t<0?-r:r,r};var li=ni;function di(e,t,i){this.x=ri(e,0),this.y=ri(t,0),this.z=ri(i,0)}di.fromSpherical=function(e,t){ti.typeOf.object("spherical",e),$t(t)||(t=new di);let i=e.clock,r=e.cone,s=ri(e.magnitude,1),n=s*Math.sin(r);return t.x=n*Math.cos(i),t.y=n*Math.sin(i),t.z=s*Math.cos(r),t},di.fromElements=function(e,t,i,r){return $t(r)?(r.x=e,r.y=t,r.z=i,r):new di(e,t,i)},di.clone=function(e,t){if($t(e))return $t(t)?(t.x=e.x,t.y=e.y,t.z=e.z,t):new di(e.x,e.y,e.z)},di.fromCartesian4=di.clone,di.packedLength=3,di.pack=function(e,t,i){return ti.typeOf.object("value",e),ti.defined("array",t),i=ri(i,0),t[i++]=e.x,t[i++]=e.y,t[i]=e.z,t},di.unpack=function(e,t,i){return ti.defined("array",e),t=ri(t,0),$t(i)||(i=new di),i.x=e[t++],i.y=e[t++],i.z=e[t],i},di.packArray=function(e,t){ti.defined("array",e);let i=e.length,r=3*i;if($t(t)){if(!Array.isArray(t)&&t.length!==r)throw new Kt("If result is a typed array, it must have exactly array.length * 3 elements");t.length!==r&&(t.length=r)}else t=new Array(r);for(let r=0;r<i;++r)di.pack(e[r],t,3*r);return t},di.unpackArray=function(e,t){if(ti.defined("array",e),ti.typeOf.number.greaterThanOrEquals("array.length",e.length,3),e.length%3!=0)throw new Kt("array length must be a multiple of 3.");let i=e.length;$t(t)?t.length=i/3:t=new Array(i/3);for(let r=0;r<i;r+=3){let i=r/3;t[i]=di.unpack(e,r,t[i])}return t},di.fromArray=di.unpack,di.maximumComponent=function(e){return ti.typeOf.object("cartesian",e),Math.max(e.x,e.y,e.z)},di.minimumComponent=function(e){return ti.typeOf.object("cartesian",e),Math.min(e.x,e.y,e.z)},di.minimumByComponent=function(e,t,i){return ti.typeOf.object("first",e),ti.typeOf.object("second",t),ti.typeOf.object("result",i),i.x=Math.min(e.x,t.x),i.y=Math.min(e.y,t.y),i.z=Math.min(e.z,t.z),i},di.maximumByComponent=function(e,t,i){return ti.typeOf.object("first",e),ti.typeOf.object("second",t),ti.typeOf.object("result",i),i.x=Math.max(e.x,t.x),i.y=Math.max(e.y,t.y),i.z=Math.max(e.z,t.z),i},di.clamp=function(e,t,i,r){ti.typeOf.object("value",e),ti.typeOf.object("min",t),ti.typeOf.object("max",i),ti.typeOf.object("result",r);let s=li.clamp(e.x,t.x,i.x),n=li.clamp(e.y,t.y,i.y),o=li.clamp(e.z,t.z,i.z);return r.x=s,r.y=n,r.z=o,r},di.magnitudeSquared=function(e){return ti.typeOf.object("cartesian",e),e.x*e.x+e.y*e.y+e.z*e.z},di.magnitude=function(e){return Math.sqrt(di.magnitudeSquared(e))};var hi=new di;di.distance=function(e,t){return ti.typeOf.object("left",e),ti.typeOf.object("right",t),di.subtract(e,t,hi),di.magnitude(hi)},di.distanceSquared=function(e,t){return ti.typeOf.object("left",e),ti.typeOf.object("right",t),di.subtract(e,t,hi),di.magnitudeSquared(hi)},di.normalize=function(e,t){ti.typeOf.object("cartesian",e),ti.typeOf.object("result",t);let i=di.magnitude(e);if(t.x=e.x/i,t.y=e.y/i,t.z=e.z/i,isNaN(t.x)||isNaN(t.y)||isNaN(t.z))throw new Kt("normalized result is not a number");return t},di.dot=function(e,t){return ti.typeOf.object("left",e),ti.typeOf.object("right",t),e.x*t.x+e.y*t.y+e.z*t.z},di.multiplyComponents=function(e,t,i){return ti.typeOf.object("left",e),ti.typeOf.object("right",t),ti.typeOf.object("result",i),i.x=e.x*t.x,i.y=e.y*t.y,i.z=e.z*t.z,i},di.divideComponents=function(e,t,i){return ti.typeOf.object("left",e),ti.typeOf.object("right",t),ti.typeOf.object("result",i),i.x=e.x/t.x,i.y=e.y/t.y,i.z=e.z/t.z,i},di.add=function(e,t,i){return ti.typeOf.object("left",e),ti.typeOf.object("right",t),ti.typeOf.object("result",i),i.x=e.x+t.x,i.y=e.y+t.y,i.z=e.z+t.z,i},di.subtract=function(e,t,i){return ti.typeOf.object("left",e),ti.typeOf.object("right",t),ti.typeOf.object("result",i),i.x=e.x-t.x,i.y=e.y-t.y,i.z=e.z-t.z,i},di.multiplyByScalar=function(e,t,i){return ti.typeOf.object("cartesian",e),ti.typeOf.number("scalar",t),ti.typeOf.object("result",i),i.x=e.x*t,i.y=e.y*t,i.z=e.z*t,i},di.divideByScalar=function(e,t,i){return ti.typeOf.object("cartesian",e),ti.typeOf.number("scalar",t),ti.typeOf.object("result",i),i.x=e.x/t,i.y=e.y/t,i.z=e.z/t,i},di.negate=function(e,t){return ti.typeOf.object("cartesian",e),ti.typeOf.object("result",t),t.x=-e.x,t.y=-e.y,t.z=-e.z,t},di.abs=function(e,t){return ti.typeOf.object("cartesian",e),ti.typeOf.object("result",t),t.x=Math.abs(e.x),t.y=Math.abs(e.y),t.z=Math.abs(e.z),t};var ci=new di;di.lerp=function(e,t,i,r){return ti.typeOf.object("start",e),ti.typeOf.object("end",t),ti.typeOf.number("t",i),ti.typeOf.object("result",r),di.multiplyByScalar(t,i,ci),r=di.multiplyByScalar(e,1-i,r),di.add(ci,r,r)};var ui=new di,_i=new di;di.angleBetween=function(e,t){ti.typeOf.object("left",e),ti.typeOf.object("right",t),di.normalize(e,ui),di.normalize(t,_i);let i=di.dot(ui,_i),r=di.magnitude(di.cross(ui,_i,ui));return Math.atan2(r,i)};var pi=new di;di.mostOrthogonalAxis=function(e,t){ti.typeOf.object("cartesian",e),ti.typeOf.object("result",t);let i=di.normalize(e,pi);return di.abs(i,i),t=i.x<=i.y?i.x<=i.z?di.clone(di.UNIT_X,t):di.clone(di.UNIT_Z,t):i.y<=i.z?di.clone(di.UNIT_Y,t):di.clone(di.UNIT_Z,t)},di.projectVector=function(e,t,i){ti.defined("a",e),ti.defined("b",t),ti.defined("result",i);let r=di.dot(e,t)/di.dot(t,t);return di.multiplyByScalar(t,r,i)},di.equals=function(e,t){return e===t||$t(e)&&$t(t)&&e.x===t.x&&e.y===t.y&&e.z===t.z},di.equalsArray=function(e,t,i){return e.x===t[i]&&e.y===t[i+1]&&e.z===t[i+2]},di.equalsEpsilon=function(e,t,i,r){return e===t||$t(e)&&$t(t)&&li.equalsEpsilon(e.x,t.x,i,r)&&li.equalsEpsilon(e.y,t.y,i,r)&&li.equalsEpsilon(e.z,t.z,i,r)},di.cross=function(e,t,i){ti.typeOf.object("left",e),ti.typeOf.object("right",t),ti.typeOf.object("result",i);let r=e.x,s=e.y,n=e.z,o=t.x,a=t.y,l=t.z,d=s*l-n*a,h=n*o-r*l,c=r*a-s*o;return i.x=d,i.y=h,i.z=c,i},di.midpoint=function(e,t,i){return ti.typeOf.object("left",e),ti.typeOf.object("right",t),ti.typeOf.object("result",i),i.x=.5*(e.x+t.x),i.y=.5*(e.y+t.y),i.z=.5*(e.z+t.z),i},di.fromDegrees=function(e,t,i,r,s){return ti.typeOf.number("longitude",e),ti.typeOf.number("latitude",t),e=li.toRadians(e),t=li.toRadians(t),di.fromRadians(e,t,i,r,s)};var mi=new di,fi=new di,gi=new di(40680631590769,40680631590769,40408299984661.445);di.fromRadians=function(e,t,i,r,s){ti.typeOf.number("longitude",e),ti.typeOf.number("latitude",t),i=ri(i,0);let n=$t(r)?r.radiiSquared:gi,o=Math.cos(t);mi.x=o*Math.cos(e),mi.y=o*Math.sin(e),mi.z=Math.sin(t),mi=di.normalize(mi,mi),di.multiplyComponents(n,mi,fi);let a=Math.sqrt(di.dot(mi,fi));return fi=di.divideByScalar(fi,a,fi),mi=di.multiplyByScalar(mi,i,mi),$t(s)||(s=new di),di.add(fi,mi,s)},di.fromDegreesArray=function(e,t,i){if(ti.defined("coordinates",e),e.length<2||e.length%2!=0)throw new Kt("the number of coordinates must be a multiple of 2 and at least 2");let r=e.length;$t(i)?i.length=r/2:i=new Array(r/2);for(let s=0;s<r;s+=2){let r=e[s],n=e[s+1],o=s/2;i[o]=di.fromDegrees(r,n,0,t,i[o])}return i},di.fromRadiansArray=function(e,t,i){if(ti.defined("coordinates",e),e.length<2||e.length%2!=0)throw new Kt("the number of coordinates must be a multiple of 2 and at least 2");let r=e.length;$t(i)?i.length=r/2:i=new Array(r/2);for(let s=0;s<r;s+=2){let r=e[s],n=e[s+1],o=s/2;i[o]=di.fromRadians(r,n,0,t,i[o])}return i},di.fromDegreesArrayHeights=function(e,t,i){if(ti.defined("coordinates",e),e.length<3||e.length%3!=0)throw new Kt("the number of coordinates must be a multiple of 3 and at least 3");let r=e.length;$t(i)?i.length=r/3:i=new Array(r/3);for(let s=0;s<r;s+=3){let r=e[s],n=e[s+1],o=e[s+2],a=s/3;i[a]=di.fromDegrees(r,n,o,t,i[a])}return i},di.fromRadiansArrayHeights=function(e,t,i){if(ti.defined("coordinates",e),e.length<3||e.length%3!=0)throw new Kt("the number of coordinates must be a multiple of 3 and at least 3");let r=e.length;$t(i)?i.length=r/3:i=new Array(r/3);for(let s=0;s<r;s+=3){let r=e[s],n=e[s+1],o=e[s+2],a=s/3;i[a]=di.fromRadians(r,n,o,t,i[a])}return i},di.ZERO=Object.freeze(new di(0,0,0)),di.ONE=Object.freeze(new di(1,1,1)),di.UNIT_X=Object.freeze(new di(1,0,0)),di.UNIT_Y=Object.freeze(new di(0,1,0)),di.UNIT_Z=Object.freeze(new di(0,0,1)),di.prototype.clone=function(e){return di.clone(this,e)},di.prototype.equals=function(e){return di.equals(this,e)},di.prototype.equalsEpsilon=function(e,t,i){return di.equalsEpsilon(this,e,t,i)},di.prototype.toString=function(){return`(${this.x}, ${this.y}, ${this.z})`};var vi=di,yi=new vi,xi=new vi;var bi=function(e,t,i,r,s){if(!$t(e))throw new Kt("cartesian is required.");if(!$t(t))throw new Kt("oneOverRadii is required.");if(!$t(i))throw new Kt("oneOverRadiiSquared is required.");if(!$t(r))throw new Kt("centerToleranceSquared is required.");let n=e.x,o=e.y,a=e.z,l=t.x,d=t.y,h=t.z,c=n*n*l*l,u=o*o*d*d,_=a*a*h*h,p=c+u+_,m=Math.sqrt(1/p),f=vi.multiplyByScalar(e,m,yi);if(p<r)return isFinite(m)?vi.clone(f,s):void 0;let g=i.x,v=i.y,y=i.z,x=xi;x.x=f.x*g*2,x.y=f.y*v*2,x.z=f.z*y*2;let b,T,w,C,P,S,M,R,I,L,E,A=(1-m)*vi.magnitude(e)/(.5*vi.magnitude(x)),U=0;do{A-=U,w=1/(1+A*g),C=1/(1+A*v),P=1/(1+A*y),S=w*w,M=C*C,R=P*P,I=S*w,L=M*C,E=R*P,b=c*S+u*M+_*R-1,T=c*I*g+u*L*v+_*E*y,U=b/(-2*T)}while(Math.abs(b)>li.EPSILON12);return $t(s)?(s.x=n*w,s.y=o*C,s.z=a*P,s):new vi(n*w,o*C,a*P)};function Ti(e,t,i){this.longitude=ri(e,0),this.latitude=ri(t,0),this.height=ri(i,0)}Ti.fromRadians=function(e,t,i,r){return ti.typeOf.number("longitude",e),ti.typeOf.number("latitude",t),i=ri(i,0),$t(r)?(r.longitude=e,r.latitude=t,r.height=i,r):new Ti(e,t,i)},Ti.fromDegrees=function(e,t,i,r){return ti.typeOf.number("longitude",e),ti.typeOf.number("latitude",t),e=li.toRadians(e),t=li.toRadians(t),Ti.fromRadians(e,t,i,r)};var wi=new vi,Ci=new vi,Pi=new vi,Si=new vi(1/6378137,1/6378137,1/6356752.314245179),Mi=new vi(1/40680631590769,1/40680631590769,1/40408299984661.445),Ri=li.EPSILON1;Ti.fromCartesian=function(e,t,i){let r=$t(t)?t.oneOverRadii:Si,s=$t(t)?t.oneOverRadiiSquared:Mi,n=$t(t)?t._centerToleranceSquared:Ri,o=bi(e,r,s,n,Ci);if(!$t(o))return;let a=vi.multiplyComponents(o,s,wi);a=vi.normalize(a,a);let l=vi.subtract(e,o,Pi),d=Math.atan2(a.y,a.x),h=Math.asin(a.z),c=li.sign(vi.dot(l,e))*vi.magnitude(l);return $t(i)?(i.longitude=d,i.latitude=h,i.height=c,i):new Ti(d,h,c)},Ti.toCartesian=function(e,t,i){return ti.defined("cartographic",e),vi.fromRadians(e.longitude,e.latitude,e.height,t,i)},Ti.clone=function(e,t){if($t(e))return $t(t)?(t.longitude=e.longitude,t.latitude=e.latitude,t.height=e.height,t):new Ti(e.longitude,e.latitude,e.height)},Ti.equals=function(e,t){return e===t||$t(e)&&$t(t)&&e.longitude===t.longitude&&e.latitude===t.latitude&&e.height===t.height},Ti.equalsEpsilon=function(e,t,i){return i=ri(i,0),e===t||$t(e)&&$t(t)&&Math.abs(e.longitude-t.longitude)<=i&&Math.abs(e.latitude-t.latitude)<=i&&Math.abs(e.height-t.height)<=i},Ti.ZERO=Object.freeze(new Ti(0,0,0)),Ti.prototype.clone=function(e){return Ti.clone(this,e)},Ti.prototype.equals=function(e){return Ti.equals(this,e)},Ti.prototype.equalsEpsilon=function(e,t){return Ti.equalsEpsilon(this,e,t)},Ti.prototype.toString=function(){return`(${this.longitude}, ${this.latitude}, ${this.height})`};var Ii=Ti,Li=6378137,Ei=Math.PI*Li,Ai=.0818191908426;function Ui({lon:e,lat:t,alt:i},r=ue(0,0,0)){return r.x=(Ei+function(e){let t=yt(bt(e),-Math.PI,Math.PI);return Li*t}(e))/Ei-1,r.y=vt(1-(Ei-function(e){let t=bt(vt(e,-89.9999999999,89.9999999999)),i=Ai*Math.sin(t),r=Math.tan(.25*Math.PI+.5*t),s=Math.pow(Math.tan(.25*Math.PI+.5*Math.asin(i)),Ai),n=r/s;return Li*Math.log(n)}(t))/Ei,-1,1),r.z=function(e,t){return e/Math.cos(bt(t))}(i,t)/Ei,r}function Oi(e,t={lon:0,lat:0,alt:0}){let i=Ii.fromCartesian(e,void 0,Vi);return t.lon=i.longitude,t.lat=i.latitude,t.alt=i.height,t}var Vi=new Ii,Di=Zt(((e,t=ze(Oe))=>{let{azimuth:i,tilt:r,aspectRatio:s}=e,n=Dt(e),o=zi(e),a=Gt(o,i,r,Ni);ze(Oe,t),function(e,t,i,r,s=De()){let n=xe(t,i);Ce(n,n);let o=Se(r,n);Ce(o,o);let a=Se(n,o);Fe[0]=o.x,Fe[1]=a.x,Fe[2]=n.x,Fe[4]=o.y,Fe[5]=a.y,Fe[6]=n.y,Fe[8]=o.z,Fe[9]=a.z,Fe[10]=n.z,Fe[12]=-Pe(o,t),Fe[13]=-Pe(a,t),Fe[14]=-Pe(n,t),Ne(e,Fe,s)}(t,a,me,Re(fe,i),t);let l=Gi(o,r,n);return function(e,t,i,r,s,n=De()){let o=1/Math.tan(.5*t),a=o/i,l=(r+s)/(r-s),d=2*r*s/(r-s);for(let t=0;t<Ve;t+=4){n[t]=e[t]*a,n[t+1]=e[t+1]*o;let i=e[t+2],r=e[t+3];n[t+2]=i*l+r*d,n[t+3]=-i}}(t,n,s,l.zNear,l.zFar,t),t})),zi=Zt((e=>{let{fov:t,screenSize:i}=e,r=Vt(e);return Nt(i.height,t,r)})),Bi=10/Ei,Fi=bt(85),Ni=ue(0,0,0);function ki(e,t,i){return Math.min(.01*e,e/(1+ji(t,i)))}function Hi(e,t,i){return e/(1-ji(Math.min(t,Fi-.5*i),i))+Bi}function ji(e,t){return Math.tan(Math.abs(e))*Math.tan(.5*t)}function Gi(e,t,i){return{zNear:ki(e,t,i),zFar:Hi(e,t,i)}}var Wi=Zt(((e,t={origin:ue(0,0,0),planes:[{normal:ue(0,0,0),distance:0},{normal:ue(0,0,0),distance:0},{normal:ue(0,0,0),distance:0},{normal:ue(0,0,0),distance:0}],farPlane:{normal:ue(0,0,0),distance:0},nearPlane:{normal:ue(0,0,0),distance:0},edges:[ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0)]})=>{let{origin:i,planes:r,farPlane:s,nearPlane:n,edges:o}=t,{screenSize:a,fov:l,azimuth:d,tilt:h,aspectRatio:c}=e,u=Dt(e),_=Vt(e),p=Nt(a.height,l,_),m=Gt(p,d,h,$i);pe(e.center.x,e.center.y,0,i),ye(i,m,i);let f=Zi(u),g=ue(f*c,f,1);for(let e=0;e<4;++e){let t=o[e];be(Xi[e],g,t),Me(t,qt(h,l,-1===Xi[e].y),t),Re(t,d,t)}qi(o[0],o[3],i,r[0]),qi(o[1],o[0],i,r[1]),qi(o[2],o[1],i,r[2]),qi(o[3],o[2],i,r[3]);let v=Gi(p,h,u),y=Ce(m,Qi),x=Te(y,-1,Ki);return Yi(x,x,v.zFar,i,s),Yi(y,x,v.zNear,i,n),t}));function Yi(e,t,i,r,s){ve(e,s.normal);let n=Te(t,i,Ji);s.distance=Pe(s.normal,ye(n,r,Ji))}function qi(e,t,i,r){Se(e,t,r.normal),Ce(r.normal,r.normal),r.distance=-Pe(r.normal,i)}var Xi=[ue(-1,1,-1),ue(1,1,-1),ue(1,-1,-1),ue(-1,-1,-1)],Zi=At((e=>Math.tan(.5*e))),$i=ue(0,0,0),Qi=ue(0,0,0),Ki=ue(0,0,0),Ji=ue(0,0,0),er=Zt(((e,t=[ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0)])=>{let i=Wi(e),r=function(e,t){for(let i=0;i<e.edges.length;++i)t[i].origin=e.origin,t[i].direction=e.edges[i];return t}(i,nr);for(let[e,s]of sr){let n=tr(rr(i,r[e],r[s],or));t[e]=n[0],t[s]=n[1]}return t}));function tr(e){let t=[],i=e.length;for(let r=0;r<i;++r){let s=e[r],n=e[(r+1)%i];if(z(n.z,0,Number.EPSILON))continue;let o=Ie(0,s,n);o&&t.push(o)}if(2===t.length)return t;throw new Error(`Intersection with polyline ${JSON.stringify(e)} has ${t.length} points`)}function ir(e){if(null==e)throw new Error("Called unwrap on an absent value");return e}function rr(e,t,i,r){return ir(Le(e.farPlane,t,r[0])),ir(Le(e.nearPlane,t,r[1])),ir(Le(e.nearPlane,i,r[2])),ir(Le(e.farPlane,i,r[3])),r}var sr=[[1,2],[0,3]],nr=[{origin:me,direction:me},{origin:me,direction:me},{origin:me,direction:me},{origin:me,direction:me}],or=[ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0)],ar=B(-1,-1),lr=e=>{let t=H(e);return W(t,ar,t),Y(t,.5,t),t},dr=e=>.25*(e+2)*4294967295,hr=e=>Math.trunc(e/65536),cr=e=>65535&e,ur=(e,t)=>e.x-t.x||e.y-t.y,_r=B(0,0),pr=[],mr=[];function fr(e){let t=er(e);if(0===function(e,t,i){let r=Math.min(t.length,i.length);for(let s=0;s<r;s++){let r=e(t[s],i[s]);if(r)return r}return t.length-i.length}(ur,pr,t))return mr;let i=[];for(let r of function(e){let t=[],i=ne(e),r=Math.floor(i.minX),s=Math.ceil(i.maxX)-r,n=new Lt(s);for(let t=e.length-1,s=0;s<e.length;t=s++){let o=e[t],a=e[s];if(o.x>a.x){let e=o;o=a,a=e}let l=Math.floor(o.x+1),d=Math.ceil(a.x-1),h=(o.y-a.y)/(o.x-a.x);n.updateValue(Et(o.x,i.maxX)-r,Et(o.y,i.maxY)),n.updateValue(Et(a.x,i.maxX)-r,Et(a.y,i.maxY));for(let e=l;e<=d;e++){let t=(isFinite(h)?h*(e-o.x):0)+o.y,s=e-r,a=s-1,l=Math.floor(t);Number.isInteger(t)?t===i.maxY?(n.updateValue(a,l-1),n.updateValue(s,l-1)):h>0?(n.updateValue(a,l-1),n.updateValue(s,l)):h<0&&(n.updateValue(a,l),n.updateValue(s,l-1)):(n.updateValue(a,l),n.updateValue(s,l))}}for(let{min:e,max:i,index:s}of n.values()){let n=r+s;for(let r=e;r<=i;r++)t.push(B(n,r))}return t}(t.map(lr)))if(!(2!==e.options.wrapModeX&&0!==r.x||2!==e.options.wrapModeY&&0!==r.y)){Y(r,-2,_r),G(e.center,_r,_r);let t=H(_r);Q(_r,dr,_r),i.push({lookAt:t,lookAtHigh:Q(_r,hr),lookAtLow:Q(_r,cr)})}st(i,mr),mr.length=i.length,pr.length=t.length;for(let e=0;e<t.length;e++)pr[e]=H(t[e],pr[e]);return i}function gr(){return devicePixelRatio>1?devicePixelRatio:1}function vr(e=0,t=0){return{width:e,height:t}}function yr(e,t=vr()){return t.width=e.width,t.height=e.height,t}function xr(e,t){return e.width===t.width&&e.height===t.height}var br=Date.now();var Tr="performance"in self&&"now"in performance?()=>performance.now():function(){return Date.now()-br},wr="varying lowp vec4 id;void main(){gl_FragColor=id;}",Cr=new D({depthTest:!0,clearDepth:0,depthFunc:516,dither:!1}),Pr=class extends ft{constructor(e){let t=e.createProgram("#version 100\nattribute vec2 position;uniform sampler2D directPriorityGrid;uniform sampler2D reversePriorityGrid;uniform vec2 idHalfPxSize;varying lowp vec4 id;const vec2 NO_ID=vec2(0,0);const vec4 DISCARD_POSITION=vec4(2,2,2,1);const float ID_RENORMALIZATION=255.0/256.0;const float MIN_OVERLAPPING_PRIMITVES_ALPHA=0.01;const float JUST_VISIBLE_PRIMITIVE_Z_POSITION=0.25;const float OVERLAPPING_PRIMITIVE_Z_POSITION=0.5;void main(){vec4 primitiveIdReversePriority=texture2D(reversePriorityGrid,position);if(primitiveIdReversePriority.rg!=NO_ID){vec4 primitiveIdPriority=texture2D(directPriorityGrid,position);vec2 idTexCoordinates=primitiveIdReversePriority.rg*ID_RENORMALIZATION+idHalfPxSize;bool isOverlap=primitiveIdReversePriority!=primitiveIdPriority;gl_Position=vec4(idTexCoordinates*2.0-1.0,JUST_VISIBLE_PRIMITIVE_Z_POSITION,1);id=vec4(NO_ID,0,0);if(isOverlap&&primitiveIdPriority.a>=MIN_OVERLAPPING_PRIMITVES_ALPHA){gl_Position.z=OVERLAPPING_PRIMITIVE_Z_POSITION;id=vec4(primitiveIdPriority.rg,0,1);}gl_PointSize=1.0;}else{gl_Position=DISCARD_POSITION;}}",wr,{attribMap:{position:0}});super(e,Cr,t),e.bindProgram(t),t.setIntScalarUniform("directPriorityGrid",0),t.setIntScalarUniform("reversePriorityGrid",1)}_prepareProgram(e,t,i,r,s,n,o){super._prepareProgram(e,t,i,r,s,n,o),this._context.bindTextureUnit(0),this._context.bindTexture(r),this._context.bindTextureUnit(1),this._context.bindTexture(s),e.setVector2Uniform("idHalfPxSize",n)}_render(e,t){this._context.bindVao(e),this._context.drawMesh(0,t,0)}_prepareRenderTarget(e,t,i,r,s,n,o){super._prepareRenderTarget(e,t,i,r,s,n,o),o&&this._context.clearCurrentTarget(256)}},Sr=$e([[0,{size:4,type:5120,normalized:!1}]]),Mr=class extends _t{constructor(){super(Sr.vertexByteSize,4,4,6),this._writeBytes(-1,-1,0,0),this._writeBytes(-1,1,0,1),this._writeBytes(1,1,1,1),this._writeBytes(1,-1,1,0),this.writeIndicesForFan([0,1,2,3]),this.vertexData=this.getBuffers()[0].vertexBuffer,this.indexData=this.getBuffers()[0].indexBuffer}},Rr=new D({dither:!1}),Ir=class extends ft{constructor(e){let t=e.createProgram("#version 100\nattribute vec4 position;varying vec2 idTexCoordinates;void main(){gl_Position=vec4(position.xy,0,1);idTexCoordinates=position.zw;}","#version 100\nprecision mediump float;uniform sampler2D prevVisibility;uniform sampler2D overlaps;uniform sampler2D scene;uniform sampler2D friendIds;uniform float fadeAnimationAmount;uniform float currentZoom;uniform float currentTilt;uniform float currentAzimuth;varying vec2 idTexCoordinates;const vec2 NO_ID=vec2(0,0);const float LOWP_EPSILON=1.0/256.0;void main(){vec4 prevVisibilityValue=texture2D(prevVisibility,idTexCoordinates);vec4 overlapsValue=texture2D(overlaps,idTexCoordinates);vec4 sceneValue=texture2D(scene,idTexCoordinates);vec4 friendIdsValue=texture2D(friendIds,idTexCoordinates);bool isInScene=sceneValue.a>=LOWP_EPSILON;if(isInScene){gl_FragColor=prevVisibilityValue;bool isOverlapped=overlapsValue.a>=LOWP_EPSILON;bool isFriend=friendIdsValue.rg!=NO_ID&&friendIdsValue.rg==overlapsValue.rg;if(isOverlapped&&!isFriend){if(gl_FragColor.b<LOWP_EPSILON){gl_FragColor.b=currentZoom;gl_FragColor.r=currentTilt;gl_FragColor.g=currentAzimuth;}gl_FragColor.a=clamp(gl_FragColor.a-fadeAnimationAmount,0.0,1.0);}else{gl_FragColor.a=clamp(gl_FragColor.a+fadeAnimationAmount,0.0,1.0);gl_FragColor.rgb=vec3(0,0,0);}}else{gl_FragColor=vec4(0,0,0,0);}}",{attribMap:{position:0}});super(e,Rr,t);let i=new Mr;this._idSamplerVertexBuffer=this._context.createVertexBuffer(i.vertexData.byteLength),this._idSamplerIndexBuffer=this._context.createIndexBuffer(i.indexData.byteLength),this._idSamplerVao=this._context.createVao([{attributeMapping:Sr,buffer:this._idSamplerVertexBuffer}],this._idSamplerIndexBuffer),this._context.uploadDataToBuffer(this._idSamplerVertexBuffer,i.vertexData),this._context.uploadDataToBuffer(this._idSamplerIndexBuffer,i.indexData),e.bindProgram(t),t.setIntScalarUniform("prevVisibility",0),t.setIntScalarUniform("overlaps",1),t.setIntScalarUniform("scene",2),t.setIntScalarUniform("friendIds",3)}destroy(){this._idSamplerVertexBuffer.destroy(),this._idSamplerIndexBuffer.destroy(),this._idSamplerVao.destroy(),super.destroy()}_prepareProgram(e,t,i,r,s,n,o,a,l){super._prepareProgram(e,t,i,r,s,n,o,a,l),this._context.bindTextureUnit(0),this._context.bindTexture(t),this._context.bindTextureUnit(1),this._context.bindTexture(i),this._context.bindTextureUnit(2),this._context.bindTexture(r),this._context.bindTextureUnit(3),this._context.bindTexture(s),e.setScalarUniform("fadeAnimationAmount",n),e.setScalarUniform("currentZoom",o),e.setScalarUniform("currentTilt",a),e.setScalarUniform("currentAzimuth",l)}_render(){this._context.bindVao(this._idSamplerVao),this._context.drawIndexedMesh(0,6,4,5123)}},Lr=new D({blend:!0,blendFuncSrcRgb:0,blendFuncDstRgb:1,blendFuncSrcAlpha:1,blendFuncDstAlpha:0,dither:!1}),Er=class extends ft{constructor(e){let t=e.createProgram("#version 100\nattribute vec4 position;void main(){gl_Position=vec4(position.xy,0,1);}","#version 100\nvoid main(){gl_FragColor=vec4(0,0,0,1);}",{attribMap:{position:0}});super(e,Lr,t);let i=new Mr;this._idSamplerVertexBuffer=this._context.createVertexBuffer(i.vertexData.byteLength),this._idSamplerIndexBuffer=this._context.createIndexBuffer(i.indexData.byteLength),this._idSamplerVao=this._context.createVao([{attributeMapping:Sr,buffer:this._idSamplerVertexBuffer}],this._idSamplerIndexBuffer),this._context.uploadDataToBuffer(this._idSamplerVertexBuffer,i.vertexData),this._context.uploadDataToBuffer(this._idSamplerIndexBuffer,i.indexData)}destroy(){this._idSamplerVertexBuffer.destroy(),this._idSamplerIndexBuffer.destroy(),this._idSamplerVao.destroy(),super.destroy()}_render(){this._context.bindVao(this._idSamplerVao),this._context.drawIndexedMesh(0,6,4,5123)}},Ar=256,Ur=new D({clearColor:S(0,0,0,0),dither:!1}),Or=S(0,0,0,1),Vr=new D({clearColor:Or,depthTest:!0,clearDepth:-1,depthFunc:518,dither:!1}),Dr=new D({clearColor:Or,depthTest:!0,clearDepth:1,depthFunc:513,dither:!1}),zr=class{constructor(e,t,i,r,s=150){this._onSceneUpdate=()=>{this._lastSceneUpdateTime=Tr(),this._animationTicksCount=0,this._renderLoop.update()},this._onBeforeRender=()=>{this._isDirty=!0},this.fadeEffectDuration=s,this._context=e,this._camera=t,this._renderLoop=i,this._lastRenderTimeInLoop=-1,this._lastSceneUpdateTime=Tr(),this._animationTicksCount=0,this._prevTargetSize={width:0,height:0},this._isEnabled=!0,this._camera.onUpdate.addListener(this._onSceneUpdate),this._renderLoop.onBeforeRender.addListener(this._onBeforeRender),this._directPriorityGridRenderer=new gt(e,Vr),this._reversePriorityGridRenderer=new gt(e,Dr),this._noCollidingVisibilityTexture=this._createPlainTexture(S(1,1,1,1)),this._currentVisibilityTexture=e.createEmpty2DTexture(Ar,Ar,6408,5121),this._prevVisibilityTexture=e.createEmpty2DTexture(Ar,Ar,6408,5121),this._sceneTexture=e.createEmpty2DTexture(Ar,Ar,6408,5121),this._overlapsTexture=e.createEmpty2DTexture(Ar,Ar,6408,5121),this._friendsTexture=e.createEmpty2DTexture(Ar,Ar,6408,5121),this._currentVisibilityBuffer=e.createFramebuffer({color:this._currentVisibilityTexture}),this._prevVisibilityBuffer=e.createFramebuffer({color:this._prevVisibilityTexture}),this._sceneBuffer=e.createFramebuffer({color:this._sceneTexture}),this._overlapsBuffer=e.createFramebuffer({color:this._overlapsTexture,depthStencil:e.createRenderbuffer(Ar,Ar,34041)}),this._friendsBuffer=e.createFramebuffer({color:this._friendsTexture}),this._stabilityShift=ue(0,0,0),this._gridHalfPxSizeUniform=B(0,0),this._idHalfPxSizeUniform=B(.5/Ar,.5/Ar),this._resetRemoved=new class{render(e,t,i){for(let r of t)r.render(e,i)}},this._makeAllOverlapped=new Er(e),this._findOverlaps=new Pr(e),this._makeFriends=new class{render(e,t,i){for(let r of t)r.render(e,i)}},this._computeVisibility=new Ir(e),this._clearVisibility(this._currentVisibilityBuffer),this._clearVisibility(this._overlapsBuffer),this._primitiveProviders=[],this._resetRemovedRenderers=[],this._friendIdRenderers=[],this._phases=[],this.setTargetSize(r)}get visibilityTexture(){return this._isEnabled?this._currentVisibilityTexture:this._noCollidingVisibilityTexture}get noCollidingVisibilityTexture(){return this._noCollidingVisibilityTexture}destroy(){this._destroyGridResources(),this._directPriorityGridRenderer.destroy(),this._reversePriorityGridRenderer.destroy(),this._noCollidingVisibilityTexture.destroy(),this._currentVisibilityTexture.destroy(),this._prevVisibilityTexture.destroy(),this._sceneTexture.destroy(),this._overlapsTexture.destroy(),this._friendsTexture.destroy(),this._currentVisibilityBuffer.destroy(),this._prevVisibilityBuffer.destroy(),this._sceneBuffer.destroy(),this._overlapsBuffer.destroy(),this._friendsBuffer.destroy(),this._makeAllOverlapped.destroy(),this._findOverlaps.destroy(),this._computeVisibility.destroy(),this._renderLoop.onBeforeRender.removeListener(this._onBeforeRender),this._camera.onUpdate.removeListener(this._onSceneUpdate)}setEnabled(e){this._isEnabled=e,this._renderLoop.update()}setTargetSize(e){let t=3*gr(),i=Math.ceil(e.width/t),r=Math.ceil(e.height/t);this._directPriorityGridRenderer.setResolution(i,r),this._reversePriorityGridRenderer.setResolution(i,r),this._gridSamplerVertexBuffer&&this._destroyGridResources();let s=new mt(i,r),n=this._context;this._gridSamplerVertexBuffer=n.createVertexBuffer(s.data.byteLength),this._gridSamplerVao=n.createVao([{attributeMapping:pt,buffer:this._gridSamplerVertexBuffer}]),this._numberOfGridSamplers=s.numberOfSamplers,this._context.uploadDataToBuffer(this._gridSamplerVertexBuffer,s.data),yr(e,this._prevTargetSize),this._gridHalfPxSizeUniform.x=.5/i,this._gridHalfPxSizeUniform.y=.5/r}updateVisibilityIfNeeded(){if(!this._isDirty)return;this._isDirty=!1;let e=this._stabilityShift;H(this._camera.center,e),e.z=0,ke(Di(this._camera),e,e),e.x%=4*this._gridHalfPxSizeUniform.x,e.y%=4*this._gridHalfPxSizeUniform.y;let t=this._currentVisibilityTexture,i=this._currentVisibilityBuffer,r=this._prevVisibilityTexture,s=this._prevVisibilityBuffer,n=this._overlapsTexture,o=this._overlapsBuffer,a=this._sceneTexture,l=this._sceneBuffer,d=this._friendsTexture,h=this._friendsBuffer;this._currentVisibilityBuffer=s,this._currentVisibilityTexture=r,this._prevVisibilityBuffer=i,this._prevVisibilityTexture=t;let c=this._idHalfPxSizeUniform,u=this._camera.zoom/this._camera.options.maxZoom,_=this._camera.tilt,p=this._camera.azimuth/(2*Math.PI),m=Di(this._camera),f=fr(this._camera),g=this._gridSamplerVao,v=this._numberOfGridSamplers,y=Tr(),x=this._lastRenderTimeInLoop,b=-1!==x,T=y-this._lastSceneUpdateTime>this.fadeEffectDuration||b&&y-x>this.fadeEffectDuration,w=T?1:b?(y-x)/this.fadeEffectDuration:(y-this._lastSceneUpdateTime)/this.fadeEffectDuration;this._animationTicksCount++,this._clearVisibility(s),this._clearVisibility(l),this._clearVisibility(h),this._resetRemoved.render(l,this._resetRemovedRenderers,c),this._makeFriends.render(h,this._friendIdRenderers,c),this._makeAllOverlapped.render(o);for(let i=0;i<this._phases.length;i++){let r=this._phases[i],l=0===i,h=this._directPriorityGridRenderer.updateGrid(m,f,r.colorIdRenderers,e,t,n,a,u,_,p,l),y=this._reversePriorityGridRenderer.updateGrid(m,f,r.colorIdRenderers,e,t,n,a,u,_,p,l);this._findOverlaps.render(o,g,v,h,y,c,l),this._computeVisibility.render(s,t,n,a,d,w,u,_,p)}T&&this._animationTicksCount>1?this._lastRenderTimeInLoop=-1:(this._renderLoop.update(),this._lastRenderTimeInLoop=y)}registerCollidingPrimitives(e,{colorId:t,resetRemoved:i,friendId:r},s=0){var n;this._primitiveProviders.push(e),this._resetRemovedRenderers.push(i),r&&this._friendIdRenderers.push(r);let o=(n=this._phases)[s]||(n[s]={colorIdRenderers:[]});o.colorIdRenderers.push(t),o.colorIdRenderers.sort(((e,t)=>Number(e.options.clearDepth)-Number(t.options.clearDepth))),e.onUpdate.addListener(this._onSceneUpdate)}deregisterCollidingPrimitives(e,{colorId:t,resetRemoved:i,friendId:r}){let s=this._primitiveProviders.indexOf(e);s>-1&&this._primitiveProviders.splice(s,1),s=this._resetRemovedRenderers.indexOf(i),s>-1&&this._resetRemovedRenderers.splice(s,1),s=r?this._friendIdRenderers.indexOf(r):-1,s>-1&&this._friendIdRenderers.splice(s,1);for(let e of this._phases)s=e.colorIdRenderers.indexOf(t),s>-1&&e.colorIdRenderers.splice(s,1);e.onUpdate.removeListener(this._onSceneUpdate)}_clearVisibility(e){this._context.bindRenderState(Ur),this._context.bindRenderTarget(e),this._context.clearCurrentTarget(16384)}_createPlainTexture(e){let t=this._context.createEmpty2DTexture(1,1,6408,5121);return this._context.setTextureData(t,new Uint8Array([255*e.r,255*e.g,255*e.b,255*e.a])),t}_destroyGridResources(){this._gridSamplerVertexBuffer.destroy(),this._gridSamplerVao.destroy()}},Br=8/gr(),Fr=128,Nr=vr(Fr,Fr);function kr(e){return Math.ceil(e/Br/Fr)*Fr}var Hr=class extends(null){constructor(){super("Base render unit is not in the list")}},jr=class{constructor(){this._subRenderUnitUpdateHandler=()=>{this._onSubRenderUnitUpdate()},this._onUpdate=new wt,this._onRenderUnitListChanged=new wt,this._subRenderUnits=[]}get onUpdate(){return this._onUpdate}get onRenderUnitListChanged(){return this._onRenderUnitListChanged}[Symbol.iterator](){return this._subRenderUnits[Symbol.iterator]()}addRenderUnit(e){this._subRenderUnits.push(e),this._addUpdateHandler(e),this._onUpdate.fire(),this._onRenderUnitListChanged.fire()}removeRenderUnit(e){let t=this._subRenderUnits.indexOf(e);-1!==t&&(this._subRenderUnits.splice(t,1),this._removeUpdateHandler(e),this._onUpdate.fire(),this._onRenderUnitListChanged.fire())}addRenderUnitAbove(e,t){let i=this._subRenderUnits.indexOf(e);if(-1===i)throw new Hr;this._subRenderUnits.splice(i+1,0,t),this._addUpdateHandler(t)}addRenderUnitBelow(e,t){let i=this._subRenderUnits.indexOf(e);if(-1===i)throw new Hr;this._subRenderUnits.splice(i,0,t),this._addUpdateHandler(t)}render(e,...t){for(let i of this._subRenderUnits)i.render(e,...t)}renderHitTestBuffer(e,...t){for(let i of this._subRenderUnits)i.renderHitTestBuffer(e,...t)}_onSubRenderUnitUpdate(){this._onUpdate.fire()}_addUpdateHandler(e){var t;null==(t=e.onUpdate)||t.addListener(this._subRenderUnitUpdateHandler)}_removeUpdateHandler(e){var t;null==(t=e.onUpdate)||t.removeListener(this._subRenderUnitUpdateHandler)}},Gr=new D({clearDepth:-1,depthTest:!0,depthFunc:518}),Wr=new D(g(f({},Gr),{clearColor:P})),Yr={r:0,g:0,b:0,a:0},qr=class extends jr{constructor(e,t){super(),this._context=e,this._camera=t,this.onRender=this._onRender=new wt,this.setBackgroundColor(Yr)}render(e){let t=Di(this._camera),i=fr(this._camera);this._context.bindRenderTarget(e),this._context.bindRenderState(this._renderState),this._context.clearCurrentTarget(17664);for(let r of this._subRenderUnits)r.render(e,t,i);this._onRender.fire()}renderHitTestBuffer(e){let t=Di(this._camera),i=fr(this._camera);this._context.bindRenderTarget(e),this._context.bindRenderState(Wr),this._context.clearCurrentTarget(17664);for(let r of this._subRenderUnits)r.renderHitTestBuffer(e,t,i)}setBackgroundColor(e){this._renderState=new D(Gr,{clearColor:e})}},Xr=0,Zr=class{*[Symbol.iterator](){this._prepare(),yield*this._data}get length(){return this._prepare(),this._data.length}constructor(){this._key=Symbol("array_storage_metadata#"+Xr++),this._data=[],this._isDirty=!1}add(e){let t=this._getMetadata(e);return!t&&(t={index:this._data.push(e)-1},e[this._key]=t,!0)}remove(e){let t=this._getMetadata(e);return!!t&&(delete this._data[t.index],delete e[this._key],this._setDirty(),!0)}_prepare(){this._isDirty&&(this._onDirtyDataAccessed(),this._isDirty=!1)}_getDirty(){return this._isDirty}_setDirty(){this._isDirty=!0}_onDirtyDataAccessed(){this._shakeDown()}_getMetadata(e){return e[this._key]}_shakeDown(){let e=0;for(let t=0;t<this._data.length;++t){let i=this._data[t];if(void 0!==i){let t=this._getMetadata(i);this._data[e]=i,t.index=e,++e}}this._data.length=e}};function $r(e,t){let i=0;return(...r)=>{i&&clearTimeout(i),i=setTimeout((()=>{i=0,e(...r)}),t)}}function Qr(e,t=!1){let i=!1;return(...r)=>{(!t||!i)&&(Promise.resolve().then((()=>{e(...r),i=!1})),i=!0)}}var Kr=class{constructor(e=new Zr){this._primitives=e,this.onUpdate=this._onUpdate=new wt,this._updateScheduler=Qr(this._fireUpdate.bind(this),!0)}destroy(){for(let e of this._primitives)this._primitives.remove(e),e.release()}get primitives(){return this._primitives}addAll(e){let t=!1;for(let i of e)this._primitives.add(i)&&(i.retain(),t=!0);t&&this._updateScheduler()}removeAll(e){let t=!1;for(let i of e)this._primitives.remove(i)&&(i.release(),t=!0);t&&this._updateScheduler()}_fireUpdate(){this._onUpdate.fire()}},Jr=class extends Kr{constructor(e=new Zr){super(),this._visiblePrimitives=e}get primitives(){return this.visiblePrimitives}get visiblePrimitives(){return this._visiblePrimitives}addAll(e){super.addAll(e),this.show(e)}removeAll(e){this.hide(e),super.removeAll(e)}show(e){this._show(e)&&this._updateScheduler()}hide(e){this._hide(e)&&this._updateScheduler()}_show(e){let t=!1;for(let i of e)this._visiblePrimitives.add(i)&&(t=!0);return t}_hide(e){let t=!1;for(let i of e)this._visiblePrimitives.remove(i)&&(t=!0);return t}},es=class{constructor(e,t,i,r){this.id=i,this.vao=e,this.location=t,this.metadata=r}},ts=class extends es{retain(){}release(){}};function is(e,t){return t<<16|65535&e}function rs(e){return Ke(.25*(e+2))}function ss(e,t){let i=rs(t.x),r=rs(t.y);e.writeVertexUint32(function(e,t){return is(e>>>16,t>>>16)}(i,r)),e.writeVertexUint32(function(e,t){return is(e,t)}(i,r))}var ns=class{constructor(e){this._bufferDataProvider=e,this._currentMeshWrittenVertices=0}endMesh(){return this._currentMeshWrittenVertices=0,this._currentBufferData.endMesh()}writeIndices(e){this._ensureEnoughIndexBufferSpace(e.length),this._currentBufferData.writeIndices(e)}writeVertex(...e){return this._ensureEnoughVertexBufferSpace(),this._writeVertex(this._currentBufferData,...e),this._currentMeshWrittenVertices++}_ensureEnoughVertexBufferSpace(e=1){this._currentBufferData||this._requestNewBuffer();let t=this._currentBufferData.vertexBuffer,i=e*t.vertexByteSize;if(t.occupiedByteSize+i>t.byteSize&&(this._requestNewBuffer(),i>this._currentBufferData.vertexBuffer.byteSize))throw new Error("Mesh is too big to write its vertices")}_ensureEnoughIndexBufferSpace(e){this._currentBufferData||this._requestNewBuffer();let t=this._currentBufferData.indexBuffer;if(t.occupiedSize+e>t.size&&(this._requestNewBuffer(),e>this._currentBufferData.indexBuffer.size))throw new Error("Mesh is too big to write its indices")}_requestNewBuffer(){let e=this._currentBufferData;if(this._currentBufferData=this._bufferDataProvider(),e){if(0===e.vertexBuffer.currentMeshBaseIndex)throw new Error("Mesh is too big: tried to transfer the whole buffer");e.vertexBuffer.transferUnfinishedMesh(this._currentBufferData.vertexBuffer),e.indexBuffer.transferUnfinishedMesh(this._currentBufferData.indexBuffer,e.vertexBuffer.currentMeshBaseIndex)}}},os=class extends ns{writeFakePrimitive(e,t,i){let r=this.writeVertex(e,t.minX,t.minY,i),s=this.writeVertex(e,t.minX,t.maxY,i),n=this.writeVertex(e,t.maxX,t.minY,i),o=this.writeVertex(e,t.maxX,t.maxY,i);return this.writeIndices([r,n,s,s,n,o]),this.endMesh()}_writeVertex(e,t,i,r,s){ss(e,t),e.writeVertexUint32(is(i,r)),e.writeVertexUint32(s)}},as=class{get isRetained(){return 0!==this._clients}constructor(){this.onReleased=this._onReleased=new wt,this.onRetain=this._onRetain=new wt,this._clients=0}retain(){++this._clients,this._onRetain.fire(this)}release(){this._clients>0&&(--this._clients,0===this._clients&&this._onReleased.fire(this))}};function ls(e){for(let t of e)t.retain()}function ds(e){for(let t of e)t.release()}var hs=class extends as{constructor(e,t,i,r,s){super(),this._destructor=()=>{this.onReleased.removeListener(this._destructor),this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.dynamicVertexBuffer&&this.dynamicVertexBuffer.destroy(),this.vao.destroy()},this._context=e,this.layout=t,this.vertexBuffer=this._context.createVertexBuffer(i),this.indexBuffer=this._context.createIndexBuffer(r);let n=[{attributeMapping:t,buffer:this.vertexBuffer}];s&&(this.dynamicVertexBuffer=this._context.createVertexBuffer(i/t.vertexByteSize*s.vertexByteSize|0,35048),n.push({attributeMapping:s,buffer:this.dynamicVertexBuffer})),this.vao=this._context.createVao(n,this.indexBuffer),this.onReleased.addListener(this._destructor)}updateVertexContent(e,t){this._context.bindVao(null),this._context.uploadDataToBuffer(this.vertexBuffer,e,t)}updateIndexContent(e,t){this._context.bindVao(null),this._context.uploadDataToBuffer(this.indexBuffer,e,t)}updateDynamicContent(e,t){if(!this.dynamicVertexBuffer)throw new Error("Tried to update dynamic data of a page without dynamic vertex buffer.");this._context.bindVao(null),this._context.uploadDataToBuffer(this.dynamicVertexBuffer,e,t)}};function cs(e,t="something that is supposed to be defined is undefined"){if(void 0===e)throw new Error(t);return void 0!==e}function us(e){let t=new Image,i=new Promise((i=>{t.onload=()=>i(),t.crossOrigin="anonymous",t.src=e}));return[t,i]}function _s(e){return!!e&&"function"==typeof e.close}function ps(e,t,i){return x(this,null,(function*(){let r;r=_s(i)?i:yield function(e){return x(this,null,(function*(){let[t,i]=us(e);return yield i,t}))}(function(e){return!!e&&e.data instanceof ArrayBuffer}(i)?function(e,t){let i=new Blob([e],{type:t});return URL.createObjectURL(i)}(i.data,i.mimeType):i.uri),(t.getWidth()!==r.width||t.getHeight()!==r.height)&&e.resizeTexture(t,{width:r.width,height:r.height}),e.setTextureDataFromDomElement(t,r)}))}var ms={wrapS:33071,wrapT:33071,magnificationFilter:9728,minificationFilter:9728,premultipliedAlpha:!1,unpackAlignment:4},fs=class{constructor(e,t,i,r,s,n,o=e.createTexture()){let a=f(f({},ms),n);this._gl=e,this._format=r,this._type=s,this._params=a,this._width=t,this._height=i,this._halfPxSize=gs(t,i),this._handle=o,this._magnificationFilter=null,this._minificationFilter=null}initialize(){let e=this._gl;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this._params.wrapS),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this._params.wrapT),this.setFilters(this._params.magnificationFilter,this._params.minificationFilter),e.texImage2D(e.TEXTURE_2D,0,this._format,this._width,this._height,0,this._format,this._type,null)}bind(){let e=this._gl;e.bindTexture(e.TEXTURE_2D,this._handle)}isBound(){let e=this._gl;return e.getParameter(e.TEXTURE_BINDING_2D)===this._handle}attachToFramebuffer(e){let t=this._gl;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this._handle,0)}getWidth(){return this._width}getHeight(){return this._height}getFormat(){return this._format}getType(){return this._type}getParams(){return this._params}getHalfPxSize(){return this._halfPxSize}setFilters(e=this._params.magnificationFilter,t=this._params.minificationFilter){let i=this._gl;this._magnificationFilter!==e&&(this._magnificationFilter=e,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,e)),this._minificationFilter!==t&&(this._minificationFilter=t,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,t))}resize({width:e,height:t}){this._width=e,this._height=t,this._halfPxSize=gs(e,t)}destroy(){this._gl.deleteTexture(this._handle)}};function gs(e,t){return B(.5/e,.5/t)}function vs(e){return e.getWidth()*e.getHeight()*ys[e.getFormat()]*xs[e.getType()]}var ys={6406:1,6409:1,6410:2,6407:3,6408:4},xs={5126:4,36193:2,5121:1,32819:1,32820:1,33635:1},bs=class extends as{constructor(){super(),this._onRelease=()=>{this._destructor(),this.onReleased.removeListener(this._onRelease)},this.onReleased.addListener(this._onRelease)}},Ts=class extends bs{constructor(e,t,i,r,s){super(),this.id=e,this._buffers=[],this._onMemoryChanged=s,this._memorySize=0;let n,o=[];r&&o.push(...r.vertexBuffers);for(let{data:e,mapping:r}of i.vertices){let i=t.createVertexBuffer(e.byteLength);this._buffers.push(i),this._memorySize+=e.byteLength,t.uploadDataToBuffer(i,e),o.push({attributeMapping:r,buffer:i})}r?n=r.indexBuffer:(n=t.createIndexBuffer(i.indices.byteLength),this._buffers.push(n),this._memorySize+=i.indices.byteLength,t.uploadDataToBuffer(n,i.indices)),this.vertexBuffers=o,this.indexBuffer=n,this.vao=t.createVao(o,n),this._onMemoryChanged(this._memorySize)}get memoryUsageInBytes(){return this._memorySize}_destructor(){this.vao.destroy();for(let e of this._buffers)e.destroy();this._onMemoryChanged(-this._memorySize)}},ws=class extends bs{constructor(e,t,i,r){super(),this._memorySize=0,this.id=e,this._context=t,this._onMemoryChanged=r;let{width:s,height:n}=function(e){let t=1,i=1;return _s(e)&&(t=e.width,i=e.height),{width:t,height:i}}(i.content);this.texture=t.createEmpty2DTexture(s,n,6408,5121,{minificationFilter:9987,magnificationFilter:9729,wrapS:10497,wrapT:10497}),this.updateTextureData(i.content)}get memoryUsageInBytes(){return this._memorySize}updateTextureData(e){return this._setMemorySize(vs(this.texture)),ps(this._context,this.texture,e).then((()=>{this._setMemorySize(vs(this.texture))}),(e=>{console.warn(e)}))}_destructor(){this.texture.destroy(),this._onMemoryChanged(-this._memorySize)}_setMemorySize(e){e!==this._memorySize&&(this._onMemoryChanged(e-this._memorySize),this._memorySize=e)}},Cs=class{constructor(e,t){this._onMessage=e=>{switch(e.type){case 0:this._onPageAdd(e);break;case 1:this._onPageUpdate(e);break;case 2:this._onPageRemove(e);break;case 3:this._entityManager.addEntity(e.id,e.description);break;case 4:this._entityManager.removeEntity(e.id)}},this._communicator=e,this._context=t,this._pages=new Map,this._entityManager=this._createEntityManager(),this._memoryUsage={memoryForTextures:0,memoryForBuffers:0,memoryForVertices:0,memoryForIndices:0},this._onMemoryUsageChanged=new wt,this._communicator.onMessage.addListener(this._onMessage)}get memoryUsage(){return this._memoryUsage}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}destructor(){this._communicator.onMessage.removeListener(this._onMessage),this._entityManager.destructor();for(let[e,t]of this._pages)t.release();this._pages.clear()}getPage(e){return this._pages.get(e)}getEntity(e){return this._entityManager.getEntity(e)}_onPageAdd(e){let t=new hs(this._context,e.attribMapping,e.vertexDataByteSize,e.indexDataByteSize,e.dynamicAttribMapping);t.retain(),this._pages.set(e.id,t)}_onPageUpdate(e){let t=this.getPage(e.id);if(cs(t)){let{vertexUpdate:i,indexUpdate:r,dynamicVertexUpdate:s}=e;i&&t.updateVertexContent(i.data,i.byteOffset),r&&t.updateIndexContent(r.data,r.byteOffset),s&&t.updateDynamicContent(s.data,s.byteOffset)}}_onPageRemove(e){let t=this._pages.get(e.id);cs(t)&&(this._pages.delete(e.id),t.release())}_createEntityManager(){return new class{constructor(e,t,i){this._context=e,this._onGeometryMemoryChanged=t,this._onTextureMemoryChanged=i,this._entities=new Map}destructor(){for(let e of Array.from(this._entities.keys()))this.removeEntity(e)}getEntity(e){return this._entities.get(e)}addEntity(e,t){let i;switch(t.type){case 0:i=this._createGeometry(e,t);break;case 1:i=this._createImage(e,t)}i.retain(),this._entities.set(e,i)}removeEntity(e){let t=this._entities.get(e);cs(t)&&(this._entities.delete(e),t.release())}_createGeometry(e,t){let i;return void 0!==t.baseGeometryId&&(i=this._entities.get(t.baseGeometryId),cs(i)),new Ts(e,this._context,t,i,this._onGeometryMemoryChanged)}_createImage(e,t){return new ws(e,this._context,t,this._onTextureMemoryChanged)}}(this._context,(e=>{}),(e=>{}))}},Ps=class extends Error{};function Ss(e,t){if("boolean"==typeof e&&!e||"function"==typeof e&&!e())throw new Ps(`Assertion failed: ${t}`)}var Ms=class{get data(){return this._uint8View.buffer}get byteSize(){return this._uint8View.byteLength}get occupiedByteSize(){return this._nextWordOffset*this._wordByteSize}constructor(e,t){Ss(e%t==0,"size in bytes must be a multiply of wordByteSize"),this._wordByteSize=t,this._nextWordOffset=0,this._currentMeshByteOffset=0,this._uint8View=new Uint8Array(e)}endMesh(){let e=this._currentMeshByteOffset,t=this.occupiedByteSize,i=t-e;return this._currentMeshByteOffset=t,{byteOffset:e,byteSize:i}}transferUnfinishedMesh(e){let t=this.occupiedByteSize,i=t-this._currentMeshByteOffset,r=this._uint8View.subarray(this._currentMeshByteOffset,t);e._uint8View.set(r,0),e._nextWordOffset=i/this._wordByteSize,this._nextWordOffset=this._currentMeshByteOffset/this._wordByteSize}reset(){this._nextWordOffset=0,this._currentMeshByteOffset=0}},Rs=class extends Ms{constructor(e,t){super(e*t,Uint32Array.BYTES_PER_ELEMENT),this.vertexByteSize=t,this._uint32View=new Uint32Array(this._uint8View.buffer),this._float32View=new Float32Array(this._uint8View.buffer),this._currentMeshBaseIndex=0}get currentMeshBaseIndex(){return this._currentMeshBaseIndex}get isFull(){return this._nextWordOffset>=this._uint32View.length}pushUint32(e){this._uint32View[this._nextWordOffset++]=e}pushFloat32(e){this._float32View[this._nextWordOffset++]=e}asUint32Array(){return this._uint32View.subarray(0,this._nextWordOffset)}endMesh(){return this._currentMeshBaseIndex=this.occupiedByteSize/this.vertexByteSize,super.endMesh()}reset(){this._currentMeshBaseIndex=0,super.reset()}},Is=class extends Ms{constructor(e){let t=Uint16Array.BYTES_PER_ELEMENT;super(e*t,t),this._uint16View=new Uint16Array(this._uint8View.buffer)}get size(){return this._uint16View.length}get occupiedSize(){return this._nextWordOffset}push(e){this._uint16View[this._nextWordOffset++]=e}asUint16Array(){return this._uint16View.subarray(0,this._nextWordOffset)}transferUnfinishedMesh(e,t=0){if(super.transferUnfinishedMesh(e),t)for(let i=0;i<e._nextWordOffset;i++)e._uint16View[i]-=t}},Ls={vertexMinByte:Number.MAX_SAFE_INTEGER,vertexMaxByte:Number.MIN_SAFE_INTEGER},Es=g(f({},Ls),{indexMinByte:Number.MAX_SAFE_INTEGER,indexMaxByte:Number.MIN_SAFE_INTEGER}),As=class extends as{constructor(e,t,i,r,s){super(),this._onMeshWritten=e=>{this._updatedRegion||(this._updatedRegion=f({},Es)),this._extendRegion(this._updatedRegion,e),this._onUpdate.fire(this)},this.id=e,this.attribMapping=t,this.data=new class{constructor(e,t,i,r){this.id=e,this.vertexBuffer=new Rs(t,i),this.indexBuffer=new Is(r),this.onMeshWritten=this._onMeshWritten=new wt}writeVertexUint32(e){this.vertexBuffer.pushUint32(e)}writeVertexFloat32(e){this.vertexBuffer.pushFloat32(e)}writeIndices(e){let t=this.vertexBuffer.currentMeshBaseIndex;for(let i of e)this.indexBuffer.push(t+i)}endMesh(){let e=this.vertexBuffer.endMesh(),t=this.indexBuffer.endMesh(),i={vertexByteOffset:e.byteOffset,vertexByteLength:e.byteSize,indexByteOffset:t.byteOffset,indexByteLength:t.byteSize,indexType:5123,bufferId:this.id};return this._onMeshWritten.fire(i),i}reset(){this.vertexBuffer.reset(),this.indexBuffer.reset()}}(e,i,t.vertexByteSize,r),this.dynamicData=s&&{attribMapping:s,vertexData:new Rs(i,s.vertexByteSize)},this.data.onMeshWritten.addListener(this._onMeshWritten),this.onUpdate=this._onUpdate=new wt,this._updatedRegion=void 0,this._updatedDynamicRegion=void 0}touch(e){this._onMeshWritten(e)}touchDynamicData(e){this._onDynamicMeshWritten(e)}flushUpdatedRegion(){let e=this._updatedRegion;return this._updatedRegion=void 0,e}flushUpdatedDynamicRegion(){let e=this._updatedDynamicRegion;return this._updatedDynamicRegion=void 0,e}_onDynamicMeshWritten(e){this._updatedDynamicRegion||(this._updatedDynamicRegion=f({},Ls)),this._extendVertexBufferRegion(this._updatedDynamicRegion,e),this._onUpdate.fire(this)}_extendRegion(e,t){this._extendVertexBufferRegion(e,t),t.indexByteOffset<e.indexMinByte&&(e.indexMinByte=t.indexByteOffset);let i=t.indexByteOffset+t.indexByteLength;i>e.indexMaxByte&&(e.indexMaxByte=i)}_extendVertexBufferRegion(e,t){t.vertexByteOffset<e.vertexMinByte&&(e.vertexMinByte=t.vertexByteOffset);let i=t.vertexByteOffset+t.vertexByteLength;i>e.vertexMaxByte&&(e.vertexMaxByte=i)}},Us=class extends as{constructor(e,t){super(),this.id=e,this.type=t}};var Os=$e([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:2,type:5122,normalized:!1}],[10,{size:4,type:5121,normalized:!1}]]),Vs="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec4 vertexCollidingId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 shift;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float MAX_PRIORITY=1.0-pow(2.0,-24.0);varying vec4 id;void main(){vec4 position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,0,1);gl_Position=vec4(position.xy/position.w,MAX_PRIORITY,1.0);gl_Position.xy+=vertexDisplacement*pixelSize;gl_Position.xy+=shift;id=vec4(vertexCollidingId.xy/255.0,0,1);}";function Ds(e,t){switch(t){case 5121:return e;case 5123:return e>>1;case 5125:return e>>2;default:return-1}}function zs(e,t){return t.indexByteOffset+t.indexByteLength===e.indexByteOffset&&(t.indexByteLength+=e.indexByteLength,!0)}function Bs(e,t){return t.vertexByteOffset+t.vertexByteLength===e.vertexByteOffset&&t.indexByteOffset+t.indexByteLength===e.indexByteOffset&&(t.vertexByteLength+=e.vertexByteLength,t.indexByteLength+=e.indexByteLength,!0)}function Fs(e,t,i){return function*(e,t,i,r=(()=>!0),s=zs){let n=e[Symbol.iterator](),o=n.next().value;if(!o)return;let a=o,l=i(a);for(o=n.next().value;o;){let e=t(o);(!r(a,o,l)||!s(e,l))&&(yield l,l=i(o)),a=o,o=n.next().value}yield l}(e,(e=>e.location),(e=>f({firstPrimitive:e},e.location)),((e,i)=>!(e.vao!==i.vao||t&&!t(e,i))),i)}var Ns=class{constructor(e){this._batches=[],this._isSynced=!1,this._canBatchPredicate=e}batch(e){return this._sync(e),this._batches}invalidate(){this._isSynced=!1}_sync(e){if(!this._isSynced){let t=0;for(let i of Fs(e,this._canBatchPredicate))this._batches[t]=i,t++;this._batches.length=t,this._isSynced=!0}}},ks=class extends ft{constructor(e,t,i,r,s,n){super(t,i,r,s,n),this._updateListener=()=>{this._batchesCache.invalidate(),this._hitTestBatchesCache.invalidate(),this._onUpdate.fire()},this.primitiveProvider=e,this.onUpdate=this._onUpdate=new wt,this.primitiveProvider.onUpdate.addListener(this._updateListener),this._canBatchPredicate=this._canBatchAdjacentPrimitives.bind(this),this._batchesCache=new Ns(this._canBatchPredicate),this._hitTestBatchesCache=new Ns(this._canBatchPredicate)}destroy(){this.primitiveProvider.onUpdate.removeListener(this._updateListener),super.destroy()}_render(e,t){let i=this._program,r=this._batchesCache.batch(this._getPrimitives());for(let e of t){i.setVector2Uniform("lookAtHigh",e.lookAtHigh),i.setVector2Uniform("lookAtLow",e.lookAtLow);for(let e of r)this._renderBatch(e,i)}}_renderHitTestBuffer(e,t){let i=this._hitTestProgram,r=this._hitTestBatchesCache.batch(this._getHitTestPrimitives());for(let e of t){i.setVector2Uniform("lookAtHigh",e.lookAtHigh),i.setVector2Uniform("lookAtLow",e.lookAtLow);for(let e of r)this._renderHitTestBufferBatch(e,i)}}_getPrimitives(){return this.primitiveProvider.primitives}_getHitTestPrimitives(){return this.primitiveProvider.primitives}_prepareProgram(e,t,i,...r){super._prepareProgram(e,t,i,...r),e.setMatrix4Uniform("viewProjMatrix",t)}_prepareHitTestProgram(e,t,i,...r){super._prepareProgram(e,t,i,...r),e.setMatrix4Uniform("viewProjMatrix",t)}_renderBatch(e,t){this._context.bindVao(e.firstPrimitive.vao),this._context.drawIndexedMesh(e.indexByteOffset,Ds(e.indexByteLength,e.indexType),4,e.indexType)}_renderHitTestBufferBatch(e,t){this._context.bindVao(e.firstPrimitive.vao),this._context.drawIndexedMesh(e.indexByteOffset,Ds(e.indexByteLength,e.indexType),4,e.indexType)}_canBatchAdjacentPrimitives(e,t){return!0}},Hs=class extends ks{constructor(e,t,i,r=Gs){super(e,t,new D,i),this.options=r}_getPrimitives(){return this.primitiveProvider.primitives}_prepareProgram(e,t,i,r,s,n,o,a,l,d,h){super._prepareProgram(e,t,i,r,s,n,o,a,l,d,h),this._context.bindTextureUnit(0),this._context.bindTexture(n),this._context.bindTextureUnit(1),this._context.bindTexture(o),this._context.bindTextureUnit(2),this._context.bindTexture(a),e.setIntScalarUniform("visibility",0),e.setIntScalarUniform("overlap",1),e.setIntScalarUniform("scene",2),e.setVector2Uniform("idHalfPxSize",n.getHalfPxSize()),e.setVector2Uniform("shift",s),e.setScalarUniform("currentZoom",l),e.setScalarUniform("currentTilt",d),e.setScalarUniform("currentAzimuth",h)}_prepareRenderTarget(e,t,i,r,s,n,o){this._context.bindRenderState(r),this._context.bindRenderTarget(e),this.options.clearDepth&&this._context.clearCurrentTarget(256)}},js=class extends Hs{constructor(e,t,i,r=Gs){super(e,t,i),this.options=r}_getPrimitives(){return this.primitiveProvider.visiblePrimitives}},Gs={clearDepth:!1},Ws={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexCollidingId:10}},Ys=class extends js{constructor(e,t,i,r){super(e,t,t.createProgram(Vs,wr,Ws),r),this._camera=i}_prepareProgram(e,t,i,r,s,n,o,a,l,d,h){super._prepareProgram(e,t,i,r,s,n,o,a,l,d,h),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},qs=class extends ft{constructor(e,t){let i=t.createProgram("#version 100\nattribute vec2 vertexCollidingId;uniform vec2 idHalfPxSize;void main(){vec2 idTexCoordinates=vertexCollidingId/256.0+idHalfPxSize;vec4 idWindowCoordinates=vec4(idTexCoordinates*2.0-1.0,0,1);gl_Position=idWindowCoordinates;gl_PointSize=1.0;}","#version 100\nvoid main(){gl_FragColor=vec4(0,0,0,1);}",{attribMap:{vertexCollidingId:10}});super(t,new D,i),this._primitiveProvider=e}_render(){let e=this._primitiveProvider.primitives;for(let t of Fs(e))this._context.bindVao(t.firstPrimitive.vao),this._context.drawIndexedMesh(t.indexByteOffset,Ds(t.indexByteLength,t.indexType),0,t.indexType)}_prepareProgram(e,t){super._prepareProgram(e,t),e.setVector2Uniform("idHalfPxSize",t)}},Xs=class{constructor(){this.onMessage=this._onMessage=new wt}sendMessage(e,t){this.peerCommunicator&&this.peerCommunicator._onMessage.fire(e)}};var Zs=class extends ts{constructor(e,t,i,r,s){super(e,t,i),this.anchor=r,this.rect=s}};function $s(e){return{maxX:e.maxX,minX:e.minX,maxY:-e.minY,minY:-e.maxY}}var Qs={min:1,max:511},Ks={min:512,max:4095},Js={min:65536,max:77823};function en({min:e,max:t}){let i=0;return()=>i++%(t-e+1)+e}var tn,rn=(e=>(e[e.GROUND=100]="GROUND",e))(rn||{}),sn=(e=>(e[e.PLACEMARK=110]="PLACEMARK",e))(sn||{}),nn=(e=>(e[e.ICON=120]="ICON",e[e.POINT_LABEL=121]="POINT_LABEL",e[e.POLYLINE_LABEL=122]="POLYLINE_LABEL",e))(nn||{}),on=((tn=on||{})[tn.OPAQUE_POLYGON=0]="OPAQUE_POLYGON",tn[tn.TRANSPARENT_POLYGON=1]="TRANSPARENT_POLYGON",tn[tn.TEXTURED_POLYGON=2]="TEXTURED_POLYGON",tn[tn.MESH=3]="MESH",tn[tn.RICH_MODEL=4]="RICH_MODEL",tn[tn.POLYLINE=5]="POLYLINE",tn[tn.POINT_LABEL=6]="POINT_LABEL",tn[tn.POLYLINE_LABEL=7]="POLYLINE_LABEL",tn[tn.ICON=8]="ICON",tn);function*an(e){for(let t in e)yield Number(t)}var ln=J(-1,1,-1,1);function dn(e){return!te(e)&&se(e,ln)}var hn=63,cn=(hn-1)/2/2;function un(e,t,i){return i.x=vt(cn*(e- -1)|0,0,hn-1),i.y=vt(cn*(t- -1)|0,0,hn-1),i}var _n=F(),pn=F();function mn(e,t,i=F()){return i.x=e.width>0?2*t.x/e.width-1:0,i.y=e.height>0?-(2*t.y/e.height-1):0,i}function fn(e,t,i,r=F()){let s=function(e,t,i){let r=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15];if(r<=We)return null;let s=(e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12])/r,n=(e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13])/r,o=(e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14])/r;return null!=i||(i=_e()),i.x=s,i.y=n,i.z=o,i}(e,t,Tn);return s?(r.x=(s.x+1)/2*i.width,r.y=(1-s.y)/2*i.height,r):null}function gn(e,t,i,r=F()){return function(e,t,i,r,s=F()){let n=bn;return W(r,t,n),n.z=r.z,fn(e,n,i,s)}(Di(e),i,e.screenSize,t,r)}function vn(e,t,i,r=F()){return H(t,wn),gn(e,wn,i,r)}function yn(e,t,i=F()){return gn(e,t,e.center,i)}function xn(e,t,i=F()){return fn(Di(e),t,e.screenSize,i)}De(),_e(),_e();var bn=_e(),Tn=_e(),wn=_e();function Cn(e){let t=.5*e.width,i=.5*e.height;return J(-t,+t,-i,+i)}var Pn=class e{constructor(e,t,i){this._array=e,this._step=i,this._pos=t}get(e=0){return this._array[this._pos+e*this._step]}advance(e=1){return this._pos+=e*this._step,this}distanceTo(e){return Ss(e._array===this._array,"Must not compare iterators over different arrays"),(e._pos-this._pos)/this._step}clone(){return new e(this._array,this._pos,this._step)}};function Sn(e){return new Pn(e,0,1)}function Mn(e){return new Pn(e,e.length-1,-1)}function Rn(e,t){return 0===e.distanceTo(t)}function In(e){return W(e.get(1),e.get(0))}function Ln(e,t,i){let r=e.clone().advance(-2),s=i,n=s.segmentLength-s.offsetOnSegment;if(Rn(s.vertexIt,r)||t<n)s.offsetOnSegment+=t;else{for(t-=n,s.vertexIt.advance();s.segmentLength=Z(In(s.vertexIt)),!(Rn(s.vertexIt,r)||t<s.segmentLength);)t-=s.segmentLength,s.vertexIt.advance();s.offsetOnSegment=t}}function En(e,t){if(e<t+2)throw new Error(`verticesNum < segmentIndex + 2; verticesNum: ${e}, segmentIndex: ${t}`);return e-t-2}var An=class e{constructor(e,t,i,r){this._polyline=e,this._position=t,this._point=i,this._segmentDirection=r}segmentIndex(){return Sn(this._polyline).distanceTo(this._position.vertexIt)}point(){return this._point}segmentDirection(){return this._segmentDirection}forward(e){let t=this._position.vertexIt.clone();e>=0?Ln(function(e){return Sn(e).advance(e.length)}(this._polyline),e,this._position):this._backward(-e),Rn(t,this._position.vertexIt)||(this._segmentDirection=q(In(this._position.vertexIt),this._position.segmentLength)),Ss(0!==this._position.segmentLength,"PolylineSlider is broken");let i=Y(this._segmentDirection,this._position.offsetOnSegment);this._point=G(this._position.vertexIt.get(),i)}forwardCopy(e){let t=this.clone();return t.forward(e),t}_backward(e){let t={vertexIt:Mn(this._polyline).advance(En(this._polyline.length,this.segmentIndex())),segmentLength:this._position.segmentLength,offsetOnSegment:this._position.segmentLength-this._position.offsetOnSegment},i=t.vertexIt.clone();Ln(function(e){return Mn(e).advance(e.length)}(this._polyline),e,t);let r=t;Rn(i,r.vertexIt)||(this._position.vertexIt=Sn(this._polyline).advance(En(this._polyline.length,Mn(this._polyline).distanceTo(r.vertexIt))),this._position.segmentLength=r.segmentLength),this._position.offsetOnSegment=this._position.segmentLength-r.offsetOnSegment}clone(){return new e(this._polyline,function(e){return{vertexIt:e.vertexIt.clone(),segmentLength:e.segmentLength,offsetOnSegment:e.offsetOnSegment}}(this._position),H(this._point),H(this._segmentDirection))}},Un=class extends An{constructor(e){if(e.length<2)throw new Error("Polyline must contain at least two points");let t=W(e[1],e[0]),i={vertexIt:Sn(e),segmentLength:Z(t),offsetOnSegment:0},r=q(t,i.segmentLength),s=G(i.vertexIt.get(),Y(r,i.offsetOnSegment));super(e,i,s,r)}};function On(e,t,i=F()){let r=e[0]*t.x+e[2]*t.y,s=e[1]*t.x+e[3]*t.y;return i.x=r,i.y=s,i}function Vn(e,t,i){let r=t>=0?e.segmentDirection():function(e,t=B(0,0)){return t.x=-e.x,t.y=-e.y,t}(e.segmentDirection(),Fn),s=e.forwardCopy(t);return e.segmentIndex()!==s.segmentIndex()&&(r=W(s.point(),e.point(),Fn),function(e,t=B(0,0)){q(e,Z(e),t)}(r,r)),i[0]=r.x,i[1]=r.y,i[2]=-r.y,i[3]=r.x,i}function Dn(e){return!te(e.rect)}var zn=class{constructor(e,t,i){this._boxes=[],this._projectedGlyphs=[],this._polylineSlider=e,this._screenSize=t,this._perspectiveScale=i}bboxes(){return this._boxes}projectedGlyphs(){return this._projectedGlyphs}addOffset(e){this._polylineSlider.forward(e*this._perspectiveScale)}addText(e){let t=e.textLength*this._perspectiveScale,i=this._polylineSlider.forwardCopy(t);this._polylineSlider.point().x>i.point().x?this._placeTextAlongPolyline(e.glyphs,i,1):this._placeTextAlongPolyline(e.glyphs,this._polylineSlider.clone(),0),this._polylineSlider.forward(t)}_placeTextAlongPolyline(e,t,i){let r=!0;for(let s=0;s<e.length;++s){let n=e[s],o=n.advance*this._perspectiveScale;if(1===i&&(o=-o),Dn(n)){let e=Vn(t,o,Bn),i=t.point(),s=ee(),a=[];for(let t of le(n.rect))Y(t,this._perspectiveScale,t),On(e,t,t),G(i,t,t),mn(this._screenSize,t,t),oe(s,t,s),a.push(t);r?dn(s)&&(this._boxes.push(s),this._projectedGlyphs.push(Nn(a,n)),r=!1):(ae(it(this._boxes),s,it(this._boxes)),this._projectedGlyphs.push(Nn(a,n)),r=!0)}t.forward(o)}}},Bn=new Array(4),Fn=F();function Nn(e,t){return{ndcCorners:e,textColor:t.color,outlineColor:t.outlineColor,uv:t.uv,height:Math.abs(t.rect.maxY-t.rect.minY),textOutlineWidth:t.outlineWidth,glyphToTexRatio:t.glyphToTexRatio}}function kn(e){let t=0;for(let i=1;i<e.length;i++)t+=$(e[i],e[i-1]);return t}function Hn(e,t){if(!Gn)return 1;let i=Di(e),r=i[3]*t.x+i[7]*t.y+i[11]*t.z+i[15];return r>0?zi(e)/r:0}var jn=_e(),Gn=!1;function Wn(e,t,i,r,s,n,o){let a=i.map((e=>W(e.lookAt,r))),l=[];for(let r of function(e){let t=[];for(let i=0;i<e.length;++i){let r=e[i];for(let e of r[110])(e.icon||e.label)&&t.push({priorities:e.priorities,sceneIndex:i,data:{type:0,object:e},id:e.id,logicalId:e.logicalId});for(let e of r[7].visiblePrimitives){let r=e.conflictResolvingInfos;for(let e of r)t.push({priorities:e.priorities,sceneIndex:i,data:{type:1,object:e.renderState},id:e.renderState.id,logicalId:e.renderState.logicalId})}}return t.sort(Zn)}(t)){let t=Yn(o,r);for(let o=0;o<a.length;++o){if(s.prepareNextScreenObject(t,i[o].lookAt),e.displaced(r,n))continue;let d=qn(r,s,a[o]);d&&l.push(d),t=s.activePointLabelCandidateIndex}}return l}function Yn(e,{data:t,logicalId:i}){let r=e.activePointLabelCandidateFor(i);if(!(void 0!==r&&0===t.type&&t.object.label&&t.object.label.candidates.length<=r))return r;e.resetActivePointLabelCandidateFor(i)}function qn(e,t,i){let{sceneIndex:r}=e;switch(e.data.type){case 0:return function({icon:e,label:t,id:i,legacyCollidingId:r,logicalId:s},n,o,a){let l=e&&n.isIconVisible(e),d=t&&n.isPointLabelVisible(t);if(!l&&!d)return null;let h=n.activePointLabelCandidateIndex;return{iconIsVisible:l,activePointLabelCandidateIndex:d?h:void 0,iconRenderState:e,pointLabelRenderState:t,id:i,legacyCollidingId:r,logicalId:s,sceneIndex:a,cameraSpacePosition:o}}(e.data.object,t,i,r);case 1:return function(e,t,i,r){if(t.polylineLabelWasDisplaced)return null;let s=t.acquirePolylineLabelSnapshot(e),n=s&&tt(s.projectedGlyphs());return n?{id:e.id,legacyCollidingId:e.legacyCollidingId,logicalId:e.logicalId,polylineLabelRenderState:e,polylineLabelProjectedGlyphs:n,sceneIndex:r,cameraSpacePosition:i}:null}(e.data.object,t,i,r)}}function Xn(e,t,i,r){for(let s of t[7].visiblePrimitives){let t=s.conflictResolvingInfos;for(let s of t){let t=to(e,s.renderState,e.center);if(!t)continue;let n=t.bboxes(),o=t.projectedGlyphs();et(n)&&et(o)&&r.push(Qn(s,n,o,s.renderState,i))}}}function Zn(e,t){return function(e,t){return e.providerPriority-t.providerPriority||e.layerPriority-t.layerPriority||e.priority-t.priority}(t.priorities,e.priorities)}function $n(e,t,i){return{id:e.renderState.id,legacyCollidingId:e.renderState.legacyCollidingId,logicalId:e.renderState.logicalId,label:t,sceneIndex:i,priorities:e.priorities,cameraSpacePosition:k}}function Qn(e,t,i,r,s){return{id:e.renderState.id,legacyCollidingId:e.renderState.legacyCollidingId,logicalId:e.renderState.logicalId,label:t,polylineLabelProjectedGlyphs:i,polylineLabelRenderState:r,sceneIndex:s,priorities:e.priorities,cameraSpacePosition:k}}function Kn(e,t,i,r){return{id:e.renderState.id,legacyCollidingId:e.renderState.legacyCollidingId,logicalId:e.renderState.logicalId,icon:t,label:i,sceneIndex:r,priorities:e.priorities,cameraSpacePosition:k}}function Jn(e,t,i){let r=ve(t.worldPos,oo);W(r,i,r);let s=xn(e,r,no);if(!s)return;let n=Hn(e,r);if(n<=0)return;W(s,Y(t.screenSpaceIconOffset,n,ao),s);let o=Cn(t.screenSpaceSize);return function(e,t,i={minX:0,maxX:0,minY:0,maxY:0}){i.minX=t.minX-e,i.minY=t.minY-e,i.maxX=t.maxX+e,i.maxY=t.maxY+e}(t.collidingBuffer,o,o),re(o,n,o),so(o,s,e.screenSize,o),dn(o)?o:void 0}function eo(e,t,i,r){let s=ve(t.worldPos,oo);W(s,r,s);let n=xn(e,s,no);if(!n)return[];let o=Hn(e,s);if(o<=0)return[];let a=[],{text:l}=t.candidates[i];for(let{lines:t}of l)for(let{screenSpaceBBox:i}of t){let t=re(i,o);so(t,n,e.screenSize,t),dn(t)&&a.push(t)}return a}function to(e,t,i,r=!1){if(t.polyline.length<2)return;let s=ro(t.polyline,.5*kn(t.polyline)),n=W(s,i,oo),o=function(e,t){return H(t,jn),Hn(e,jn)}(e,n);if(o<=0||!function(e,t,i=F()){return H(t,bn),fn(Di(e),bn,e.screenSize,i)}(e,n,s))return;let a=function(e,t,i){let r=[];for(let s of t){let t=vn(e,s,i);if(!t)return null;let n=it(r);(!n||!j(n,t))&&r.push(t)}return r.length<2?null:r}(e,t.polyline,i);if(!a)return;let l=kn(a),d=t.measuredLabel.textLength*o;if(!r&&d>l*io)return;let h=.5*(l-d);ro(a,h).x>ro(a,h+d).x&&function(e,t=0,i=e.length){for(let r=t,s=i-1;r<s;++r,--s)rt(e,r,s)}(a);let c=new Un(a);c.forward(h);let u=new zn(c,e.screenSize,o);return u.addText(t.measuredLabel.text),t.measuredLabel.altText&&(u.addOffset(t.measuredLabel.textOffset),u.addText(t.measuredLabel.altText)),u}var io=1.6;function ro(e,t){let i=new Un(e);return i.forward(t),i.point()}function so(e,t,i,r=ee()){return function(e,t,i=J(0,0,0,0)){i.minX=e.minX+t.x,i.maxX=e.maxX+t.x,i.minY=e.minY+t.y,i.maxY=e.maxY+t.y}(e,t,r),lo.x=r.minX,lo.y=r.maxY,ho.x=r.maxX,ho.y=r.minY,mn(i,lo,lo),mn(i,ho,ho),r.maxX=ho.x,r.maxY=ho.y,r.minX=lo.x,r.minY=lo.y,r}var no=F(),oo=_e(),ao=_e(),lo=F(),ho=F();var co=0;var uo=$e([[0,{size:2,type:5126,normalized:!1}]]),_o=($e([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:4,type:5122,normalized:!1}],[11,{size:2,type:5122,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[10,{size:4,type:5121,normalized:!1}],[2,{size:4,type:5121,normalized:!1}],[15,{size:4,type:5121,normalized:!1}],[12,{size:2,type:5123,normalized:!0}],[13,{size:1,type:5126,normalized:!1}]]),$e([[9,{size:1,type:5126,normalized:!1}]]),$e([[0,{size:3,type:5126,normalized:!1}],[6,{size:2,type:5126,normalized:!1}],[11,{size:2,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[2,{size:4,type:5121,normalized:!1}],[12,{size:2,type:5123,normalized:!0}],[13,{size:1,type:5126,normalized:!1}],[14,{size:1,type:5126,normalized:!1}]])),po=$e([[0,{size:3,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[2,{size:4,type:5121,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[8,{size:4,type:5121,normalized:!0}],[3,{size:1,type:5126,normalized:!1}],[11,{size:1,type:5126,normalized:!1}],[12,{size:1,type:5126,normalized:!1}],[13,{size:3,type:5126,normalized:!1}],[14,{size:4,type:5126,normalized:!1}]]),mo=$e([[0,{size:2,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[2,{size:4,type:5121,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[8,{size:4,type:5121,normalized:!0}],[3,{size:1,type:5126,normalized:!1}],[11,{size:3,type:5126,normalized:!1}],[12,{size:3,type:5126,normalized:!1}]]),fo=$e([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[3,{size:1,type:5126,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[2,{size:4,type:5121,normalized:!1}]]),go=$e([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[2,{size:4,type:5121,normalized:!1}],[10,{size:1,type:5126,normalized:!1}]]),vo={0:$e([[2,{size:4,type:5121,normalized:!0}],[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[5,{size:2,type:5122,normalized:!0}],[6,{size:4,type:5122,normalized:!0}],[10,{size:1,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!0}],[12,{size:4,type:5123,normalized:!1}],[13,{size:1,type:5126,normalized:!1}],[14,{size:2,type:5122,normalized:!0}],[15,{size:2,type:5126,normalized:!1}]]),1:go,2:fo,3:_o,4:po,5:mo,6:uo},yo=class{constructor(e,t,i){this.length=i,this._start=t,this._base=e}at(e){return this._base[e+this._start]}*[Symbol.iterator](){for(let e=0;e<this.length;++e)yield this.at(e)}},xo=class{constructor(){this._meshBuffers=[]}createMeshes(e,t,i){if(0===e.length)return[];let r=[],s=0,n=0,o=[];for(let a of e){let e=0;for(let l=0;l<a.length;++l){let d=a[l];t.computeMeshSizes(d,bo);let h=bo.vertexCount,c=bo.indexCount;To(s+h)?(s+=h,n+=c):(l>e&&o.push(new yo(a,e,l-e)),wo(o,s,n,t,i,this._meshBuffers,r),o.length=0,s=h,n=c,e=l)}a.length>e&&o.push(new yo(a,e,a.length-e))}return wo(o,s,n,t,i,this._meshBuffers,r),r}finish(){return this._meshBuffers}},bo={vertexCount:0,indexCount:0};function To(e){return e<=p(2,16)}function wo(e,t,i,r,s,n,o){if(0===e.length||0===t||0===i)return;if(!To(t))throw new Error("Mesh is too big to write its vertices");let a=new Po(t,i,r.attributeMappingType(),5123),l=[];for(let t of e)l.push(Co(t,a,r));a.checkCompletelyFilled();for(let t=0;t<e.length;++t)o.push(s(l[t],e[t]));n.push(a.storage.vertices,a.storage.indices)}function Co(e,t,i){let r=t.writtenVertexBytes(),s=t.writtenIndexBytes();for(let r of e)t.prepareNextElement(),i.write(r,t);let n=t.writtenVertexBytes()-r;return{indexByteOffset:s,indexByteSize:t.writtenIndexBytes()-s,vertexByteSize:n,sharedStorage:t.storage}}var Po=class{constructor(e,t,i,r){this._nextFreeIndexPos=0,this._nextFreeVertexFieldPos=0,this._indexOffset=0;let s=vo[i];this._vertexByteStride=s.vertexByteSize;let n=So[r];this.storage={attributeMappingType:i,indexType:r,vertices:new ArrayBuffer(e*this._vertexByteStride),indices:new ArrayBuffer(t*n.BYTES_PER_ELEMENT)},this._uint32VertexView=new Uint32Array(this.storage.vertices),this._float32VertexView=new Float32Array(this.storage.vertices),this._indicesView=new n(this.storage.indices)}prepareNextElement(){this._indexOffset=this.writtenVertexBytes()/this._vertexByteStride}writeIndices(e){for(let t of e)this._indicesView[this._nextFreeIndexPos++]=this._indexOffset+t}writeVertexUint32(e){this._uint32VertexView[this._nextFreeVertexFieldPos++]=e}writeVertexFloat32(e){this._float32VertexView[this._nextFreeVertexFieldPos++]=e}writtenVertexBytes(){return this._nextFreeVertexFieldPos*Mo}writtenIndexBytes(){return this._nextFreeIndexPos*this._indicesView.BYTES_PER_ELEMENT}checkCompletelyFilled(){if(this._nextFreeIndexPos!==this._indicesView.length)throw new Error(`An index buffer is not completely filled, expected "${this._indicesView.length}", but got "${this._nextFreeIndexPos}"`);if(this._nextFreeVertexFieldPos!==this._uint32VertexView.length)throw new Error(`A vertex buffer is not completely filled, expected "${this._uint32VertexView.length}", but got "${this._nextFreeVertexFieldPos}"`)}},So={5123:Uint16Array,5125:Uint32Array},Mo=Uint32Array.BYTES_PER_ELEMENT;function Ro(e,t,i,r,s,n,{minBrightness:o,maxBrightness:a},l,d){e.writeVertexFloat32(i.x),e.writeVertexFloat32(i.y),e.writeVertexFloat32(i.z),e.writeVertexFloat32(s.x),e.writeVertexFloat32(s.y),e.writeVertexFloat32(r.x),e.writeVertexFloat32(r.y),e.writeVertexUint32(is(n.x,n.y)),e.writeVertexUint32(t),e.writeVertexUint32(is(Qe(o),Qe(a))),e.writeVertexFloat32(l),e.writeVertexFloat32(d)}var Io=_e(),Lo=F(),Eo=F(),Ao=class extends as{constructor(e,t,i,r,s){super(),this._destructor=()=>{var e;this.onReleased.removeListener(this._destructor),this.vertexBuffer.destroy(),null==(e=this.indexBuffer)||e.destroy(),this.vao.destroy()},this._context=e,this.layout=t,this.vertexBuffer=this._context.createVertexBuffer(r.byteLength,i),this.indexBuffer=s&&this._context.createIndexBuffer(s.byteLength,i);let n=[{attributeMapping:t,buffer:this.vertexBuffer}];this.vao=this._context.createVao(n,this.indexBuffer),this.onReleased.addListener(this._destructor),this.updateVertexContent(r,0),s&&this.updateIndexContent(s,0)}get context(){return this._context}updateVertexContent(e,t){this._context.bindVao(null),this._context.uploadDataToBuffer(this.vertexBuffer,e,t)}updateIndexContent(e,t){if(!this.indexBuffer)throw Error("Tried to update indices without index buffer");this._context.bindVao(null),this._context.uploadDataToBuffer(this.indexBuffer,e,t)}},Uo=class{constructor(e){this._storages=new Map,this._context=e}createMesh(e,t=35044){let i=this._storages.get(e.sharedStorage);return i||(i=new Ao(this._context,vo[e.sharedStorage.attributeMappingType],t,e.sharedStorage.vertices,e.sharedStorage.indices),this._storages.set(e.sharedStorage,i)),new class{get vao(){return this._sharedStorage.vao}constructor(e,t){this._sharedStorage=e,this.indexByteOffset=t.indexByteOffset,this.indexByteSize=t.indexByteSize,this.vertexByteSize=t.vertexByteSize,this.indexType=t.sharedStorage.indexType}draw(){this._sharedStorage.context.bindVao(this.vao),this._sharedStorage.context.drawIndexedMesh(this.indexByteOffset,Ds(this.indexByteSize,this.indexType),4,this.indexType)}retain(){this._sharedStorage.retain()}release(){this._sharedStorage.release()}}(i,e)}};function Oo(e,t){let i=[];for(let[r,s]of e)t.has(r)||i.push(s);return i}function Vo(e,t,i){let r=e.get(t);return r||(r=i(),e.set(t,r)),r}function Do(e,t){return Vo(e,t,Bo)}function zo(e,t){return Vo(e,t,Fo)}function Bo(){return[]}function Fo(){return new Map}function No(e,t,i,r,s,n,o,a,l,d){for(let{uv:h,bbox:c}of e){let e=d,u=c.maxY-c.minY,_=N(h.maxX-h.minX,h.maxY-h.minY,Ko),p=N(c.minX,-c.maxY,qo),m=N(c.minX,-c.minY,Xo),f=N(c.maxX,-c.minY,Zo),g=N(c.maxX,-c.maxY,$o),v=X(m,g,.5,Qo);ko(o,t.id,i,N(h.minX,h.maxY,Yo),r,s,u,n,l,e,W(p,v,Wo),_,v),ko(o,t.id,i,N(h.minX,h.minY,Yo),r,s,u,n,l,e,W(m,v,Wo),_,v),ko(o,t.id,i,N(h.maxX,h.minY,Yo),r,s,u,n,l,e,W(f,v,Wo),_,v),ko(o,t.id,i,N(h.maxX,h.maxY,Yo),r,s,u,n,l,e,W(g,v,Wo),_,v),o.writeIndices([0+a,1+a,2+a,0+a,2+a,3+a]),a+=Ho}return a}function ko(e,t,i,r,s,n,o,a,l,d,h,c,u){e.writeVertexFloat32(i.x),e.writeVertexFloat32(i.y),e.writeVertexFloat32(i.z),e.writeVertexUint32(is(r.x,r.y)),e.writeVertexUint32(t),e.writeVertexUint32(s),e.writeVertexUint32(n),e.writeVertexFloat32(o),e.writeVertexFloat32(a),e.writeVertexFloat32(l),e.writeVertexFloat32(d),e.writeVertexFloat32(c.x),e.writeVertexFloat32(c.y),e.writeVertexFloat32(h.x),e.writeVertexFloat32(h.y),e.writeVertexFloat32(u.x),e.writeVertexFloat32(u.y)}var Ho=4,jo=6,Go=_e(),Wo=F(),Yo=F(),qo=F(),Xo=F(),Zo=F(),$o=F(),Qo=F(),Ko=F(),Jo=class{constructor(e,t){this.mesh=e,this.texture=t}retain(){this.mesh.retain()}release(){this.mesh.release()}};function ea(e,t,i,r,s,n,o,a,l,d,h){e.writeVertexFloat32(i.x),e.writeVertexFloat32(i.y),e.writeVertexUint32(is(r.x,r.y)),e.writeVertexUint32(t),e.writeVertexUint32(s),e.writeVertexUint32(n),e.writeVertexFloat32(o),e.writeVertexFloat32(a),e.writeVertexFloat32(l.x),e.writeVertexFloat32(l.y),e.writeVertexFloat32(d.x),e.writeVertexFloat32(d.y),e.writeVertexFloat32(h)}var ta=F(),ia=F(),ra=4,sa=6,na=F(),oa=F();function aa(e,t){return!!e&&e.some(t)}function la(e,t,i,r){let s=t.activePointLabelCandidateIndex;if(!aa(t.acquirePointLabelBBoxes(e,s),i))return!0;if(!r)return!1;for(let r=0;r<e.candidates.length;++r){if(s===r)continue;if(!aa(t.acquirePointLabelBBoxes(e,r),i))return t.activePointLabelCandidateIndex=r,!0}return!1}var da=class{constructor(){this._fadeInAnimations=new Map,this._fadeOutAnimations=new Map}updateProgress(e){for(let[t,i]of this._fadeInAnimations){let r=Math.min(i+e,1);this._fadeInAnimations.set(t,r)}let t=[];for(let[i,r]of this._fadeOutAnimations){let s=Math.max(r-e,0);s>0?this._fadeOutAnimations.set(i,s):t.push(i)}for(let e of t)this._fadeOutAnimations.delete(e)}hasAnimationsInProgress(){if(this._fadeOutAnimations.size>0)return!0;for(let e of this._fadeInAnimations.values())if(e<1)return!0;return!1}hasVisibleElements(){return this._fadeInAnimations.size>0||this._fadeOutAnimations.size>0}progressOf(e){var t,i;return null!=(i=null!=(t=this._fadeInAnimations.get(e))?t:this._fadeOutAnimations.get(e))?i:0}setVisible(e,t){t?this._runFadeIn(e):this._runFadeOut(e)}collectProgresses(){let e=[];for(let[t,i]of this._fadeInAnimations)e.push({index:t,progress:i});for(let[t,i]of this._fadeOutAnimations)e.push({index:t,progress:i});return e}_runFadeIn(e){if(this._fadeInAnimations.has(e))return;let t=this._fadeOutAnimations.get(e);this._fadeInAnimations.set(e,null!=t?t:0),void 0!==t&&this._fadeOutAnimations.delete(e)}_runFadeOut(e){if(this._fadeOutAnimations.has(e))return;let t=this._fadeInAnimations.get(e);void 0!==t&&(this._fadeInAnimations.delete(e),t>0&&this._fadeOutAnimations.set(e,t))}},ha=class{constructor(){this._animations=new Map,this._activeCandidates=new Map}updateProgress(e){let t=[];for(let[i,r]of this._animations)r.updateProgress(e),r.hasVisibleElements()||t.push(i);for(let e of t)this._animations.delete(e)}hideAll(){for(let[e]of this._activeCandidates)this._hideActiveCandidateFor(e)}isVisible(e){var t,i;return null!=(i=null==(t=this._animations.get(e))?void 0:t.hasVisibleElements())&&i}candidateIndices(e){let t=this._animations.get(e);return t?t.collectProgresses():[]}hasAnimationsInProgress(){for(let e of this._animations.values())if(e.hasAnimationsInProgress())return!0;return!1}setActiveCandidateFor(e,t){if(void 0===t)return void this._hideActiveCandidateFor(e);let i=Vo(this._animations,e,ca),r=this._activeCandidates.get(e);void 0!==r&&i.setVisible(r,!1),this._activeCandidates.set(e,t),i.setVisible(t,!0)}activeCandidateFor(e){return this._activeCandidates.get(e)}_hideActiveCandidateFor(e){let t=this._activeCandidates.get(e);void 0!==t&&(this._activeCandidates.delete(e),this._animations.get(e).setVisible(t,!1))}};function ca(){return new da}var ua=256,_a=new Set,pa=0,ma=255;function fa(e){return void 0!==e.iconRenderState}function ga(e){return void 0!==e.pointLabelRenderState}function va(e){return void 0!==e.polylineLabelRenderState&&void 0!==e.polylineLabelProjectedGlyphs}function ya(e){let t=[];for(let i of e.values())for(let e of i.values())t.push(e);return t}function xa(e){return!e.icon&&!e.label}function ba(e,t){if(e.polylineLabelRenderState){let i=G(e.cameraSpacePosition,t.center,wa),r=to(t,e.polylineLabelRenderState,i,!0);e.polylineLabelProjectedGlyphs=r&&tt(r.projectedGlyphs())}}var Ta=F(),wa=F(),Ca=new D(O),Pa={attribMap:{vPos:0}},Sa=class extends ft{constructor(e){let t=e.createProgram("#version 100\nattribute vec2 vPos;void main(){gl_Position=vec4(vPos,0.0,1.0);}","#version 100\nvoid main(){gl_FragColor=vec4(0.3,0.0,0.0,0.3);}",Pa);super(e,Ca,t)}_render(e){let t=new Uo(this._context);for(let i of e){let e=t.createMesh(i,35040);e.retain(),e.vao.bind(),this._context.drawIndexedMesh(e.indexByteOffset,Ds(e.indexByteSize,e.indexType),4,e.indexType),e.release()}}};function Ma(e){return e}var Ra=class{constructor(e,t,i,r,s=!1){this._onUpdate=()=>{this.renderLoop.update()},this._onRender=()=>{var e,t;null!=(e=this.cpuVisibilityManager)&&e.isActive?this.cpuVisibilityManager.updateVisibilityIfNeeded():this.visibilityManager.updateVisibilityIfNeeded(),this.renderer.render(this._renderTarget),null!=(t=this.cpuVisibilityManager)&&t.isActive&&this._debugNdcBBoxRenderer&&this._debugNdcBBoxRenderer.render(this._renderTarget,this.cpuVisibilityManager.debugBBoxes()),this._hitTestManager.setDirty()},this._onContextLost=()=>{this._onInternalError.fire({source:"Engine",message:"WebGL context is lost"})},this.camera=t,this.context=e,this._renderTarget=e.getDefaultRenderTarget(),this.renderer=new qr(e,t),this.renderLoop=i,this._hitTestManager=new class{constructor(e,t,i){this._context=e,this._renderer=t,this._renderLoop=i,this._tileCache=new Map,this._isDirty=!0,this._allocateResources(),this._lastRenderTime=0}destroy(){this._deleteResources()}updateSize(){this._deleteResources(),this._allocateResources(),this.setDirty()}setDirty(){this._isDirty||(this._isDirty=!0,this._tileCache.clear())}getIdAt(e){this._isDirty&&(!this._lastRenderTime||Tr()-this._lastRenderTime>100)&&(this._lastRenderTime=Tr(),this._renderer.renderHitTestBuffer(this._framebuffer),this._renderLoop.update(),this._tileCache.clear(),this._isDirty=!1);let t=this._context,i=this._framebuffer,r=t.getDefaultRenderTarget().size,s=e.x/r.width,n=1-e.y/r.height,o=s*i.size.width|0,a=n*i.size.height|0,l=B(Math.floor(o/Fr)*Fr,Math.floor(a/Fr)*Fr),d=l.x<<16|l.y,h=this._tileCache.get(d);return h||(t.bindRenderTarget(i),h=new Uint32Array(i.readPixels(Nr,l).buffer),this._renderLoop.update(),this._tileCache.set(d,h)),h[Fr*(a-l.y)+(o-l.x)]}_deleteResources(){this._framebuffer.destroy(),this._colorBuffer.destroy(),this._depthBuffer.destroy()}_allocateResources(){let e=this._context,{width:t,height:i}=e.getDefaultRenderTarget().size,r=kr(t),s=kr(i);this._colorBuffer=e.createEmpty2DTexture(r,s,6408,5121),this._depthBuffer=e.createRenderbuffer(r,s,34041),this._framebuffer=e.createFramebuffer({color:this._colorBuffer,depthStencil:this._depthBuffer})}}(e,this.renderer,i),this._isOwnVisibilityManager=!r,this.visibilityManager=r||new zr(e,t,i,e.getDefaultRenderTarget().size),s&&(this.cpuVisibilityManager=new class{constructor(e,t,i,r=150){this._onSceneUpdate=()=>{this._lastSceneUpdateTime=Tr(),this._renderLoop.update()},this._onBeforeRender=()=>{this._isDirty=!0;for(let e of this._scenes)e[120].clear(),e[121].clear(),e[122].clear()},this._isActive=!0,this._enableExperimentalMode=!1,this._scenes=[],this._fadeOutScreenObjects=[],this._screenObjectVisibilityController=new class{constructor(){this._iconVisibility=new da,this._polylineLabelVisibility=new da,this._candidateVisibility=new ha}setVisible(e,t){let{logicalId:i}=e;if(e.iconRenderState&&this._iconVisibility.setVisible(i,t&&!!e.iconIsVisible),e.pointLabelRenderState){let r=t?e.activePointLabelCandidateIndex:void 0;this._candidateVisibility.setActiveCandidateFor(i,r)}e.polylineLabelRenderState&&this._polylineLabelVisibility.setVisible(i,t&&!!e.polylineLabelProjectedGlyphs)}isVisible(e){return!!(this.iconVisibility(e)||this._candidateVisibility.isVisible(e)||this.polylineLabelVisibility(e))}iconVisibility(e){return this._iconVisibility.progressOf(e)}pointLabelCandidateVisibilities(e){return this._candidateVisibility.candidateIndices(e)}hasVisiblePointLabelCandidate(e){return this._candidateVisibility.isVisible(e)}polylineLabelVisibility(e){return this._polylineLabelVisibility.progressOf(e)}activePointLabelCandidateFor(e){return this._candidateVisibility.activeCandidateFor(e)}resetActivePointLabelCandidateFor(e){this._candidateVisibility.setActiveCandidateFor(e,void 0)}resetActivePointLabelCandidates(){this._candidateVisibility.hideAll()}updateProgress(e){this._iconVisibility.updateProgress(e),this._candidateVisibility.updateProgress(e),this._polylineLabelVisibility.updateProgress(e)}hasAnimationsInProgress(){return this._iconVisibility.hasAnimationsInProgress()||this._candidateVisibility.hasAnimationsInProgress()||this._polylineLabelVisibility.hasAnimationsInProgress()}},this.fadeEffectDuration=r,this._context=e,this._camera=t,this._screenObjectController=new class{constructor(e){this._iconBBoxCache=null,this._pointLabelBBoxesCache=null,this._polylineLabelSnapshot=null,this._selectedLabelCandidateIndex=co,this._camera=e}prepareNextScreenObject(e,t){this.iconWasDisplaced=!1,this.pointLabelWasDisplaced=!1,this.polylineLabelWasDisplaced=!1,this._iconBBoxCache=null,this._pointLabelBBoxesCache=null,this._polylineLabelSnapshot=null,this.activePointLabelCandidateIndex=null!=e?e:co,this._selectedLabelCandidateIndex=co,this._cameraPosition=t}selectedLabelCandidateIndex(){return this._selectedLabelCandidateIndex}acquireIconBBox(e){return null===this._iconBBoxCache&&(this._iconBBoxCache=Jn(this._camera,e,this._cameraPosition)),this._iconBBoxCache}acquirePointLabelBBoxes(e,t){return(null===this._pointLabelBBoxesCache||t!==this._selectedLabelCandidateIndex)&&(this._pointLabelBBoxesCache=tt(eo(this._camera,e,t,this._cameraPosition)),this._selectedLabelCandidateIndex=t),this._pointLabelBBoxesCache}acquirePolylineLabelSnapshot(e){return null===this._polylineLabelSnapshot&&(this._polylineLabelSnapshot=to(this._camera,e,this._cameraPosition)),this._polylineLabelSnapshot}isIconVisible(e){return!this.iconWasDisplaced&&void 0!==this.acquireIconBBox(e)}isPointLabelVisible(e){let t=this.activePointLabelCandidateIndex;return!this.pointLabelWasDisplaced&&void 0!==this.acquirePointLabelBBoxes(e,t)}}(t),this._legacyScreenObjectDelegates=new class{intersects(e,t){if(e.icon){let i=t(e.icon);return i||!e.label?i:e.label.some(t)}return!!e.label&&e.label.some(t)}insert(e,t){e.icon&&t(e.icon),e.label&&e.label.forEach(t)}modeProvider(e){return 1}},this._screenObjectDelegates=new class{constructor(e){this.enableTextOptional=!1,this.enableCandidates=!1,this._controller=e}intersects(e,t){switch(e.data.type){case 0:{let{icon:i,label:r}=e.data.object,{enableCandidates:s}=this;if(i&&i.ignoreConflicts){if(r){let e=!la(r,this._controller,t,s);this._controller.pointLabelWasDisplaced=e}return!1}if(i){let n=this._controller.acquireIconBBox(i),o=!!n&&t(n);if(o||!r)return this._controller.iconWasDisplaced=o,this._controller.pointLabelWasDisplaced=o,o;let a=!la(r,this._controller,t,s),l=a&&!(this.enableTextOptional&&e.data.object.textOptional);return this._controller.iconWasDisplaced=l,this._controller.pointLabelWasDisplaced=a,l}if(r){let e=!la(r,this._controller,t,s);return this._controller.pointLabelWasDisplaced=e,e}return!1}case 1:{let i=this._controller.acquirePolylineLabelSnapshot(e.data.object),r=!!i&&i.bboxes().some(t);return this._controller.polylineLabelWasDisplaced=r,r}}}insert(e,t){switch(e.data.type){case 0:{let{icon:i,label:r}=e.data.object;if(i&&!i.ignoreConflicts&&this._controller.isIconVisible(i)){let e=this._controller.acquireIconBBox(i);e&&t(e)}if(r&&this._controller.isPointLabelVisible(r)){let e=this._controller.activePointLabelCandidateIndex,i=this._controller.acquirePointLabelBBoxes(r,e);i&&i.forEach(t)}break}case 1:if(!this._controller.polylineLabelWasDisplaced){let i=this._controller.acquirePolylineLabelSnapshot(e.data.object);i&&i.bboxes().forEach(t)}}}modeProvider(e){return 1}}(this._screenObjectController),this._noIntersectionDelegates=new class{intersects(e,t){return!1}insert(e,t){}modeProvider(e){return this._delegates.modeProvider(e)}setDelegates(e){this._delegates=e}},this._renderLoop=i,this._isEnabled=!0,this._lastRenderTimeInLoop=-1,this._lastSceneUpdateTime=Tr(),this._camera.onUpdate.addListener(this._onSceneUpdate),this._renderLoop.onBeforeRender.addListener(this._onBeforeRender),this._noCollidingVisibilityTexture=this._createPlainTexture(S(1,1,1,1));let s=65536*ys[6406];this._visibilityTexture=e.createEmpty2DTexture(ua,ua,6406,5121),this._visibilityBuffer=new Uint8ClampedArray(s),this._onVisibleScreenObjectsChange=new wt,this._visibleScreenObjectsIds=_a}get onVisibleScreenObjectsChange(){return this._onVisibleScreenObjectsChange}get visibleScreenObjectIds(){return this._visibleScreenObjectsIds}set enableDebug(e){this._screenObjectDelegatesWithBBoxesCollecting=e?new class{constructor(e){this._collectedBBoxes=[],this.ignoreConflicts=e}intersects(e,t){return!this.ignoreConflicts&&this._delegates.intersects(e,t)}insert(e,t){this._delegates.insert(e,(e=>{this._collectedBBoxes.push(ie(e)),t(e)}))}modeProvider(e){return this._delegates.modeProvider(e)}clear(){this._collectedBBoxes.length=0}collectedBBoxes(){return this._collectedBBoxes}setDelegates(e){this._delegates=e}}(!this._isEnabled):void 0,this._renderLoop.update()}get isActive(){return this._isActive}set isActive(e){this._isActive=e,this._renderLoop.update(),e||(this._visibleScreenObjectsIds=_a,this._onVisibleScreenObjectsChange.fire(this._visibleScreenObjectsIds))}get visibilityTexture(){return this._isEnabled?this._visibilityTexture:this._noCollidingVisibilityTexture}destroy(){for(this._noCollidingVisibilityTexture.destroy();this._scenes.length>0;)this.removeScene(this._scenes[0]);this.setMajorInvisiblePrimitiveProvider(void 0),this._renderLoop.onBeforeRender.removeListener(this._onBeforeRender),this._camera.onUpdate.removeListener(this._onSceneUpdate)}enableExperimentalMode(e){this._enableExperimentalMode=e,this._renderLoop.update()}experimentalModeEnabled(){return this._enableExperimentalMode}enableTextOptional(e){this._screenObjectDelegates.enableTextOptional=e,this._onSceneUpdate()}enableCandidates(e){this._screenObjectDelegates.enableCandidates=e,this._screenObjectVisibilityController.resetActivePointLabelCandidates(),this._onSceneUpdate()}setEnabled(e){this._isEnabled=e,this._renderLoop.update(),this._screenObjectDelegatesWithBBoxesCollecting&&(this._screenObjectDelegatesWithBBoxesCollecting.ignoreConflicts=!e)}updateVisibilityIfNeeded(){if(!(this._isEnabled||this._screenObjectDelegatesWithBBoxesCollecting||this._enableExperimentalMode)||!this._isDirty||0===this._scenes.length)return;this._isDirty=!1;let e,t,i=new class{constructor(){this._intersects=e=>this._gridIndex.intersects(e),this._insert=e=>this._gridIndex.insert(e),this._gridIndex=new class{constructor(){this._cells=new Array(hn*hn);for(let e=0;e<this._cells.length;++e)this._cells[e]=[]}insert(e){if(!se(e,ln))return;let t=un(e.minX,e.minY,_n),i=un(e.maxX,e.maxY,pn);e=ie(e);for(let r=t.y;r<=i.y;++r)for(let s=t.x;s<=i.x;++s){let t=r*hn+s;this._cells[t].push(e)}}intersects(e){if(!se(e,ln))return!1;let t=un(e.minX,e.minY,_n),i=un(e.maxX,e.maxY,pn);for(let r=t.y;r<=i.y;++r)for(let s=t.x;s<=i.x;++s){let t=r*hn+s;for(let i of this._cells[t])if(se(e,i))return!0}return!1}}}addMajor(e){this._gridIndex.insert(e)}displaced(e,t){switch(t.modeProvider(e)){case 0:return t.intersects(e,this._intersects);case 1:return!!t.intersects(e,this._intersects)||(t.insert(e,this._insert),!1);case 2:return t.insert(e,this._insert),!1;default:return!1}}};if(this._majorInvisiblePrimitiveProvider&&function(e,t,i){for(let r of t){let t=vn(i,r.anchor,i.center,Ta);t&&e.addMajor(so(r.rect,t,i.screenSize))}}(i,this._majorInvisiblePrimitiveProvider.primitives,this._camera),this._enableExperimentalMode){let r=fr(this._camera);e=Wn(i,this._scenes,r,this._camera.center,this._screenObjectController,this._acquireDelegates(this._screenObjectDelegates),this._screenObjectVisibilityController),t=new Set(e.map((e=>e.id)))}else e=function(e,t){let i=new Map,r=[];for(let s=0;s<t.length;++s){let n=t[s];for(let e of n[8].visiblePrimitives){let t=e.conflictResolvingInfo;i.set(t.renderState.id,{icon:e.conflictResolvingInfo,sceneIndex:s})}for(let t of n[6].visiblePrimitives){let n=t.conflictResolvingInfos;for(let t of n){let n=i.get(t.renderState.id);if(n){n.label=t;continue}let o=eo(e,t.renderState,co,e.center);et(o)&&r.push($n(t,o,s))}}Xn(e,n,s,r)}for(let{icon:t,label:s,sceneIndex:n}of i.values()){let i=Jn(e,t.renderState,e.center),o=s&&eo(e,s.renderState,co,e.center),a=o&&tt(o);(i||a)&&r.push(Kn(t,i,a,n))}return r.sort(Zn)}(this._camera,this._scenes),t=function(e,t,i){let r=new Set;for(let s of t)e.displaced(s,i)||xa(s)||r.add(s.id);return r}(i,e,this._acquireDelegates(this._legacyScreenObjectDelegates));this._updateVisibleScreenObjectsIds(t);let r,s=Tr(),n=this._fadeEffect(s);this._enableExperimentalMode?(this._updateVisibleScreenObjects(e),this._screenObjectVisibilityController.updateProgress(n),r=this._screenObjectVisibilityController.hasAnimationsInProgress(),function(e,t,i,r,s){let n=new Map,o=new Map,a=new Map;for(let t of e){let{logicalId:e}=t;fa(t)&&s.iconVisibility(e)>0&&Do(zo(n,t.sceneIndex),t.iconRenderState.atlas).push(t),ga(t)&&s.hasVisiblePointLabelCandidate(e)&&Do(zo(o,t.sceneIndex),t.pointLabelRenderState.atlas).push(t),va(t)&&s.polylineLabelVisibility(e)>0&&Do(zo(a,t.sceneIndex),t.polylineLabelRenderState.atlas).push(t)}let l=new xo,d=new Uo(t),h=new class{constructor(e,t){this._camera=e,this._screenObjectVisibility=t}attributeMappingType(){return 3}computeMeshSizes(e,t){t.vertexCount=4,t.indexCount=6}write({iconRenderState:e,cameraSpacePosition:t},i){let{minX:r,maxX:s,minY:n,maxY:o}=Cn(e.screenSpaceSize),a=ve(e.worldPos,Io);W(a,this._camera.center,a),W(a,t,a);let l=this._screenObjectVisibility.iconVisibility(e.logicalId),d=Hn(this._camera,a);Ro(i,e.id,a,e.screenSpaceIconOffset,N(r,o,Lo),N(e.uv.minX,e.uv.minY,Eo),e.brightness,l,d),Ro(i,e.id,a,e.screenSpaceIconOffset,N(r,n,Lo),N(e.uv.minX,e.uv.maxY,Eo),e.brightness,l,d),Ro(i,e.id,a,e.screenSpaceIconOffset,N(s,n,Lo),N(e.uv.maxX,e.uv.maxY,Eo),e.brightness,l,d),Ro(i,e.id,a,e.screenSpaceIconOffset,N(s,o,Lo),N(e.uv.maxX,e.uv.minY,Eo),e.brightness,l,d),i.writeIndices([0,1,2,0,2,3])}}(i,s);l.createMeshes(ya(n),h,((e,t)=>{let{iconRenderState:i,sceneIndex:s}=t.at(0),n=new Jo(d.createMesh(e,35040),i.atlas);r[s][120].add(n)}));let c=new class{constructor(e,t){this._camera=e,this._screenObjectVisibility=t}attributeMappingType(){return 4}computeMeshSizes({pointLabelRenderState:e},t){let i=0,r=this._screenObjectVisibility.pointLabelCandidateVisibilities(e.logicalId);for(let{index:t}of r)t<e.candidates.length&&++i;let s=Ho*e.glyphsInCandidate,n=jo*e.glyphsInCandidate+e.hitTestIndices.length;t.vertexCount=i*s,t.indexCount=i*n}write({pointLabelRenderState:e,cameraSpacePosition:t},i){let r=ve(e.worldPos,Go);W(r,this._camera.center,r),W(r,t,r);let s=Hn(this._camera,r),n=0,o=this._screenObjectVisibility.pointLabelCandidateVisibilities(e.logicalId);for(let{index:t,progress:a}of o)if(!(e.candidates.length<=t)){for(let{textColor:o,outlineColor:l,lines:d,outlineWidth:h}of e.candidates[t].text){let t=I(o),c=I(l);for(let{glyphs:o}of d)n=No(o,e,r,t,c,a,i,n,s,h)}i.writeIndices(e.hitTestIndices)}}}(i,s);l.createMeshes(ya(o),c,((e,t)=>{let{pointLabelRenderState:i,sceneIndex:s}=t.at(0),n=new Jo(d.createMesh(e,35040),i.atlas);r[s][121].add(n)}));let u=new class{constructor(e){this._screenObjectVisibility=e}attributeMappingType(){return 5}computeMeshSizes({polylineLabelProjectedGlyphs:e},t){t.vertexCount=ra*e.length,t.indexCount=sa*e.length}write({polylineLabelProjectedGlyphs:e,polylineLabelRenderState:t},i){let{id:r,logicalId:s}=t,n=this._screenObjectVisibility.polylineLabelVisibility(s),o=0;for(let{textColor:t,outlineColor:s,uv:a,height:l,ndcCorners:d,textOutlineWidth:h,glyphToTexRatio:c}of e){let e=R(t.r,t.g,t.b,t.a*n),u=R(s.r,s.g,s.b,s.a*n),[_,p,m,f]=d,g=X(m,p,.5,na),v=N(a.maxX-a.minX,a.maxY-a.minY,oa);ea(i,r,W(m,g,ia),N(a.minX,a.maxY,ta),e,u,l,h,v,g,c),ea(i,r,W(_,g,ia),N(a.minX,a.minY,ta),e,u,l,h,v,g,c),ea(i,r,W(p,g,ia),N(a.maxX,a.minY,ta),e,u,l,h,v,g,c),ea(i,r,W(f,g,ia),N(a.maxX,a.maxY,ta),e,u,l,h,v,g,c),i.writeIndices([0+o,1+o,2+o,0+o,2+o,3+o]),o+=ra}}}(s);l.createMeshes(ya(a),u,((e,t)=>{let{polylineLabelRenderState:i,sceneIndex:s}=t.at(0),n=new Jo(d.createMesh(e,35040),i.atlas);r[s][122].add(n)}))}(e,this._context,this._camera,this._scenes,this._screenObjectVisibilityController)):r=this._updateVisibility(function(e,t){let i=new Set;for(let{id:r,legacyCollidingId:s}of t)e.has(r)&&i.add(s);return i}(t,e),n),r?(this._lastRenderTimeInLoop=s,this._renderLoop.update()):this._lastRenderTimeInLoop=-1}addScene(e){this._scenes.includes(e)||(this._scenes.push(e),e[8].onUpdate.addListener(this._onSceneUpdate),e[6].onUpdate.addListener(this._onSceneUpdate),e[7].onUpdate.addListener(this._onSceneUpdate),e[110].onUpdate.addListener(this._onSceneUpdate))}removeScene(e){let t=e,i=this._scenes.indexOf(t);-1!==i&&(this._scenes[i]=this._scenes[this._scenes.length-1],this._scenes.pop(),this._fadeOutScreenObjects=function(e,t,i,r){let s=[];for(let n of e)n.sceneIndex===i?r.setVisible(n,!1):s.push(n.sceneIndex===t?g(f({},n),{sceneIndex:i}):n);return s}(this._fadeOutScreenObjects,this._scenes.length,i,this._screenObjectVisibilityController),t[120].clear(),t[121].clear(),t[122].clear(),t[8].onUpdate.removeListener(this._onSceneUpdate),t[6].onUpdate.removeListener(this._onSceneUpdate),t[7].onUpdate.removeListener(this._onSceneUpdate),t[110].onUpdate.removeListener(this._onSceneUpdate))}setMajorInvisiblePrimitiveProvider(e){var t,i;null==(t=this._majorInvisiblePrimitiveProvider)||t.onUpdate.removeListener(this._onSceneUpdate),this._majorInvisiblePrimitiveProvider=e,null==(i=this._majorInvisiblePrimitiveProvider)||i.onUpdate.addListener(this._onSceneUpdate)}_updateVisibleScreenObjects(e){let t=new Set,i=this._screenObjectVisibilityController;for(let r of e)i.setVisible(r,!0),t.add(r.logicalId);for(let r of this._fadeOutScreenObjects)t.has(r.logicalId)||(i.setVisible(r,!1),i.isVisible(r.logicalId)&&(ba(r,this._camera),e.push(r)));this._fadeOutScreenObjects=e}_acquireDelegates(e){return this._screenObjectDelegatesWithBBoxesCollecting?(this._screenObjectDelegatesWithBBoxesCollecting.clear(),this._screenObjectDelegatesWithBBoxesCollecting.setDelegates(e),this._screenObjectDelegatesWithBBoxesCollecting):this._isEnabled?e:(this._noIntersectionDelegates.setDelegates(e),this._noIntersectionDelegates)}_updateVisibility(e,t){t=function(e){return 255*e|0}(t);let i=!1;for(let r=0;r<65536;++r)e.has(r)?(this._visibilityBuffer[r]+=t,i||(i=this._visibilityBuffer[r]<ma)):(this._visibilityBuffer[r]-=t,i||(i=this._visibilityBuffer[r]>pa));return this._context.setTextureData(this._visibilityTexture,this._visibilityBuffer),i}_updateVisibleScreenObjectsIds(e){(function(e,t){if(e.size!==t.size)return!1;for(let i of e)if(!t.has(i))return!1;return!0})(e,this._visibleScreenObjectsIds)||(this._visibleScreenObjectsIds=e,this._onVisibleScreenObjectsChange.fire(this._visibleScreenObjectsIds))}_createPlainTexture(e){let t=this._context.createEmpty2DTexture(1,1,6408,5121);return this._context.setTextureData(t,new Uint8Array([e.r*ma,e.g*ma,e.b*ma,e.a*ma])),t}_fadeEffect(e){let t=this._lastRenderTimeInLoop,i=e-(-1!==t?t:this._lastSceneUpdateTime);return Math.min(1,i/this.fadeEffectDuration)}debugBBoxes(){var e;return(null==(e=this._screenObjectDelegatesWithBBoxesCollecting)?void 0:e.collectedBBoxes())||[]}}(e,t,i,150)),this.visibilityTextureProvider=()=>{var e;return null!=(e=this.cpuVisibilityManager)&&e.isActive?(this.cpuVisibilityManager.updateVisibilityIfNeeded(),this.cpuVisibilityManager.visibilityTexture):(this.visibilityManager.updateVisibilityIfNeeded(),this.visibilityManager.visibilityTexture)},this.stencilIdProvider=function(){let e=Ia;return()=>{let t={id:e,shouldClear:e===Ia};return e=yt(e+1,Ia,La),t}}(),this._invisibleCollidingPrimitiveManager=new class{constructor(e,t,i,r,s){var n;this._pageRegistryCommunicators=function(){let e=new Xs,t=new Xs;return e.peerCommunicator=t,t.peerCommunicator=e,{master:e,worker:t}}(),this._pageRegistry=new Cs(this._pageRegistryCommunicators.master,e),this._pageRegistryBackend=new class{constructor(e,t=65536){this._onPageUpdated=e=>{this._updatedPages.add(e)},this._onPageReleased=e=>{this._pages.delete(e.id),e.onUpdate.removeListener(this._onPageUpdated),e.onReleased.removeListener(this._onPageReleased),this._communicator.sendMessage({type:2,id:e.id},!1)},this._communicator=e,this._pageVertexNumber=t,this._updatedPages=new Set,this._pages=new Map,this._lastGeneratedPageId=0,this._entityManager=this._createEntityManager()}destructor(){this._entityManager.destructor();for(let[e,t]of this._pages)t.onUpdate.removeListener(this._onPageUpdated),t.onReleased.removeListener(this._onPageReleased);this._pages.clear()}getPage(e){return this._pages.get(e)}allocatePage(e,t){let i=this._generateId(),r=new As(i,e,this._pageVertexNumber,2*this._pageVertexNumber,t);return r.onUpdate.addListener(this._onPageUpdated),r.onReleased.addListener(this._onPageReleased),this._pages.set(i,r),this._communicator.sendMessage({type:0,id:i,attribMapping:e,dynamicAttribMapping:t,vertexDataByteSize:r.data.vertexBuffer.byteSize,indexDataByteSize:r.data.indexBuffer.byteSize},!1),r}flushBackendUpdates(){for(let e of this._updatedPages){let t=e.flushUpdatedRegion(),i=e.flushUpdatedDynamicRegion(),r=t&&{data:e.data.vertexBuffer.data.slice(t.vertexMinByte,t.vertexMaxByte),byteOffset:t.vertexMinByte},s=t&&{data:e.data.indexBuffer.data.slice(t.indexMinByte,t.indexMaxByte),byteOffset:t.indexMinByte},n=i&&e.dynamicData&&{data:e.dynamicData.vertexData.data.slice(i.vertexMinByte,i.vertexMaxByte),byteOffset:i.vertexMinByte},o=[];r&&o.push(r.data),s&&o.push(s.data),n&&o.push(n.data),this._communicator.sendMessage({type:1,id:e.id,vertexUpdate:r,indexUpdate:s,dynamicVertexUpdate:n},!1,...o)}this._updatedPages.clear()}getEntity(e){return this._entityManager.getEntity(e)}addEntity(e){return this._entityManager.addEntity(e)}_generateId(){return this._lastGeneratedPageId++}_createEntityManager(){return new class{constructor(e){this._onEntityReleased=e=>{this._removeEntity(e)},this._onAddEntity=e.onAddEntity,this._onRemoveEntity=e.onRemoveEntity,this._entities=new Map,this._referencesMap=new Map,this._nextId=0}destructor(){let e=Array.from(this._entities.values());for(let t of e)this._removeEntity(t)}getEntity(e){return this._entities.get(e)}addEntity(e){let t=new Us(this._generateId(),e.type);return this._entities.set(t.id,t),t.onReleased.addListener(this._onEntityReleased),this._setupEntity(t,e),t}_setupEntity(e,t){let i=[];switch(t.type){case 0:this._setupGeometryEntity(e,t,i);break;case 1:this._setupImageEntity(e,t,i)}this._onAddEntity(e,t,i)}_setupGeometryEntity(e,t,i){void 0!==t.baseGeometryId&&this._addReference(e,t.baseGeometryId);for(let e of t.vertices)e.data.byteLength>0&&i.push(e.data);t.indices.byteLength>0&&i.push(t.indices)}_setupImageEntity(e,t,i){(function(e){return!!e&&"string"==typeof e.uri})(t.content)||i.push(_s(t.content)?t.content:t.content.data)}_removeEntity(e){this._removeReference(e),this._entities.delete(e.id),e.onReleased.removeListener(this._onEntityReleased),this._onRemoveEntity(e)}_addReference(e,t){this._referencesMap.set(e.id,t);let i=this._entities.get(t);cs(i,`entity ${e.id}: add reference to ${t}`)&&i.retain()}_removeReference(e){let t=this._referencesMap.get(e.id);if(void 0===t)return;this._referencesMap.delete(e.id);let i=this._entities.get(t);cs(i,`entity ${e.id}: remove reference to ${t}`)&&i.release()}_generateId(){return this._nextId++}}({onAddEntity:(e,t,i)=>{this._communicator.sendMessage({type:3,id:e.id,description:t},!1,...i)},onRemoveEntity:e=>{this._communicator.sendMessage({type:4,id:e.id},!1)}})}}(this._pageRegistryCommunicators.worker),this._bufferWriter=new os(function(e,t,i){let r;return()=>{r&&setTimeout((e=>e.release()),0,r),r=e.allocatePage(t,i),r.retain();let s=e=>{e.release(),e.onRetain.removeListener(s)};return r.retain(),r.onRetain.addListener(s),r.data}}(this._pageRegistryBackend,Os)),this._visibilityManager=i,this._cpuVisibilityManager=r,this._fakePrimitiveStorage=new Jr,this._fakePrimitiveColorIdRenderer=new Ys(this._fakePrimitiveStorage,e,t),this._fakePrimitiveResetRemovedRenderer=new qs(this._fakePrimitiveStorage,e),this._visibilityManager.registerCollidingPrimitives(this._fakePrimitiveStorage,{colorId:this._fakePrimitiveColorIdRenderer,resetRemoved:this._fakePrimitiveResetRemovedRenderer}),null==(n=this._cpuVisibilityManager)||n.setMajorInvisiblePrimitiveProvider(this._fakePrimitiveStorage),this._idGenerator=s,this._primitives=new Map}destructor(){var e;this._visibilityManager.deregisterCollidingPrimitives(this._fakePrimitiveStorage,{colorId:this._fakePrimitiveColorIdRenderer,resetRemoved:this._fakePrimitiveResetRemovedRenderer}),null==(e=this._cpuVisibilityManager)||e.setMajorInvisiblePrimitiveProvider(void 0),this._fakePrimitiveResetRemovedRenderer.destroy(),this._fakePrimitiveColorIdRenderer.destroy(),this._pageRegistry.destructor()}addPrimitives(...e){let t=e.map((({anchor:e,rect:t})=>{let i=this._idGenerator();return{id:i,location:this._bufferWriter.writeFakePrimitive(e,t,i),anchor:H(e),rect:$s(t)}}));this._pageRegistryBackend.flushBackendUpdates();let i=t.map((({location:e,id:t,anchor:i,rect:r})=>{let s=this._pageRegistry.getPage(e.bufferId);if(!s)throw new Error("No page for created fake primitive");return new Zs(s.vao,e,t,i,r)}));return this._fakePrimitiveStorage.addAll(i),this._createCollidingPrimitives(i)}removePrimitives(...e){let t=[];for(let i of e){let e=this._primitives.get(i);e&&(t.push(e),this._primitives.delete(i))}this._fakePrimitiveStorage.removeAll(t)}clear(){this.removePrimitives(...this._primitives.keys())}_createCollidingPrimitives(e){return e.map((e=>{let t={};return this._primitives.set(t,e),t}))}}(e,t,this.visibilityManager,this.cpuVisibilityManager,en(Qs)),s&&(this._debugNdcBBoxRenderer=new class{constructor(e){this._writer=new class{attributeMappingType(){return 6}computeMeshSizes(e,t){t.indexCount=6,t.vertexCount=4}write(e,t){t.writeIndices([0,1,2,2,1,3]),t.writeVertexFloat32(e.minX),t.writeVertexFloat32(e.minY),t.writeVertexFloat32(e.maxX),t.writeVertexFloat32(e.minY),t.writeVertexFloat32(e.minX),t.writeVertexFloat32(e.maxY),t.writeVertexFloat32(e.maxX),t.writeVertexFloat32(e.maxY)}},this._triangleRenderer=new Sa(e)}destroy(){this._triangleRenderer.destroy()}render(e,t){if(0===t.length)return;let i=(new xo).createMeshes([t],this._writer,Ma);this._triangleRenderer.render(e,i)}}(e)),this._onInternalError=new wt,this.renderLoop.onRender.addListener(this._onRender),this.camera.onUpdate.addListener(this._onUpdate),this.renderer.onUpdate.addListener(this._onUpdate),this.context.onLoss.addListener(this._onContextLost)}get invisibleCollidingPrimitiveManager(){return this._invisibleCollidingPrimitiveManager}get onInternalError(){return this._onInternalError}destroy(){var e,t;this.context.onLoss.removeListener(this._onContextLost),this.renderer.onUpdate.removeListener(this._onUpdate),this.camera.onUpdate.removeListener(this._onUpdate),this.renderLoop.onRender.removeListener(this._onRender),this._invisibleCollidingPrimitiveManager.destructor(),this._hitTestManager.destroy(),this._isOwnVisibilityManager&&this.visibilityManager.destroy(),null==(e=this.cpuVisibilityManager)||e.destroy(),null==(t=this._debugNdcBBoxRenderer)||t.destroy()}setRenderTargetSize(e){xr(this._renderTarget.size,e)||(this._renderTarget.size=e,this.visibilityManager.setTargetSize(e),this._hitTestManager.updateSize())}getObjectIdAt(e){return this._hitTestManager.getIdAt(e)}setBackgroundColor(e){this.renderer.setBackgroundColor(e),this.renderLoop.update()}},Ia=1,La=255;function Ea(e,t){let i=Object.keys(t).map((e=>"#define "+e+" "+t[e])).join("\n"),r=e.indexOf("#version");if(-1===r)return i+"\n"+e;let s=e.indexOf("\n",r)+1;return e.slice(0,s)+i+"\n"+e.slice(s)}function Aa(e,t,i){let r=e.createShader(t);if(!r)throw new Error(`Failed to create ${Ua(e,t)} shader`);if(e.shaderSource(r,i),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))throw new Error(`Failed to compile ${Ua(e,t)} shader:\n${e.getShaderInfoLog(r)}`);return r}function Ua(e,t){switch(t){case e.VERTEX_SHADER:return"vertex";case e.FRAGMENT_SHADER:return"fragment"}return"?"}var Oa=class extends fs{constructor(e,t){super(e,0,0,6408,5121,{},t)}get handle(){return this._handle}bind(){let e=this._gl;e.bindTexture(e.TEXTURE_2D,this._handle)}setFilters(){}initialize(){}getWidth(){throw new Error("Not supported")}getHeight(){throw new Error("Not supported")}getFormat(){throw new Error("Not supported")}getType(){throw new Error("Not supported")}getParams(){throw new Error("Not supported")}getHalfPxSize(){throw new Error("Not supported")}destroy(){}},Va=new Float32Array([-1,-1,0,0,1,1,1,1,-1,1,0,1,-1,-1,0,0,1,-1,1,0,1,1,1,1]),Da=$e([[0,{size:2,type:5126,normalized:!1}],[4,{size:2,type:5126,normalized:!1}]]),za=class e{get onLoss(){return this._onLoss}get gl(){return this._gl}constructor(e){this._gl=e,this._skipChecks=!1,this._onLoss=new wt,this._contextLostListener=e=>{e.preventDefault(),this._onLoss.fire()},e.canvas.addEventListener("webglcontextlost",this._contextLostListener),this._capabilities=new class{constructor(e){this._gl=e,this._paramValues=new Map}getAliasedLineWidthRange(){return this._getParam(33902)}getAliasedPointSizeRange(){return this._getParam(33901)}getMaxCombinedTextureImageUnits(){return this._getParam(35661)}getMaxCubeMapTextureSize(){return this._getParam(34076)}getMaxFragmentUniformVectors(){return this._getParam(36349)}getMaxRenderbufferSize(){return this._getParam(34024)}getMaxTextureImageUnits(){return this._getParam(34930)}getMaxTextureSize(){return this._getParam(3379)}getMaxVaryingVectors(){return this._getParam(36348)}getMaxVertexAttribs(){return this._getParam(34921)}getMaxVertexTextureImageUnits(){return this._getParam(35660)}getMaxVertexUniformVectors(){return this._getParam(36347)}getMaxViewportDims(){return this._getParam(3386)}getRenderer(){return this._getParam(7937)}getSubpixelBits(){return this._getParam(3408)}getVendor(){return this._getParam(7936)}getVersion(){return this._getParam(7938)}getUnmaskedVendor(){return this._getParam(37445)}getUnmaskedRenderer(){return this._getParam(37446)}_getParam(e){let t=this._paramValues,i=t.get(e);return i||(i=this._gl.getParameter(e),t.set(e,i)),i}}(e);let t=e.getExtension("OES_vertex_array_object");if(!t)throw new Error("OES_vertex_array_object is required.");if(this._vaoExt=t,!e.getExtension("OES_element_index_uint"))throw new Error("OES_element_index_uint is required.");let i=this._boundRenderTarget=this._defaultRenderTarget=new class{constructor(e){this.isClear=!1,this._gl=e}bind(){let e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}setSize(e,t){let i=this._gl.canvas;i.width=e,i.height=t}get size(){return vr(this._gl.drawingBufferWidth,this._gl.drawingBufferHeight)}set size(e){let t=this._gl.canvas;t.width=e.width,t.height=e.height}destroy(){}}(e),r=this._boundRenderState=new D;this._unpackPremultiplyAlpha=!1,this._unpackAlignment=4;let{width:s,height:n}=i.size;r.scissorWidth=r.viewportWidth=s,r.scissorHeight=r.viewportHeight=n,this._quadVertexBuffer=this.createVertexBuffer(Va.byteLength),this.uploadDataToBuffer(this._quadVertexBuffer,Va),this._quadVao=this.createVao([{attributeMapping:Da,buffer:this._quadVertexBuffer}]),this._boundProgram=null,this._boundVao=null,this._boundTextures=new Array(this._capabilities.getMaxCombinedTextureImageUnits()),this._boundTextures.fill(null),this._boundTextureUnit=0,this.resetContext()}getCapabilities(){return this._capabilities}enableFragDepthExtension(){return this._gl.getExtension("EXT_frag_depth")}enableInstancedArraysExtension(){if(this._iaExt)return;let e=this._gl.getExtension("ANGLE_instanced_arrays");if(!e)throw new Error("ANGLE_instanced_arrays is required");this._iaExt=e}createFramebuffer({color:e,depth:t,stencil:i,depthStencil:r}){let s=this._gl,n=0,o=0;e?(n=e.getWidth(),o=e.getHeight()):t?(n=t.getWidth(),o=t.getHeight()):i?(n=i.getWidth(),o=i.getHeight()):r&&(n=r.getWidth(),o=r.getHeight());let a=new class{constructor(e,t){this.isClear=!1,this._gl=e,this._handle=e.createFramebuffer(),this.size=yr(t)}bind(){let e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,this._handle)}isBound(){let e=this._gl;return e.getParameter(e.FRAMEBUFFER_BINDING)===this._handle}readPixels(e=this.size,t=k,i=new Uint8Array(e.width*e.height*4)){return this._gl.readPixels(t.x,t.y,e.width,e.height,6408,5121,i),i}destroy(){this._gl.deleteFramebuffer(this._handle)}}(s,vr(n,o));return this.bindRenderTarget(a),e&&e.attachToFramebuffer(s.COLOR_ATTACHMENT0),t&&t.attachToFramebuffer(s.DEPTH_ATTACHMENT),i&&i.attachToFramebuffer(s.STENCIL_ATTACHMENT),r&&r.attachToFramebuffer(s.DEPTH_STENCIL_ATTACHMENT),a}createRenderbuffer(e,t,i){let r=this._gl,s=new class{constructor(e,t,i){this._gl=e,this._handle=e.createRenderbuffer(),this._width=t,this._height=i}bind(){let e=this._gl;e.bindRenderbuffer(e.RENDERBUFFER,this._handle)}isBound(){let e=this._gl;return e.getParameter(e.RENDERBUFFER_BINDING)===this._handle}attachToFramebuffer(e){let t=this._gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this._handle)}getWidth(){return this._width}getHeight(){return this._height}destroy(){this._gl.deleteRenderbuffer(this._handle)}}(r,e,t);return s.bind(),r.renderbufferStorage(r.RENDERBUFFER,i,e,t),s}createEmpty2DTexture(e,t,i,r,s){let n=new fs(this._gl,e,t,i,r,s);return this._setTextureDataUnpackParams(n.getParams()),this.bindTexture(n),n.initialize(),n}wrapExternalTexture(e){return new Oa(this._gl,e)}createProgram(e,t,i){return new class{constructor(e,t,i,r){this._gl=e;let s=e.createProgram();if(!s)throw new Error("Failed to create program");this._handle=s,r&&r.defines&&(t=Ea(t,r.defines),i=Ea(i,r.defines));let n=Aa(e,e.VERTEX_SHADER,t),o=Aa(e,e.FRAGMENT_SHADER,i);if(e.attachShader(s,n),e.attachShader(s,o),e.deleteShader(n),e.deleteShader(o),r&&r.attribMap&&Object.entries(r.attribMap).forEach((([t,i])=>{e.bindAttribLocation(s,i,t)})),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))throw new Error(`Failed to link program:\n${e.getProgramInfoLog(s)}`);if(e.validateProgram(s),!e.getProgramParameter(s,e.VALIDATE_STATUS))throw new Error(`Failed to validate program:\n${e.getProgramInfoLog(s)}`);this._uniformCache=new Map}destroy(){this._gl.deleteProgram(this._handle)}bind(){this._gl.useProgram(this._handle)}isBound(){let e=this._gl;return e.getParameter(e.CURRENT_PROGRAM)===this._handle}setIntScalarUniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform1i(i,t)}setScalarUniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform1f(i,t)}setVector2Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform2f(i,t.x,t.y)}setVector3Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform3f(i,t.x,t.y,t.z)}setVector4Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform4f(i,t.x,t.y,t.z,t.w)}setColorUniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniform4f(i,t.r,t.g,t.b,t.a)}setMatrix3Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniformMatrix3fv(i,!1,t)}setMatrix4Uniform(e,t){let i=this._getUniformLocation(e);i&&this._gl.uniformMatrix4fv(i,!1,t)}_getUniformLocation(e){let t=this._uniformCache,i=t.get(e);return i||(i=this._gl.getUniformLocation(this._handle,e),t.set(e,i),i)?i:null}}(this._gl,e,t,i)}createVertexBuffer(e,t=35044){return this._createBuffer(this._gl.ARRAY_BUFFER,e,t)}createIndexBuffer(e,t=35044){return this._createBuffer(this._gl.ELEMENT_ARRAY_BUFFER,e,t)}uploadDataToBuffer(e,t,i=0){e.bind(),this._gl.bufferSubData(e.getTarget(),i,t)}createVao(e,t){let i=this._gl,r=new class{constructor(e,t){this._gl=e,this._vaoExt=t,this._handle=t.createVertexArrayOES(),this.onDestroy=this._onDestroy=new wt}bind(){this._vaoExt.bindVertexArrayOES(this._handle)}isBound(){return this._gl.getParameter(this._vaoExt.VERTEX_ARRAY_BINDING_OES)===this._handle}destroy(){this._vaoExt.deleteVertexArrayOES(this._handle),this._onDestroy.fire()}}(i,this._vaoExt);r.bind(),t?t.bind():i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(let{attributeMapping:t,buffer:r,stride:s}of e){r.bind();for(let[e,r]of t.attributes)i.enableVertexAttribArray(e),i.vertexAttribPointer(e,r.size,r.type,r.normalized,s||t.vertexByteSize,r.offset),void 0!==r.divisor&&this._iaExt.vertexAttribDivisorANGLE(e,r.divisor)}return this._vaoExt.bindVertexArrayOES(null),r}setTextureData(e,t,i={x:0,y:0},r={width:e.getWidth(),height:e.getHeight()}){let s=this._gl,n=e.getFormat(),o=e.getType(),a=e.getParams(),{width:l,height:d}=r;this._setTextureDataUnpackParams(a),this.bindTexture(e),s.texSubImage2D(s.TEXTURE_2D,0,i.x,i.y,l,d,n,o,t),this._onTextureDataUpdated(e)}setTextureDataFromDomElement(e,t,i={x:0,y:0}){let r=this._gl,s=e.getFormat(),n=e.getType(),o=e.getParams();this._setTextureDataUnpackParams(o),this.bindTexture(e),r.texSubImage2D(r.TEXTURE_2D,0,i.x,i.y,s,n,t),this._onTextureDataUpdated(e)}resizeTexture(e,t){let i=this._gl,r=e.getFormat(),s=e.getType(),n=e.getParams();e.resize(t),this._setTextureDataUnpackParams(n),this.bindTexture(e),i.texImage2D(i.TEXTURE_2D,0,r,t.width,t.height,0,r,s,null),this._onTextureDataUpdated(e)}getDefaultRenderTarget(){return this._defaultRenderTarget}clearCurrentTarget(e){e&&(this._gl.clear(e),this._boundRenderTarget.isClear=!0)}bindRenderTarget(e){(this._boundRenderTarget!==e||this._skipChecks)&&(e.bind(),this._boundRenderTarget=e);let{width:t,height:i}=e.size;this._setViewportState(new D({viewportWidth:t,viewportHeight:i}))}bindRenderState(e){this._setColorBufferState(e),this._setBlendState(e),this._setCullFaceState(e),this._setFrontFaceState(e),this._setDepthTestState(e),this._setDitherState(e),this._setPolygonOffsetState(e),this._setAlphaToCoverageState(e),this._setSampleCoverageState(e),this._setStencilTestState(e),this._setScissorTestState(e),this._setViewportState(e)}bindProgram(e){(this._boundProgram!==e||this._skipChecks)&&(e.bind(),this._boundProgram=e)}unbindProgram(){(this._boundProgram||this._skipChecks)&&(this._gl.useProgram(null),this._boundProgram=null)}bindVao(e){(this._boundVao!==e||this._skipChecks)&&(e?e.bind():this._vaoExt.bindVertexArrayOES(null),this._boundVao=e)}bindQuadVao(){this.bindVao(this._quadVao)}bindTextureUnit(e){let t=this._gl;(this._boundTextureUnit!==e||this._skipChecks)&&(t.activeTexture(t.TEXTURE0+e),this._boundTextureUnit=e)}bindTexture(e,t,i){let r=this._boundTextureUnit;(this._boundTextures[r]!==e||this._skipChecks)&&(e.bind(),this._boundTextures[r]=e),e.setFilters(t,i)}unbindTexture(){let e=this._boundTextureUnit;(this._boundTextures[e]||this._skipChecks)&&(this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._boundTextures[e]=null)}drawQuad(){this.drawMesh(0,6,4)}drawMesh(e,t,i=4){this._gl.drawArrays(i,e,t),this._boundRenderTarget.isClear=!1}drawIndexedMesh(e,t,i=4,r=5123){this._gl.drawElements(i,t,r,e),this._boundRenderTarget.isClear=!1}drawIndexedMeshInstanced(e,t,i=4,r=5123,s=1){this._iaExt.drawElementsInstancedANGLE(i,t,r,e,s),this._boundRenderTarget.isClear=!1}resetContext(){let e=this._gl;this._skipChecks=!0,this.bindRenderTarget(this._defaultRenderTarget);let{width:t,height:i}=this._defaultRenderTarget.size;this.bindRenderState(new D({viewportWidth:t,viewportHeight:i,scissorWidth:t,scissorHeight:i})),this.unbindProgram(),this.bindVao(null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);for(let e=0;e<this._boundTextures.length;++e)this.bindTextureUnit(e),this.unbindTexture();this.bindTextureUnit(0),this._setTextureDataUnpackParams(ms),this._skipChecks=!1}destroy(){this._quadVao.destroy(),this._quadVertexBuffer.destroy(),this._gl.canvas.removeEventListener("webglcontextlost",this._contextLostListener)}static createFromCanvas(t,i){let r=t.getContext("webgl",i);if(!r)throw new Error("Failed to create GL context from canvas.");return new e(r)}_setCapabilityEnabled(e,t){t?this._gl.enable(e):this._gl.disable(e)}_setColorBufferState(e){let t=this._gl,i=this._boundRenderState,r=e.clearColor;(!function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}(i.clearColor,r)||this._skipChecks)&&(t.clearColor(r.r,r.g,r.b,r.a),M(r,i.clearColor)),(i.colorMaskR!==e.colorMaskR||i.colorMaskG!==e.colorMaskG||i.colorMaskB!==e.colorMaskB||i.colorMaskAlpha!==e.colorMaskAlpha||this._skipChecks)&&(this._gl.colorMask(e.colorMaskR,e.colorMaskG,e.colorMaskB,e.colorMaskAlpha),i.colorMaskR=e.colorMaskR,i.colorMaskG=e.colorMaskG,i.colorMaskB=e.colorMaskB,i.colorMaskAlpha=e.colorMaskAlpha)}_setBlendState(e){let t=this._gl,i=this._boundRenderState;(i.blend!==e.blend||this._skipChecks)&&(this._setCapabilityEnabled(t.BLEND,e.blend),i.blend=e.blend),(e.blend||this._skipChecks)&&((i.blendEquationRgb!==e.blendEquationRgb||i.blendEquationAlpha!==e.blendEquationAlpha||this._skipChecks)&&(t.blendEquationSeparate(e.blendEquationRgb,e.blendEquationAlpha),i.blendEquationRgb=e.blendEquationRgb,i.blendEquationAlpha=e.blendEquationAlpha),(i.blendFuncDstRgb!==e.blendFuncDstRgb||i.blendFuncSrcRgb!==e.blendFuncSrcRgb||i.blendFuncDstAlpha!==e.blendFuncDstAlpha||i.blendFuncSrcAlpha!==e.blendFuncSrcAlpha||this._skipChecks)&&(t.blendFuncSeparate(e.blendFuncSrcRgb,e.blendFuncDstRgb,e.blendFuncSrcAlpha,e.blendFuncDstAlpha),i.blendFuncSrcRgb=e.blendFuncSrcRgb,i.blendFuncDstRgb=e.blendFuncDstRgb,i.blendFuncSrcAlpha=e.blendFuncSrcAlpha,i.blendFuncDstAlpha=e.blendFuncDstAlpha))}_setCullFaceState(e){let t=this._gl,i=this._boundRenderState;(i.cullFace!==e.cullFace||this._skipChecks)&&(this._setCapabilityEnabled(t.CULL_FACE,e.cullFace),i.cullFace=e.cullFace),(e.cullFace&&i.cullFaceMode!==e.cullFaceMode||this._skipChecks)&&(t.cullFace(e.cullFaceMode),i.cullFaceMode=e.cullFaceMode)}_setFrontFaceState(e){let t=this._boundRenderState;(t.frontFaceMode!==e.frontFaceMode||this._skipChecks)&&(this._gl.frontFace(e.frontFaceMode),t.frontFaceMode=e.frontFaceMode)}_setDepthTestState(e){let t=this._gl,i=this._boundRenderState;(i.depthTest!==e.depthTest||this._skipChecks)&&(this._setCapabilityEnabled(t.DEPTH_TEST,e.depthTest),i.depthTest=e.depthTest),(e.depthTest||this._skipChecks)&&((i.clearDepth!==e.clearDepth||this._skipChecks)&&(t.clearDepth(e.clearDepth),i.clearDepth=e.clearDepth),(i.depthMask!==e.depthMask||this._skipChecks)&&(t.depthMask(e.depthMask),i.depthMask=e.depthMask),(i.depthFunc!==e.depthFunc||this._skipChecks)&&(t.depthFunc(e.depthFunc),i.depthFunc=e.depthFunc),(i.depthRangeNear!==e.depthRangeNear||i.depthRangeFar!==e.depthRangeFar||this._skipChecks)&&(t.depthRange(e.depthRangeNear,e.depthRangeFar),i.depthRangeNear=e.depthRangeNear,i.depthRangeFar=e.depthRangeFar))}_setDitherState(e){let t=this._boundRenderState;(t.dither!==e.dither||this._skipChecks)&&(this._setCapabilityEnabled(this._gl.DITHER,e.dither),t.dither=e.dither)}_setPolygonOffsetState(e){let t=this._gl,i=this._boundRenderState;(i.polygonOffset!==e.polygonOffset||this._skipChecks)&&(this._setCapabilityEnabled(t.POLYGON_OFFSET_FILL,e.polygonOffset),i.polygonOffset=e.polygonOffset),(e.polygonOffset&&(i.polygonOffsetFactor!==e.polygonOffsetFactor||i.polygonOffsetUnits!==e.polygonOffsetUnits)||this._skipChecks)&&(t.polygonOffset(e.polygonOffsetFactor,e.polygonOffsetUnits),i.polygonOffsetFactor=e.polygonOffsetFactor,i.polygonOffsetUnits=e.polygonOffsetUnits)}_setAlphaToCoverageState(e){let t=this._boundRenderState;(t.sampleAlphaToCoverage!==e.sampleAlphaToCoverage||this._skipChecks)&&(this._setCapabilityEnabled(this._gl.SAMPLE_ALPHA_TO_COVERAGE,e.sampleAlphaToCoverage),t.sampleAlphaToCoverage=e.sampleAlphaToCoverage)}_setSampleCoverageState(e){let t=this._gl,i=this._boundRenderState;(i.sampleCoverage!==e.sampleCoverage||this._skipChecks)&&(this._setCapabilityEnabled(t.SAMPLE_COVERAGE,e.sampleCoverage),i.sampleCoverage=e.sampleCoverage),(e.sampleCoverage&&(i.sampleCoverageValue!==e.sampleCoverageValue||i.sampleCoverageInvert!==e.sampleCoverageInvert)||this._skipChecks)&&(t.sampleCoverage(e.sampleCoverageValue,e.sampleCoverageInvert),i.sampleCoverageValue=e.sampleCoverageValue,i.sampleCoverageInvert=e.sampleCoverageInvert)}_setStencilTestState(e){let t=this._gl,i=this._boundRenderState;if((i.stencilTest!==e.stencilTest||this._skipChecks)&&(this._setCapabilityEnabled(t.STENCIL_TEST,e.stencilTest),i.stencilTest=e.stencilTest),e.stencilTest||this._skipChecks){(i.clearStencil!==e.clearStencil||this._skipChecks)&&(t.clearStencil(e.clearStencil),i.clearStencil=e.clearStencil),(i.stencilWriteMask!==e.stencilWriteMask||this._skipChecks)&&(t.stencilMask(e.stencilWriteMask),i.stencilWriteMask=e.stencilWriteMask);let r=i.stencilMask!==e.stencilMask||i.stencilReference!==e.stencilReference;(r||this._skipChecks)&&(i.stencilMask=e.stencilMask,i.stencilReference=e.stencilReference),(i.stencilFrontFunc!==e.stencilFrontFunc||r||this._skipChecks)&&(t.stencilFuncSeparate(t.FRONT,e.stencilFrontFunc,e.stencilReference,e.stencilMask),i.stencilFrontFunc=e.stencilFrontFunc),(i.stencilBackFunc!==e.stencilBackFunc||r||this._skipChecks)&&(t.stencilFuncSeparate(t.BACK,e.stencilBackFunc,e.stencilReference,e.stencilMask),i.stencilBackFunc=e.stencilBackFunc),(i.stencilFrontFailOp!==e.stencilFrontFailOp||i.stencilFrontDepthFailOp!==e.stencilFrontDepthFailOp||i.stencilFrontDepthPassOp!==e.stencilFrontDepthPassOp||this._skipChecks)&&(t.stencilOpSeparate(t.FRONT,e.stencilFrontFailOp,e.stencilFrontDepthFailOp,e.stencilFrontDepthPassOp),i.stencilFrontFailOp=e.stencilFrontFailOp,i.stencilFrontDepthFailOp=e.stencilFrontDepthFailOp,i.stencilFrontDepthPassOp=e.stencilFrontDepthPassOp),(i.stencilBackFailOp!==e.stencilBackFailOp||i.stencilBackDepthFailOp!==e.stencilBackDepthFailOp||i.stencilBackDepthPassOp!==e.stencilBackDepthPassOp||this._skipChecks)&&(t.stencilOpSeparate(t.BACK,e.stencilBackFailOp,e.stencilBackDepthFailOp,e.stencilBackDepthPassOp),i.stencilBackFailOp=e.stencilBackFailOp,i.stencilBackDepthFailOp=e.stencilBackDepthFailOp,i.stencilBackDepthPassOp=e.stencilBackDepthPassOp)}}_setScissorTestState(e){let t=this._gl,i=this._boundRenderState;(i.scissorTest!==e.scissorTest||this._skipChecks)&&(this._setCapabilityEnabled(t.SCISSOR_TEST,e.scissorTest),i.scissorTest=e.scissorTest),(e.scissorTest&&e.scissorWidth>=0&&e.scissorHeight>=0&&(i.scissorX!==e.scissorX||i.scissorY!==e.scissorY||i.scissorWidth!==e.scissorWidth||i.scissorHeight!==e.scissorHeight)||this._skipChecks)&&(t.scissor(e.scissorX,e.scissorY,e.scissorWidth,e.scissorHeight),i.scissorX=e.scissorX,i.scissorY=e.scissorY,i.scissorWidth=e.scissorWidth,i.scissorHeight=e.scissorHeight)}_setViewportState(e){let t=this._boundRenderState;(e.viewportWidth>=0&&e.viewportHeight>=0&&(t.viewportX!==e.viewportX||t.viewportY!==e.viewportY||t.viewportWidth!==e.viewportWidth||t.viewportHeight!==e.viewportHeight)||this._skipChecks)&&(this._gl.viewport(e.viewportX,e.viewportY,e.viewportWidth,e.viewportHeight),t.viewportX=e.viewportX,t.viewportY=e.viewportY,t.viewportWidth=e.viewportWidth,t.viewportHeight=e.viewportHeight)}_setTextureDataUnpackParams(e){let t=this._gl;(this._unpackPremultiplyAlpha!==e.premultipliedAlpha||this._skipChecks)&&(t.pixelStorei(37441,+e.premultipliedAlpha),this._unpackPremultiplyAlpha=e.premultipliedAlpha),(this._unpackAlignment!==e.unpackAlignment||this._skipChecks)&&(t.pixelStorei(3317,e.unpackAlignment),this._unpackAlignment=e.unpackAlignment)}_onTextureDataUpdated(e){let t=this._gl;e.getParams().minificationFilter>=9984&&t.generateMipmap(t.TEXTURE_2D)}_createBuffer(e,t,i=this._gl.STATIC_DRAW){let r=this._gl,s=new class{get size(){return this._size}constructor(e,t,i){this._gl=e,this._target=t,this._handle=e.createBuffer(),this._size=i}bind(){this._gl.bindBuffer(this._target,this._handle)}isBound(){let e=this._gl,t=this._handle;switch(this._target){case e.ARRAY_BUFFER:return e.getParameter(e.ARRAY_BUFFER_BINDING)===t;case e.ELEMENT_ARRAY_BUFFER:return e.getParameter(e.ELEMENT_ARRAY_BUFFER_BINDING)===t}return!1}getTarget(){return this._target}getSize(){return this._size}destroy(){this._gl.deleteBuffer(this._handle)}}(r,e,t);return this.bindVao(null),s.bind(),r.bufferData(e,t,i),s}};function Ba(e){e.destroy()}var Fa=(e=>(e[e.X1=0]="X1",e[e.X4=1]="X4",e[e.X16=2]="X16",e))(Fa||{});new Array;function Na(e){switch(e){case 1:return-1;case 2:return-2;default:return 0}}var ka=class{constructor(e){this._onMessage=e=>{let t=this._listeners[e.type];t&&t.fire(e.message)},this._rootCommunicator=e,this._listeners={},this._rootCommunicator.onMessage.addListener(this._onMessage)}destructor(){this._rootCommunicator.onMessage.removeListener(this._onMessage)}getCommunicator(e){let t=this._listeners[e];return t||(t=new wt,this._listeners[e]=t),{onMessage:t,sendMessage:(t,i,...r)=>{this._rootCommunicator.sendMessage({type:e,message:t},i,...r)}}}},Ha=class extends es{constructor(e,t,i,r){super(e.vao,{indexByteOffset:e.indexByteOffset,indexByteLength:e.indexByteSize,indexType:e.indexType},i,r),this.mesh=e,this.isExtruded=t}retain(){this.mesh.retain()}release(){this.mesh.release()}};function ja(e,t,i){if(0===t.length)return[];let r=[],s=new Uo(e);for(let e of t){let{mesh:t,id:n,isExtruded:o}=e,a=s.createMesh(t),l=void 0!==n?null==i?void 0:i.get(n):void 0;r.push(new Ha(a,o,n,l))}return r}var Ga=class extends es{constructor(e){var t,i,r,s,n;super(e.geometry.vao,e.location,e.id,e.metadata),this.legacyCollidingId=e.legacyCollidingId,this.geometry=e.geometry,this.image=e.image,this.occlusion=e.occlusion,this.occlusionStrength=e.occlusionStrength,this.modelId=e.modelId,this.rtc=e.rtc,this.matrix=e.transform,this.bbox=e.bbox,this.isUnlit=e.isUnlit,this.colorFactor=M(e.colorFactor),this.instanceCount=e.instanceCount,this.animateHeight=!1,this.memoryInfo={geometry:this.geometry.memoryUsageInBytes,textures:(null!=(i=null==(t=this.image)?void 0:t.memoryUsageInBytes)?i:0)+(null!=(s=null==(r=this.occlusion)?void 0:r.memoryUsageInBytes)?s:0)},this.useVertexColor=null!=(n=e.useVertexColor)&&n,this.normalMatrix=function(e,t=ce()){let i=ze(e,Wa);!function(e,t=De()){let i=je;i[0]=e[5]*e[10]*e[15]-e[5]*e[11]*e[14]-e[9]*e[6]*e[15]+e[9]*e[7]*e[14]+e[13]*e[6]*e[11]-e[13]*e[7]*e[10],i[4]=-e[4]*e[10]*e[15]+e[4]*e[11]*e[14]+e[8]*e[6]*e[15]-e[8]*e[7]*e[14]-e[12]*e[6]*e[11]+e[12]*e[7]*e[10],i[8]=e[4]*e[9]*e[15]-e[4]*e[11]*e[13]-e[8]*e[5]*e[15]+e[8]*e[7]*e[13]+e[12]*e[5]*e[11]-e[12]*e[7]*e[9],i[12]=-e[4]*e[9]*e[14]+e[4]*e[10]*e[13]+e[8]*e[5]*e[14]-e[8]*e[6]*e[13]-e[12]*e[5]*e[10]+e[12]*e[6]*e[9],i[1]=-e[1]*e[10]*e[15]+e[1]*e[11]*e[14]+e[9]*e[2]*e[15]-e[9]*e[3]*e[14]-e[13]*e[2]*e[11]+e[13]*e[3]*e[10],i[5]=e[0]*e[10]*e[15]-e[0]*e[11]*e[14]-e[8]*e[2]*e[15]+e[8]*e[3]*e[14]+e[12]*e[2]*e[11]-e[12]*e[3]*e[10],i[9]=-e[0]*e[9]*e[15]+e[0]*e[11]*e[13]+e[8]*e[1]*e[15]-e[8]*e[3]*e[13]-e[12]*e[1]*e[11]+e[12]*e[3]*e[9],i[13]=e[0]*e[9]*e[14]-e[0]*e[10]*e[13]-e[8]*e[1]*e[14]+e[8]*e[2]*e[13]+e[12]*e[1]*e[10]-e[12]*e[2]*e[9],i[2]=e[1]*e[6]*e[15]-e[1]*e[7]*e[14]-e[5]*e[2]*e[15]+e[5]*e[3]*e[14]+e[13]*e[2]*e[7]-e[13]*e[3]*e[6],i[6]=-e[0]*e[6]*e[15]+e[0]*e[7]*e[14]+e[4]*e[2]*e[15]-e[4]*e[3]*e[14]-e[12]*e[2]*e[7]+e[12]*e[3]*e[6],i[10]=e[0]*e[5]*e[15]-e[0]*e[7]*e[13]-e[4]*e[1]*e[15]+e[4]*e[3]*e[13]+e[12]*e[1]*e[7]-e[12]*e[3]*e[5],i[14]=-e[0]*e[5]*e[14]+e[0]*e[6]*e[13]+e[4]*e[1]*e[14]-e[4]*e[2]*e[13]-e[12]*e[1]*e[6]+e[12]*e[2]*e[5],i[3]=-e[1]*e[6]*e[11]+e[1]*e[7]*e[10]+e[5]*e[2]*e[11]-e[5]*e[3]*e[10]-e[9]*e[2]*e[7]+e[9]*e[3]*e[6],i[7]=e[0]*e[6]*e[11]-e[0]*e[7]*e[10]-e[4]*e[2]*e[11]+e[4]*e[3]*e[10]+e[8]*e[2]*e[7]-e[8]*e[3]*e[6],i[11]=-e[0]*e[5]*e[11]+e[0]*e[7]*e[9]+e[4]*e[1]*e[11]-e[4]*e[3]*e[9]-e[8]*e[1]*e[7]+e[8]*e[3]*e[5],i[15]=e[0]*e[5]*e[10]-e[0]*e[6]*e[9]-e[4]*e[1]*e[10]+e[4]*e[2]*e[9]+e[8]*e[1]*e[6]-e[8]*e[2]*e[5];let r=e[0]*i[0]+e[1]*i[4]+e[2]*i[8]+e[3]*i[12];if(Math.abs(r)<=Ge)return null;r=1/r;for(let e=0;e<16;++e)t[e]=i[e]*r}(i,i);let r=function(e,t=ce()){let i=Math.sqrt(de);for(let r=0;r<de;++r)t[r]=e[r+Math.trunc(r/i)];return t}(i,t);return function(e,t=he()){let i=Math.sqrt(de);for(let r=0;r<i;r++)for(let s=r;s<i;s++){let n=e[r*i+s];t[r*i+s]=e[s*i+r],t[s*i+r]=n}}(r,r),r}(this.matrix)}retain(){var e;this.geometry.retain(),null==(e=this.image)||e.retain()}release(){var e;this.geometry.release(),null==(e=this.image)||e.release()}},Wa=ce();function Ya(e,t,i){let r=[];for(let s of t){let t=s.id,{legacyCollidingId:n}=s,o=null==i?void 0:i.get(t),a=qa(e,s),l=Xa(e,s),d=Za(e,s),h=new Ga({id:t,legacyCollidingId:n,geometry:a,image:l,occlusion:d,occlusionStrength:s.occlusionStrength,location:s.location,metadata:o,modelId:-1,rtc:s.rtc,transform:s.transform,bbox:s.bbox,isUnlit:s.isUnlit,colorFactor:s.colorFactor,instanceCount:s.instanceCount,useVertexColor:!0});r.push(h)}return r}function qa(e,t){let i=e.getEntity(t.geometryId);return cs(i,`instantiate rich model ${t.id}: geometry ${t.geometryId}`),i}function Xa(e,t){if(void 0===t.imageId)return;let i=e.getEntity(t.imageId);return cs(i,`instantiate rich model ${t.id}: image ${t.imageId}`),i}function Za(e,t){if(void 0===t.occlusionId)return;let i=e.getEntity(t.occlusionId);return cs(i,`instantiate rich model ${t.id}: occlusion ${t.occlusionId}`),i}var $a=class extends es{constructor(e,t,i,r,s){super(e.vao,{indexByteOffset:e.indexByteOffset,indexByteLength:e.indexByteSize,indexType:e.indexType},i,r),this.mesh=e,this.type=t,this.zOrder=s}retain(){this.mesh.retain()}release(){this.mesh.release()}};function Qa(e,t,i,r){if(0===i.length)return[];let s=[],n=new Uo(e);for(let e of i){let{mesh:i,id:o,zOrder:a}=e,l=n.createMesh(i),d=void 0!==o?null==r?void 0:r.get(o):void 0;s.push(new $a(l,t,o,d,a))}return s}var Ka=class extends es{constructor(e,t,i,r,s){super(e,t,r,s),this.texture=i}},Ja=class extends Ka{constructor(e,t,i,r,s,n){super(e.vao,{indexByteOffset:e.indexByteOffset,indexByteLength:e.indexByteSize,indexType:e.indexType},t,r,s),this.mesh=e,this.type=5,this.opacity=i,this.zOrder=n}retain(){this.mesh.retain()}release(){this.mesh.release()}};function el(e,t,i,r){if(0===i.length)return[];let s=[],n=new Uo(e);for(let e of i){let i=t.getAtlas(e.atlasId);if(cs(i)){let{mesh:t,id:o,opacity:a,zOrder:l}=e,d=n.createMesh(t),h=void 0!==o?null==r?void 0:r.get(o):void 0;s.push(new Ja(d,i.texture,a,o,h,l))}}return s}var tl=class extends Ka{constructor(e,t,i,r,s,n,o){super(e.vao,t,i,n,o),this.page=e,this.minZoom=r,this.conflictResolvingInfos=s}retain(){this.page.retain()}release(){this.page.release()}};function il(e,t,i,r,s){let n=[];for(let o of i){let i=e.getPage(o.location.bufferId),a=t.getAtlas(o.atlasId);if(cs(i)&&cs(a)){let{location:e,id:t,conflictResolvingInfos:l}=o,d=void 0!==t?null==s?void 0:s.get(t):void 0;n.push(new tl(i,e,a.texture,r,rl(l,a.texture),t,d))}}return n}function rl(e,t){let i=[];for(let r of e)i.push({renderState:g(f({},r.renderState),{atlas:t}),priorities:r.priorities});return i}var sl=class extends Ka{constructor(e,t,i,r,s,n,o,a){super(e.vao,t,i,o,a),this._page=e,this.zIndex=r,this.minZoom=s,this.conflictResolvingInfo=n}retain(){this._page.retain()}release(){this._page.release()}};function nl(e,t,i,r,s){let n=[];for(let o of i){let i=e.getPage(o.location.bufferId),a=t.getAtlas(o.atlasId);if(cs(i)&&cs(a)){let{location:e,zIndex:t,id:l,conflictResolvingInfo:d}=o,h=g(f({},d.renderState),{atlas:a.texture}),c=void 0!==l?null==s?void 0:s.get(l):void 0;n.push(new sl(i,e,a.texture,t,r,{renderState:h,priorities:d.priorities},l,c))}}return n}var ol=class{constructor(){this._data=new Map,this._onUpdate=new wt}get onUpdate(){return this._onUpdate}[Symbol.iterator](){return this._data.values()}get(e){return this._data.get(e)}add(e){this._data.set(e.id,e),this._onUpdate.fire()}remove(e){this._data.delete(e.id),this._onUpdate.fire()}addAll(e){for(let t of e)this._data.set(t.id,t);this._onUpdate.fire()}removeAll(e){for(let t of e)this._data.delete(t.id);this._onUpdate.fire()}},al=class{constructor(e,t,i,r,s){this._context=e,this._registry=t,this._glyphAtlasRegistry=i,this._iconAtlasRegistry=r,this._additionalMetadata=s}destructor(){}_instantiatePrimitives(e,t){let i={primitives:{},references:[]};if(e.metadata&&(i.metadata=e.metadata,this._applyAdditionalMetadata(e.metadata)),e.references&&i.references.push(...e.references),e.placemarkDescriptions&&e.placemarkDescriptions.length>0){i.placemarks=new ol;let r=Math.max(t-2,0);for(let t of e.placemarkDescriptions)i.placemarks.add({id:t.id,legacyCollidingId:t.legacyCollidingId,logicalId:t.logicalId,priorities:t.priorities,metadata:t.metadata,textOptional:t.textOptional,minZoom:r})}for(let r of an(e.primitives))switch(r){case 0:case 1:i.primitives[r]=Qa(this._context,r,e.primitives[r],e.metadata);break;case 3:i.primitives[r]=ja(this._context,e.primitives[r],e.metadata);break;case 4:i.primitives[r]=Ya(this._registry,e.primitives[r],e.metadata);break;case 5:i.primitives[r]=el(this._context,this._iconAtlasRegistry,e.primitives[r],e.metadata);break;case 6:case 7:{let s=Math.max(t-2,0);i.primitives[r]=il(this._registry,this._glyphAtlasRegistry,e.primitives[r],s,e.metadata);break}case 8:{let s=Math.max(t-2,0);i.primitives[r]=nl(this._registry,this._iconAtlasRegistry,e.primitives[r],s,e.metadata);break}}return i}_applyAdditionalMetadata(e){if(e&&this._additionalMetadata)for(let t of e.values())for(let[e,i]of this._additionalMetadata)t.set(e,i)}_serializeOptions(e){return e}};function ll(e,t){return String(e).padStart(t,"0")}var dl=class extends al{constructor(e,t,i,r,s,n,o,a,l){super(r,s,n,o,l),this._onMessage=e=>{switch(e.type){case 4:this._onReportError(e);break;case 5:this._onAddPrimitives(e);break;case 7:this._onAddModelPrimitives(e);break;case 6:this._onRemovePrimitives(e)}},this._reportContentErrorHandler=e=>{this._onContentError.fire(g(f({},e),{source:`TileVectorContentManager/${e.source}`}))},this._communicator=e,this._options=a,this._storage=t,this._modelStorage=i,this._onError=new wt,this._onContentError=new wt,this._onTileContentAdded=this.onTileContentAdded=new wt,this._communicator.onMessage.addListener(this._onMessage),this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1),this._options.customizationConfig&&this._options.customizationConfig.length&&this._updateCustomizationConfig()}get onError(){return this._onError}get onContentError(){return this._onContentError}destructor(){this._communicator.onMessage.removeListener(this._onMessage),super.destructor()}updateOption(e,t){this._options[e]=t,this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1)}updateCustomizationConfig(e){this._options.customizationConfig=e,this._updateCustomizationConfig()}updateLod({modelId:e,lodId:t}){this._communicator.sendMessage({type:3,modelId:e,lodId:t},!0)}_onReportError(e){this._onError.fire(e.error)}_onAddPrimitives(e){let t=this._storage.get(e.tileId);if(!t)return void this._reportNoTile(e.tileId);if(function(e,t,i){var r;if(null==(r=t.errors)||!r.length)return;let s=`${ll(e.x,5)}:${ll(e.y,5)}:${ll(e.zoom,2)}`;for(let e of t.errors)i.fire(g(f({},e),{source:`${s}/${e.source}`}))}(t.tile,e.content,this._onContentError),!cl(e,this._onError))return;let i=function(e,t){return e.zoom-Na(t)}(t.tile,this._options.tileSize),r=this._instantiatePrimitives(e.content,i);t.addContent(r,this._reportContentErrorHandler),this._onTileContentAdded.fire(t,r,e.metrics)}_onRemovePrimitives(e){let t=this._storage.get(e.tileId);if(!t)return void this._reportNoTile(e.tileId);let i={primitives:{},references:[]};for(let r of e.content){let e=t.content.primitives[r];hl(i.primitives,r,e&&[...e])}t.removeContent(i)}_onAddModelPrimitives(e){let t=this._modelStorage.get(e.modelId),i=e.content.metadata;if(!t)return void this._reportNoModel(e.modelId);if(function(e,t,i){var r;if(null!=(r=t.errors)&&r.length)for(let r of t.errors)i.fire(g(f({},r),{source:`${e}/${r.source}`}))}(t.id,e.content,this._onContentError),!cl(e,this._onError))return;if(t.content){let e=t.content.primitives[4],i=t.content.primitives[3];t.removeContent(g(f({},t.content),{primitives:{4:e?[...e]:[],3:i?[...i]:[]}}))}let r=e.content.primitives[3],s=e.content.primitives[4],n=r?ja(this._context,r,e.content.metadata):void 0,o=s?Ya(this._registry,s,e.content.metadata):void 0;(n||o)&&(this._applyAdditionalMetadata(i),t.addContent({primitives:{3:n,4:o},metadata:i},this._reportContentErrorHandler))}_updateCustomizationConfig(){this._communicator.sendMessage({type:2,customizationConfig:this._options.customizationConfig},!1)}_reportNoTile(e){this._onContentError.fire({source:"tile",message:`tile is not found: ${e}`})}_reportNoModel(e){this._onContentError.fire({source:"model",message:`model is not found: ${e}`})}};function hl(e,t,i){e[t]=i}function cl(e,t){return!function(e){var t;for(let i of ul){let r=null==(t=e.primitives)?void 0:t[i];if(r)for(let{mesh:e}of r){let{vertices:t,indices:i}=e.sharedStorage;if(void 0===t||void 0===i)return!0}}return!1}(e.content)||(t.fire({source:"[TileVectorContentManager] "+(5===e.type?`tileId: ${e.tileId}`:`modelId: ${e.modelId}`),message:"emptyBufferCheck"}),!1)}var ul=[0,1,5,3];function _l(e,t){return e.x+"_"+e.y+"_"+e.zoom+"_"+t}function pl(e,t){return g(f({},e),{id:_l(e,t)})}var ml={x:0,y:0,zoom:0};var fl=Zt(((e,t=f({},K))=>ne(er(e),t))),gl=class{get visibleTiles(){return this._visibleTiles.values()}set tileIdPrefix(e){this._tileIdPrefix=e,this._syncOptions()}constructor(e,t,i,r=new class{constructor(e,t,i=.5,r=1/0){this._camera=e,this._zoomShift=Na(t),this._targetZoomShift=i,this._maxZoomWithTilesLoading=r}recalculateVisibleTiles(){let e=this._camera,t=Math.min(this._getTargetZoom(),this._maxZoomWithTilesLoading);return function*(e,t,i,r,s){if(0===s)return void(yield ml);let n=1<<s,o=n-1,{minX:a,maxX:l,minY:d,maxY:h}=t,c=Math.floor((a+1)*n/2),u=Math.floor((l+1)*n/2),_=u-c+1,p=new Array(_),m=new Array(_);p.fill(Math.floor((1-d)*n/2)),m.fill(Math.floor((1-h)*n/2));let f=e.length,g=e[f-1].x+1,v=1-e[f-1].y,y=Math.floor(g*n/2),x=Math.floor(v*n/2);for(let t=0;t<f;++t){let i=e[t].x+1,r=1-e[t].y,s=Math.floor(i*n/2),o=Math.floor(r*n/2),a=Math.abs(s-y)+Math.abs(o-x),l=i-g,d=r-v,h=l>0?1:-1,u=d>0?1:-1,_=2*h*d,f=-2*h*l,b=h*n*(l*v-d*g)+_*(~h>>>31);for(let e=0,t=y,i=x;e<a;++e){let e=_*t+f*i+b;0<=e&&e<=-f?t+=h:i+=u;let r=t-c;m[r]<i&&(m[r]=i),p[r]>i&&(p[r]=i)}g=i,v=r,y=s,x=o}if(2===i&&_>n)for(let e=0;e<n;++e)for(let t=e+n;t<_;t+=n)m[e]<m[t]&&(m[e]=m[t]),p[e]>p[t]&&(p[e]=p[t]);if(2===r)for(let e=0;e<_&&e<n;++e){let t=m[e]-p[e];if(t>n)p[e]=0,m[e]=o;else{let i=p[e]&=o;m[e]=i+t}}else for(let e=0;e<_&&e<n;++e)p[e]=Math.max(p[e],0),m[e]=Math.min(m[e],o);if(2===i)for(let e=0;e<_&&e<n;++e){let t=e+c&o;for(let i=p[e];i<=m[e];++i)yield{x:t,y:i&o,zoom:s}}else for(let e=Math.max(c,0),t=Math.min(u,o);e<=t;++e){let t=e-c;for(let i=p[t];i<=m[t];++i)yield{x:e,y:i&o,zoom:s}}}(er(e),fl(e),e.options.wrapModeX,e.options.wrapModeY,Math.max(0,t+this._zoomShift))}_getTargetZoom(){return Math.floor(this._camera.zoom+this._targetZoomShift)}}(t,i.tileSize,i.targetZoomShift,i.maxZoomWithTilesLoading),s=""){this._camera=t,this._communicator=e,this._options=i,this._visibleTilesCalculator=r,this._tileIdPrefix=s,this._visibleTiles=new Map,this.onViewportChanged=this._onViewportChanged=new wt;let n=Number(i.cameraIdleThrottling)||0;this._messageSender=n<=xl?new vl(e,t):new yl(e,t,n),this._onCameraUpdateWrapper=this._onCameraUpdate.bind(this),this._camera.onUpdate.addListener(this._onCameraUpdateWrapper),this._syncOptions()}destructor(){this.pause(),this._camera.onUpdate.removeListener(this._onCameraUpdateWrapper),this._messageSender.destroy()}forceCameraStateRecalculation(e=!1){this._onCameraUpdate(e)}pause(){this._camera.onUpdate.removeListener(this._onCameraUpdateWrapper),this._fireUpdates([],[...this._visibleTiles.values()],!0),this._visibleTiles.clear()}resume(){this._camera.onUpdate.addListener(this._onCameraUpdateWrapper),this.forceCameraStateRecalculation(!0)}_onCameraUpdate(e){let t=new Map;for(let e of this._visibleTilesCalculator.recalculateVisibleTiles()){let i=pl(e,this._tileIdPrefix);t.set(i.id,i)}let i=this._visibleTiles;this._visibleTiles=t;let r=Oo(t,i),s=Oo(i,t);(r.length>0||s.length>0)&&this._fireUpdates(r,s,e)}_syncOptions(){var e;this._communicator.sendMessage({type:0,tileIdPrefix:this._tileIdPrefix,preloadedTilesBeltWidth:this._options.preloadedTilesBeltWidth,useLowPrecisionBeltTiles:null==(e=this._options.useLowPrecisionBeltTiles)||e,wrapModeX:this._camera.options.wrapModeX,wrapModeY:this._camera.options.wrapModeY},!1)}_fireUpdates(e,t,i){this._onViewportChanged.fire({visibleAdded:e,visibleRemoved:t}),this._messageSender.sendMessageToBackend(e,t,i)}},vl=class{constructor(e,t){this._communicator=e,this._camera=t}sendMessageToBackend(e,t){bl(this._communicator,this._camera,e,t)}destroy(){}},yl=class{constructor(e,t,i){this._sendDelayedMessageToBackend=()=>{this._timerId=void 0,bl(this._communicator,this._camera,[...this._visibleTilesToAdd.values()],[...this._visibleTilesToRemove.values()]),this._visibleTilesToAdd.clear(),this._visibleTilesToRemove.clear()},this._timerId=void 0,this._visibleTilesToAdd=new Map,this._visibleTilesToRemove=new Map,this._communicator=e,this._camera=t,this._delay=i}sendMessageToBackend(e,t,i){clearTimeout(this._timerId),function(e,t,i,r){for(let r of i)t.delete(r.id)||e.set(r.id,r);for(let i of r)e.delete(i.id)||t.set(i.id,i)}(this._visibleTilesToAdd,this._visibleTilesToRemove,e,t),i?this._sendDelayedMessageToBackend():this._timerId=setTimeout(this._sendDelayedMessageToBackend,this._delay)}destroy(){clearTimeout(this._timerId)}},xl=10;function bl(e,t,i,r){e.sendMessage({type:1,cameraPosition:{x:t.center.x,y:t.center.y,zoom:t.zoom},visibleTilesToAdd:i,visibleTilesToRemove:r},!0)}var Tl=class{get size(){return this._items.size}get items(){return this._items.values()}constructor(){this._items=new Map,this.onAdded=this._onAdded=new wt,this.onRemoved=this._onRemoved=new wt}get(e){return this._items.get(e)}has(e){return this._items.has(e)}_add(e,t){this._items.set(e,t),this._onAdded.fire(t)}_remove(e){let t=this._items.get(e);return t&&(this._items.delete(e),this._onRemoved.fire(t)),t}destroy(){for(let[e]of this._items)this._remove(e);this._items.clear()}},wl=class extends Tl{constructor(e){super(),this._onMessage=e=>{switch(e.type){case 0:this._onAdd(e);break;case 1:this._onRemove(e)}},this._communicator=e,this._communicator.onMessage.addListener(this._onMessage)}destructor(){super.destroy(),this._communicator.onMessage.removeListener(this._onMessage)}_remove(e){let t=super._remove(e);return t&&this._destroy(t),t}_onAdd(e){this._add(e.id,this._deserialize(e.item))}_onRemove(e){this._remove(e.id)}};function*Cl(e,t){for(let i of e.references||[])i.type===t&&(yield i.value)}var Pl=class{constructor(e){this.content=this._content=e;for(let t of an(e.primitives)){let i=e.primitives[t];void 0!==i&&ls(i)}this.onContentAdded=this._onContentAdded=new wt,this.onContentRemoved=this._onContentRemoved=new wt}destroy(){for(let e of an(this._content.primitives)){let t=this._content.primitives[e];t&&ds(t)}}addContent(e,t){for(let t of an(e.primitives)){this._content.primitives[t]||(this._content.primitives[t]=this._createStorage());let i=e.primitives[t];i&&(ls(i),this._addPrimitives(this._content.primitives[t],i))}if(e.references&&(this._content.references=this._content.references||[],this._content.references.push(...e.references)),e.metadata){this._content.metadata=this._content.metadata||new Map;for(let[t,i]of e.metadata)this._content.metadata.set(t,i)}(e.placemarks||e.primitives[8]||e.primitives[6])&&(this._content.placemarks=this._content.placemarks||new ol,e.placemarks=function(e,t,i){t.placemarks&&e.addAll(t.placemarks);let r=!1,s=!1,n=new Set;for(let i of t.primitives[8]||[]){let t=i.conflictResolvingInfo.renderState.id,s=e.get(t);s?(s.icon=i.conflictResolvingInfo.renderState,n.add(t)):r=!0}for(let i of t.primitives[6]||[])for(let t of i.conflictResolvingInfos){let i=t.renderState.id,r=e.get(i);r?(r.label=t.renderState,n.add(i)):s=!0}r&&Ml(i,"placemark for icon not found"),s&&Ml(i,"placemark for label not found");let o=new ol;for(let t of n)o.add(e.get(t));return o}(this._content.placemarks,e,t)),this._onContentAdded.fire(this,e)}removeContent(e){for(let t of an(e.primitives)){let i=this._content.primitives[t],r=e.primitives[t];i&&r&&(this._removePrimitives(i,r),ds(r))}if(e.references&&this._content.references){let t=e.references||[];lt(this._content.references,t)}if(e.metadata&&this._content.metadata)for(let t of e.metadata.keys())this._content.metadata.delete(t);this._content.placemarks&&e.placemarks&&this._content.placemarks.removeAll(e.placemarks),this._onContentRemoved.fire(this,e)}},Sl=class extends Pl{_createStorage(){return[]}_addPrimitives(e,t){e.push(...t)}_removePrimitives(e,t){lt(e,t)}};function Ml(e,t){e({source:"updatePlacemarks",message:t})}var Rl=class extends Sl{constructor(e){super({primitives:{},references:[]}),this.id=e.id,this.tile=e}},Il=class extends wl{_deserialize(e){return new Rl(e)}_destroy(e){e.destroy()}};function Ll(e){let t="";for(let i=e.zoom;i>0;i--){let r="0",s=1<<i-1;e.x&s&&(r="1"),e.y&s&&(r="1"===r?"3":"2"),t+=r}return t}function El(e,t){let i=t.zoom-e.zoom;return i>0&&t.x>>i===e.x&&t.y>>i===e.y}var Al=class{constructor(e){this._onTileAdd=e=>{let t=this._isTileVisualizableFunc(e),i=this._getTileNode(e.tile);i.tile=e,i.isVisualizable=t,t&&this._visualizableTileNodeByQuadKey.set(i.quadKey,i),i.isVisible&&i.isVisualizable&&!i.isVisualized&&this._tryToVisualizeViewport(),e.onContentAdded.addListener(this._onTileContentAdded)},this._onTileContentAdded=e=>{let t=this._getTileNode(e.tile);t.isVisualizable=t.isVisualizable||this._isTileVisualizableFunc(e),t.isVisualizable&&this._visualizableTileNodeByQuadKey.set(t.quadKey,t),t.isVisible&&t.isVisualizable&&this._tryToVisualizeViewport()},this._onTileRemove=e=>{let t=this._getTileNode(e.tile);t.isVisible||(this._allTileNodes.delete(t.tileItem.id),this._visualizableTileNodeByQuadKey.delete(t.quadKey)),t.isVisualized&&this._makeNotVisualized(t),delete t.tile,e.onContentAdded.removeListener(this._onTileContentAdded)},this._onViewportUpdate=({visibleAdded:e,visibleRemoved:t})=>{for(let t of e){let e=this._getTileNode(t);this._makeVisible(e)}for(let e of t){let t=this._getTileNode(e);this._makeNotVisible(t)}if(e.length>0){let t=new Set,i=e[0].zoom;for(let e of this._visualizedTileNodes.values())t.add(e.tileItem.zoom);if(t.size<=2&&t.has(i+1))for(let e of this._visibleTileNodes.values())if(e.isVisualizable)this._makeVisualized(e);else for(let t=0;t<4;t++){let i=this._visualizableTileNodeByQuadKey.get(e.quadKey+t);i&&this._makeVisualized(i)}else if(t.size<=2&&t.has(i))for(let e of this._visibleTileNodes.values())if(e.isVisualizable)this._makeVisualized(e);else{let t=e.quadKey.slice(0,-1),i=this._visualizableTileNodeByQuadKey.get(t);if(i){let e=!0;for(let i=0;i<4;i++)this._visualizableTileNodeByQuadKey.get(t+i)&&(e=!1);e&&this._makeVisualized(i)}}}!this._changeModeTimer&&0===this._mode&&(this._changeModeTimer=setTimeout((()=>{this._mode=1,this._tryToVisualizeViewport()}),800)),this._tryToVisualizeViewport()},this._onViewportStateChanged=new wt,this._onViewportVisibilityChanged=new wt,this._viewportState={visibleTileNumber:0,visualizableTileNumber:0},this._allTileNodes=new Map,this._visualizableTileNodeByQuadKey=new Map,this._visibleTileNodes=new Map,this._visualizedTileNodes=new Map,this._onTileHidden=new wt,this._onTileVisualized=new wt,this._isViewportVisible=!1,this._mode=0,this._changeModeTimer=0,this._viewport=e.viewport,this._tileStorage=e.tileStorage,this._tileContentVisibilityManager=e.tileContentVisibilityManager,this._modelVisibilityManager=e.modelVisibilityManager,this._isTileVisualizableFunc=e.isTileVisualizable,this._visibilityThreshold=e.visibilityThreshold,this._viewport.onViewportChanged.addListener(this._onViewportUpdate),this._tileStorage.onAdded.addListener(this._onTileAdd),this._tileStorage.onRemoved.addListener(this._onTileRemove)}get viewportState(){return this._viewportState}get isViewportVisible(){return this._isViewportVisible}get onViewportStateChanged(){return this._onViewportStateChanged}get onViewportVisibilityChanged(){return this._onViewportVisibilityChanged}get onTileVisualized(){return this._onTileVisualized}get onTileHidden(){return this._onTileHidden}destructor(){this._viewport.onViewportChanged.removeListener(this._onViewportUpdate),this._tileStorage.onAdded.removeListener(this._onTileAdd),this._tileStorage.onRemoved.removeListener(this._onTileRemove),clearTimeout(this._changeModeTimer)}getVisualizedTiles(){return[...Ye(this._visualizedTileNodes.values(),(e=>e.tile))]}_tryToVisualizeViewport(){let e=this._visibleTileNodes.size;if(e===Ze(this._visibleTileNodes.values(),(e=>e.isVisualizable))){clearTimeout(this._changeModeTimer),this._changeModeTimer=0,this._mode=0;for(let e of this._visualizedTileNodes.values())e.isVisible||this._makeNotVisualized(e);for(let e of this._visibleTileNodes.values())this._makeVisualized(e)}else if(1===this._mode)for(let e of this._visibleTileNodes.values())if(!e.isVisualized&&e.isVisualizable){let t=!1;for(let i of this._visualizedTileNodes.values())if(El(e.tileItem,i.tileItem)||e.quadKey===i.quadKey)this._makeNotVisualized(i);else if(El(i.tileItem,e.tileItem)){let e=i,r=[];for(let t of this._visibleTileNodes.values())El(e.tileItem,t.tileItem)&&r.push(t);Xe(r,(e=>e.isVisualizable))?this._makeNotVisualized(e):t=!0}t||this._makeVisualized(e)}let t=Ze(this._visibleTileNodes.values(),(e=>e.isVisualized));this._updateViewportState(e,t)}_updateViewportState(e,t){if(e===this._viewportState.visibleTileNumber&&t===this._viewportState.visualizableTileNumber)return;this._viewportState.visibleTileNumber=e,this._viewportState.visualizableTileNumber=t,this._onViewportStateChanged.fire(this._viewportState);let i=this._isViewportVisible;this._isViewportVisible=function(e,t,i){return 0!==e&&0!==t&&(e===t||t/e>=i)}(e,t,this._visibilityThreshold),i!==this._isViewportVisible&&this._onViewportVisibilityChanged.fire(this._isViewportVisible)}_makeVisible(e){e.isVisible||(e.isVisible=!0,this._visibleTileNodes.set(e.id,e))}_makeNotVisible(e){e.isVisible&&(e.isVisible=!1,this._visibleTileNodes.delete(e.id))}_makeVisualized(e){let t=e.tile;e.isVisualizable&&!e.isVisualized&&t&&(this._tileContentVisibilityManager.showObject(t),this._modelVisibilityManager.showTileModels(t),e.isVisualized=!0,this._visualizedTileNodes.set(e.id,e),this._onTileVisualized.fire(t))}_makeNotVisualized(e){let t=e.tile;e.isVisualized&&t&&(this._tileContentVisibilityManager.hideObject(t),this._modelVisibilityManager.hideTileModels(t),e.isVisualized=!1,this._visualizedTileNodes.delete(e.id),this._onTileHidden.fire(t))}_getTileNode(e){let t=this._allTileNodes.get(e.id);if(t)return t;{let t={id:e.id,tileItem:e,quadKey:Ll(e),isVisualizable:!1,isVisible:!1,isVisualized:!1};return this._allTileNodes.set(e.id,t),t}}};var Ul=class{constructor(e,t,i){this._onMessage=e=>{switch(e.type){case 1:this._onAtlasAdd(e);break;case 2:this._onAtlasUpdate(e);break;case 3:this._onAtlasRemove(e)}},this._communicator=e,this._context=i,this._options=t,this._atlases=[],this._memoryUsage={memoryForGlyphs:0},this._onMemoryUsageChanged=new wt,this._communicator.onMessage.addListener(this._onMessage),this._syncOptions()}get memoryUsage(){return this._memoryUsage}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}destructor(){this._communicator.onMessage.removeListener(this._onMessage);for(let e of this._atlases)e.destructor();this._atlases.length=0}getAtlas(e){return this._atlases[e]}updateOption(e,t){this._options[e]=t,this._syncOptions()}_onAtlasAdd(e){this._atlases[e.atlasId]=new class{constructor(e,t,i){this._context=e,this.texture=e.createEmpty2DTexture(t,i,6406,5121,{wrapS:33071,wrapT:33071,magnificationFilter:9729,minificationFilter:9729,premultipliedAlpha:!1,unpackAlignment:1}),"string"==typeof navigator.vendor&&navigator.vendor.match(/^Apple/)&&this.updateContent(B(0,0),vr(1,1),new Uint8Array(1))}destructor(){this.texture.destroy()}updateContent(e,t,i){this._context.setTextureData(this.texture,i,e,t)}}(this._context,e.width,e.height)}_onAtlasUpdate(e){let{atlasId:t,data:i,offset:r,size:s}=e,n=this._atlases[t];cs(n)&&n.updateContent(r,s,i)}_onAtlasRemove(e){let t=this._atlases[e.atlasId];cs(t)&&(t.destructor(),delete this._atlases[e.atlasId])}_syncOptions(){this._communicator.sendMessage({type:0,options:this._options},!1)}},Ol=(Symbol.iterator,Symbol.iterator,J(Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER),class{constructor(e,t,i){this._onMessage=e=>{switch(e.type){case 1:this._onAddAtlas(e);break;case 2:this._onUpdateAtlas(e);break;case 3:this._onRemoveAtlas(e)}},this._communicator=e,this._context=i,this._options=t,this._atlases=[],this._memoryUsage={memoryForIcons:0},this._onMemoryUsageChanged=new wt,this._communicator.onMessage.addListener(this._onMessage),this._syncOptions()}get memoryUsage(){return this._memoryUsage}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}destructor(){this._communicator.onMessage.removeListener(this._onMessage);for(let e of this._atlases)e.destructor();this._atlases.length=0}getAtlas(e){return this._atlases[e]}updateOption(e,t){this._options[e]=t,this._syncOptions()}_onAddAtlas(e){this._atlases[e.atlasId]=new class{constructor(e,t,i){this._context=e,this.texture=e.createEmpty2DTexture(t,i,6408,5121,{wrapS:33071,wrapT:33071,magnificationFilter:9728,minificationFilter:9728,premultipliedAlpha:!0,unpackAlignment:1}),this.onContentUpdated=this._onContentUpdated=new wt}destructor(){this.texture.destroy()}updateContent(e){this._context.setTextureData(this.texture,e.data,e.offset,e.size),this._onContentUpdated.fire()}}(this._context,e.atlasWidth,e.atlasHeight)}_onUpdateAtlas(e){let t=this._atlases[e.atlasId];cs(t)&&t.updateContent(e.atlasRegion)}_onRemoveAtlas(e){let t=this._atlases[e.atlasId];cs(t)&&(t.destructor(),delete this._atlases[e.atlasId])}_syncOptions(){this._communicator.sendMessage({type:0,options:this._options},!1)}}),Vl=class extends Sl{constructor({id:e,options:t}){super({primitives:{}}),this.id=e,this.options=t}set lodId(e){this._lodId=e}get lodId(){return this._lodId}get lodInfo(){var e;return null==(e=this.options)?void 0:e.lodInfo}},Dl=class extends wl{_deserialize(e){return new Vl(e)}_destroy(e){e.destroy()}},zl="_vector_",Bl={objectId:"objectId",position:"position",priority:zl+"priority",zoom:zl+"zoom",iconUrl:zl+"iconUrl",selectedIconUrl:zl+"selectedIconUrl",richModel:zl+"richModel",footprintModelId:zl+"footprintModelId"};function Fl(e){return null==e?void 0:e.get(Bl.objectId)}var Nl=Ee(Ue()),kl=_e(),Hl=[0,1],jl=class{constructor(e,t,i){this._onModelAdded=e=>{this._addModelData(e),this._modelsToVisualizedTiles.has(e.id)&&this._showModel(e),e.lodInfo&&this._setLod(e)},this._onModelRemoved=e=>{this._removeModelData(e),this._modelsToVisualizedTiles.has(e.id)&&this._hideModel(e)},this._onCameraUpdate=()=>{for(let e of this._modelStorage.items)this._setLod(e)},this._modelsToVisualizedTiles=new Map,this._modelsData=new Map,this._modelFootprintFilter=new class{get onUpdate(){return this._onUpdate}constructor(){this._modelIds=new Set,this._onUpdate=new wt}test(e){let{metadata:t}=e;if(t){let e=t.get(Bl.footprintModelId);if(void 0!==e)return!this._modelIds.has(e)}return!0}addModelId(e){this._modelIds.add(e),this._onUpdate.fire()}removeModelId(e){this._modelIds.delete(e),this._onUpdate.fire()}reset(){this._modelIds.clear(),this._onUpdate.fire()}},this._onUpdateLod=new wt,this._contentVisibilityManager=e,this._modelStorage=t,this._camera=i,this._modelStorage.onAdded.addListener(this._onModelAdded),this._modelStorage.onRemoved.addListener(this._onModelRemoved);for(let e of Hl)this._contentVisibilityManager.addFilter(e,this._modelFootprintFilter);this._camera.onUpdate.addListener(this._onCameraUpdate)}get onUpdateLod(){return this._onUpdateLod}destructor(){this._camera.onUpdate.removeListener(this._onCameraUpdate);for(let e of Hl)this._contentVisibilityManager.removeFilter(e,this._modelFootprintFilter);this._modelFootprintFilter.reset(),this._modelStorage.onAdded.removeListener(this._onModelAdded),this._modelStorage.onRemoved.removeListener(this._onModelRemoved)}showTileModels(e){for(let t of Gl(e)){let i=Vo(this._modelsToVisualizedTiles,t,(()=>new Set));0===i.size&&this._tryToGetAndShowModel(t),i.add(e)}}hideTileModels(e){for(let t of Gl(e)){let i=this._modelsToVisualizedTiles.get(t);i&&(i.delete(e),0===i.size&&(this._modelsToVisualizedTiles.delete(t),this._tryToGetAndHideModel(t)))}}_addModelData(e){let t={contentAddedHandler:()=>{this._modelFootprintFilter.addModelId(e.id)},contentRemovedHandler:()=>{this._modelFootprintFilter.removeModelId(e.id)}};this._modelsData.set(e.id,t),e.onContentAdded.addListener(t.contentAddedHandler),e.onContentRemoved.addListener(t.contentRemovedHandler)}_removeModelData(e){let t=this._modelsData.get(e.id);this._modelsData.delete(e.id),e.onContentAdded.removeListener(t.contentAddedHandler),e.onContentRemoved.removeListener(t.contentRemovedHandler)}_tryToGetAndShowModel(e){let t=this._modelStorage.get(e);t&&this._showModel(t)}_tryToGetAndHideModel(e){let t=this._modelStorage.get(e);t&&this._hideModel(t)}_showModel(e){this._contentVisibilityManager.showObject(e),Wl(e)&&this._modelFootprintFilter.addModelId(e.id)}_hideModel(e){this._contentVisibilityManager.hideObject(e),Wl(e)&&this._modelFootprintFilter.removeModelId(e.id)}_setLod(e){if(!e.lodInfo)return;let{bbox:t,lods:i}=e.lodInfo,r=function(e,t){let i=Ee(t,Nl),r=ee();for(let t of i){let i=yn(e,t,kl);i&&oe(r,i,r)}return te(r)?0:(r.maxX-r.minX)*(r.maxY-r.minY)}(this._camera,t),s=function(e,t,i){for(let r=0;r<t.length;r++){let s=t[r].screenCoverage;if(t[r].id===i&&(s-=t[r].toleranceRange),e>=s)return r}return t.length-1}(r,i,e.lodId),n=i[s].id;n!==e.lodId&&(e.lodId=n,this._onUpdateLod.fire({modelId:e.id,lodId:n}))}};function*Gl(e){yield*Cl(e.content,"model")}function Wl(e){let{primitives:t}=e.content;return!(!t[3]&&!t[4])}var Yl=class e{constructor(){this._marks=new Map}mark(e){this._marks.set(e,Tr())}unmark(e){this._marks.delete(e)}measure(t,i=!1){let r=this._marks.get(t);return void 0!==r?(i||this.unmark(t),Tr()-r):e.UNMEASURED}};Yl.UNMEASURED=-1;var ql,Xl=Yl,Zl={postfix:"",reduce:e=>e[0]},$l={postfix:"Max",reduce:e=>e[e.length-1]},Ql={postfix:"Avg",reduce:e=>e.reduce(((e,t)=>e+t),0)/e.length},Kl=class{constructor(e,t,i=1,r=[Zl],s){this._transport=e,this._name=t,this._maxItems=i,this._reducers=r,this._additionalParams=s,this._values={},this._marker=new Xl}mark(e){this._marker.mark(e)}unmark(e){this._marker.unmark(e)}putMeasuredValue(e,t=e,i){let r=this._marker.measure(e,i);r!==Xl.UNMEASURED&&this.putValue(t,r)}putValue(e,t){let i=this._values[e];i||(i=this._values[e]=[]),i.length<this._maxItems&&i.push(t),function(e){return"function"==typeof e.putValue}(this._transport)&&this._transport.putValue(this._name,e,t,this._additionalParams)}putValues(e){for(let t of Object.keys(e)){let i=t,r=e[i];void 0!==r&&this.putValue(i,r)}}submit(){(function(e){return"function"==typeof e.submit})(this._transport)&&this._hasValues()&&this._transport.submit(this._name,this._getReducedValues()),this._clearValues()}_getReducedValues(){let e=f({},this._additionalParams);for(let t of Object.keys(this._values)){let i=t,r=this._values[i];if(r&&r.length>0){r.sort(((e,t)=>e-t));for(let t of this._reducers)e[i+t.postfix]=t.reduce(r).toFixed(2)}}return e}_hasValues(){return Object.keys(this._values).length>0}_clearValues(){this._values={}}},Jl=class{constructor(e,t,i,r,s,n,o){this._onTileRemoved=e=>{this._everVisibleTiles.delete(e.id)},this._onTileContentAdded=(e,t,i)=>{if(this._measuringTiles.has(e.id)){this._metrics.putValues(e.id,i),this._tileReadyChecker(e)&&this._metrics.measure(e.id,"tileReady");let r=t.primitives;(r[0]||r[1])&&this._metrics.measure(e.id,"polygonsReady"),(r[7]||r[6])&&this._metrics.measure(e.id,"labelsReady"),t.primitives[8]&&this._metrics.measure(e.id,"iconsReady")}},this._onViewportChanged=e=>{for(let t of e.visibleAdded)!this._everVisibleTiles.has(t.id)&&!this._storage.get(t.id)&&(this._everVisibleTiles.add(t.id),this._measuringTiles.add(t.id),this._metrics.addTilesToMeasure(t.id));for(let t of e.visibleRemoved)this._measuringTiles.delete(t.id)&&this._metrics.removeTileMeasurement(t.id)},this._storage=r,this._contentManager=s,this._viewport=n,this._tileReadyChecker=o,this._everVisibleTiles=new Set,this._measuringTiles=new Set;let a="vector."+t+".tile_processing";this._metrics=new ed(e,a,i,{visible:"1"}),r.onRemoved.addListener(this._onTileRemoved),s.onTileContentAdded.addListener(this._onTileContentAdded),n.onViewportChanged.addListener(this._onViewportChanged)}submit(){this._metrics.submit()}destructor(){this._storage.onRemoved.removeListener(this._onTileRemoved),this._contentManager.onTileContentAdded.removeListener(this._onTileContentAdded),this._viewport.onViewportChanged.removeListener(this._onViewportChanged)}},ed=class{constructor(e,t,i,r){let s=[Ql];this._metrics=new Kl(e,t,1024,s,f({firstViewport:"0"},r)),this._firstViewportMetrics=new Kl(e,t,1024,s,f({firstViewport:"1"},r)),this._firstViewportTiles=new Set,this._isFirstViewport=!0,this._camera=i}addTilesToMeasure(e){this._firstViewportState||(this._firstViewportState={x:this._camera.center.x,y:this._camera.center.y,zoom:this._camera.zoom}),this._isFirstViewport&&(this._firstViewportState.x!==this._camera.center.x||this._firstViewportState.y!==this._camera.center.y||this._firstViewportState.zoom!==this._camera.zoom)&&(this._isFirstViewport=!1),this._isFirstViewport?(this._firstViewportTiles.add(e),this._firstViewportMetrics.mark(e)):this._metrics.mark(e)}measure(e,t){this._firstViewportTiles.size>0&&this._firstViewportTiles.has(e)?this._firstViewportMetrics.putMeasuredValue(e,t,!0):this._metrics.putMeasuredValue(e,t,!0)}removeTileMeasurement(e){this._firstViewportTiles.size>0&&this._firstViewportTiles.delete(e)?this._firstViewportMetrics.unmark(e):this._metrics.unmark(e)}putValues(e,t){this._firstViewportTiles.size>0&&this._firstViewportTiles.has(e)?this._firstViewportMetrics.putValues(t):this._metrics.putValues(t)}submit(){this._firstViewportMetrics.submit(),this._metrics.submit()}},td=((ql=td||{})[ql.DEFAULT=0]="DEFAULT",ql[ql.NIGHT=1]="NIGHT",ql);var id=class{constructor(e){this.onUpdate=this._onUpdate=new wt,this._camera=e,this._onZoomUpdated=this._onZoomUpdated.bind(this),e.onUpdate.addListener(this._onZoomUpdated)}destructor(){this._camera.onUpdate.removeListener(this._onZoomUpdated)}test(e){return this._camera.zoom>=e.minZoom}_onZoomUpdated(){this._prevZoom!==this._camera.zoom&&(this._onUpdate.fire(),this._prevZoom=this._camera.zoom)}},rd=class{constructor(e){this._onCameraUpdate=()=>{this._screenBbox=fl(this._camera),this._onUpdate.fire()},this._onUpdate=new wt,this._camera=e,this._screenBbox=fl(this._camera),this._camera.onUpdate.addListener(this._onCameraUpdate)}destructor(){this._camera.onUpdate.removeListener(this._onCameraUpdate)}get onUpdate(){return this._onUpdate}test(e){return void 0!==e.instanceCount||this._isVisibleOnScreen(e)}_isVisibleOnScreen(e){return se(this._screenBbox,e.bbox)}},sd=class{constructor(e){this._onObjectAdded=e=>{this._onContentAdded(e,e.content),e.onContentAdded.addListener(this._onContentAdded),e.onContentRemoved.addListener(this._onContentRemoved)},this._onObjectRemoved=e=>{this._onContentRemoved(e,e.content),e.onContentAdded.removeListener(this._onContentAdded),e.onContentRemoved.removeListener(this._onContentRemoved)},this._onContentAdded=(e,t)=>{t.metadata&&this._addPrimitivesMetadata(t.metadata)},this._onContentRemoved=(e,t)=>{t.metadata&&this._removePrimitivesMetadata(t.metadata)},this._storages=e,this._index=new Map;for(let e of this._storages){for(let t of e.items)this._onObjectAdded(t);e.onAdded.addListener(this._onObjectAdded),e.onRemoved.addListener(this._onObjectRemoved)}}destructor(){for(let e of this._storages){for(let t of e.items)this._onObjectRemoved(t);e.onAdded.removeListener(this._onObjectAdded),e.onRemoved.removeListener(this._onObjectRemoved)}}getMetadata(e){var t;return null==(t=this._index.get(e))?void 0:t.metadata}_addPrimitivesMetadata(e){for(let[t,i]of e.entries())this._retain(t,i)}_removePrimitivesMetadata(e){for(let t of e.keys())this._release(t)}_retain(e,t){let i=this._index.get(e);i?i.count++:this._index.set(e,{metadata:t,count:1})}_release(e){let t=this._index.get(e);t&&(t.count--,0===t.count&&this._index.delete(e))}},nd=class extends Jr{constructor(e,t){super(t),this._appearingEffectDuration=e,this._timeoutIds=new Set,this._removeSchedulerFlagKey=Symbol("1"),this._scheduler=Qr(this._scheduleRemovePrimitives.bind(this),!0),this._scheduledForRemovePrimitives=[]}get primitives(){return this._primitives}addAll(e){super.addAll(e);for(let t of e){let e=t[this._removeSchedulerFlagKey];e&&e.isScheduledForRemove&&(e.isScheduledForRemove=!1)}}removeAll(e){this.hide(e);for(let t of e){let e=t[this._removeSchedulerFlagKey];e||(e={isScheduledForRemove:!0},t[this._removeSchedulerFlagKey]=e),e.isScheduledForRemove=!0}this._scheduledForRemovePrimitives.push(...e),this._scheduler()}destroy(){for(let e of this._timeoutIds)clearTimeout(e);super.destroy()}_scheduleRemovePrimitives(){let e=setTimeout((t=>{super.removeAll([...qe(t,(e=>{let t=e[this._removeSchedulerFlagKey];return void 0!==t&&t.isScheduledForRemove}))]),this._timeoutIds.delete(e)}),this._appearingEffectDuration,[...this._scheduledForRemovePrimitives]);this._scheduledForRemovePrimitives.length=0,this._timeoutIds.add(e)}},od=class{constructor(...e){this.onUpdate=this._onUpdate=new wt,this._filterUpdateListener=()=>this._onUpdate.fire();for(let t of e)t.onUpdate&&t.onUpdate.addListener(this._filterUpdateListener);this._filters=new Set(e)}addFilter(e){this._filters.has(e)||(this._filters.add(e),e.onUpdate&&e.onUpdate.addListener(this._filterUpdateListener),this._onUpdate.fire())}deleteFilter(e){this._filters.delete(e)&&(e.onUpdate&&e.onUpdate.removeListener(this._filterUpdateListener),this._onUpdate.fire())}test(e){return Xe(this._filters,(t=>t.test(e)))}},ad=class{constructor(e,t){this._onFilterUpdate=()=>{let e=[];for(let t of this._visible)this._filter.test(t)||e.push(t);let t=[];for(let e of this._hidden)this._filter.test(e)&&t.push(e);for(let t of e)this._visible.remove(t),this._hidden.add(t);for(let e of t)this._visible.add(e),this._hidden.remove(e);this._scene.removeAll(e),this._scene.addAll(t)},this._scene=e,this._filter=new od,this._visible=new t,this._hidden=new t,this._filter.onUpdate.addListener(this._onFilterUpdate)}addPrimitives(e){let t=[],i=[];for(let r of e)this._filter.test(r)?(t.push(r),this._visible.add(r)):(i.push(r),this._hidden.add(r));this._scene.addAll(t),this._scene.removeAll(i)}removePrimitives(e){this._scene.removeAll(e);for(let t of e)this._visible.remove(t),this._hidden.remove(t)}addFilter(e){this._filter.addFilter(e)}removeFilter(e){this._filter.deleteFilter(e)}},ld=class{constructor(e){this._onContentAdded=(e,t)=>{this._showObjectContent(e,t)},this._onContentRemoved=(e,t)=>{this._hideObjectContent(e,t)},this._scene=e,this._filteringManagers={}}destructor(){}addFilter(e,t){let i=this._filteringManagers[e];if(!i){let t=this._scene[e];i=function(e){return 110===e}(e)?new ad(t,ol):new ad(t,Zr),this._filteringManagers[e]=i}return i.addFilter(t),this}removeFilter(e,t){let i=this._filteringManagers[e];return i&&i.removeFilter(t),this}showObject(e){this._showObjectContent(e,e.content),e.onContentAdded.addListener(this._onContentAdded),e.onContentRemoved.addListener(this._onContentRemoved)}hideObject(e){this._hideObjectContent(e,e.content),e.onContentAdded.removeListener(this._onContentAdded),e.onContentRemoved.removeListener(this._onContentRemoved)}_showObjectContent(e,t){for(let e of an(t.primitives)){let i=t.primitives[e];if(i&&i.length>0){let t=this._filteringManagers[e];t?t.addPrimitives(i):this._scene[e].addAll(i)}}if(!t.placemarks)return;let i=this._filteringManagers[110];i?(i.removePrimitives(t.placemarks),i.addPrimitives(t.placemarks)):this._scene[110].addAll(t.placemarks)}_hideObjectContent(e,t){for(let e of an(t.primitives)){let i=t.primitives[e];if(i){let t=this._filteringManagers[e];t?t.removePrimitives(i):this._scene[e].removeAll(i)}}if(!t.placemarks)return;let i=this._filteringManagers[110];i?i.removePrimitives(t.placemarks):this._scene[110].removeAll(t.placemarks)}};var dd=class{setScreenBBox(e){this._screenBbox=e}},hd=_e(),cd=class extends dd{visible(e){if(void 0!==e.instanceCount)return!1;return function(e,t){return t.minX<=e.x&&e.x<=t.maxX&&t.minY<=e.y&&e.y<=t.maxY}(Ae(e.bbox,hd),this._screenBbox)}},ud=class extends dd{constructor(e){super(),this._cpuVisibilityManager=e}visible(e){var t;return null==(t=this._cpuVisibilityManager)||!t.isActive||void 0!==e.id&&this._cpuVisibilityManager.visibleScreenObjectIds.has(e.id)}},_d=class{constructor(e,t,i){var r,s;this._onCameraUpdate=()=>{this._screenBbox=fl(this._camera);let e=!1;Object.values(this._filteringStorages).forEach((t=>{e||(e=t.updateScreenBbox(this._screenBbox))})),e&&this._onUpdate.fire()},this._camera=t,this._cpuVisibilityManager=i,this._onUpdate=new wt;let n=new ud(this._cpuVisibilityManager);this._filteringStorages={icon:this._createStorage(e[8],n),label:this._createStorage(e[6],n),model:this._createStorage(e[4],new cd)},this._camera.onUpdate.addListener(this._onCameraUpdate),this._onCameraUpdate(),null==(r=this._cpuVisibilityManager)||r.onVisibleScreenObjectsChange.addListener(this._filteringStorages.icon.onObjectsUpdate),null==(s=this._cpuVisibilityManager)||s.onVisibleScreenObjectsChange.addListener(this._filteringStorages.label.onObjectsUpdate)}destructor(){var e,t;this._camera.onUpdate.removeListener(this._onCameraUpdate),null==(e=this._cpuVisibilityManager)||e.onVisibleScreenObjectsChange.removeListener(this._filteringStorages.icon.onObjectsUpdate),null==(t=this._cpuVisibilityManager)||t.onVisibleScreenObjectsChange.removeListener(this._filteringStorages.label.onObjectsUpdate),Object.values(this._filteringStorages).forEach(Ba)}get onUpdate(){return this._onUpdate}getVisibleObjects(){let e=[],t=new Map;Object.entries(this._filteringStorages).forEach((([i,r])=>{let s=r.visibleObjects;for(let{metadata:r}of s){let s=Fl(r);if(s){if("model"===i){e.push({objectId:s,metadata:r,type:"model"});continue}t.has(s)||t.set(s,{metadata:r,icon:!1,label:!1}),t.get(s)[i]=!0}}}));for(let[i,{metadata:r,icon:s,label:n}]of t)e.push({objectId:i,metadata:r,type:s&&n?"icon-label":n?"label":"icon"});return e}_createStorage(e,t){return new pd(e,this._onUpdate,t)}},pd=class{constructor(e,t,i){this.onObjectsUpdate=()=>{if(!this._filter)return void this._onUpdate.fire();let e=!1,t=new Set;for(let i of this._storage.primitives){let r=Fl(i.metadata);r&&(t.add(r),this._isVisible(i)?this._visible.has(r)||(this._moveToVisible(i),e=!0):(this._visible.has(r)&&(e=!0),this._moveToHidden(i)))}for(let i of this._visible.keys())t.has(i)||(this._visible.delete(i),e=!0);for(let e of this._hidden.keys())t.has(e)||this._hidden.delete(e);e&&this._onUpdate.fire()},this._storage=e,this._onUpdate=t,this._visible=new Map,this._hidden=new Map,this._filter=i,this._storage.onUpdate.addListener(this.onObjectsUpdate)}destroy(){this._storage.onUpdate.removeListener(this.onObjectsUpdate)}get visibleObjects(){return this._visible.values()}updateScreenBbox(e){if(!this._filter)return!1;this._filter.setScreenBBox(e);let t=!1;for(let e of this._visible.values())this._isVisible(e)||(this._moveToHidden(e),t=!0);for(let e of this._hidden.values())this._isVisible(e)&&(this._moveToVisible(e),t=!0);return t}_isVisible(e){return this._filter.visible(e)}_moveToVisible(e){let t=Fl(e.metadata);this._hidden.delete(t),this._visible.set(t,e)}_moveToHidden(e){let t=Fl(e.metadata);this._visible.delete(t),this._hidden.set(t,e)}},md=class{constructor(){this._data=[]}[Symbol.iterator](){return this._data[Symbol.iterator]()}get length(){return this._data.length}add(e){e.retain(),this._data.push(e)}clear(){ds(this._data),this._data.length=0}},fd=class{constructor(e,t,i,r,s,n,o,a){this._onMemoryUsageComponentChange=e=>{Object.assign(this._memoryUsage,e),this._onMemoryUsageChanged.fire(this._memoryUsage)},this._isPaused=!1,this.name=e,this._context=t,this._camera=i,this._gpuMemoryRegistry=r,this._glyphAtlasRegistry=s,this._iconAtlasRegistry=n,this._objectMetadataIndex=o,this.scene=this._createScene(),this._contentVisibilityManager=new ld(this.scene),this._reportedVisibilityManager=new _d(this.scene,this._camera,a),this.memoryUsage=this._memoryUsage=f(f({},this._glyphAtlasRegistry.memoryUsage),this._iconAtlasRegistry.memoryUsage),this._onMemoryUsageChanged=new wt}get isPaused(){return this._isPaused}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}get onVisibleObjectsChanged(){return this._reportedVisibilityManager.onUpdate}destructor(){this._contentVisibilityManager.destructor(),this._reportedVisibilityManager.destructor()}getObjectMetadata(e){return this._objectMetadataIndex.getMetadata(e)}getVisibleObjects(){return this._reportedVisibilityManager.getVisibleObjects()}pause(){this._isPaused=!0}resume(){this._isPaused=!1}_createScene(){return{100:new Kr,110:new ol,0:new Kr,1:new Kr,2:new Kr,5:new Kr,3:new Kr,4:new Kr,6:new nd(150),7:new nd(150),8:new nd(150),120:new md,121:new md,122:new md}}_createAdditionalMetadata(){return new Map([[zl+"layerName",this.name]])}},gd=class{constructor(e){this._communicator=e,this._geometryIds=new WeakMap,this._currentId=1}addGeometry(e){let t=this._geometryIds.get(e);t||(t=this._currentId++,this._geometryIds.set(e,t)),this._communicator.sendMessage({type:0,id:t,geometry:e},!1)}removeGeometry(e){let t=this._geometryIds.get(e);t&&(this._geometryIds.delete(e),this._communicator.sendMessage({type:1,id:t},!1))}},vd="start",yd=class{constructor(e,t,i,r){this._onViewportVisibilityChanged=e=>{this._isFirstViewport&&e.visualizableTileNumber===e.visibleTileNumber&&this._onFirstViewportReady()},this._onViewportChanged=e=>{this._isFirstViewport&&e.visibleAdded.length+e.visibleRemoved.length>0&&this._onFirstViewportLeft(),!this._isFirstViewport&&e.visibleAdded.length>0&&(this._isFirstViewport=!0)},this._viewport=i,this._viewportVisibility=r,this._isFirstViewport=!1,this._metrics=new Kl(t,`vector.${e}.viewport`,32),this._metrics.mark(vd),this._subscribeToViewports()}destructor(){this._unsubscribeFromViewports()}submit(){this._metrics.submit()}_onFirstViewportLeft(){this._metrics.putMeasuredValue(vd,"firstViewportLeft"),this._unsubscribeFromViewports()}_onFirstViewportReady(){this._metrics.putMeasuredValue(vd,"firstViewportReady"),this._unsubscribeFromViewports()}_subscribeToViewports(){this._viewport.onViewportChanged.addListener(this._onViewportChanged),this._viewportVisibility.onViewportStateChanged.addListener(this._onViewportVisibilityChanged)}_unsubscribeFromViewports(){this._viewport.onViewportChanged.removeListener(this._onViewportChanged),this._viewportVisibility.onViewportStateChanged.removeListener(this._onViewportVisibilityChanged)}};function xd(e){let t=setInterval(e,5e3);return window.addEventListener("beforeunload",e),()=>{clearInterval(t)}}var bd=Td(0,0,0,0);function Td(e,t,i,r){return{x:e,y:t,z:i,w:r}}var wd=class{get roofLightAmount(){return this._roofLightAmount}constructor(e){this._params=function({intensity:e,thetaDegrees:t,phiDegrees:i}){let r=bt(t),s=bt(i);return Td(e*Math.sin(r)*Math.cos(s),e*Math.sin(r)*Math.sin(s),e*Math.cos(r),1-e*Math.cos(r))}(e),this._roofLightAmount=this.getLightAmount(ge)}getParams(){return this._params}getLightAmount(e){return Math.max(0,Pe(this._params,e))+this._params.w}},Cd=new wd({intensity:.21,thetaDegrees:35,phiDegrees:-90}),Pd=new wd({intensity:.34,thetaDegrees:35,phiDegrees:-90});function Sd(e){switch(e){case 0:return Cd;case 1:return Pd;default:throw new Error(`Models light for ${e} in not defined`)}}var Md=class extends fd{constructor(e,t,i,r,s,n,o,a){let l=f({dpr:gr()},s),d=new ka(e),h=new Il(d.getCommunicator(1)),c=new Dl(d.getCommunicator(2));super(n,i,t,r,new Ul(d.getCommunicator(4),l,i),new Ol(d.getCommunicator(5),l,i),new sd([h,c]),a),this._submitMetrics=()=>{this._metricsCollector.submit(),this._viewportMetricsCollector.submit()},this._updateLodHandler=e=>{this._tileContentManager.updateLod(e)},this._tileGeneration=0,this._currentLight=Sd(0),this._options=l,this._commutator=d,this._storage=h,this._modelStorage=c,this._viewport=new gl(this._commutator.getCommunicator(0),t,this._options),this._tileModelVisibilityManager=new jl(this._contentVisibilityManager,this._modelStorage,t),this._tileContentClipper=new gd(this._commutator.getCommunicator(6)),this._tileContentManager=this._createContentManager(),this._tileModelVisibilityManager.onUpdateLod.addListener(this._updateLodHandler),this._zoomFilter=new id(this._camera),this._richModelVisibilityFilter=new rd(this._camera),this._addVisibilityFilters(),this._visibilityManager=this._createViewportVisibilityManager(),this._metricsCollector=new Jl(o,n,t,this._storage,this._tileContentManager,this._viewport,(e=>this._isTileVisualizable(e))),this._viewportMetricsCollector=new yd(n,o,this._viewport,this._visibilityManager),this._recalculateViewport(),this._stopSubmittingMetrics=xd(this._submitMetrics)}get visibilityManager(){return this._visibilityManager}get isViewportVisible(){return this._visibilityManager.isViewportVisible}get onViewportVisibilityChanged(){return this._visibilityManager.onViewportVisibilityChanged}get onError(){return this._tileContentManager.onError}get onContentError(){return this._tileContentManager.onContentError}get lightProvider(){return()=>this._currentLight.getParams()}get options(){return this._options}get tileStorage(){return this._storage}get modelStorage(){return this._modelStorage}destructor(){this._stopSubmittingMetrics(),this._removeVisibilityFilters(),this._zoomFilter.destructor(),this._richModelVisibilityFilter.destructor(),this._tileModelVisibilityManager.destructor(),this._viewport.destructor(),this._metricsCollector.destructor(),this._viewportMetricsCollector.destructor(),this._storage.destructor(),this._modelStorage.destructor(),this._tileModelVisibilityManager.onUpdateLod.removeListener(this._updateLodHandler),this._tileContentManager.destructor(),this._visibilityManager.destructor(),this._contentVisibilityManager.destructor(),this._iconAtlasRegistry.destructor(),this._glyphAtlasRegistry.destructor(),this._objectMetadataIndex.destructor(),this._commutator.destructor()}pause(){this._viewport.pause(),super.pause()}resume(){this._viewport.resume(),super.resume()}updateUrlTemplates(e){let{iconUrlTemplate:t,glyphRangeUrlTemplate:i,tileUrlTemplate:r,meshUrlTemplate:s,richModelUrlTemplate:n}=e;t&&(this._iconAtlasRegistry.updateOption("iconUrlTemplate",t),this._options.iconUrlTemplate=t),i&&(this._glyphAtlasRegistry.updateOption("glyphRangeUrlTemplate",i),this._options.glyphRangeUrlTemplate=i),r&&(this._tileContentManager.updateOption("tileUrlTemplate",r),this._options.tileUrlTemplate=r),s&&(this._tileContentManager.updateOption("meshUrlTemplate",s),this._options.meshUrlTemplate=s),n&&(this._tileContentManager.updateOption("richModelUrlTemplate",n),this._options.richModelUrlTemplate=n),this._tileGeneration++,this._recalculateViewport()}setMapMode(e){e!==this._options.mapMode&&(this._currentLight=Sd(e),this._tileContentManager.updateOption("mapMode",e),this._options.mapMode=e,this._recalculateViewport())}updateCustomizationConfig(e){let t=[],i=!1;!function(e){return!Array.isArray(e)}(e)?t=e:(e.style&&(t=e.style),i="off"===e["render-3d"]),this._tileContentManager.updateCustomizationConfig(t),this._options.customizationConfig=t,this._options.disable3d=i,this._tileContentManager.updateOption("disable3d",i),this._tileGeneration++,this._recalculateViewport()}addVisibilityFilter(e,t){return this._contentVisibilityManager.addFilter(e,t),this}removeVisibilityFilter(e,t){return this._contentVisibilityManager.removeFilter(e,t),this}addTileContentClipperGeometry(e){this._tileContentClipper.addGeometry(e),this._tileGeneration++,this._recalculateViewport()}removeTileContentClipperGeometry(e){this._tileContentClipper.removeGeometry(e),this._tileGeneration++,this._recalculateViewport()}_createViewportVisibilityManager(){return new Al({viewport:this._viewport,tileStorage:this._storage,tileContentVisibilityManager:this._contentVisibilityManager,modelVisibilityManager:this._tileModelVisibilityManager,isTileVisualizable:e=>this._isTileVisualizable(e),visibilityThreshold:Rd(this._options.viewportVisibleTilesRatioThreshold)})}_isTileVisualizable(e){return!(!e.content.primitives[0]&&!e.content.primitives[1]||!e.content.primitives[6]&&!e.content.primitives[7])}_createContentManager(){return new dl(this._commutator.getCommunicator(3),this._storage,this._modelStorage,this._context,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata())}_addVisibilityFilters(){this._contentVisibilityManager.addFilter(6,this._zoomFilter).addFilter(7,this._zoomFilter).addFilter(8,this._zoomFilter).addFilter(110,this._zoomFilter).addFilter(4,this._richModelVisibilityFilter)}_removeVisibilityFilters(){this._contentVisibilityManager.removeFilter(6,this._zoomFilter).removeFilter(7,this._zoomFilter).removeFilter(8,this._zoomFilter).removeFilter(110,this._zoomFilter).removeFilter(4,this._richModelVisibilityFilter)}_recalculateViewport(){this._viewport.tileIdPrefix=this._getTileIdPrefix(),this._viewport.forceCameraStateRecalculation()}_getTileIdPrefix(){let e=1===this._options.mapMode?"night_":"";return this._getCustomTileIdPrefix()+e+this._tileGeneration.toString()}_getCustomTileIdPrefix(){return""}};function Rd(e){return Number.isFinite(e)?vt(e,0,1):1}var Id="indoor_plan",Ld=class{constructor(e,t,i,r){if(this.id=e,0===t.length)throw new Error("No levels provided for a plan");this.levels=t;let s=this._selectLevelById(t,i);if(!s)throw new Error("Cannot find default level");this.defaultLevel=this._activeLevel=s,this.bbox=r,this.onActiveLevelChange=this._onActiveLevelChange=new wt,this.onVisibilityChange=this._onVisibilityChange=new wt,this.onOpacityChange=this._onOpacityChange=new wt,this._isVisible=!1,this._opacity=1}get activeLevel(){return this._activeLevel}setActiveLevel(e){let t=this._selectLevelById(this.levels,e);if(t&&t!==this._activeLevel){let e=this._activeLevel;this._activeLevel=t,this._onActiveLevelChange.fire({previousLevel:e,currentLevel:t},this)}}get isVisible(){return this._isVisible}set isVisible(e){e!==this._isVisible&&(this._isVisible=e,this._onVisibilityChange.fire(e,this))}get opacity(){return this._opacity}set opacity(e){e!==this._opacity&&(this._opacity=e,this._onOpacityChange.fire(e,this))}_selectLevelById(e,t){return e.find((e=>e.id===t))}},Ed=class{constructor(e){this._onPlanAdded=e=>{e.onVisibilityChange.addListener(this._onPlanVisibilityChange),e.onActiveLevelChange.addListener(this._onPlanLevelChange),e.isVisible&&this._fireUpdate()},this._onPlanRemoved=e=>{e.isVisible&&this._fireUpdate(),e.onActiveLevelChange.removeListener(this._onPlanLevelChange),e.onVisibilityChange.removeListener(this._onPlanVisibilityChange)},this._onPlanVisibilityChange=()=>{this._fireUpdate()},this._onPlanLevelChange=(e,t)=>{t.isVisible&&this._fireUpdate()},this._planRegistry=e,this.onUpdate=this._onUpdate=new wt,this._metaKey=Symbol(),this._currentVersion=0,this._planRegistry.onPlanAdded.addListener(this._onPlanAdded),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved)}destructor(){this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved),this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.getAllPlans().forEach((e=>{e.onActiveLevelChange.removeListener(this._onPlanLevelChange),e.onVisibilityChange.removeListener(this._onPlanVisibilityChange)}))}test(e){let t=e[this._metaKey];if(t&&t.version===this._currentVersion)return t.result;let i=this._test(e);return t?t.result=i:e[this._metaKey]={version:this._currentVersion,result:i},i}_test(e){let{metadata:t}=e;if(!t)return!1;let i=t.get("indoor_plan_id");if(!i)return!1;let r=i&&this._planRegistry.getPlan(i);if(!r)return!1;let s=t.get("indoor_level_id");return!!s&&(r.isVisible&&r.activeLevel.id===s)}_fireUpdate(){this._currentVersion++,this._onUpdate.fire()}},Ad=class extends Ed{_test(e){var t;return null==(t=e.metadata)||!t.has("indoor_plan_id")||super._test(e)}},Ud=class{constructor(e,t,i,r){this._updateCoveredByIndoorFilter=(e=-this._visibleIndoorPlans.visiblePlans.size)=>{this._coveredByIndoorFilter.applyPlansCountDelta(e)},this._onPlanAdded=e=>{this._onPlansChanged.fire(this._planRegistry.getAllPlans())},this._onPlanRemoved=e=>{this._onPlansChanged.fire(this._planRegistry.getAllPlans())},this._onPlansChanged=new wt,this._coveredByIndoorFilter=i,this._contentVisibilityManager=r,this._planRegistry=new class{constructor(e,t){this._onMessage=e=>{switch(e.type){case 1:this._onAdd(e);break;case 2:this._onDestroy(e)}},this._communicator=e,this._plans=new Map,this.onPlanAdded=this._onPlanAdded=new wt,this.onPlanRemoved=this._onPlanRemoved=new wt,this._communicator.onMessage.addListener(this._onMessage),this._communicator.sendMessage({type:0,options:t},!0)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getPlan(e){return this._plans.get(e)}getAllPlans(){return[...this._plans.values()]}_onAdd(e){let{planId:t,levels:i,defaultLevelId:r,boundary:s}=e,n=new Ld(t,i,r,s);this._plans.set(t,n),this._onPlanAdded.fire(n)}_onDestroy(e){let t=this._plans.get(e.planId);cs(t)&&(this._plans.delete(e.planId),this._onPlanRemoved.fire(t))}}(e,t),this._planRegistry.onPlanAdded.addListener(this._onPlanAdded),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved),this._visibleIndoorPlans=new class{constructor(e){this._onTileVisualized=e=>{for(let t of Cl(e.content,Id))this._retainPlan(t)},this._onTileHidden=e=>{for(let t of Cl(e.content,Id))this._releasePlan(t)},this._onPlanAdded=e=>{this._allPlans.add(e),e.onVisibilityChange.addListener(this._onPlanVisibilityChange),this._onPlanVisibilityChange(e.isVisible,e)},this._onPlanRemoved=e=>{this._allPlans.delete(e),e.onVisibilityChange.removeListener(this._onPlanVisibilityChange)},this._onPlanVisibilityChange=(e,t)=>{this._updatePlanVisibility(t.id)},this._viewports=[],this._planRegistry=e,this._planRefCounts=new Map,this._visiblePlans=new Map,this._allPlans=new Set,this._onVisiblePlansChanged=new wt,this._planRegistry.onPlanAdded.addListener(this._onPlanAdded),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved);for(let t of e.getAllPlans())this._onPlanAdded(t)}destructor(){this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved);for(let e of this._viewports)this.removeViewport(e);for(let e of this._allPlans)e.onVisibilityChange.removeListener(this._onPlanVisibilityChange)}get visiblePlans(){return this._visiblePlans}get onVisiblePlansChanged(){return this._onVisiblePlansChanged}addViewport(e){e.onTileVisualized.addListener(this._onTileVisualized),e.onTileHidden.addListener(this._onTileHidden);for(let t of e.getVisualizedTiles())this._onTileVisualized(t)}removeViewport(e){e.onTileVisualized.removeListener(this._onTileVisualized),e.onTileHidden.removeListener(this._onTileHidden);for(let t of e.getVisualizedTiles())this._onTileHidden(t)}_retainPlan(e){let t=this._planRefCounts.get(e)||0;this._planRefCounts.set(e,t+1),this._updatePlanVisibility(e)}_releasePlan(e){let t=this._planRefCounts.get(e)||0;t>1?this._planRefCounts.set(e,t-1):this._planRefCounts.delete(e),this._updatePlanVisibility(e)}_updatePlanVisibility(e){let t=this._planRegistry.getPlan(e),i=this._planRefCounts.get(e)||0,r=this._visiblePlans.size;i>0&&t&&t.isVisible?this._visiblePlans.set(e,t):this._visiblePlans.delete(e),this._visiblePlans.size!==r&&this._onVisiblePlansChanged.fire(this._visiblePlans.size-r)}}(this._planRegistry),this._visibleIndoorPlans.onVisiblePlansChanged.addListener(this._updateCoveredByIndoorFilter),this._indoorFilter=new Ad(this._planRegistry),function(e,t){for(let i of Od)e.addFilter(i,t)}(this._contentVisibilityManager,this._indoorFilter),this._updateCoveredByIndoorFilter()}get onPlansChanged(){return this._onPlansChanged}get plans(){return this._planRegistry.getAllPlans()}destroy(){(function(e,t){for(let i of Od)e.removeFilter(i,t)})(this._contentVisibilityManager,this._indoorFilter),this._visibleIndoorPlans.onVisiblePlansChanged.removeListener(this._updateCoveredByIndoorFilter),this._visibleIndoorPlans.destructor(),this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved),this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.destructor(),this._updateCoveredByIndoorFilter()}addViewport(e){this._visibleIndoorPlans.addViewport(e)}removeViewport(e){this._visibleIndoorPlans.removeViewport(e)}pause(){this._updateCoveredByIndoorFilter()}resume(){this._updateCoveredByIndoorFilter()}};var Od=[5,0,1,6,7,8,110],Vd=class extends Md{constructor(e,t,i,r,s,n,o,a,l){super(t,i,r,s,n,e,o,l),this._indoorManager=new Ud(this._commutator.getCommunicator(8),this._options,a,this._contentVisibilityManager),this._indoorManager.addViewport(this.visibilityManager)}get onPlansChanged(){return this._indoorManager.onPlansChanged}get plans(){return this._indoorManager.plans}destructor(){this._indoorManager.destroy(),super.destructor()}pause(){this._indoorManager.pause(),super.pause()}resume(){super.resume(),this._indoorManager.resume()}},Dd=class{constructor(){this._isActive=!1,this._plansCount=0,this.onUpdate=this._onUpdate=new wt}applyPlansCountDelta(e){this._plansCount+=e,this._setActive(this._plansCount>0)}test(e){let{metadata:t}=e;return!(this._isActive&&t&&"true"===t.get("indoor_covered"))}_setActive(e){this._isActive!==e&&(this._isActive=e,this._onUpdate.fire())}},zd=class extends al{constructor(e,t,i,r,s,n,o,a,l){super(i,r,s,n,a),this._onMessage=e=>{switch(e.type){case 2:this._onAddPrimitives(e);break;case 3:this._onRemovePrimitives(e)}},this._reportContentErrorHandler=e=>{this._onContentError(g(f({},e),{source:`GraphicsContentManager/${e.source}`}))},this._communicator=e,this._options=o,this._detalizationStorage=t,this._onContentAdded=this.onContentAdded=new wt,this._onContentError=l,this._communicator.onMessage.addListener(this._onMessage),this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}updateOption(e,t){this._options[e]=t,this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1)}_onAddPrimitives(e){let t=this._detalizationStorage.get(e.levelId);if(cs(t)){let i=this._instantiatePrimitives(e.content,t.zoom);t.addContent(i,this._reportContentErrorHandler),this._onContentAdded.fire(t,i,e.metrics)}}_onRemovePrimitives(e){let t=this._detalizationStorage.get(e.levelId);if(cs(t)){let i={primitives:{},references:[]};for(let r of e.content)i.primitives[r]=t.content.primitives[r];t.removeContent(i)}}},Bd=class extends wl{constructor(e,t){super(e),this._groupStorage=t}_deserialize({id:e,parentId:t}){let i=this._groupStorage.get(t);if(!i)throw new Error(`Parent ${t} for object ${e} is not found`);return new class{constructor(e,t){this.type=0,this.id=e,this.parent=t,this._onActiveDetalizationChanged=new wt,this._latestActiveDetalizationVersion=-1,this._detalizationLevels=new Set}get activeDetalizationLevel(){return this._activeDetalizationLevel}set activeDetalizationLevel(e){if(e!==this._activeDetalizationLevel){let t=this._activeDetalizationLevel;this._activeDetalizationLevel=e,e&&e.version>this._latestActiveDetalizationVersion&&(this._latestActiveDetalizationVersion=e.version),this._onActiveDetalizationChanged.fire(this,t,this._activeDetalizationLevel)}}get onActiveDetalizationChanged(){return this._onActiveDetalizationChanged}get latestActiveDetalizationVersion(){return this._latestActiveDetalizationVersion}get detalizationLevels(){return this._detalizationLevels}addDetalizationLevel(e){this._detalizationLevels.add(e)}removeDetalizationLevel(e){this._detalizationLevels.delete(e)}}(e,i)}_add(e,t){t.parent.addChild(t),super._add(e,t)}_remove(e){let t=this.get(e);return t&&t.parent.removeChild(t),super._remove(e),t}_destroy(e){}},Fd=class extends Pl{constructor(e){super({primitives:{}}),this.type=0,this.zIndex=e,this.levelIds=new Set}_createStorage(){return new Zr}_addPrimitives(e,t){for(let i of t)e.add(i)}_removePrimitives(e,t){for(let i of t)e.remove(i)}},Nd=class{constructor(e,t,i,r){this._onChildUpdate=()=>{this._onUpdate.fire()},this._onChildActiveLevelChanged=(e,t,i)=>{t&&(t.onContentAdded.removeListener(this._onChildContentAdded),t.onContentRemoved.removeListener(this._onChildContentRemoved),t.hasContent&&this._onChildContentRemoved(t,t.content),this._removeLevelBatch(t.id)),i&&(i.onContentAdded.addListener(this._onChildContentAdded),i.onContentRemoved.addListener(this._onChildContentRemoved),i.hasContent&&this._onChildContentAdded(i,i.content))},this._onChildContentAdded=(e,t)=>{this._addContentToBatch(e.id,t,e.zIndex),this._onChildUpdate()},this._onChildContentRemoved=(e,t)=>{this._removeContentFromBatch(e.id,t),this._onChildUpdate()},this._reportContentErrorHandler=e=>{this._onContentError(g(f({},e),{source:`GraphicsGroup/${e.source}`}))},this.type=1,this.id=e,this.zIndex=t.zIndex,this.opacity=t.opacity,this.parent=i,this._children=new Set,this._batchedChildren=[],this._batchesByLevelIds=new Map,this.onUpdate=this._onUpdate=new wt,this._onContentError=r}get children(){return this._children}get batchedChildren(){return this._batchedChildren}addChild(e){this._children.add(e),0===e.type?(e.onActiveDetalizationChanged.addListener(this._onChildActiveLevelChanged),e.activeDetalizationLevel&&this._onChildActiveLevelChanged(e,void 0,e.activeDetalizationLevel)):(e.onUpdate.addListener(this._onChildUpdate),this._addGroupBatch(e),this._onChildUpdate())}removeChild(e){this._children.delete(e)&&(0===e.type?(e.onActiveDetalizationChanged.removeListener(this._onChildActiveLevelChanged),e.activeDetalizationLevel&&this._onChildActiveLevelChanged(e,e.activeDetalizationLevel,void 0)):(e.onUpdate.removeListener(this._onChildUpdate),this._removeBatchedChild(e),this._onChildUpdate()))}_addContentToBatch(e,t,i){let r=this._getBatchIndex(i),s=this._batchedChildren[r-1],n=s&&0===s.type&&s.zIndex===i,o=n?s:new Fd(i);n||this._batchedChildren.splice(r,0,o),this._batchesByLevelIds.set(e,o),o.addContent(t,this._reportContentErrorHandler),o.levelIds.add(e)}_removeContentFromBatch(e,t){let i=this._batchesByLevelIds.get(e);i&&i.removeContent(t)}_removeLevelBatch(e){let t=this._batchesByLevelIds.get(e);t&&(t.levelIds.delete(e),0===t.levelIds.size&&this._removeBatchedChild(t),this._batchesByLevelIds.delete(e))}_addGroupBatch(e){let t=this._getBatchIndex(e.zIndex);this._batchedChildren.splice(t,0,e)}_removeBatchedChild(e){let t=this._batchedChildren.indexOf(e);t>-1&&this._batchedChildren.splice(t,1)}_getBatchIndex(e){let t=this._batchedChildren.findIndex((t=>t.zIndex>e));return-1===t?this._batchedChildren.length:t}},kd=class extends wl{constructor(e,t){super(e),this._onContentError=t}_deserialize({id:e,style:t,parentId:i}){let r=null===i?null:this.get(i);if(void 0===r)throw new Error(`Parent ${i} for group ${e} is not found`);return new Nd(e,t,r,this._onContentError)}_add(e,t){t.parent&&t.parent.addChild(t),super._add(e,t)}_remove(e){let t=this.get(e);return t&&t.parent&&t.parent.removeChild(t),super._remove(e),t}_destroy(e){}};function Hd(e){return!!(e.content.primitives[5]||e.content.primitives[0]||e.content.primitives[1]||e.content.primitives[8])}var jd={zIndex:0,simplificationRate:0},Gd={zIndex:0,opacity:1},Wd=class extends Sl{constructor(e,t,i,r,s){super({primitives:{}}),this.object=t,this.zoom=r,this.zIndex=i,this.version=s,this.id=e,this._hasContent=!1}get hasContent(){return this._hasContent}addContent(e,t){this._hasContent=!0,super.addContent(e,t)}},Yd=class extends wl{constructor(e,t){super(e),this._objectStorage=t}_deserialize({id:e,objectId:t,zoom:i,zIndex:r,version:s}){let n=this._objectStorage.get(t);if(!n)throw new Error(`Object ${t} for level ${e} is not found`);return new Wd(e,n,r,i,s)}_add(e,t){t.object.addDetalizationLevel(t),super._add(e,t)}_remove(e){let t=this.get(e);return t&&t.object.removeDetalizationLevel(t),super._remove(e),t}_destroy(e){}},qd=class{constructor(e,t,i,r,s,n,o){this._onMemoryUsageComponentChange=e=>{Object.assign(this._memoryUsage,e),this._onMemoryUsageChanged.fire(this._memoryUsage)},this._reportContentErrorHandler=e=>{this._onContentError.fire(g(f({},e),{source:`GraphicsContentProvider/${e.source}`}))},this._onError=new wt,this._onContentError=new wt,this.name=e,this._camera=t,this._context=i,this._metricsTransport=o,this._gpuMemoryRegistry=s;let a=this._commutator=new ka(r),l=f({dpr:gr(),iconUrlTemplate:"no icon url",glyphRangeUrlTemplate:"no glyph range url template"},n),d=new kd(a.getCommunicator(3),this._reportContentErrorHandler);this._groupStorage=d;let h=new Bd(a.getCommunicator(2),d);this._objectStorage=h,this._detalizationStorage=new Yd(a.getCommunicator(4),h),this._glyphAtlasRegistry=new Ul(a.getCommunicator(8),l,i),this._iconAtlasRegistry=new Ol(a.getCommunicator(7),l,i),this._objectMetadataIndex=new sd([this._detalizationStorage]),this._options=l;let c=new class{constructor(){this._onRootUpdate=()=>{this._onUpdate.fire()},this.onUpdate=this._onUpdate=new wt}get root(){return this._root}set root(e){let t=this._root;t&&t.onUpdate.removeListener(this._onRootUpdate),e&&e.onUpdate.addListener(this._onRootUpdate),this._root=e,e!==t&&this._onRootUpdate()}};this.scene=c,this._viewport=new class{constructor(e,t){this._communicator=e,this._camera=t,this._zoom=0,this.onUpdate=this._onUpdate=new wt,this._onCameraUpdate=this._onCameraUpdate.bind(this),this._camera.onUpdate.addListener(this._onCameraUpdate),this._onCameraUpdate()}destructor(){this._camera.onUpdate.removeListener(this._onCameraUpdate)}get zoom(){return this._zoom}_tryToUpdateZoom(e){let t=Math.round(e);t!==this._zoom&&(this._zoom=t,this._communicator.sendMessage({type:0,zoom:t},!0),this._onUpdate.fire())}_onCameraUpdate(){this._tryToUpdateZoom(this._camera.zoom)}}(a.getCommunicator(5),t);let u=new class{constructor(e,t,i){this._communicator=e,this._onContentError=i,this._currentObjectId=1,this._communicator.sendMessage({type:0,options:t},!1),this._rootGroup=new Nd("__root_id__",Gd,null,this._onContentError),this._addRootGroup()}addObject(e,t,i=this._rootGroup.id,r=String(this._currentObjectId++)){return this._communicator.sendMessage({type:1,feature:e,style:f(f({},jd),t),id:r,parentId:i},!0),r}updateObject(e,t,i){this._communicator.sendMessage({type:2,id:e,feature:t,style:f(f({},jd),i)},!0)}removeObject(e){this._communicator.sendMessage({type:3,id:e},!0)}addGroup(e,t=this._rootGroup.id,i=String(this._currentObjectId++)){return this._addGroup(i,f(f({},Gd),e),t)}removeGroupAndChildren(e){this._communicator.sendMessage({type:5,id:e},!0)}_addGroup(e,t,i){return this._communicator.sendMessage({type:4,id:e,style:t,parentId:i},!0),e}_addRootGroup(){let{id:e,zIndex:t,opacity:i}=this._rootGroup;this._addGroup(e,{zIndex:t,opacity:i},null)}}(a.getCommunicator(1),this._options,this._reportContentErrorHandler);this._graphicsManager=u,this.visibilityManager=new class{constructor(e,t,i,r,s){this._onGroupAdded=e=>{null===e.parent&&(this._scene.root&&console.warn(`Adding another root to the scene, new: ${e.id}, old: ${this._scene.root}`),this._scene.root=e,this._currentRoot=e)},this._onGroupRemoved=e=>{this._scene.root===e&&(this._scene.root=void 0,this._currentRoot=void 0)},this._onObjectAdded=e=>{this._recalculateState()},this._onObjectRemoved=e=>{this._setObjectActiveLevel(e,void 0),this._recalculateState()},this._onLevelAdded=e=>{e.onContentAdded.addListener(this._onLevelContentAdded),e.onContentRemoved.addListener(this._onLevelContentRemoved),this._onLevelContentAdded(e,e.content)},this._onLevelRemoved=e=>{e.onContentAdded.removeListener(this._onLevelContentAdded),e.onContentRemoved.removeListener(this._onLevelContentRemoved),e.object.activeDetalizationLevel===e&&this._findBestLevelForObject(e.object)},this._onLevelContentAdded=(e,t)=>{let i=e.object.activeDetalizationLevel;Hd(e)&&this._shouldReplaceLevel(i,e)&&this._setObjectActiveLevel(e.object,e)},this._onLevelContentRemoved=(e,t)=>{e===e.object.activeDetalizationLevel&&!Hd(e)&&this._setObjectActiveLevel(e.object,void 0)},this._onViewportUpdate=()=>{for(let e of this._objectStorage.items)this._findBestLevelForObject(e)},this._visibleObjectIds=new Set,this._onStateChanged=new wt,this._state={objectsTotal:0,objectsVisible:0},this._onGraphicsVisibilityChanged=new wt,this._isGraphicsVisible=!1,this._scene=e,this._viewport=t,this._groupStorage=i,this._objectStorage=r,this._detalizationStorage=s,this._viewport.onUpdate.addListener(this._onViewportUpdate),this._onViewportUpdate(),this._groupStorage.onAdded.addListener(this._onGroupAdded),this._groupStorage.onRemoved.addListener(this._onGroupRemoved),this._objectStorage.onAdded.addListener(this._onObjectAdded),this._objectStorage.onRemoved.addListener(this._onObjectRemoved),this._detalizationStorage.onAdded.addListener(this._onLevelAdded),this._detalizationStorage.onRemoved.addListener(this._onLevelRemoved);for(let e of this._groupStorage.items)this._onGroupAdded(e);for(let e of this._objectStorage.items)this._onObjectAdded(e);for(let e of this._detalizationStorage.items)this._onLevelAdded(e)}get onStateChanged(){return this._onStateChanged}get state(){return this._state}get isGraphicsVisible(){return this._isGraphicsVisible}get onGraphicsVisibilityChanged(){return this._onGraphicsVisibilityChanged}destructor(){this._groupStorage.onAdded.removeListener(this._onGroupAdded),this._groupStorage.onRemoved.removeListener(this._onGroupRemoved),this._objectStorage.onAdded.removeListener(this._onObjectAdded),this._objectStorage.onRemoved.removeListener(this._onObjectRemoved),this._detalizationStorage.onAdded.removeListener(this._onLevelAdded),this._detalizationStorage.onRemoved.removeListener(this._onLevelRemoved);for(let e of this._groupStorage.items)this._onGroupRemoved(e);for(let e of this._objectStorage.items)this._onObjectRemoved(e);for(let e of this._detalizationStorage.items)this._onLevelRemoved(e)}pause(){this._scene.root=void 0}resume(){this._scene.root=this._currentRoot}_recalculateState(){let e=this._visibleObjectIds.size,t=this._objectStorage.size;if(this._state.objectsVisible===e&&this._state.objectsTotal===t)return;this._state.objectsVisible=e,this._state.objectsTotal=t,this._onStateChanged.fire(this._state);let i=this._isGraphicsVisible;this._isGraphicsVisible=t===e,i!==this._isGraphicsVisible&&this._onGraphicsVisibilityChanged.fire(this._isGraphicsVisible)}_setObjectActiveLevel(e,t){e.activeDetalizationLevel=t,t?this._visibleObjectIds.add(e.id):this._visibleObjectIds.delete(e.id),this._recalculateState()}_findBestLevelForObject(e){let t;for(let i of e.detalizationLevels)Hd(i)&&this._shouldReplaceLevel(t,i)&&(t=i);t!==e.activeDetalizationLevel&&this._setObjectActiveLevel(e,t)}_shouldReplaceLevel(e,t){return!(!t||t.version<t.object.latestActiveDetalizationVersion||e&&!(t.version!==e.version?t.version>e.version:Math.abs(t.zoom-this._viewport.zoom)<Math.abs(e.zoom-this._viewport.zoom)))}}(c,this._viewport,this._groupStorage,this._objectStorage,this._detalizationStorage),this._contentManager=new zd(this._commutator.getCommunicator(0),this._detalizationStorage,this._context,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata(),this._reportContentErrorHandler),this._metrics=new class{constructor(e,t,i){this._onObjectAdded=e=>{this._metrics.mark(e.id)},this._onObjectRemoved=e=>{this._metrics.unmark(e.id)},this._onContentAdded=(e,t,i)=>{this._metrics.putValues(i),Hd(e)&&this._metrics.putMeasuredValue(e.object.id,"graphicsReady",!1)},this._objectStorage=t,this._contentManager=i,this._metrics=new Kl(e,"vector.graphics.processing",1024,[Ql,$l]),this._objectStorage.onAdded.addListener(this._onObjectAdded),this._objectStorage.onRemoved.addListener(this._onObjectRemoved),this._contentManager.onContentAdded.addListener(this._onContentAdded)}destructor(){this._contentManager.onContentAdded.removeListener(this._onContentAdded),this._objectStorage.onRemoved.removeListener(this._onObjectRemoved),this._objectStorage.onAdded.removeListener(this._onObjectAdded)}submit(){this._metrics.submit()}}(this._metricsTransport,this._objectStorage,this._contentManager),this._memoryUsage=f(f({},this._glyphAtlasRegistry.memoryUsage),this._iconAtlasRegistry.memoryUsage),this._onMemoryUsageChanged=new wt,this._stopSubmittingMetrics=xd((()=>this._metrics.submit()))}get memoryUsage(){return this._memoryUsage}get onError(){return this._onError}get onContentError(){return this._onContentError}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}get isGraphicsVisible(){return this.visibilityManager.isGraphicsVisible}get onGraphicsVisibilityChanged(){return this.visibilityManager.onGraphicsVisibilityChanged}destructor(){this._stopSubmittingMetrics(),this._objectStorage.destructor(),this._groupStorage.destructor(),this._contentManager.destructor(),this._commutator.destructor(),this._viewport.destructor(),this.visibilityManager.destructor(),this._metrics.destructor()}get options(){return this._options}get isPaused(){return this._isPaused}getObjectMetadata(e){return this._objectMetadataIndex.getMetadata(e)}pause(){this._isPaused||(this.visibilityManager.pause(),this._isPaused=!0)}resume(){this._isPaused&&(this.visibilityManager.resume(),this._isPaused=!1)}addObject(e,t,i,r){return this._graphicsManager.addObject(e,t,i,r)}updateObject(e,t,i){return this._graphicsManager.updateObject(e,t,i)}removeObject(e){return this._graphicsManager.removeObject(e)}addGroup(e,t,i){return this._graphicsManager.addGroup(e,t,i)}removeGroupAndChildren(e){return this._graphicsManager.removeGroupAndChildren(e)}_createAdditionalMetadata(){return new Map([[zl+"layerName",this.name]])}},Xd=class extends Sl{constructor(e,t){super({primitives:{},references:[]}),this.id=e,this.bbox=t}},Zd=class extends wl{_deserialize(e){return new Xd(e.id,e.bbox)}_destroy(e){}},$d=class extends al{constructor(e,t,i,r,s,n,o,a){super(i,r,s,n,a),this._onMessage=e=>{if(2===e.type)this._onAddPrimitives(e)},this._reportContentErrorHandler=e=>{this._onContentError.fire(g(f({},e),{source:`GeoContentManager/${e.source}`}))},this._onError=new wt,this._onContentError=new wt,this._communicator=e,this._options=o,this._storage=t,this._onContentAdded=new wt,this._communicator.onMessage.addListener(this._onMessage),this._communicator.sendMessage({type:0,options:this._options},!1)}get onContentAdded(){return this._onContentAdded}get onError(){return this._onError}get onContentError(){return this._onContentError}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}updateOption(e,t){this._options[e]=t,this._communicator.sendMessage({type:0,options:this._options},!1)}_onAddPrimitives(e){let t=this._storage.get(e.objectId);if(cs(t)){let i=this._instantiatePrimitives(e.content,0);t.addContent(i,this._reportContentErrorHandler),this._onContentAdded.fire(t,i)}}},Qd=class extends fd{constructor(e,t,i,r,s,n,o){let a=new ka(r),l=f({dpr:gr()},n),d=new Zd(a.getCommunicator(2));super(e,t,i,s,new Ul(a.getCommunicator(4),l,t),new Ol(a.getCommunicator(3),l,t),new sd([d]),o),this._options=l,this._commutator=a,this._communicator=this._commutator.getCommunicator(0),this._storage=d,this._geoContentManager=new $d(this._commutator.getCommunicator(1),this._storage,this._context,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options),this._visibilityManager=new class{constructor(e,t,i){this._onCameraChanged=()=>{for(let e of this._storage.items)this._updateObjectVisibility(e)},this._onObjectAdded=e=>{this._updateObjectVisibility(e)},this._onObjectRemoved=e=>{this._visibleObjects.has(e.id)&&(this._visibleObjects.delete(e.id),this._contentVisibilityManager.hideObject(e))},this._camera=e,this._storage=t,this._contentVisibilityManager=i,this._visibleObjects=new Map,this._cameraArea=fl(this._camera),this._camera.onUpdate.addListener(this._onCameraChanged),this._storage.onAdded.addListener(this._onObjectAdded),this._storage.onRemoved.addListener(this._onObjectRemoved)}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged),this._storage.onAdded.removeListener(this._onObjectAdded),this._storage.onRemoved.removeListener(this._onObjectRemoved)}_updateObjectVisibility(e){se(this._cameraArea,e.bbox)?this._visibleObjects.has(e.id)||(this._visibleObjects.set(e.id,e),this._contentVisibilityManager.showObject(e)):this._visibleObjects.has(e.id)&&(this._visibleObjects.delete(e.id),this._contentVisibilityManager.hideObject(e))}}(this._camera,this._storage,this._contentVisibilityManager),this._gc=new class{constructor(e,t,i){this._camera=t,this._communicator=e,this._storage=i,this._isActive=!1,this._onCameraUpdateDebounced=$r((()=>this._onCameraUpdate()),5e3),this._onUpdateInStorage()}destructor(){this._pause()}_pause(){this._isActive&&(this._camera.onUpdate.removeListener(this._onCameraUpdateDebounced),this._isActive=!1)}_resume(){this._isActive||(this._camera.onUpdate.addListener(this._onCameraUpdateDebounced),this._isActive=!0)}_onCameraUpdate(){this._communicator.sendMessage({type:0,viewportBBox:fl(this._camera)},!0)}_onUpdateInStorage(){0===this._storage.size?this._pause():this._resume()}}(this._commutator.getCommunicator(5),this._camera,this._storage),this._onCameraChanged(),this._onCameraChanged=$r(this._onCameraChanged.bind(this),500),this._camera.onUpdate.addListener(this._onCameraChanged)}get onError(){return this._geoContentManager.onError}get onContentError(){return this._geoContentManager.onContentError}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged),this._storage.destructor(),this._geoContentManager.destructor(),this._visibilityManager.destructor(),this._gc.destructor(),this._commutator.destructor()}_onCameraChanged(){let e=this._camera.center;this._communicator.sendMessage({type:0,center:B(e.x,e.y),zoom:this._camera.zoom},!0)}};function*Kd(e,t=(()=>!1)){let i=0,r=[e];for(;i<r.length;){let e=r[i];if(yield e,!t(e))for(let t of e.children)r.push(t);++i}}function Jd(e,t,i){if(function(e,t){for(let i of t){let t=!0;for(let r of e)if(Pe(i.normal,r)+i.distance<0){t=!1;break}if(t)return!1}return!0}(e.bboxPoints,i.planes)){let r=[];if(!e.isDetalizationAcceptable(t))for(let s of e.children){let e=Jd(s,t,i);e&&r.push(e)}return{tile:e,children:r}}}function eh(e){let t=!0;for(let i of e.children)if(!eh(i)){t=!1;break}return e.children.length>0&&t?(e.isSelfRenderable=!1,!0):e.tile.content?(e.isSelfRenderable=!0,!0):(e.isSelfRenderable=!1,!1)}var th=class{constructor(e){this._onCameraChanged=()=>{this._needRecalculation=!0,this._recalculateVisibleTiles()},this._camera=e,this._entries=[],this._onUpdate=new wt,this._needRecalculation=!0,this._camera.onUpdate.addListener(this._onCameraChanged)}get onUpdate(){return this._onUpdate}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged)}*visibleTiles(){for(let e of this._entries){if("simple"===e.type){yield e.tile;continue}let t=e.node;if(t)for(let e of Kd(t))yield e.tile}}*visibleRenderableTiles(){for(let e of this._entries){if("simple"===e.type){yield e.tile;continue}let t=e.node;if(t){eh(t);for(let e of Kd(t,ih))e.isSelfRenderable&&(yield e.tile)}}}_onAddRootTile(e){if(-1!==this._entries.findIndex((t=>t.tile===e)))return;let t=void 0!==e.getObjectMetadata?{tile:e,type:"simple"}:{tile:e,type:"tree",node:Jd(e,this._camera,Wi(this._camera))};this._entries.push(t),this._onUpdate.fire()}_onRemoveRootTile(e){let t=this._entries.findIndex((t=>t.tile===e));-1!==t&&(this._entries.splice(t,1),this._onUpdate.fire())}_recalculateVisibleTiles(){if(!this._needRecalculation||(this._needRecalculation=!1,0===this._entries.length))return;let e=Wi(this._camera),t=0;for(let i of this._entries)"tree"===i.type&&(i.node=Jd(i.tile,this._camera,e),++t);t>0&&this._onUpdate.fire()}};function ih(e){return!e.isSelfRenderable}var rh=class extends th{constructor(){super(...arguments),this._onTileUpdate=()=>{this._onUpdate.fire()}}addRootTile(e){e.onUpdate.addListener(this._onTileUpdate),this._onAddRootTile(e)}removeRootTile(e){e.onUpdate.removeListener(this._onTileUpdate),this._onRemoveRootTile(e)}forceVisibilityRecalculation(){this._recalculateVisibleTiles()}},sh=["Y","M","A","P","S","_","R","T","C"].join(""),nh=["Y","M","A","P","S","_","B","O","X"].join(""),oh=["Y","M","A","P","S","_","T","I","E","R","S"].join("");function ah(e){return void 0!==e.content}var lh=1;Number.MAX_SAFE_INTEGER;function dh(e,t){return e.type===t}var hh=class{constructor(e){this._addressee=e,this._events=new wt,this._listeners=new Map,this._transferableExtractors=new Map,this._messages=[],this._transferables=[],this._timeoutHandle=0,this._flushMessagesBinded=this.flushMessages.bind(this)}setTransferableExtractor(e,t){this._transferableExtractors.set(e,t)}sendMessage(e,t=0){e.messagePostMetrics={postDelay:Tr(),postTime:0};let i=this._transferableExtractors.get(e.type),r=i?i(e):void 0,s=0===this._messages.length;s&&(this._firstMessageTime=Tr()),this._messages.push(e),r&&(this._transferables=this._transferables.concat(r)),clearTimeout(this._timeoutHandle),this._messages.length>50||1===t||!s&&Tr()-this._firstMessageTime>250?this.flushMessages():this._timeoutHandle=setTimeout(this._flushMessagesBinded,50)}request(e,t){return new Promise(((i,r)=>{-1===e.requestId&&(e.requestId=lh++);let s=t=>{dh(t,e.responseType)&&t.requestId===e.requestId&&(i(t),this._events.removeListener(s)),dh(t,e.errorType)&&t.requestId===e.requestId&&(r(),this.off(s))};this._events.addListener(s),this.sendMessage(e,t)}))}respond(e,t,i){t.requestId=e.requestId,this.sendMessage(t,i)}on(e,t){let i=i=>{dh(i,e)&&t(i)};this._listeners.set(t,i),this._events.addListener(i)}off(e){let t=this._listeners.get(e);t&&this._events.removeListener(t)}flushMessages(){for(let e of this._messages)e.messagePostMetrics&&(e.messagePostMetrics.postDelay=Tr()-e.messagePostMetrics.postDelay,e.messagePostMetrics.postTime=Date.now());this._addressee.postMessage(this._messages,this._transferables),this._messages.length=0,this._transferables.length=0}listen(){this._addressee.onmessage=({data:e})=>{for(let t of e)this.onMessage(t)}}onMessage(e){this._events.fire(e)}},ch=class extends hh{constructor(e){let t="function"==typeof e?e():new Worker(e);super(t),this._worker=t,this.listen()}destroy(){this._worker.terminate()}},uh=class extends ch{};function _h({buffer:e}){return[e]}var ph=class{constructor(e){this._worker=new class{constructor(e){this._onFromBackendDecodeResponseMessage=e=>{let t=this._queue.get(e.messageId);t&&(this._queue.delete(e.messageId),e.asset?t.resolve(e.asset):t.reject(e.error))},this._nextMessageId=0,this._worker=new uh(e),this._worker.setTransferableExtractor(0,_h),this._queue=new Map,this._worker.on(1,this._onFromBackendDecodeResponseMessage)}destructor(){this._worker.off(this._onFromBackendDecodeResponseMessage),this._worker.destroy(),this._queue.clear()}decode(e,t){let i,r,s=this._getMessageId(),n={type:0,messageId:s,buffer:e,metadata:t},o=new Promise(((e,t)=>{i=e,r=t}));return this._queue.set(s,{resolve:i,reject:r,decoding:o}),this._worker.sendMessage(n),o}cancel(e){let t;for(let[i,r]of this._queue)if(e===r.decoding){t=i;break}return void 0!==t&&(this._queue.delete(t),!0)}_getMessageId(){return++this._nextMessageId}}(e),this._taskToWorkerTaskMap=new Map}destructor(){this._worker.destructor(),this._taskToWorkerTaskMap.clear()}decode(e,t){let i,r,{buffer:s,byteOffset:n,byteLength:o}=e,a=s.slice(n,n+o),l=new Promise(((e,t)=>{i=e,r=t})),d=this._worker.decode(a,t);return d.then((e=>{this._taskToWorkerTaskMap.has(l)&&(this._taskToWorkerTaskMap.delete(l),i(e))}),(e=>{this._taskToWorkerTaskMap.has(l)&&(this._taskToWorkerTaskMap.delete(l),r(e))})),this._taskToWorkerTaskMap.set(l,d),l}cancel(e){let t=this._taskToWorkerTaskMap.get(e);return!!t&&(this._taskToWorkerTaskMap.delete(e),this._worker.cancel(t),!0)}};function mh(e){return(e+1>>1)-1}function fh(e){return(e+1<<1)-1}var gh=class{constructor(e=Je){this._items=[],this._comparator=e}insert(e){let t=this._items,i=this._comparator,r=t.push(e)-1,s=mh(r);for(;s>-1&&i(t[r],t[s])>0;)rt(t,r,s),r=s,s=mh(r)}pop(){let e=this._items;if(0===e.length)return;let t=e[0];return this._removeByIndex(0),t}peek(){return this._items[0]}*[Symbol.iterator](){for(let e of this._items)yield e}get size(){return this._items.length}remove(e){let t=this._items.findIndex(e);-1!==t&&this._removeByIndex(t)}_restoreOrderDownward(e){let t=e,i=fh(t),r=this._items.length,s=this._comparator,n=this._items;for(;i<r&&(i+1<r&&s(n[i],n[i+1])<0&&(i+=1),!(s(n[t],n[i])>0));)rt(n,t,i),t=i,i=fh(i)}_removeByIndex(e){rt(this._items,e,this._items.length-1),this._items.pop(),this._restoreOrderDownward(e)}};function vh(e,t){return e.priority-t.priority}var yh=class{constructor(){this._heap=new gh(vh)}enqueue(e){this._heap.insert(e)}dequeue(){return this._heap.pop()}peek(){return this._heap.peek()}isEmpty(){return 0===this._heap.size}get size(){return this._heap.size}remove(e){this._heap.remove(e)}};var xh="to_nested:init",bh="to_nested:terminate",Th="to_nested:request",wh="from_nested:response",Ch="_NESTED_WORKER_TAG_";function Ph(e){return[f({[Ch]:!0},e)]}function Sh(e){let t=e;return 1===t.length&&t[0][Ch]?t[0]:null}var Mh=1;var Rh=null,Ih=[];function Lh(e){Rh&&Rh(e);for(let t of Ih)t(e)}var Eh=class{constructor(e){this._onMathThreadMessage=({data:e})=>{let t=Sh(e);t&&t.id===this._id&&t.type===wh&&this._processMessage(t.content)},this._id=function(){let e=Mh;return++Mh,e}();let t=Ph({type:xh,id:this._id,content:e});postMessage(t),function(e){0===Ih.length&&(Rh=onmessage,onmessage=Lh),Ih.push(e)}(this._onMathThreadMessage)}get onmessage(){return this._onmessage}set onmessage(e){this._onmessage=e}get onmessageerrot(){throw new Error("Not implemented")}set onmessageerror(e){throw new Error("Not implemented")}get onerror(){throw new Error("Not implemented")}set onerror(e){throw new Error("Not implemented")}terminate(){!function(e){let t=Ih.indexOf(e);t>=0&&Ih.splice(t,1),0===Ih.length&&(onmessage=Rh,Rh=null)}(this._onMathThreadMessage);let e=Ph({type:bh,id:this._id,content:null});postMessage(e)}postMessage(e,t){let i=t||[],r=Ph({type:Th,id:this._id,content:e});postMessage(r,i)}addEventListener(e,t,i){throw new Error("Not implemented")}removeEventListener(e,t,i){throw new Error("Not implemented")}dispatchEvent(e){throw new Error("Not implemented")}_processMessage(e){this._onmessage&&this._onmessage({data:e})}};function Ah(){"function"==typeof importScripts&&"undefined"==typeof Worker&&(Worker=Eh)}var Uh=class{constructor(e){this._decoder=e}run({content:e,metadata:t}){return this._decoder.decode(e,t)}cancel(e){this._decoder.cancel(e)}},Oh=class{constructor(e){this._onViewportUpdate=()=>{this._onUpdate.fire()},this._viewport=e,this._onUpdate=new wt,this._viewport.onUpdate.addListener(this._onViewportUpdate)}get onUpdate(){return this._onUpdate}get primitives(){return function*(e){for(let t of e)t.content&&(yield*t.content.primitives)}(this._viewport.visibleRenderableTiles())}destructor(){this._viewport.onUpdate.removeListener(this._onViewportUpdate)}};var Vh=$e([[0,{size:3,type:5126,normalized:!1}]]),Dh=$e([[5,{size:3,type:5126,normalized:!1}]]),zh=($e([[7,{size:4,type:5121,normalized:!0}]]),$e([[4,{size:2,type:5126,normalized:!1}]])),Bh=$e([[2,{size:4,type:5123,normalized:!0}]]),Fh=($e([[12,{size:4,type:5126,normalized:!1,divisor:1}],[13,{size:4,type:5126,normalized:!1,divisor:1}],[14,{size:4,type:5126,normalized:!1,divisor:1}],[15,{size:4,type:5126,normalized:!1,divisor:1}],[9,{size:4,type:5121,normalized:!0,divisor:1}],[8,{size:4,type:5121,normalized:!0,divisor:1}]]),P),Nh={colorFactor:Fh,colorTextureIndex:void 0,isUnlit:!1,occlusionTextureIndex:void 0,occlusionStrength:1};function kh(e,t){var i,r,s;if(!e.materials||void 0===t)return Nh;let n=e.materials[t];if(!n)return Nh;let o=n.pbrMetallicRoughness,a=null!=o&&o.baseColorFactor?S(...o.baseColorFactor):Fh,l=Hh(e,null==o?void 0:o.baseColorTexture),d=Hh(e,n.occlusionTexture);return{colorFactor:a,colorTextureIndex:l,isUnlit:void 0!==(null==(i=n.extensions)?void 0:i.KHR_materials_unlit),occlusionTextureIndex:d,occlusionStrength:null!=(s=null==(r=n.occlusionTexture)?void 0:r.strength)?s:1}}function Hh(e,t){if(!t||!e.textures)return;let i=e.textures[t.index];return i&&void 0!==i.source?i.source:void 0}var jh=1e-32;function Gh(e,t,i,r){return[e,t,i,r]}function Wh(e,t,i,r,s){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function Yh(e,t=Gh(0,0,0,1)){let i=function(e){return Math.sqrt(function([e,t,i,r]){return e*e+t*t+i*i+r*r}(e))}(e);return z(i,0,jh)||z(i,1,jh)?Wh(e[0],e[1],e[2],e[3],t):(function([e,t,i,r],s,n=Gh(0,0,0,1)){n[0]=vt(e*s,-1,1),n[1]=vt(t*s,-1,1),n[2]=vt(i*s,-1,1),n[3]=vt(r*s,-1,1)}(e,1/i,t),e)}function qh(e,t=function(){return{rotation:Gh(0,0,0,1),scale:ue(1,1,1),translation:ue(0,0,0)}}()){return e.rotation&&(Wh(...e.rotation,t.rotation),Yh(e.rotation,t.rotation)),e.translation&&pe(...e.translation,t.translation),e.scale&&pe(...e.scale,t.scale),t}function Xh(e,t=ze(Oe)){if(void 0!==e.scale){let i=function(e,t,i=De()){for(let r=0;r<Ve;r+=4)i[r]=e[r]*t.x,i[r+1]=e[r+1]*t.y,i[r+2]=e[r+2]*t.z,i[r+3]=e[r+3];return i}(Oe,e.scale,Qh);t=Ne(t,i,t)}if(void 0!==e.rotation){let i=function([e,t,i,r],s=ze(Oe)){let n=e*e,o=e*t,a=e*i,l=e*r,d=t*r,h=t*t,c=t*i,u=i*i,_=i*r;return s[0]=1-2*(h+u),s[1]=2*(o+_),s[2]=2*(a-d),s[4]=2*(c-_),s[5]=1-2*(n+u),s[6]=2*(c+l),s[8]=2*(a+d),s[9]=2*(c-l),s[10]=1-2*(n+h),s}(e.rotation,ze(Oe,Qh));t=Ne(t,i,t)}if(void 0!==e.translation){t=Ne(t,Be(Oe,e.translation,Qh),t)}return t}function Zh(e){let{scene:t,scenes:i,nodes:r}=e;return void 0!==t&&i[t].nodes||function(e){if(void 0===e)return[];let t=new Array(e.length);for(let i of e)for(let e of i.children||[])t[e]=!0;let i=[];for(let e=0;e<t.length;++e)void 0===t[e]&&i.push(e);return i}(r)}function $h(e,t,i=ze(Oe),r={}){for(let s of t){let t=e[s],n=Xh(qh(t));Ne(n,i,n),void 0!==t.mesh&&(r[t.mesh]=n),$h(e,t.children||[],n,r)}return r}var Qh=De();var Kh=Array.from({length:8}).map((()=>ue(0,0,0))),Jh=Array.from({length:Kh.length}).map((()=>0)),ec=Array.from({length:Kh.length}).map((()=>0)),tc=Array.from({length:Kh.length}).map((()=>0)),ic=(ze(Oe),ce(),_e()),rc=_e(),sc=_e(),nc=1e-6;function oc(e,t){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`unsupported format type - ${e} for ${t}`)}}function ac(e){return e.slice().buffer}function lc(e,t,i,r,s,n,o,a){let l=e.attributes.NORMAL;if(!l)return function(e,t,i,r){let s=new(oc(r,"INDEX"))(i),n=new(oc(t,"POSITION"))(e),o=new ArrayBuffer(n.byteLength),a=new Float32Array(o),l=s.length,d=0;for(;d<l;){let e=3*s[d],t=3*s[d+1],i=3*s[d+2],r=pe(n[e],n[e+1],n[e+2],ic),o=pe(n[t],n[t+1],n[t+2],rc),l=pe(n[i],n[i+1],n[i+2],sc),h=Se(xe(o,r,o),xe(l,r,l),l);we(h)<nc?pe(0,1,0,h):Ce(h,h),dc(h,a,e),dc(h,a,t),dc(h,a,i),d+=3}return{data:o,mapping:Dh}}(r,s,n,o);uc(t,l,"NORMAL");let d=cc(t,i,l);return{data:a?ac(d):d.buffer,mapping:Dh}}function dc(e,t,i){let r=pe(t[i],t[i+1],t[i+2],ic);ye(e,r,r),Ce(r,r),t[i]=r.x,t[i+1]=r.y,t[i+2]=r.z}Ss(!0,"Batch type size must be 32 bits");hc(1),hc(12),hc(12),hc(7);function hc(e){let t=32-e;return-1<<t>>>t}function cc(e,t,i){let r=e.accessors[i],s=e.bufferViews[r.bufferView];return new Uint8Array(t[s.buffer],s.byteOffset||0,s.byteLength)}function uc(e,t,i){let r=e.accessors[t];if(!r||"VEC3"!==r.type||5126!==r.componentType)throw new Error(`no or bad ${i} attribute`)}function _c(e,t){let i=e.accessors[t];if(!i||"VEC2"!==i.type||5126!==i.componentType)throw new Error("no or bad TEXCOORD_0 attribute")}function pc(e,t){let i=e.accessors[t];if(!i||"VEC4"!==i.type||5123!==i.componentType)throw new Error("no or bad COLOR_0 attribute")}var mc,fc=new Map,gc=class{constructor(e,t,i,r,s,n,o){this._onViewportUpdate=()=>{let e=new Set(this._viewport.visibleTiles());for(let t of this._visibleTiles)if(!e.has(t)){this._getDetails(t).isVisible=!1,this._stopTileProcessing(t)}this._visibleTiles=e;for(let t of e){let e=this._getDetails(t);e?e.isVisible=!0:(e={isVisible:!0,stage:0},t[this._contentManagementKey]=e),this._continueTileProcessing(t)}},this._context=e,this._viewport=t,this._taskQueue=r,this._taskBasePriority=s,this._tileIdGenerator=n,this._tilesMetadata=o,this._richModelDecoder=i,this._visibleTiles=new Set,this._preloadingTiles=new Set,this._contentManagementKey=Symbol("content_manager_details"),this._onTileProcessingError=new wt,this._onTileProcessingStageChanged=new wt,this._viewport.onUpdate.addListener(this._onViewportUpdate),this._onViewportUpdate()}get onTileProcessingError(){return this._onTileProcessingError}get onTileProcessingStageChanged(){return this._onTileProcessingStageChanged}destructor(){for(let e of this._visibleTiles)this._stopTileProcessing(e);for(let e of this._preloadingTiles)this._stopTileProcessing(e);this._viewport.onUpdate.removeListener(this._onViewportUpdate)}preload(e){e[this._contentManagementKey]={isVisible:!0,stage:0},this._preloadingTiles.add(e),this._continueTileProcessing(e)}cancelPreload(e){let t=this._getDetails(e);t&&(t.isVisible=!1,this._preloadingTiles.delete(e),this._stopTileProcessing(e))}changeTextures(e,t){let i=this._getDetails(e);if(!i||!e.content)throw new Error("tile is unknown or content is not ready");if(8!==i.stage&&(this._stopTileProcessing(e),i.texturesData=void 0,i.texturesContent=void 0),null===t)return this._setStage(e,i,8),void e.content.updateTextures(null).catch((()=>{}));i.texturesTier=t,this._setStage(e,i,9),this._continueTileProcessing(e)}updateMetadataForTile(e){this._setTileMetadata(e)}_continueTileProcessing(e){let t=this._getDetails(e);if(t.isVisible)switch(t.stage){case 0:case 2:clearTimeout(t.failedContentDataLoadRetryId),e.load().then(this._onTileLoaded.bind(this,e),this._onTileLoadingFailed.bind(this,e)),this._setStage(e,t,1);break;case 3:t.contentDecodingCancel=this._callDecoder(e,t.contentData.data,t.contentData.metadata,(t=>this._onTileDecoded(e,t)),(t=>this._onTileDecodingFailed(e,t))),this._setStage(e,t,4);break;case 6:if(!t.initializingAsset){let i=void 0!==e.getObjectMetadata;this._setTileMetadata(e);let r=i?e.modelId:this._tileIdGenerator.getTileId(e.modelId),s=i?-1:e.modelId;t.initializingAsset=new class{constructor(e,t,i,r,s,n,o,a){this._onTextureMemoryChanged=()=>{},this._onGeometryMemoryChanged=()=>{},this._primitives=[],this._textures=new Map,this._geometries=[],this.gltf=e.description,this._context=t,this._initSteps=[],this._onUpdate=new wt;let l=e.images;this._defaultImages=a?l:null,this._initSteps.push((()=>this._initPrimitives(e,i,r,s,n,o))),this._initSteps.reverse()}get primitives(){if(!this.isInitialized)throw new Error("asset is not fully initialized, call stepInitialization() more times");return this._primitives}get isInitialized(){return 0===this._initSteps.length}get onUpdate(){return this._onUpdate}destructor(){for(let e of this._textures.values())e.release();for(let e of this._geometries)e.release();for(let e of this._primitives)e.release()}stepInitialization(){return 0!==this._initSteps.length&&this._initSteps.pop()(),!this.isInitialized}updateTextures(e){if(!this.isInitialized)throw new Error("asset is not fully initialized, call stepInitialization() more times");if(!this._defaultImages)throw new Error("asset does not support textures change");let t=e||this._defaultImages,i=[];for(let[e,r]of this._textures){let s=t[e];i.push(r.updateTextureData(s))}return Promise.all(i).then((()=>{var e,t;for(let i of this.primitives)i.memoryInfo.textures=null!=(t=null==(e=i.image)?void 0:e.memoryUsageInBytes)?t:0;this._onUpdate.fire()}))}_getTexture(e,t){if(void 0===e)return;let i=this._textures.get(e);if(i)return i;let r=t[e];if(!r)return;let s=new ws(0,this._context,{content:r,type:1},this._onTextureMemoryChanged);return s.retain(),this._textures.set(e,s),s}_initPrimitives(e,t,i,r,s,n){let{description:o,buffers:a,images:l}=e,d=this._context,h=$h(o.nodes||[],Zh(o)),c={minX:0,maxX:0,minY:0,maxY:0,minZ:0,maxZ:0};for(let e=0;e<(o.meshes||[]).length;e++){let u=o.meshes[e];for(let _ of u.primitives){let u=[],p=_.attributes.POSITION;uc(o,p,"POSITION");let m=cc(o,a,p),f=o.accessors[p].componentType;u.push({mapping:Vh,data:m});let g,v,y=kh(o,_.material),x=_.attributes.TEXCOORD_0;x&&(g=this._getTexture(y.colorTextureIndex,l),v=this._getTexture(y.occlusionTextureIndex,l),(g||v)&&(_c(o,x),u.push({mapping:zh,data:cc(o,a,x)})));let b=_.attributes.COLOR_0;b>=0&&n&&(pc(o,b),u.push({mapping:Bh,data:cc(o,a,b)}));let T=cc(o,a,_.indices),w=o.accessors[_.indices].componentType;y.isUnlit||u.push(lc(_,o,a,m.buffer,f,T.buffer,w,!1));let C=new Ts(0,d,{vertices:u,indices:T,type:0},void 0,this._onGeometryMemoryChanged);C.retain(),this._geometries.push(C);let P={indexByteOffset:0,indexByteLength:T.byteLength,indexType:o.accessors[_.indices].componentType},S=h[e]||Oe,M=new Ga({id:i,legacyCollidingId:r,geometry:C,image:g,occlusion:v,occlusionStrength:y.occlusionStrength,location:P,metadata:fc,modelId:s,rtc:t,transform:S,bbox:c,isUnlit:y.isUnlit,colorFactor:y.colorFactor});M.retain(),this._primitives.push(M)}}!function(e,t,i,r={minX:0,maxX:0,minY:0,maxY:0,minZ:0,maxZ:0}){let s=e.meshes,n=e.accessors,o=+Number.MAX_VALUE,a=+Number.MAX_VALUE,l=+Number.MAX_VALUE,d=-Number.MAX_VALUE,h=-Number.MAX_VALUE,c=-Number.MAX_VALUE,u=0;for(let e=0;e<s.length;++e)for(let t of s[e].primitives){let e=i[u++],r=n[t.attributes.POSITION],[s,_,p]=r.min,[m,f,g]=r.max,v=Kh;Ee({minX:s,maxX:m,minY:_,maxY:f,minZ:p,maxZ:g},v);let y=Jh,x=ec,b=tc;for(let t=0;t<v.length;++t){let i=v[t];ke(e,i,i),y[t]=i.x,x[t]=i.y,b[t]=i.z}o=Math.min(...y,o),a=Math.min(...x,a),l=Math.min(...b,l),d=Math.max(...y,d),h=Math.max(...x,h),c=Math.max(...b,c)}!function(e,{x:t,y:i,z:r}){e.minX+=t,e.maxX+=t,e.minY+=i,e.maxY+=i,e.minZ+=r,e.maxZ+=r}(r,t)}(o,t,this._primitives.map((({matrix:e})=>e)),c)}}(t.content,this._context,t.contentData.metadata[sh],r,r,s,!i,!i),this._setStage(e,t,7)}t.task={priority:this._taskBasePriority,execute:()=>{t.initializingAsset.stepInitialization()?this._taskQueue.enqueue(t.task):(this._setStage(e,t,8),e.content=t.initializingAsset,t.contentData=void 0,t.content=void 0,this._preloadingTiles.delete(e))}},this._taskQueue.enqueue(t.task);break;case 9:case 11:clearTimeout(t.failedTextureDataLoadRetryId),e.loadTextures(t.texturesTier).then((t=>this._onTileTexturesDataLoaded(e,t)),(t=>this._onTileTexturesDataLoadingFailed(e,t))),this._setStage(e,t,10);break;case 12:t.texturesDecodingCancel=this._callDecoder(e,t.texturesData,{},(t=>this._onTileTextureDataDecoded(e,t)),(t=>this._onTileTextureDataDecodingFailed(e,t))),this._setStage(e,t,13);break;case 15:let{images:i}=t.texturesContent;this._setStage(e,t,8),t.texturesContent=void 0,e.content.updateTextures(i).catch((()=>{}))}}_stopTileProcessing(e){let t=this._getDetails(e);switch(t.stage){case 1:e.cancelLoading(),this._setStage(e,t,0);break;case 2:clearTimeout(t.failedContentDataLoadRetryId);break;case 4:t.contentDecodingCancel(),t.contentDecodingCancel=void 0,this._setStage(e,t,3);break;case 7:this._taskQueue.remove(t.task),this._destroyInitializingAsset(e),this._setStage(e,t,6);break;case 10:e.cancelLoadingTextures(),this._setStage(e,t,9);break;case 11:clearTimeout(t.failedTextureDataLoadRetryId),t.failedTextureDataLoadAttempts=0,this._setStage(e,t,9);break;case 13:t.texturesDecodingCancel(),t.texturesDecodingCancel=void 0,this._setStage(e,t,12)}}_onTileLoaded(e,t){let i=this._getDetails(e);i.contentData=t,i.contentDataReadyTime=Tr(),this._setStage(e,i,3),this._continueTileProcessing(e)}_onTileLoadingFailed(e,t){let i=this._getDetails(e);this._setStage(e,i,2),i.failedContentDataLoadAttempts=(i.failedContentDataLoadAttempts||0)+1,i.failedContentDataLoadAttempts<=2?i.failedContentDataLoadRetryId=setTimeout(this._continueTileProcessing.bind(this,e),500):this._onTileProcessingError.fire(e,t)}_onTileDecoded(e,t){let i=this._getDetails(e);i.contentDecodingCancel=void 0,i.content=t,this._setStage(e,i,6),this._continueTileProcessing(e)}_onTileDecodingFailed(e,t){let i=this._getDetails(e);i.contentDecodingCancel=void 0,this._setStage(e,i,5),this._onTileProcessingError.fire(e,t)}_callDecoder(e,t,i,r,s){let n=-this._getDetails(e).contentDataReadyTime,o=this._richModelDecoder.decode(t,i,n);return o.then(r,s),()=>{this._richModelDecoder.cancel(o)}}_onTileTexturesDataLoaded(e,t){let i=this._getDetails(e);i.texturesTier=void 0,i.failedTextureDataLoadAttempts=0,i.texturesData=t,this._setStage(e,i,12),this._continueTileProcessing(e)}_onTileTexturesDataLoadingFailed(e,t){let i=this._getDetails(e);this._setStage(e,i,11),i.failedTextureDataLoadAttempts=(i.failedTextureDataLoadAttempts||0)+1,i.failedTextureDataLoadAttempts<=2?i.failedTextureDataLoadRetryId=setTimeout((()=>this._continueTileProcessing(e)),500):(i.texturesTier=void 0,i.failedTextureDataLoadAttempts=0,this._onTileProcessingError.fire(e,t))}_onTileTextureDataDecoded(e,t){let i=this._getDetails(e);i.texturesData=void 0,i.texturesDecodingCancel=void 0,i.texturesContent=t,this._setStage(e,i,15),this._continueTileProcessing(e)}_onTileTextureDataDecodingFailed(e,t){let i=this._getDetails(e);i.texturesDecodingCancel=void 0,this._setStage(e,i,14),this._onTileProcessingError.fire(e,t)}_destroyInitializingAsset(e){let t=this._getDetails(e);t.initializingAsset&&t.initializingAsset.destructor()}_getDetails(e){return e[this._contentManagementKey]}_setStage(e,t,i){let r=t.stage;t.stage=i,this._onTileProcessingStageChanged.fire(e,i,r)}_setTileMetadata(e){let t=void 0!==e.getObjectMetadata;this._tilesMetadata.setTileMetadata(e.modelId,t?void 0:e.getCustomObjectIds(),t?e.getObjectMetadata():void 0)}},vc=((mc=vc||{})[mc.NOT_LOADED=0]="NOT_LOADED",mc[mc.REQUESTED=1]="REQUESTED",mc[mc.REQUEST_FAILED=2]="REQUEST_FAILED",mc[mc.RESPONSE_RECEIVED=3]="RESPONSE_RECEIVED",mc[mc.DECODING=4]="DECODING",mc[mc.DECODING_FAILED=5]="DECODING_FAILED",mc[mc.DECODED=6]="DECODED",mc[mc.INSTIATING_ENQUEUED=7]="INSTIATING_ENQUEUED",mc[mc.INSTIANCIATED=8]="INSTIANCIATED",mc[mc.TEXTURES_CHANGE_REQUESTED=9]="TEXTURES_CHANGE_REQUESTED",mc[mc.TEXTURES_DATA_LOAD_PENDING=10]="TEXTURES_DATA_LOAD_PENDING",mc[mc.TEXTURES_DATA_LOAD_FAILED=11]="TEXTURES_DATA_LOAD_FAILED",mc[mc.TEXTURES_DATA_LOAD_DONE=12]="TEXTURES_DATA_LOAD_DONE",mc[mc.TEXTURES_DATA_DECODE_PENDING=13]="TEXTURES_DATA_DECODE_PENDING",mc[mc.TEXTURES_DATA_DECODE_FAILED=14]="TEXTURES_DATA_DECODE_FAILED",mc[mc.TEXTURES_DATA_DECODE_DONE=15]="TEXTURES_DATA_DECODE_DONE",mc),yc=(e=>(e[e.HIGH=300]="HIGH",e[e.MEDIUM=200]="MEDIUM",e[e.LOW=100]="LOW",e))(yc||{}),xc=class extends Error{constructor(e,t,i){super(e),this.url=t,this.state=i}},bc=class{constructor(e,t="GET",i={}){this._url=e,this._method=t,this._options=i,this._abortController=new AbortController}send(){let e={method:this._method,credentials:this._options.withCredentials?"include":"omit",headers:this._options.requestHeaders,signal:this._abortController.signal};return fetch(this._url,e).then((e=>{let t=function(e){return e.ok?null:400<=e.status&&e.status<500?"client_side":"not_client_side"}(e);if(t)throw new xc(e.statusText,this._url,t);return this._prepareResponse(e).catch((()=>{throw new xc("failed to read response body",this._url,"response_body")}))}),(e=>{throw e instanceof xc?e:new xc(e.message,this._url,"fetch")}))}cancel(){let e=new xc("canceled",this._url,"canceled");this._abortController.abort(e)}};var Tc=class extends bc{_prepareResponse(e){return e.arrayBuffer()}},wc=class extends bc{_prepareResponse(e){return e.json()}},Cc=(Zt((e=>Nt(e.screenSize.height,e.fov,e.zoom))),At((e=>2*Math.tan(.5*e))));var Pc={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0,minZ:1/0,maxZ:-1/0},Sc=ue(0,0,0),Mc={lon:0,lat:0,alt:0},Rc=[ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0),ue(0,0,0)];function Ic(e,t=ue(0,0,0)){return e?Ui(Oi(ue(e[0],e[1],e[2]),Lc),t):pe(0,0,0,t)}var Lc={lon:0,lat:0,alt:0};function Ec(e){let t=new class{constructor({buffer:e,byteOffset:t,byteLength:i}){this._buffer=e,this._currentOffset=t,this._availableBytes=i,this._u32view=new Uint32Array(e)}readUint32(){this._checkAvailableBytes(4);let e=this._u32view[this._currentOffset>>2];return this._advance(4),e}readBinary(e){this._checkAvailableBytes(e);let t=new Uint8Array(this._buffer,this._currentOffset,e);return this._advance(e+(4-e%4)%4),t}readJSON(e){return function(e){let t=(new TextDecoder).decode(e);return JSON.parse(t)}(this.readBinary(e))}availableBytes(){return this._availableBytes}_checkAvailableBytes(e){if(e>this._availableBytes)throw new Error("not enough data")}_advance(e){this._currentOffset+=e,this._availableBytes-=e}}(new Uint8Array(e)),i=function(e){if(1835283298!==e.readUint32())throw new Error("b3dm header magic mismatch");if(1!==e.readUint32())throw new Error("b3dm format version mismatch");return{tileByteLength:e.readUint32(),featureTableJSONByteLength:e.readUint32(),featureTableBinaryByteLength:e.readUint32(),batchTableJSONByteLength:e.readUint32(),batchTableBinaryByteLength:e.readUint32()}}(t),r=function(e,t){if(0===t.featureTableJSONByteLength)return{RTC_CENTER:[0,0,0],BATCH_LENGTH:0};let i=e.readJSON(t.featureTableJSONByteLength);return e.readBinary(t.featureTableBinaryByteLength),i}(t,i),s=function(e,t){if(0===t.batchTableJSONByteLength)return;let i=e.readJSON(t.batchTableJSONByteLength);return e.readBinary(t.batchTableBinaryByteLength),i}(t,i);return{featureTable:r,batchTable:s,binaryGlTF:t.readBinary(t.availableBytes())}}var Ac=["Y","M","A","P","S","_","O","B","J","E","C","T","_","I","D","S"].join("");var Uc=class e{constructor(e,t,i,r=1){this._onTileUpdated=()=>{this._onUpdate.fire(this)},this._updateTile(e),this.baseUri=t,this.modelId=i,this.detalizationFactor=r,this._onUpdate=new wt}get bboxPoints(){return this._bboxPoints}get children(){return this._children?this._children:(this._children=this._initChildren(),this._children||[])}get content(){return this._content}set content(e){this._content&&this._content.onUpdate.removeListener(this._onTileUpdated),this._content=e,this._content&&this._content.onUpdate.addListener(this._onTileUpdated),this._onTileUpdated()}get onUpdate(){return this._onUpdate}load(){return x(this,null,(function*(){if(!this._content&&this._tile.content){let e=this.baseUri+this._tile.content.uri,t=yield(this._contentRequest=new Tc(e)).send();this._contentRequest=void 0;let{featureTable:i,binaryGlTF:r}=Ec(t);return{data:r,metadata:f({[sh]:Ic(i.RTC_CENTER)},i)}}throw new Error("no contentUri or already loaded")}))}cancelLoading(){this._contentRequest&&(this._contentRequest.cancel(),this._contentRequest=void 0)}getTexturesTiers(){let e=Oc(this._tile);return e?Object.keys(e):[]}loadTextures(e){return x(this,null,(function*(){if(this._texturesRequest)throw new Error("textures are already being loaded");let t=Oc(this._tile),i=t&&t[e];if(!i)throw new Error(`tier "${e}" is unknown`);this._texturesRequest=new Tc(this.baseUri+i);let r=yield this._texturesRequest.send();return this._texturesRequest=void 0,new Uint8Array(r)}))}cancelLoadingTextures(){this._texturesRequest&&(this._texturesRequest.cancel(),this._texturesRequest=void 0)}isDetalizationAcceptable(e){let t=Dt(e),i=Wi(e).origin.z,{height:r}=e.screenSize,s=this.detalizationFactor;return this._tile.geometricError*r/(i*Cc(t))*s<55e6}getCustomObjectIds(){return this._tile.content?function(e){let t=e[Ac];if(!t)return;let i=new Map;for(let[e,r]of Object.entries(t))i.set(Number(e),r);return i}(this._tile.content):void 0}_updateTile(e){this._tile=e,e.boundingVolume[nh]?this._bbox=Object.assign(this._bbox||{},e.boundingVolume[nh]):this._bbox=function(e,t=f({},Pc)){if(e.box){let i=e.box;Object.assign(t,Pc);let r=Rc;Ui(Oi(pe(i[0]+i[3]+i[6]+i[9],i[1]+i[4]+i[7]+i[10],i[2]+i[5]+i[8]+i[11],Sc),Mc),r[0]),Ui(Oi(pe(i[0]+i[3]+i[6]-i[9],i[1]+i[4]+i[7]-i[10],i[2]+i[5]+i[8]-i[11],Sc),Mc),Rc[1]),Ui(Oi(pe(i[0]+i[3]-i[6]+i[9],i[1]+i[4]-i[7]+i[10],i[2]+i[5]-i[8]+i[11],Sc),Mc),Rc[2]),Ui(Oi(pe(i[0]+i[3]-i[6]-i[9],i[1]+i[4]-i[7]-i[10],i[2]+i[5]-i[8]-i[11],Sc),Mc),Rc[3]),Ui(Oi(pe(i[0]-i[3]+i[6]+i[9],i[1]-i[4]+i[7]+i[10],i[2]-i[5]+i[8]+i[11],Sc),Mc),Rc[4]),Ui(Oi(pe(i[0]-i[3]+i[6]-i[9],i[1]-i[4]+i[7]-i[10],i[2]-i[5]+i[8]-i[11],Sc),Mc),Rc[5]),Ui(Oi(pe(i[0]-i[3]-i[6]+i[9],i[1]-i[4]-i[7]+i[10],i[2]-i[5]-i[8]+i[11],Sc),Mc),Rc[6]),Ui(Oi(pe(i[0]-i[3]-i[6]-i[9],i[1]-i[4]-i[7]-i[10],i[2]-i[5]-i[8]-i[11],Sc),Mc),Rc[7]);for(let e of r)t.maxX=Math.max(t.maxX,e.x),t.minX=Math.min(t.minX,e.x),t.maxY=Math.max(t.maxY,e.y),t.minY=Math.min(t.minY,e.y),t.maxZ=Math.max(t.maxZ,e.z),t.minZ=Math.min(t.minZ,e.z);return t}throw new Error("unsupported bounding volume type")}(e.boundingVolume,this._bbox),this._bboxCenter=Ae(this._bbox,this._bboxCenter),this._bboxPoints=Ee(this._bbox,this._bboxPoints),this._bboxRadius=function(e){return Math.max(Math.abs(e.maxX-e.minX)/2,Math.abs(e.maxY-e.minY)/2,Math.abs(e.maxZ-e.minZ)/2)}(this._bbox)}_initChildren(){if(!this._tile.children)return;let t=[];for(let i of this._tile.children)if(i.content){let r=this.baseUri+i.content.uri,s=r.match(/\.json$/)?new Vc(r,i,this.modelId,this.detalizationFactor):new e(i,this.baseUri,this.modelId,this.detalizationFactor);s.onUpdate.addListener(this._onTileUpdated),t.push(s)}return t}};function Oc(e){return e.content[oh]}var Vc=class e extends Uc{constructor(e,t,i=Dc++,r){super(t,e.substring(0,e.lastIndexOf("/")+1),i,r),this.tilesetUri=e}load(){return x(this,null,(function*(){if(!this._tileset){let e=this._tilesetRequest=new wc(this.tilesetUri);this._tileset=yield e.send(),this._tilesetRequest=void 0,this._updateTile(this._tileset.root)}return((e,t,i)=>_(h(e),i,t))(e.prototype,this,"load").call(this)}))}cancelLoading(){this._tilesetRequest&&(this._tilesetRequest.cancel(),this._tilesetRequest=void 0),super.cancelLoading()}},Dc=0;function zc(e){return vc[e]}function Bc(e){return e instanceof Vc?e.tilesetUri:e instanceof Uc?e.baseUri:"nouri"}var Fc={getTileId:()=>4294967295},Nc={setTileMetadata(){}},kc=class{constructor(e,t,i,r,s,n,o){this._currentLight=Sd(0),this._onError=new wt,this._onContentError=new wt,this.name=r,this._buildingsFilters=n,this._renderLoop=i,this._metricsTransport=o,this._options=f(f({},Gc),s),this._modelColor=M(Hc),this.memoryUsage={},this._onMemoryUsageChanged=new wt,this.viewport=new rh(t),this.collidingViewport=new rh(t),this._richModelDecoder=new class{constructor(e){Ah(),this._poolSize=e,this._decoders=[],this._workerUrl=""}destructor(){this._destroyDecoders()}setWorkerUrl(e){e!==this._workerUrl&&(this._destroyDecoders(),this._workerUrl=e,this._workerUrl&&this._createDecoders())}decode(e,t,i){if(!this._pool)throw new Error("decoder worker url is not defined");return this._pool.run({content:e,metadata:t},i)}cancel(e){this._pool&&this._pool.cancel(e)}_createDecoders(){for(let e=0;e<this._poolSize;++e){let e=new ph(this._workerUrl);this._decoders.push(e)}let e=this._decoders.map((e=>new Uh(e))),t=[];for(let i=0;i<4;++i)t.push(...e);this._pool=new class{constructor(e){this._executors=[...e],this._active=[],this._queue=new yh}destroy(){for(let e of this._active)e.executor.cancel(e.pending)}run(e,t=0){let i,r,s=new Promise(((e,t)=>{i=e,r=t})),n={promise:s,resolve:i,reject:r,priority:t,input:e};return this._queue.enqueue(n),this._checkTasks(),s}cancel(e){let t=this._active.findIndex((t=>t.promise===e));if(t>=0){let[e]=this._active.splice(t,1);return e.executor.cancel(e.pending),this._executors.push(e.executor),void this._checkTasks()}this._queue.remove((t=>t.promise===e))}_checkTasks(){if(0===this._queue.size||0===this._executors.length)return;let e=this._queue.dequeue();this._active.push(e),e.executor=this._executors.shift(),e.pending=e.executor.run(e.input),e.input=void 0,function(e,t){e.finally?e.finally(t):e.then((e=>Promise.resolve(t()).then((()=>e))),(e=>Promise.resolve(t()).then((()=>Promise.reject(e)))))}(e.pending.then(e.resolve,e.reject),(()=>{let t=this._active.indexOf(e);t>=0&&(this._active.splice(t,1),this._executors.push(e.executor),this._checkTasks())}))}}(t)}_destroyDecoders(){this._pool&&(this._pool.destroy(),this._pool=void 0);for(let e of this._decoders)e.destructor();this._decoders.length=0}}(1),this._richModelDecoder.setWorkerUrl(this._options.gltfDecoderWorkerUrl),this._taskQueue=new class{constructor(e=50){this._queue=new yh,this._frozen=!1,this._dequeueTimeoutHandle=0,this.onEmpty=this._onEmpty=new wt,this.onAdd=this._onAdd=new wt,this._maxDequeueDuration=e}destroy(){clearTimeout(this._dequeueTimeoutHandle)}enqueue(e){return this._onAdd.fire(),this._frozen||this._setDequeueTimeout(),new Promise(((t,i)=>{let r={execute(){try{e.execute(),t()}catch(e){i(e)}},priority:e.priority,task:e};this._queue.enqueue(r)}))}enqueueSync(e){let t={execute(){try{e.execute()}catch(e){console.error(e)}},priority:e.priority,task:e};this._queue.enqueue(t),this._frozen||this._setDequeueTimeout()}remove(e){this._queue.remove((t=>t.task===e))}isEmpty(){return this._queue.isEmpty()}freeze(){this._dequeueTimeoutHandle&&(clearTimeout(this._dequeueTimeoutHandle),this._dequeueTimeoutHandle=0),this._frozen=!0}unfreeze(){this._frozen=!1,this._queue.isEmpty()||this._setDequeueTimeout()}_dequeue(){if(this._dequeueTimeoutHandle=0,null===this._maxDequeueDuration)for(;this._queue.size;)this._queue.dequeue().execute();else{let e=Tr();for(;this._queue.size&&(this._queue.dequeue().execute(),!(Tr()-e>this._maxDequeueDuration)););}this._queue.isEmpty()?this._onEmpty.fire():this._setDequeueTimeout()}_setDequeueTimeout(){this._dequeueTimeoutHandle||(this._dequeueTimeoutHandle=setTimeout((()=>this._dequeue()),0))}}(10),this._tileIdGenerator=new class{constructor(){let{min:e,max:t}=Js;this._generateId=en({min:e>>8,max:t>>8}),this._idToModelMap=new Map,this._modelToIdMap=new Map}getTileId(e){let t=this._modelToIdMap.get(e);return void 0===t?(t=this._generateId()<<8,this._idToModelMap.set(t,e),this._modelToIdMap.set(e,t),this._modelToIdMap.get(e)):t}resetTile(e){let t=this._modelToIdMap.get(e);this._idToModelMap.delete(t),this._modelToIdMap.delete(e)}parseObjectId(e){let t=4294967040&e,i=function(e){let t=255&e;return t<255?t:0}(e),r=this._idToModelMap.get(t);return void 0!==r?{modelId:r,itemId:i}:void 0}},this._tilesMetadata=new class{constructor(e){this._modelToMetadataMap=new Map,this._modelToObjectIdsMap=new Map,this._commonMetadata=[...e]}resetTile(e){this._modelToMetadataMap.delete(e),this._modelToObjectIdsMap.delete(e)}setTileMetadata(e,t,i){let r=new Map;this._modelToMetadataMap.set(e,r),r.set(0,this._createMetadata(e,i)),t&&this._modelToObjectIdsMap.set(e,t)}get(e,t){let i=this._modelToMetadataMap.get(e);if(!i)return;let r=i.get(t);return 0!==t&&!r&&(r=this._makeItemMetadata(i.get(0),t,this._modelToObjectIdsMap.get(e)),i.set(t,r)),r}_createMetadata(e,t){let i=new Map;for(let[e,t]of this._commonMetadata)i.set(e,t);if(i.set("modelId",String(e)),t)for(let[e,r]of t.entries())i.set(e,r);return i}_makeItemMetadata(e,t,i){let r=new Map(e);if(r.set("itemId",String(t)),i){let e=i.get(t);void 0!==e&&r.set("objectId",e)}return r}}([[zl+"layerName",this.name]]),this._contentManager=new gc(e,this.viewport,this._richModelDecoder,this._taskQueue,0,this._tileIdGenerator,this._tilesMetadata),this._collidingContentManager=new gc(e,this.collidingViewport,this._richModelDecoder,this._taskQueue,0,Fc,Nc),this.scene=new Oh(this.viewport),this.collidingScene=new Oh(this.collidingViewport),this._tiles=new Map,this._metrics=new class{constructor(e,t){this._onTileProcessingStageChanged=(e,t,i)=>{let r=this._getTileMetrics(e);r.putMeasuredValue(zc(i),function(e,t){return`${zc(e)}->${zc(t)}`}(i,t),!1),r.unmark(zc(i)),r.mark(zc(t))},this._transport=e,this._contentManager=t,this._tiles=new Map,this._contentManager.onTileProcessingStageChanged.addListener(this._onTileProcessingStageChanged)}destructor(){this._contentManager.onTileProcessingStageChanged.removeListener(this._onTileProcessingStageChanged)}submit(){for(let e of this._tiles.values())e.submit()}_getTileMetrics(e){let t=function(e){return`${Bc(e)}~${e.modelId}`}(e),i=Bc(e);return Vo(this._tiles,t,(()=>new Kl(this._transport,"vector.map.tile3d",1024,void 0,{tileUri:i})))}}(this._metricsTransport,this._contentManager),this._stopSubmittingMetrics=xd((()=>this._metrics.submit()))}get contentManager(){return this._contentManager}get onError(){return this._onError}get onContentError(){return this._onContentError}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}get modelColor(){return this._modelColor}get lightProvider(){return()=>this._currentLight.getParams()}destructor(){this._stopSubmittingMetrics(),this._collidingContentManager.destructor(),this._contentManager.destructor(),this._taskQueue.destroy(),this._metrics.destructor(),this._richModelDecoder.destructor(),this.viewport.destructor(),this.collidingViewport.destructor();for(let[e,t]of this._tiles)this._buildingsFilters.idFilter.removeModelFilter(e),this._removeTileEntry(t)}addRootTile(e,t=[],i,r=Wc){if(void 0===e.modelId)throw new Error("tile modelId is not defined");if(i&&i.modelId!==e.modelId)throw new Error("modelId of tile and collidingTile must be equal");let s=this._getTileEntry(e);if(s)return 5===s.state&&(s.state=0),void this.showRootTile(e);let n={tile:e,collidingTile:i,updateListener:()=>this._onTileUpdateEntryUpdate(n),preRenderListener:()=>this._onPrerenderEntryUpdate(n),objectIds:t,state:0,progress:0,progressUpdateTime:Tr(),hideTimeoutId:0,fadeInDuration:qc(r),fadeOutDuration:Yc};e.onUpdate.addListener(n.updateListener),this._onTileUpdateEntryUpdate(n),this._tiles.set(e.modelId,n),this._addToViewport(n)}removeRootTile(e,t=Yc){let i=this._getTileEntry(e);if(i)switch(i.state){case 4:case 0:this._removeTileEntry(i);break;case 2:case 1:case 3:i.state=5,i.fadeOutDuration=qc(t),this._runFadeOutAnimation(i,(()=>this._removeTileEntry(i)))}}showRootTile(e,t=Wc){let i=this._getTileEntry(e);if(i){switch(i.state){case 3:i.state=0,this._cancelHiding(i);break;case 4:i.state=0,this._addToViewport(i)}i.fadeInDuration=qc(t),this._onTileUpdateEntryUpdate(i)}}hideRootTile(e,t=Yc){let i=this._getTileEntry(e);if(i)switch(i.state){case 1:case 2:i.state=3,i.fadeOutDuration=qc(t),this._runFadeOutAnimation(i,(()=>this._hideTileEntry(i)));break;case 0:this._removeFromViewport(i),i.state=4}}changeRootTileTextures(e,t){this._getTileEntry(e)&&this._contentManager.changeTextures(e,t)}pause(){}resume(){}getObjectMetadata(e){let t=this._tileIdGenerator.parseObjectId(e);if(void 0!==t)return this._tilesMetadata.get(t.modelId,t.itemId)}getModelAppearingProgress(e){var t;return null==(t=this._tiles.get(e))?void 0:t.progress}setModelColor(e){this._modelColor=M(e),this._renderLoop.update()}setLight(e){this._currentLight=Sd(e)}_getTileEntry(e){return this._tiles.get(e.modelId)}_addToViewport(e){this.viewport.addRootTile(e.tile),e.collidingTile&&this.collidingViewport.addRootTile(e.collidingTile)}_removeFromViewport(e){this.viewport.removeRootTile(e.tile),e.collidingTile&&this.collidingViewport.removeRootTile(e.collidingTile)}_onTileUpdateEntryUpdate(e){ah(e.tile)&&(0===e.state?(this._toggleEntryBuildingsFilters(e,!0),e.state=1,e.progress=0,e.progressUpdateTime=Tr(),this._beginRenderLoopUpdates(e)):2===e.state&&this._renderLoop.update()),this.viewport.forceVisibilityRecalculation()}_onPrerenderEntryUpdate(e){let t=Tr(),i=t-e.progressUpdateTime,r=1===e.state?1:-1,s=r>0?e.fadeInDuration:e.fadeOutDuration;e.progress=vt(e.progress+r*i/s,0,1),e.progressUpdateTime=t,r<0&&e.progress<=0?this._endRenderLoopUpdates(e):r>0&&e.progress>=1?(e.state=2,this._endRenderLoopUpdates(e)):this._renderLoop.update()}_cancelHiding(e){0!==e.hideTimeoutId&&(clearTimeout(e.hideTimeoutId),e.hideTimeoutId=0)}_runFadeOutAnimation(e,t){this._cancelHiding(e),e.progressUpdateTime=Tr(),e.hideTimeoutId=setTimeout(t,e.progress*e.fadeOutDuration),this._beginRenderLoopUpdates(e)}_hideTileEntry(e){this._cancelHiding(e),this._removeFromViewport(e),this._endRenderLoopUpdates(e),(3===e.state||5===e.state)&&this._toggleEntryBuildingsFilters(e,!1),e.state=4}_beginRenderLoopUpdates(e){this._endRenderLoopUpdates(e),this._renderLoop.onBeforeRender.addListener(e.preRenderListener),this._renderLoop.update()}_endRenderLoopUpdates(e){this._renderLoop.onBeforeRender.removeListener(e.preRenderListener)}_removeTileEntry(e){var t;let{modelId:i}=e.tile;this._hideTileEntry(e),e.tile.onUpdate.removeListener(e.updateListener),this._tiles.delete(i),this._tileIdGenerator.resetTile(i),this._tilesMetadata.resetTile(i),e.tile.content&&e.tile.content.destructor(),null!=(t=e.collidingTile)&&t.content&&e.collidingTile.content.destructor()}_toggleEntryBuildingsFilters(e,t){let{modelId:i}=e.tile;t?this._buildingsFilters.idFilter.addModelFilter(i,e.objectIds):this._buildingsFilters.idFilter.removeModelFilter(i)}},Hc=A("#E8E4DE"),jc=A("#2B3343"),Gc={basePriority:200,gltfDecoderWorkerUrl:"gltf_decoder.worker.js"},Wc=500,Yc=500;function qc(e){return Math.max(0,e)}var Xc=class{get onUpdate(){return this._filter.onUpdate}constructor(){this._filter=new od,this._modelFilters=new Map}addModelFilter(e,t){if(!this._modelFilters.has(e)){let i=new class{constructor(e){this._objectIds=new Set(e),this.onUpdate=this._onUpdate=new wt}test(e){let{metadata:t}=e;if(t){let e=t.get("objectId");if(void 0!==e)return!this._objectIds.has(e)}return!0}addObjectId(e){this._objectIds.add(e),this._onUpdate.fire()}removeObjectId(e){this._objectIds.delete(e),this._onUpdate.fire()}removeAllObjectIds(){this._objectIds.clear(),this._onUpdate.fire()}}(t);this._modelFilters.set(e,i),this._filter.addFilter(i)}}removeModelFilter(e){let t=this._modelFilters.get(e);t&&(this._modelFilters.delete(e),this._filter.deleteFilter(t))}test(e){return this._filter.test(e)}},Zc=class extends Ka{constructor(e,t,i,r,s){super(e.vao,t,i,r,s)}retain(){this._page.retain()}release(){this._page.release()}},$c=class extends dl{constructor(e,t,i,r,s,n,o,a,l,d){super(e,r,s,i,n,o,a,l,d),this._onExtMessage=e=>{if(1===e.type)this._onExtAddPrimitives(e)},this._reportHybridContentError=e=>{this._onContentError.fire({source:`[TileHybridContentManager] ${e.source}`,message:e.message,error:e.error})},this._extCommunicator=t,this._extCommunicator.onMessage.addListener(this._onExtMessage),this._extCommunicator.sendMessage({type:0,options:l},!1)}destructor(){this._extCommunicator.onMessage.removeListener(this._onExtMessage),super.destructor()}_onExtAddPrimitives(e){return x(this,null,(function*(){let t=this._storage.get(e.tileId);if(cs(t)){let i=e.content[2];for(let[r,s]of function*(e,t,i=((e,t)=>[e,t])){let r=e[Symbol.iterator](),s=t[Symbol.iterator]();for(let e=r.next(),t=s.next();!e.done&&!t.done;e=r.next(),t=s.next())yield i(e.value,t.value)}(i||[],e.images||[])){let e=this._registry.getPage(r.location.bufferId);if(!cs(e))continue;let[i,n]="createImageBitmap"in self?[s,void 0]:us(URL.createObjectURL(s));n&&(yield n);let o=this._context.createEmpty2DTexture(i.width+2,i.height+2,6408,5121,{magnificationFilter:9729,minificationFilter:9729,premultipliedAlpha:!0});this._context.setTextureDataFromDomElement(o,i,{x:1,y:1});let a={primitives:{2:[new Zc(e,r.location,o)]}};t.addContent(a,this._reportHybridContentError),this._onTileContentAdded.fire(t,a,{})}}}))}},Qc=class extends Md{_createContentManager(){return new $c(this._commutator.getCommunicator(3),this._commutator.getCommunicator(8),this._context,this._storage,this._modelStorage,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata())}_isTileVisualizable(e){let t=!!e.content.primitives[2],i=!this._options.tileUrlTemplate||!(!e.content.primitives[6]&&!e.content.primitives[7]);return t&&i}},Kc=class extends Md{_isTileVisualizable(e){return!!e.content.primitives[8]&&super._isTileVisualizable(e)}_addVisibilityFilters(){let e=new id(this._camera);this._contentVisibilityManager.addFilter(6,e).addFilter(7,e).addFilter(110,e)}};p(2,5),p(2,10),p(2,1),p(2,10),p(2,7);var Jc,eu=(e,t)=>{var i,r;return(null!=(i=e.zOrder)?i:0)-(null!=(r=t.zOrder)?r:0)},tu=class{constructor(e){this._target=e,this.primitives=[],this.onUpdate=new wt}addAll(e){this._target.addAll(e)}removeAll(e){this._target.removeAll(e)}},iu=class extends Zr{constructor(e){super(),this._comparator=e}add(e){let t=super.add(e);return t&&this._setDirty(),t}_onDirtyDataAccessed(){super._onDirtyDataAccessed(),function(e,t=Je,i=0,r=e.length){if(r-i<=32)return void nt(e,t,i,r);{let s=i,n=s+32;for(;n<r;)nt(e,t,s,n),s=n,n+=32;nt(e,t,s,r)}let s=new Array(r-i);for(let n=32;n<r-i;n+=n){st(e,s,i,r);let o=i,a=0,l=n,d=l+n;for(;d<r-i;)ot(s,e,t,a,l,d,o),a=d,l=a+n,d=l+n,o+=2*n;ot(s,e,t,a,Math.min(l,r-i),r-i,o)}}(this._data,this._comparator);for(let e=0;e<this._data.length;e++){this._getMetadata(this._data[e]).index=e}}},ru=class extends dl{updateOption(e,t){this._options[e]=t,this._communicator.sendMessage({type:0,options:this._serializeOptions(this._options)},!1)}},su=((Jc=su||{})[Jc.MAP=0]="MAP",Jc[Jc.DRIVING=1]="DRIVING",Jc[Jc.TRANSIT=2]="TRANSIT",Jc[Jc.ADMIN=3]="ADMIN",Jc[Jc.FUTURE_MAP=4]="FUTURE_MAP",Jc),nu={mapType:0,hdMode:!1};function ou(e){return e.mapType*au+Number(e.hdMode)}var au=2,lu=class extends Vd{constructor(e,t,i,r,s,n,o,a,l){super(e,t,i,r,s,n,o,a,l),this.backgroundController=new class{constructor(e){this._onMessage=e=>{0===e.type&&this._onSetBackground(e)},this._communicator=e,this._onBackgroundSet=new wt,this._communicator.onMessage.addListener(this._onMessage)}get onBackgroundSet(){return this._onBackgroundSet}get background(){return this._background}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}_onSetBackground(e){this._background=e.background,this._onBackgroundSet.fire(this._background)}}(this._commutator.getCommunicator(7))}destructor(){this.backgroundController.destructor(),super.destructor()}updateUrlTemplates(e){super.updateUrlTemplates(e),e.styleUrlTemplate&&this._tileContentManager.updateOption("styleUrlTemplate",e.styleUrlTemplate),e.fontListUrlTemplate&&this._tileContentManager.updateOption("fontListUrlTemplate",e.fontListUrlTemplate),e.fontObjectUrlTemplate&&this._tileContentManager.updateOption("fontObjectUrlTemplate",e.fontObjectUrlTemplate)}setMapType(e){e!==this._options.mapType&&(this._tileContentManager.updateOption("mapType",e),this._options.mapType=e,this._recalculateViewport())}setHDMode(e){e!==this._options.hdModeEnabled&&(this._tileContentManager.updateOption("hdModeEnabled",e),this._options.hdModeEnabled=e,this._recalculateViewport())}_createScene(){let e=new Kr(new iu(eu));return g(f({},super._createScene()),{100:e,0:new tu(e),1:new tu(e),2:new tu(e),5:new tu(e)})}_createContentManager(){return new ru(this._commutator.getCommunicator(3),this._storage,this._modelStorage,this._context,this._gpuMemoryRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata())}_getCustomTileIdPrefix(){var e,t;return`${ou({hdMode:null!=(e=this._options.hdModeEnabled)?e:nu.hdMode,mapType:null!=(t=this._options.mapType)?t:nu.mapType})}_`}},du=class{constructor(e){this._addressee=e,this._messageQueue=[],this._transferableQueue=[],this._listeners=[]}addMessage(e,t=[]){this._messageQueue.push(e),this._transferableQueue.push(...t)}onMessage(e){this._listeners.push(e)}flushMessages(){0!==this._messageQueue.length&&this._addressee.postMessage(this._messageQueue,this._transferableQueue),this._messageQueue.length=0,this._transferableQueue.length=0}listen(){this._addressee.onmessage=({data:e})=>{for(let t of e)for(let e of this._listeners)e(t)}}},hu=class extends du{constructor(e,t){let i="function"==typeof e?e():new Worker(e);super(i),this._worker=i,this._onWorkerError=t,this._worker.addEventListener("error",this._onWorkerError),this.listen()}destroy(){this._worker.removeEventListener("error",this._onWorkerError),this._worker.terminate()}};function cu(e){if("undefined"!=typeof window){let t=new class{constructor(e){this._onMessage=({data:e})=>{let t=Sh(e);t&&this._processMessage(t.type,t.id,t.content)},this._masterWorker=e,this._nestedWorkers=new Map,this._masterWorker.addEventListener("message",this._onMessage)}terminate(){this._masterWorker.removeEventListener("message",this._onMessage);for(let e of this._nestedWorkers.values())e.terminate()}_processMessage(e,t,i){switch(e){case xh:this._initNestedWorker(t,i);break;case bh:this._terminateNestedWorker(t);break;case Th:this._passRequestToNestedWorker(t,i)}}_initNestedWorker(e,t){if(this._nestedWorkers.has(e))throw new Error(`nested worker ${e} already exists`);let i=new Worker(t);i.onmessage=({data:t})=>{this._passResponseFromNestedWorker(e,t)},this._nestedWorkers.set(e,i)}_terminateNestedWorker(e){let t=this._nestedWorkers.get(e);if(!t)throw new Error(`nested worker ${e} does not exist`);this._nestedWorkers.delete(e),t.terminate()}_passRequestToNestedWorker(e,t){let i=this._nestedWorkers.get(e);if(!i)throw new Error(`nested worker ${e} does not exist`);i.postMessage(t)}_passResponseFromNestedWorker(e,t){let i=Ph({type:wh,id:e,content:t});this._masterWorker.postMessage(i)}}(e);!function(e,t){let{terminate:i}=e;e.terminate=function(){i.apply(this,arguments),t()}}(e,(()=>t.terminate()))}}var uu="workerInitialized",_u=class{get dataSource(){return this._dataSource}get isVisible(){if(this._dataSource&&this._dataSource.isVisible!==this._isVisible)throw new Error("DataSourceLayer.isVisible is not consistent with the dataSource.isVisible");return this._isVisible}set isVisible(e){var t;this._isVisible!==e&&(this._isVisible=e,this._instantiateDataSourceIfNeeded(),null==(t=this._dataSource)||t.setVisibility(this._isVisible))}constructor(e){this.dataSourceName=e,this._isVisible=!pu.has(e)}destroy(){this._destroyDataSourceIfExists()}setCustomizationConfig(e){throw new Error("Method not implemented.")}setDataSource(e){var t;this._destroyDataSourceIfExists(),this._dataSourceCreator=e,this._instantiateDataSourceIfNeeded(),null==(t=this._dataSource)||t.setVisibility(this._isVisible)}_instantiateDataSourceIfNeeded(){if(!this._isVisible)return;let e=this._dataSourceCreator;this._dataSourceCreator=void 0,e&&(this._dataSource=e())}_destroyDataSourceIfExists(){this._dataSource&&(this._dataSource.destroy(),this._dataSource=void 0),this._dataSourceCreator=void 0}};var pu=new Set(["auction","ppoi","ppoi_no_cache","trf","carparks","carparksnearby","mrc-automotive","mrc-pedestrian","panorama","photos"]);function mu(e,t){"object"==typeof t&&"string"==typeof t.name&&"string"==typeof t.id&&void 0===e.get(t.name)&&e.set(t.name,t.id)}var fu=class extends dl{constructor(e,t,i,r,s,n,o,a,l){super(e,t,i,r,s,n,o,function(e){return{objectsCollisionPriority:e.objectsCollisionPriority,computeIconBrightnessRange:e.computeIconBrightnessRange,accurateGeometryLines:e.accurateGeometryLines,disable3d:e.disable3d,tileSize:e.tileSize,tileUrlTemplate:e.tileUrlConfig.urlTemplate,tileRequestWithCredentials:e.tileUrlConfig.requestWithCredentials,tileRequestHeaders:e.tileUrlConfig.requestHeaders,tileCacheSize:e.tileCacheSize,meshUrlTemplate:e.meshUrlConfig.urlTemplate,meshRequestWithCredentials:e.meshUrlConfig.requestWithCredentials,meshRequestHeaders:e.meshUrlConfig.requestHeaders,richModelUrlTemplate:e.richModelUrlConfig.urlTemplate,richModelRequestWithCredentials:e.richModelUrlConfig.requestWithCredentials,richModelRequestHeaders:e.richModelUrlConfig.requestHeaders,richModelCacheSize:e.richModelCacheSize,richModelEnabled:e.richModelEnabled,richPointEnabled:e.richPointEnabled,richModelDecoderWorkerUrl:e.richModelDecoderWorkerUrl,customizationConfig:e.customizationConfig,deferLowPriorityResourcesLoading:e.deferLowPriorityResourcesLoading,allObjectsInteractive:e.allObjectsInteractive,enableTileContentColliding:e.enableTileContentColliding,tileContentCollidingParameters:e.tileContentCollidingParameters}}(a),l)}};var gu=class{constructor(e,t,i,r,s){this._isVisible=!0,this._dataSourceName=e,this.dataSourceId=t,this.uniqueId=i,this._options=r,this._commutator=new ka(s)}destroy(){var e;null==(e=this._state)||e.destroy(),this._commutator.destructor()}init(e){if(void 0!==this._state)throw new Error(`DataSource ${this._dataSourceName}#${this.dataSourceId} is already initialized`);this._state=new yu(this._dataSourceName,this.dataSourceId,this._commutator,this._options,e),this._isVisible||this._state.pause()}get isVisible(){return this._isVisible}setVisibility(e){this._isVisible!==e&&(this._isVisible=e,this._state&&(e?this._state.resume():this._state.pause()))}updateUrlTemplates(e){throw new Error("Method not implemented.")}description(){return{dataSourceName:this._dataSourceName,dataSourceId:this.dataSourceId,uniqueId:this.uniqueId,type:0,options:this._options}}setMapMode(e){var t;null==(t=this._state)||t.setMapMode(e)}setScenario(e){var t;null==(t=this._state)||t.setScenario(e)}forceUpdateTileVersion(){var e;null==(e=this._state)||e.forceUpdateTileVersion()}getObjectMetadata(e){var t;return null==(t=this._state)?void 0:t.getObjectMetadata(e)}};function vu(e){return!(!e.content.primitives[0]&&!e.content.primitives[1]||!e.content.primitives[6]&&!e.content.primitives[7])}var yu=class{constructor(e,t,i,r,s){this._updateLodHandler=e=>{this._tileContentManager.updateLod(e)},this._submitMetrics=()=>{this._metricsCollector.submit(),this._viewportMetricsCollector.submit()},this._tileGeneration=0,this._context=s.context,this._indoorManager=s.indoorManager,this._mapMode=s.mapMode,this._scenario=s.scenario,this._onError=s.onError,this._onContentError=s.onContentError,this._storage=new Il(i.getCommunicator(1)),this._modelStorage=new Dl(i.getCommunicator(2)),this._objectMetadataIndex=new sd([this._storage,this._modelStorage]),this._iconAtlasRegistry=this._createIconAtlasRegistry(i,r),this._viewport=this._createTileViewport(i,r),this._tileContentManager=this._createTileContentManager(i,r,e,t),this._tileContentManager.onError.addListener(this._onError),this._tileContentManager.onContentError.addListener(this._onContentError),this._tileModelVisibilityManager=new jl(this._context.contentVisibilityManager,this._modelStorage,this._context.camera),this._tileModelVisibilityManager.onUpdateLod.addListener(this._updateLodHandler),this._visibilityManager=this._createViewportVisibilityManager(r);let n=`${e}#${t}`;this._metricsCollector=new Jl(this._context.metricsTransport,n,this._context.camera,this._storage,this._tileContentManager,this._viewport,vu),this._viewportMetricsCollector=new yd(n,this._context.metricsTransport,this._viewport,this._visibilityManager),this._indoorManager.addViewport(this._visibilityManager),this._recalculateViewport(),this._stopSubmittingMetrics=xd(this._submitMetrics)}destroy(){this._stopSubmittingMetrics(),this._indoorManager.removeViewport(this._visibilityManager),this._viewportMetricsCollector.destructor(),this._metricsCollector.destructor(),this._visibilityManager.destructor(),this._tileContentManager.onContentError.removeListener(this._onContentError),this._tileContentManager.onError.removeListener(this._onError),this._tileModelVisibilityManager.onUpdateLod.removeListener(this._updateLodHandler),this._tileModelVisibilityManager.destructor(),this._tileContentManager.destructor(),this._viewport.destructor(),this._iconAtlasRegistry.destructor(),this._objectMetadataIndex.destructor(),this._modelStorage.destructor(),this._storage.destructor()}pause(){this._viewport.pause()}resume(){this._viewport.resume()}setMapMode(e){e!==this._mapMode&&(this._mapMode=e,this._recalculateViewport())}setScenario(e){this._scenario.hdMode===e.hdMode&&this._scenario.mapType===e.mapType||(this._scenario=e,this._recalculateViewport())}forceUpdateTileVersion(){this._tileGeneration++,this._recalculateViewport()}getObjectMetadata(e){return this._objectMetadataIndex.getMetadata(e)}_createTileContentManager(e,t,i,r){return new fu(e.getCommunicator(3),this._storage,this._modelStorage,this._context.context,this._context.gpuMemoryRegistry,this._context.glyphAtlasRegistry,this._iconAtlasRegistry,t,function(e,t){return new Map([[zl+"data_source_id",t],[zl+"data_source_name",e]])}(i,r))}_createTileViewport(e,t){return new gl(e.getCommunicator(0),this._context.camera,t)}_createIconAtlasRegistry(e,t){return new Ol(e.getCommunicator(4),{iconUrlTemplate:t.iconUrlConfig.urlTemplate,iconRequestWithCredentials:t.iconUrlConfig.requestWithCredentials,iconRequestHeaders:t.iconUrlConfig.requestHeaders,dpr:gr(),iconFormat:t.iconFormat},this._context.context)}_createViewportVisibilityManager(e){return new Al({viewport:this._viewport,tileStorage:this._storage,tileContentVisibilityManager:this._context.contentVisibilityManager,modelVisibilityManager:this._tileModelVisibilityManager,isTileVisualizable:vu,visibilityThreshold:Rd(e.viewportVisibleTilesRatioThreshold)})}_recalculateViewport(){this._viewport.tileIdPrefix=this._getTileIdPrefix(),this._viewport.forceCameraStateRecalculation()}_getTileIdPrefix(){let e=1===this._mapMode?"night_":"";return`${ou(this._scenario)}_`+e+this._tileGeneration.toString()}};var xu=(e=>(e[e.VECTOR3_TILE=0]="VECTOR3_TILE",e))(xu||{});var bu=4;var Tu=class{constructor(e,t,i,r,s,n,o,a,l,d){var h,c,u;this.scene=function(){let e=new Kr(new iu(eu));return{100:e,0:new tu(e),1:new tu(e),2:new tu(e),5:new tu(e),3:new Kr,4:new Kr,110:new ol,6:new nd(150),7:new nd(150),8:new nd(150),120:new md,121:new md,122:new md}}(),this._onMessage=e=>{if(1===e.type)this._onError.fire(e.error)},this._dataSourceLayers=new Map,this._onError=new wt,this._onContentError=new wt,this._dataSourceFactory=i,this._camera=s,this._mapMode=null!=(h=t.mapMode)?h:0,this._hdMode=null!=(c=t.hdMode)?c:nu.hdMode,this._mapType=null!=(u=t.mapType)?u:nu.mapType,this._currentLight=Sd(this._mapMode),this._commutator=new ka(r),this._communicator=this._commutator.getCommunicator(0),this._communicator.onMessage.addListener(this._onMessage);let _=new ld(this.scene);this._reportedVisibilityManager=new _d(this.scene,this._camera,d),this._tileContentClipper=new gd(this._commutator.getCommunicator(3)),this._indoorManager=new Ud(this._commutator.getCommunicator(1),{indoorPlanUrlTemplate:e.indoorPlanUrlConfig.urlTemplate,indoorPlanRequestWithCredentials:e.indoorPlanUrlConfig.requestWithCredentials,indoorPlanRequestHeaders:e.indoorPlanUrlConfig.requestHeaders},l,_);let p=new Ul(this._commutator.getCommunicator(2),{glyphRangeUrlTemplate:e.glyphRangeUrlConfig.urlTemplate,glyphRequestWithCredentials:e.glyphRangeUrlConfig.requestWithCredentials,glyphRequestHeaders:e.glyphRangeUrlConfig.requestHeaders},n);this._dataSourceContext={camera:s,context:n,gpuMemoryRegistry:o,glyphAtlasRegistry:p,contentVisibilityManager:_,metricsTransport:a},this._zoomFilter=new id(this._camera),this._richModelVisibilityFilter=new rd(this._camera),this._addVisibilityFilters(),this._sendMapSettingsToBackend()}get lightProvider(){return()=>this._currentLight.getParams()}get onPlansChanged(){return this._indoorManager.onPlansChanged}get plans(){return this._indoorManager.plans}get onError(){return this._onError}get onContentError(){return this._onContentError}destroy(){for(let e of[...this._dataSourceLayers.values()])this.removeDataSourceLayer(e);this._removeVisibilityFilters(),this._zoomFilter.destructor(),this._richModelVisibilityFilter.destructor(),this._indoorManager.destroy();let{glyphAtlasRegistry:e}=this._dataSourceContext;e.destructor(),this._reportedVisibilityManager.destructor(),this._dataSourceContext.contentVisibilityManager.destructor(),this._communicator.onMessage.removeListener(this._onMessage),this._commutator.destructor()}getObjectMetadata(e){var t;for(let i of this._dataSourceLayers.values()){let r=null==(t=i.dataSource)?void 0:t.getObjectMetadata(e);if(r)return r}}getOrCreateDataSourceLayer(e){let t=this._dataSourceLayers.get(e);return void 0===t&&(t=new _u(e),this._dataSourceLayers.set(e,t)),t}removeDataSourceLayer(e){var t;let i=function(e){if(e instanceof _u)return e;throw new Error("Invalid data source layer")}(e);if(!this._dataSourceLayers.has(i.dataSourceName))throw new Error(`DataSourceLayer ${i.dataSourceName} not found`);let r=null==(t=i.dataSource)?void 0:t.uniqueId;this._dataSourceLayers.delete(i.dataSourceName),i.destroy(),void 0!==r&&this._communicator.sendMessage({dataSourceUniqueId:r,type:4},!0)}setMapMode(e){e!==this._mapMode&&(this._currentLight=Sd(e),this._mapMode=e,this._sendMapSettingsToBackend(),this._propagateMapMode())}setMapType(e){e!==this._mapType&&(this._mapType=e,this._sendMapSettingsToBackend(),this._propagateScenario())}setHDMode(e){e!==this._hdMode&&(this._hdMode=e,this._sendMapSettingsToBackend(),this._propagateScenario())}addVisibilityFilter(e,t){this._dataSourceContext.contentVisibilityManager.addFilter(e,t)}removeVisibilityFilter(e,t){this._dataSourceContext.contentVisibilityManager.removeFilter(e,t)}addTileContentClipperGeometry(e){this._tileContentClipper.addGeometry(e),this._forceUpdateTileVersion()}removeTileContentClipperGeometry(e){this._tileContentClipper.removeGeometry(e),this._forceUpdateTileVersion()}getVisibleObjects(){return this._reportedVisibilityManager.getVisibleObjects()}setStyle(e){let t=function(e){let t=new Map;if(!e.sources)return t;for(let i of Object.values(e.sources))if(i)if(Array.isArray(i))for(let e of i)mu(t,e);else mu(t,i);return t}(e),i={type:0,style:e,toBeRemovedDataSources:this._removeOutdatedDataSources(t)};this._communicator.sendMessage(i,!0),this._addAbsentDataSources(t)}_removeOutdatedDataSources(e){let t=[];for(let[i,r]of this._dataSourceLayers){let{dataSource:s}=r;void 0!==s&&(e.get(i)!==s.dataSourceId&&(t.push(s.uniqueId),r.setDataSource(void 0)))}return t}_addAbsentDataSources(e){var t,i;for(let[r,s]of e){if((null==(i=null==(t=this._dataSourceLayers.get(r))?void 0:t.dataSource)?void 0:i.dataSourceId)===s)continue;let e=this._dataSourceLayers.get(r);void 0===e&&(e=new _u(r),this._dataSourceLayers.set(r,e)),e.setDataSource(this._makeDataSourceCreator(r,s))}}_makeDataSourceCreator(e,t){return()=>{let i=new class{constructor(e,t,i){this._dataSourceName=e,this._dataSourceId=t,this._commutator=i}build(e,t){let i=++bu;if(0===e)return new gu(this._dataSourceName,this._dataSourceId,i,t,this._commutator.getCommunicator(i));throw new Error(`Unknown data source type: ${e}`)}}(e,t,this._commutator),r=this._dataSourceFactory(e,t,i);if(!r)return;let s=function(e){if(e instanceof gu)return e;throw new Error("Invalid data source")}(r),n={context:this._dataSourceContext,mapMode:this._mapMode,scenario:this._getScenario(),indoorManager:this._indoorManager,onError:e=>this._onError.fire(e),onContentError:e=>this._onContentError.fire(e)},o={type:3,dataSourceDescription:s.description()};return this._communicator.sendMessage(o,!0),s.init(n),s}}_propagateScenario(){var e;let t=this._getScenario();for(let i of this._dataSourceLayers.values())null==(e=i.dataSource)||e.setScenario(t)}_getScenario(){return{hdMode:this._hdMode,mapType:this._mapType}}_propagateMapMode(){var e;for(let t of this._dataSourceLayers.values())null==(e=t.dataSource)||e.setMapMode(this._mapMode)}_forceUpdateTileVersion(){var e;for(let t of this._dataSourceLayers.values())null==(e=t.dataSource)||e.forceUpdateTileVersion()}_addVisibilityFilters(){this._dataSourceContext.contentVisibilityManager.addFilter(6,this._zoomFilter).addFilter(7,this._zoomFilter).addFilter(8,this._zoomFilter).addFilter(110,this._zoomFilter).addFilter(4,this._richModelVisibilityFilter)}_removeVisibilityFilters(){this._dataSourceContext.contentVisibilityManager.removeFilter(6,this._zoomFilter).removeFilter(7,this._zoomFilter).removeFilter(8,this._zoomFilter).removeFilter(110,this._zoomFilter).removeFilter(4,this._richModelVisibilityFilter)}_sendMapSettingsToBackend(){this._communicator.sendMessage({type:2,mapMode:this._mapMode,scenario:this._getScenario()},!1)}};function wu(e,...t){let i=f({},e);for(let e of t)if(e)for(let t of Object.keys(e)){let r=e[t];void 0!==r&&(i[t]=r)}return i}Tu.defaultOptions={mapMode:0,hdMode:nu.hdMode,mapType:nu.mapType};var Cu,Pu,Su=((Cu=Su||{})[Cu.TILE=0]="TILE",Cu[Cu.ICONS_TILE=1]="ICONS_TILE",Cu[Cu.HYBRID=2]="HYBRID",Cu[Cu.INDOOR=3]="INDOOR",Cu[Cu.GRAPHICS=4]="GRAPHICS",Cu[Cu.GEO=5]="GEO",Cu[Cu.TILE_3D=6]="TILE_3D",Cu[Cu.VMAP3_TILE=7]="VMAP3_TILE",Cu),Mu=class{constructor(e,t,i,r,s,n){this._onMemoryUsageInContentProviderChanged=()=>{let e={providers:this._contentProviders.reduce(((e,{provider:t})=>(e[t.name]=t.memoryUsage,e)),{}),providersTotal:this._computeProvidersTotalMemoryUsage(),gpuMemory:this._gpuMemoryRegistry.memoryUsage};this._onMemoryUsageChanged.fire(e)},this._reportErrorHandler=e=>{this._onInternalError.fire(e)},this._reportContentErrorHandler=e=>{this._onContentError.fire(e)},this._onMessage=e=>{switch(e.type){case 5:this._onPingResponse(e);break;case 6:this._reportErrorHandler(e.error)}},this._onWorkerHolderError=e=>{"Worker"===e.source?this._reportErrorHandler(e):this._reportContentErrorHandler(e)},this._compositeLayerRegistry=new Map,this._onInternalError=new wt,this._onContentError=new wt,this._workerHolder=new class{constructor(e,t){this._pingTimeoutId=0,this._metrics=new Kl(e,"vector.map.content_provider"),this._metrics.mark(uu),this._onError=new wt,this._worker=new hu(t,(e=>{let i;i=void 0===e.message?{source:"Worker",message:`internal worker error (${t})`}:{source:"Worker/Uncaught",message:"uncaught worker error",error:new Error(e.message)},this._onError.fire(i)})),this._stopSubmittingMetrics=xd((()=>this._metrics.submit())),cu(this.worker._worker)}get onError(){return this._onError}get worker(){return this._worker}destructor(){clearTimeout(this._pingTimeoutId),this._stopSubmittingMetrics(),this._worker.destroy()}beginPing(){Ss(0===this._pingTimeoutId,"worker ping is already begun"),this._waitForPingEnd()}endPing(e){Ss(0!==this._pingTimeoutId,"worker ping is not begun"),clearTimeout(this._pingTimeoutId),"6.23.0"===e?this._metrics.putMeasuredValue(uu):this._onError.fire({source:"Worker",message:`worker is not initialized: actual ${e} != expected 6.23.0`})}_waitForPingEnd(){let e=Tr();this._pingTimeoutId=setTimeout((()=>{Tr()-e>30250?this._waitForPingEnd():this.endPing("_TIMEOUT_")}),3e4)}}(s,e),this._context=i,this._camera=t,this._renderLoop=r,this._metricsTransport=s,this._commutator=new ka(new class{constructor(e){this._worker=e,this._scheduledFlush=Qr((()=>e.flushMessages())),this.onMessage=this._onMessage=new wt,e.onMessage((e=>{this._onMessage.fire(e)}))}sendMessage(e,t,...i){this._worker.addMessage(e,i),t&&this._scheduledFlush()}}(this._workerHolder.worker)),this._communicator=this._commutator.getCommunicator(0),this._cpuVisibilityManager=n,this._gpuMemoryRegistry=new Cs(this._commutator.getCommunicator(1),i),this._onMemoryUsageChanged=new wt,this._contentProviders=[],this.coveredByIndoorFilter=new Dd,this.buildingsFilters={idFilter:new Xc},this._currentProviderId=2,this.idGenerator=en(Ks),this._workerHolder.onError.addListener(this._onWorkerHolderError),this._communicator.onMessage.addListener(this._onMessage),this._sendPingRequest()}get onMemoryUsageChanged(){return this._onMemoryUsageChanged}get onInternalError(){return this._onInternalError}get onContentError(){return this._onContentError}get contentProviders(){return this._contentProviders}destructor(){this._communicator.onMessage.removeListener(this._onMessage),this._workerHolder.onError.removeListener(this._onWorkerHolderError);for(let e of this._contentProviders)this._destroyContentProvider(e);for(let e of[...this._compositeLayerRegistry.keys()])this.destroyCompositeLayer(e);this._contentProviders.length=0,this._gpuMemoryRegistry.destructor(),this._commutator.destructor(),this._workerHolder.destructor()}getContentProvider(e,t){let i=this._contentProviders.find((e=>e.provider.name===t));if(i){if(i.type!==e){let r=Ru[e],s=Ru[i.type];throw new Error(`Content provider "${r}:${t}" already exists with another type: ${s}`)}return i.provider}}initContentProvider(e,t,i){let r=this.getContentProvider(e,t);if(r){if(r.isPaused)r.resume();else{let i=Ru[e];console.warn(`initializing already initialized and running content provider: "${i}:${t}"`)}return r}let s,n=this._currentProviderId++;switch(e){case 0:this._initContentProviderBackend(n,t,e,i),s=new Md(this._commutator.getCommunicator(n),this._camera,this._context,this._gpuMemoryRegistry,i,t,this._metricsTransport,this._cpuVisibilityManager);break;case 1:this._initContentProviderBackend(n,t,0,i),s=new Kc(this._commutator.getCommunicator(n),this._camera,this._context,this._gpuMemoryRegistry,i,t,this._metricsTransport,this._cpuVisibilityManager);break;case 2:this._initContentProviderBackend(n,t,e,i),s=new Qc(this._commutator.getCommunicator(n),this._camera,this._context,this._gpuMemoryRegistry,i,t,this._metricsTransport,this._cpuVisibilityManager);break;case 3:this._initContentProviderBackend(n,t,e,i),s=new Vd(t,this._commutator.getCommunicator(n),this._camera,this._context,this._gpuMemoryRegistry,i,this._metricsTransport,this.coveredByIndoorFilter,this._cpuVisibilityManager);break;case 4:this._initContentProviderBackend(n,t,e,i),s=new qd(t,this._camera,this._context,this._commutator.getCommunicator(n),this._gpuMemoryRegistry,i,this._metricsTransport);break;case 5:this._initContentProviderBackend(n,t,e,i),s=new Qd(t,this._context,this._camera,this._commutator.getCommunicator(n),this._gpuMemoryRegistry,i,this._cpuVisibilityManager);break;case 6:s=new kc(this._context,this._camera,this._renderLoop,t,i,this.buildingsFilters,this._metricsTransport);break;case 7:this._initContentProviderBackend(n,t,e,i),s=new lu(t,this._commutator.getCommunicator(n),this._camera,this._context,this._gpuMemoryRegistry,i,this._metricsTransport,this.coveredByIndoorFilter,this._cpuVisibilityManager);break;default:throw new Error(`Unknown content provider type: ${e}:${t}`)}let o=`${Ru[e]}:${t}`,a={id:n,type:e,provider:s,onError:e=>{this._reportErrorHandler(g(f({},e),{source:`ContentProvider/${o}/${e.source}`}))},onContentError:e=>{this._reportContentErrorHandler(g(f({},e),{source:`${o}/${e.source}`}))}};return this._contentProviders.push(a),this._initContentProvider(a),s}getObjectMetadata(e){for(let t of this._contentProviders){if(!t)continue;let i=t.provider.getObjectMetadata(e);if(i)return i}for(let t of this._compositeLayerRegistry.keys()){let i=t.getObjectMetadata(e);if(i)return i}}destroyContentProvider(e){let t=this._contentProviders.findIndex((t=>t.provider===e));if(-1!==t){let[e]=this._contentProviders.splice(t,1);this._destroyContentProvider(e),this._communicator.sendMessage({type:2,id:e.id},!1)}}createCompositeLayer(e,t,i){var r;let s=this._currentProviderId++,n=this._commutator.getCommunicator(s),o=wu(Tu.defaultOptions,t);this._communicator.sendMessage({id:s,options:o,fontListUrlConfig:e.fontListUrlConfig,fontObjectUrlConfig:e.fontObjectUrlConfig,type:3},!1);let a=new Tu(e,o,i,n,this._camera,this._context,this._gpuMemoryRegistry,this._metricsTransport,this.coveredByIndoorFilter,this._cpuVisibilityManager);return a.onError.addListener(this._reportErrorHandler),a.onContentError.addListener(this._reportContentErrorHandler),this._compositeLayerRegistry.set(a,s),null==(r=this._cpuVisibilityManager)||r.addScene(a.scene),a}destroyCompositeLayer(e){var t;let i=e,r=this._compositeLayerRegistry.get(i);if(void 0===r)throw new Error("Composite layer has already been destroyed!");null==(t=this._cpuVisibilityManager)||t.removeScene(i.scene),this._compositeLayerRegistry.delete(i),i.onError.removeListener(this._reportErrorHandler),i.onContentError.removeListener(this._reportContentErrorHandler),i.destroy(),this._communicator.sendMessage({id:r,type:4},!1)}_sendPingRequest(){this._communicator.sendMessage({type:0},!0),this._workerHolder.beginPing()}_onPingResponse(e){this._workerHolder.endPing(e.version)}_initContentProvider(e){var t;let{provider:i}=e;i instanceof fd&&(null==(t=this._cpuVisibilityManager)||t.addScene(i.scene)),i.onError.addListener(e.onError),i.onContentError.addListener(e.onContentError)}_destroyContentProvider(e){var t;let{provider:i}=e;i instanceof fd&&(null==(t=this._cpuVisibilityManager)||t.removeScene(i.scene)),i.onError.removeListener(e.onError),i.onContentError.removeListener(e.onContentError),i.destructor()}_initContentProviderBackend(e,t,i,r){this._communicator.sendMessage({type:1,id:e,name:t,providerType:i,options:r},!1)}_computeProvidersTotalMemoryUsage(){let e=this._contentProviders;return{memoryForGlyphs:e.reduce(((e,{provider:t})=>e+t.memoryUsage.memoryForGlyphs),0),memoryForIcons:e.reduce(((e,{provider:t})=>e+t.memoryUsage.memoryForIcons),0)}}},Ru={0:"TILE",1:"ICONS_TILE",2:"HYBRID",3:"INDOOR",4:"GRAPHICS",5:"GEO",6:"TILE_3D",7:"VMAP3_TILE"},Iu=((Pu=Iu||{})[Pu.LOW=0]="LOW",Pu[Pu.MEDIUM=1]="MEDIUM",Pu[Pu.HIGH=2]="HIGH",Pu[Pu.ULTRA=3]="ULTRA",Pu),Lu=class extends Vc{constructor(){super(...arguments),this._isLoading=!1,this._isLoaded=!1,this._onLoadingStarted=new wt,this._onLoadingFinished=new wt,this._texturesTierLoading=void 0,this._texturesTierLoaded=void 0,this._onTexturesTierLoadingStarted=new wt,this._onTexturesTierLoadingFinished=new wt}get isLoading(){return this._isLoading}get isLoaded(){return this._isLoaded}get onLoadingStarted(){return this._onLoadingStarted}get onLoadingFinished(){return this._onLoadingFinished}get texturesTierLoading(){return this._texturesTierLoading}get texturesTierLoaded(){return this._texturesTierLoaded}get onTexturesTierLoadingStarted(){return this._onTexturesTierLoadingStarted}get onTexturesTierLoadingFinished(){return this._onTexturesTierLoadingFinished}load(){return this._isLoading=!0,this._onLoadingStarted.fire(this),super.load().finally((()=>{this._isLoading=!1})).then((e=>(this._isLoaded=!0,this._onLoadingFinished.fire(this),e)))}cancelLoading(){this._isLoading=!1,super.cancelLoading()}loadTextures(e){return this._texturesTierLoading=e,this._texturesTierLoaded=void 0,this._onTexturesTierLoadingStarted.fire(this,e),super.loadTextures(e).finally((()=>{this._texturesTierLoading=void 0})).then((t=>(this._texturesTierLoaded=e,this._onTexturesTierLoadingFinished.fire(this,e),t)))}cancelLoadingTextures(){this._texturesTierLoading=void 0,super.cancelLoadingTextures()}};new RegExp("#([0-9a-fA-F]{3}|[0-9a-fA-F]{6}|[0-9a-fA-F]{8})$");S(0,0,0,0),function(e,t,i=De()){let r=Math.cos(t),s=Math.sin(t);for(let t=0;t<Ve;t+=4){i[t]=e[t];let n=e[t+1],o=e[t+2];i[t+1]=n*r-o*s,i[t+2]=n*s+o*r,i[t+3]=e[t+3]}}(Oe,Math.PI/2),_e(),Ee(Ue()),B(0,0),Number.MAX_VALUE;var Eu=function(e){let t=new Map;for(let[i,r]of e.entries())t.set(r,i);return t}(new Map([["map",0],["transit",2],["driving",1],["admin",3],["future_map",4]]));function Au(e){let t=Eu.get(e);if(void 0===t)throw"mapTypeToString: unknown map type";return t}var Uu="#version 100\nattribute vec2 vertexPosition;attribute vec2 vertexUv;uniform float zIndex;\n#ifndef YV_LEAST_16b_P\n# ifdef GL_FRAGMENT_PRECISION_HIGH\n# define YV_LEAST_16b_P highp\n# else\n# define YV_LEAST_16b_P mediump\n# endif\n#endif\nvarying YV_LEAST_16b_P vec2 uv;void main(){gl_Position=vec4(vertexPosition,zIndex,1);uv=vertexUv;}",Ou=new D({depthTest:!0,depthFunc:518}),Vu={LIGHT:{r:.98,g:.97,b:.94,a:1},DARK:{r:.12,g:.14,b:.18,a:1}},Du=class extends ft{constructor(e){let t=e.createProgram(Uu,"#version 100\nuniform lowp vec4 color;void main(){gl_FragColor=color;}",{attribMap:{vertexPosition:0,vertexUv:4}});super(e,Ou,t),this._color=Vu.LIGHT,e.bindProgram(t),t.setScalarUniform("zIndex",-1),this.onUpdate=new wt}setColor(e){this._color=e,this.onUpdate.fire()}_render(){this._context.bindQuadVao(),this._context.drawQuad()}_prepareProgram(e){super._prepareProgram(e),e.setScalarUniform("dpr",gr());let{r:t,g:i,b:r,a:s}=this._color;e.setVector4Uniform("color",{x:t,y:i,z:r,w:s})}},zu=new D({depthTest:!0,clearDepth:-1}),Bu=(e=>(e[e.NO_CLEAR=0]="NO_CLEAR",e[e.BEFORE_RENDER=1]="BEFORE_RENDER",e))(Bu||{}),Fu=class extends jr{constructor(e,t=0){super(),this._depthClearStrategy=t,this._context=e}render(e,...t){this._clearDepthIfNeeded(e),super.render(e,...t)}renderHitTestBuffer(e,...t){this._clearDepthIfNeeded(e),super.renderHitTestBuffer(e,...t)}_clearDepthIfNeeded(e){1===this._depthClearStrategy&&(this._context.bindRenderState(zu),this._context.bindRenderTarget(e),this._context.clearCurrentTarget(256))}},Nu=new D(U),ku=class extends ft{constructor(e,t){super(e,Nu,e.createProgram(Uu,"#version 100\nprecision mediump float;uniform vec2 pixelSize;uniform sampler2D texture;uniform float dpr;const float FXAA_QUALITY_SUBPIX=0.75;const float FXAA_QUALITY_EDGE_THRESHOLD=0.063;const float FXAA_QUALITY_EDGE_THRESHOLD_MIN=0.0625;const float EPSILON=0.0001;float luma(vec4 rgba){return dot(rgba.xyz,vec3(0.299,0.587,0.114));}vec4 fxaa(vec2 pos,sampler2D tex,vec2 fxaaQualityRcpFrame,float fxaaQualitySubpix,float fxaaQualityEdgeThreshold,float fxaaQualityEdgeThresholdMin){vec2 posM;posM.x=pos.x;posM.y=pos.y;vec4 rgbyM=texture2D(tex,posM);float lumaM=luma(rgbyM);float lumaS=luma(texture2D(tex,posM+vec2(0,1)*fxaaQualityRcpFrame.xy));float lumaE=luma(texture2D(tex,posM+vec2(1,0)*fxaaQualityRcpFrame.xy));float lumaN=luma(texture2D(tex,posM+vec2(0,-1)*fxaaQualityRcpFrame.xy));float lumaW=luma(texture2D(tex,posM+vec2(-1,0)*fxaaQualityRcpFrame.xy));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);bool earlyExit=range<rangeMaxClamped;if(earlyExit)return rgbyM;float lumaNW=luma(texture2D(tex,posM+vec2(-1,-1)*fxaaQualityRcpFrame.xy));float lumaSE=luma(texture2D(tex,posM+vec2(1,1)*fxaaQualityRcpFrame.xy));float lumaNE=luma(texture2D(tex,posM+vec2(1,-1)*fxaaQualityRcpFrame.xy));float lumaSW=luma(texture2D(tex,posM+vec2(-1,1)*fxaaQualityRcpFrame.xy));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=fxaaQualityRcpFrame.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if(horzSpan){lengthSign=fxaaQualityRcpFrame.y;}else{lumaN=lumaW;lumaS=lumaE;}float subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if(pairN){lengthSign=-lengthSign;}else{lumaNN=lumaSS;}float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB=posM;vec2 offNP;vec2 offHM;if(horzSpan){offNP=vec2(fxaaQualityRcpFrame.x,0.0);offHM=vec2(0.0,lengthSign);}else{offNP=vec2(0.0,fxaaQualityRcpFrame.y);offHM=vec2(lengthSign,0.0);}vec2 posN=posB-offNP*2.;vec2 posP=posB+offNP*2.;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=luma(mix(texture2D(tex,posN),texture2D(tex,posN+offHM),0.5));float subpixE=subpixC*subpixC;float lumaEndP=luma(mix(texture2D(tex,posP),texture2D(tex,posP+offHM),0.5));float gradientScaled=gradient*0.25;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if(!doneN){posN-=offNP*3.0;}bool doneNP=(!doneN)||(!doneP);if(!doneP){posP+=offNP*3.0;}if(doneNP){if(!doneN){lumaEndN=luma(mix(texture2D(tex,posN),texture2D(tex,posN+offHM),0.5));lumaEndN=lumaEndN-lumaNN*0.5;}if(!doneP){lumaEndP=luma(mix(texture2D(tex,posP.xy),texture2D(tex,posP.xy+offHM),0.5));lumaEndP=lumaEndP-lumaNN*0.5;}doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN){posN-=offNP*12.0;}if(!doneP){posP+=offNP*12.0;}}float dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if(!horzSpan){dstN=posM.y-posN.y;dstP=posP.y-posM.y;}float goodSpanN=float((lumaEndN<0.0)!=lumaMLTZero);float spanLength=(dstP+dstN);float goodSpanP=float((lumaEndP<0.0)!=lumaMLTZero);float spanLengthRcp=1.0/spanLength;float directionN=float(dstN<dstP);float dst=min(dstN,dstP);float goodSpan=mix(goodSpanP,goodSpanN,directionN);float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=mix(0.0,pixelOffset,goodSpan);float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);vec4 color;float factor=pixelOffsetSubpix;if(horzSpan){color=mix(texture2D(tex,posM),texture2D(tex,posM+vec2(0.0,lengthSign)),factor);}else{color=mix(texture2D(tex,posM),texture2D(tex,posM+vec2(lengthSign,0.0)),factor);}return color;}void main(){vec2 pos=gl_FragCoord.xy*pixelSize;vec4 color=fxaa(pos,texture,pixelSize,FXAA_QUALITY_SUBPIX,FXAA_QUALITY_EDGE_THRESHOLD,FXAA_QUALITY_EDGE_THRESHOLD_MIN);if(color.a>EPSILON){color.xyz/=color.a;}gl_FragColor=color;}",{attribMap:{vertexPosition:0}})),this._renderers=new jr,this._renderLoop=t,this.onUpdate=this._renderers.onUpdate,this._pixelSize=B(0,0)}addRenderUnit(e){this._renderers.addRenderUnit(e)}removeRenderUnit(e){this._renderers.removeRenderUnit(e)}render(e,...t){if(this._renderLoop.isActive)return this._renderers.render(e,...t),void this._renderLoop.update();this._intermediateRenderbuffer?xr(this._intermediateRenderbuffer.size,e.size)||(this._destroyInternalRenderTargets(),this._initIntermediateRenderTargets(e.size)):this._initIntermediateRenderTargets(e.size),this._context.bindRenderTarget(this._intermediateRenderbuffer),this._context.clearCurrentTarget(17664),this._renderers.render(this._intermediateRenderbuffer,...t),this._intermediateRenderbuffer.isClear||(this._updateFrameUniformState(e),super.render(e,...t))}renderHitTestBuffer(e,...t){this._renderers.renderHitTestBuffer(e,...t)}destroy(){this._intermediateRenderbuffer&&this._destroyInternalRenderTargets()}_render(){this._context.bindQuadVao(),this._context.drawQuad()}_prepareProgram(e,...t){super._prepareProgram(e,...t),this._context.bindTextureUnit(0),this._context.bindTexture(this._intermediateColorBuffer),e.setIntScalarUniform("texture",0),e.setVector2Uniform("pixelSize",this._pixelSize),e.setScalarUniform("dpr",gr())}_updateFrameUniformState(e){this._pixelSize.x=1/e.size.width,this._pixelSize.y=1/e.size.height}_initIntermediateRenderTargets({width:e,height:t}){let i=this._context,r=this._intermediateColorBuffer=i.createEmpty2DTexture(e,t,6408,5121),s=this._intermediateDepthStencilBuffer=i.createRenderbuffer(e,t,34041);this._intermediateRenderbuffer=i.createFramebuffer({color:r,depthStencil:s})}_destroyInternalRenderTargets(){this._intermediateRenderbuffer.destroy(),this._intermediateColorBuffer.destroy(),this._intermediateDepthStencilBuffer.destroy()}},Hu=new D(U),ju={attribMap:{vertexPosition:0,vertexUV:4}},Gu=class extends ft{constructor(e){super(e,Hu,e.createProgram("#version 100\nprecision mediump float;attribute vec2 vertexPosition;attribute vec2 vertexUV;varying vec2 uv;void main(){gl_Position=vec4(vertexPosition,0,1);uv=vertexUV;}","#version 100\nprecision mediump float;uniform sampler2D texture;varying vec2 uv;void main(){gl_FragColor=texture2D(texture,uv);}",ju))}_render(e){this._context.bindTextureUnit(0),this._context.bindTexture(e),this._context.bindQuadVao(),this._context.drawQuad()}},Wu=new D({depthTest:!0,clearDepth:1}),Yu=class extends Fu{constructor(e){super(e),this._midRenderer=new class{constructor(e,t=!0){this._context=e,this._depthBufferEnabled=t,this._outputSize=vr(-1,-1),this._overlayRenderer=new Gu(e)}render(e,t,...i){this._syncOutputBufferWith(e),this._prepareOutputBuffer(),t(this._outputBuffer,...i),this._outputBuffer.isClear||this._overlayRenderer.render(e,this._outputTexture)}destroy(){var e,t,i;this._overlayRenderer.destroy(),null==(e=this._outputTexture)||e.destroy(),null==(t=this._outputDepthBuffer)||t.destroy(),null==(i=this._outputBuffer)||i.destroy()}_syncOutputBufferWith(e){var t;if(!xr(this._outputSize,e.size)){(this._outputTexture||this._outputDepthBuffer||this._outputBuffer)&&(this._outputTexture.destroy(),null==(t=this._outputDepthBuffer)||t.destroy(),this._outputBuffer.destroy());let{width:i,height:r}=yr(e.size,this._outputSize);this._outputTexture=this._context.createEmpty2DTexture(i,r,6408,5121),this._outputDepthBuffer=this._depthBufferEnabled?this._context.createRenderbuffer(i,r,34041):void 0,this._outputBuffer=this._context.createFramebuffer({color:this._outputTexture,depthStencil:this._outputDepthBuffer})}}_prepareOutputBuffer(){this._context.bindRenderTarget(this._outputBuffer),this._context.bindRenderState(Wu),this._context.clearCurrentTarget(16640)}}(e)}render(e,...t){this._midRenderer.render(e,super.render.bind(this),...t)}renderHitTestBuffer(e,...t){this._prepareHitTestRenderTarget(e),super.renderHitTestBuffer(e,...t)}destroy(){this._midRenderer.destroy()}_prepareHitTestRenderTarget(e){this._context.bindRenderTarget(e),this._context.bindRenderState(qu),this._context.clearCurrentTarget(256)}},qu=new D({depthTest:!0,clearDepth:1}),Xu=class{constructor(e={}){this._colorTransformProvider=e.colorTransform,this._opacityProvider=e.opacity||(()=>1)}update(e){var t;let i=null==(t=this._colorTransformProvider)?void 0:t.call(this);i?(e.setVector4Uniform("highlightId",function(e,t){return function(e,t,i,r,s){return s.x=e,s.y=t,s.z=i,s.w=r,s}(255&e,e>>8&255,e>>16&255,e>>24&255,t)}(i.objectId,Zu)),e.setMatrix4Uniform("highlightColorTransform",i.transform)):e.setVector4Uniform("highlightId",bd),e.setScalarUniform("opacity",this._opacityProvider())}},Zu=Td(0,0,0,0);var $u=class extends ks{constructor(e,t,i,r,s,n,o={}){super(e,t,i,r,s,n),this._colorTransformUniforms=new Xu(o)}_prepareProgram(e,t,i,...r){super._prepareProgram(e,t,i,...r),this._colorTransformUniforms.update(e)}},Qu={hitTest:!1},Ku="#version 100\nattribute vec3 vertexPos;attribute vec3 vertexNormal;attribute vec2 vertexUV;attribute vec4 vertexColor;attribute vec4 vertexColorId;\n#ifdef INSTANCING\nattribute vec4 vertexColorStyle;attribute mat4 vertexTransform;attribute vec4 vertexModelStyle;\n#endif\nuniform mat4 viewProjMatrix;uniform mat4 modelMatrix;uniform mat3 normalMatrix;uniform vec4 colorFactor;uniform float zFactor;uniform vec4 primitiveId;uniform float useVertexColor;\n#ifndef YV_COLOR_ID\nuniform vec4 highlightId;uniform mat4 highlightColorTransform;\n#endif\n#ifndef YV_COLOR_ID\nvarying vec2 uv;varying mat4 colorTransform;varying vec4 finalColorFactor;varying vec3 normal;\n#else\nvarying vec4 id;\n#endif\nconst float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}float areFuzzyEqual(vec4 a,vec4 b,float threshold){return float(all(lessThan(abs(a-b),vec4(threshold))));}void main(){vec4 position=modelMatrix*vec4(vertexPos,1);\n#ifdef INSTANCING\nposition=vertexTransform*position;\n#endif\nposition.z*=zFactor*position.w;vec4 objectId=vec4(vertexColorId.x*255.0+primitiveId.x,primitiveId.yzw);\n#ifndef YV_COLOR_ID\nnormal=normalMatrix*vertexNormal;uv=vertexUV;float isHighlighted=areFuzzyEqual(objectId,highlightId,0.5);colorTransform=mat4(1.0)*(1.0-isHighlighted)+highlightColorTransform*isHighlighted;\n#ifdef INSTANCING\nfloat hasInstanceColor=vertexModelStyle.x;float opacity=vertexModelStyle.y;finalColorFactor=mix(vertexColor,vertexColorStyle,hasInstanceColor);finalColorFactor.a*=opacity;\n#else\nfinalColorFactor=mix(colorFactor,vertexColor,useVertexColor);\n#endif\n#else\nid=objectId/255.0;\n#endif\ngl_Position=viewProjMatrix*position;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);}";function Ju(e,t,i,r=De()){let s=ve(e.rtc,e_);return s.x-=i.x,s.y-=i.y,Ne(Be(Oe,s,t_),t,r)}var e_=ue(0,0,0),t_=De(),i_=Td(0,0,1,0),r_=g(f({},Qu),{forceUnlit:!1}),s_=class extends $u{constructor(e,t,i={},r,s,n){let o=wu(r_,r),a=t.createProgram(Ku,"#version 100\nprecision highp float;uniform sampler2D colorTexture;uniform sampler2D occlusionTexture;uniform float occlusionStrength;uniform vec4 diffuseColor;uniform float litFactor;uniform float materialFactor;uniform float opacity;uniform vec4 lightParams;varying vec2 uv;varying mat4 colorTransform;varying vec4 finalColorFactor;varying vec3 normal;vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const float EPSILON=1e-12;float getLightFactor(vec3 normal,vec4 lightParams,float ambientOcclusion,float occlusionStrength){normal=normal/max(length(normal),EPSILON);float ambientContribution=1.0-occlusionStrength*(1.0-ambientOcclusion);return max(dot(lightParams.xyz,normal),0.0)+lightParams.w*ambientContribution;}vec4 applyLightFactor(vec4 color,float lightFactor){return vec4(color.rgb*lightFactor,color.a);}void main(){vec4 baseColor=texture2D(colorTexture,uv)*finalColorFactor;float ambientOcclusion=texture2D(occlusionTexture,uv).r;float lightFactor=getLightFactor(normal,lightParams,ambientOcclusion,occlusionStrength);float litLightFactor=mix(1.0,lightFactor,litFactor);vec4 color=mix(applyLightFactor(diffuseColor,lightFactor),applyLightFactor(baseColor,litLightFactor),materialFactor);gl_FragColor=transformColor(color,colorTransform);gl_FragColor=mix(gl_FragColor,vec4(sqrt(gl_FragColor.rgb),gl_FragColor.a),litFactor);gl_FragColor.a*=opacity;}",s),l=o.hitTest?t.createProgram(Ku,wr,n):void 0;super(e,t,__,a,__,l,i),t.enableInstancedArraysExtension(),this._opaqueWhiteTexture=function(e){let t=o_.get(e);if(t||(t={texture:void 0,refCount:0},o_.set(e,t)),0===t.refCount){let i=e.createEmpty2DTexture(1,1,6408,5121);e.setTextureData(i,new Uint8Array([255,255,255,255])),t.texture=i}return++t.refCount,t.texture}(t),this._materialFactorProvider=function(e){let{materialFactor:t}=e;return t?e=>{var i;return vt(null!=(i=t(e))?i:1,0,1)}:()=>1}(i),this._heightFactorProvider=function(e){let{heightFactor:t}=e;return null!=t?t:()=>1}(i),this._diffuseColorProvider=function(e){let{diffuseColor:t}=e;return null!=t?t:()=>p_}(i),this._litFactorProvider=function(e){return e?()=>0:e=>e.isUnlit?0:1}(o.forceUnlit),this._lightParamsProvider=function(e){let{lightParams:t}=e;return null!=t?t:()=>i_}(i)}destroy(){(function(e){let t=o_.get(e);t&&(--t.refCount,0===t.refCount&&(t.texture.destroy(),o_.delete(e)))})(this._context),super.destroy()}_canBatchAdjacentPrimitives(e,t){return e.id===t.id&&super._canBatchAdjacentPrimitives(e,t)}_getHitTestPrimitives(){return qe(super._getHitTestPrimitives(),a_)}_render(e,t){let i=this._program;for(let r of t)for(let t of Fs(this._getPrimitives(),this._canBatchPredicate))this._setUniforms(t.firstPrimitive,e,r.lookAt,i),this._setColorUniforms(t.firstPrimitive,i),this._renderBatch(t,i)}_renderBatch(e,t){this._context.bindVao(e.firstPrimitive.vao),this._context.drawIndexedMesh(e.indexByteOffset,Ds(e.indexByteLength,e.indexType),4,e.indexType)}_renderHitTestBuffer(e,t){let i=this._hitTestProgram;for(let r of t)for(let t of Fs(this._getHitTestPrimitives(),this._canBatchPredicate))this._setUniforms(t.firstPrimitive,e,r.lookAt,i),this._renderHitTestBufferBatch(t,i)}_renderHitTestBufferBatch(e,t){this._renderBatch(e,t)}_setUniforms(e,t,i,r){let s=Ju(e,t,i,f_);r.setMatrix4Uniform("viewProjMatrix",s),r.setMatrix4Uniform("modelMatrix",e.matrix),r.setMatrix3Uniform("normalMatrix",e.normalMatrix),function(e,t){t.x=e>>0&255,t.y=e>>8&255,t.z=e>>16&255,t.w=e>>24&255}(e.id,m_),r.setVector4Uniform("primitiveId",m_),r.setScalarUniform("zFactor",e.animateHeight?this._heightFactorProvider():1)}_setColorUniforms(e,t){var i,r;t.setColorUniform("diffuseColor",this._diffuseColorProvider()),t.setScalarUniform("litFactor",this._litFactorProvider(e)),t.setScalarUniform("useVertexColor",e.useVertexColor?1:0),t.setScalarUniform("materialFactor",this._materialFactorProvider(e.modelId)),this._context.bindTextureUnit(0),this._context.bindTexture((null==(i=e.image)?void 0:i.texture)||this._opaqueWhiteTexture),this._context.bindTextureUnit(1),this._context.bindTexture((null==(r=e.occlusion)?void 0:r.texture)||this._opaqueWhiteTexture),t.setIntScalarUniform("colorTexture",0),t.setIntScalarUniform("occlusionTexture",1),t.setScalarUniform("occlusionStrength",e.occlusionStrength),t.setColorUniform("colorFactor",e.colorFactor),t.setVector4Uniform("lightParams",this._lightParamsProvider())}},n_=class extends s_{_renderBatch(e,t){this._context.bindVao(e.firstPrimitive.vao),this._context.drawIndexedMeshInstanced(e.indexByteOffset,Ds(e.indexByteLength,e.indexType),4,e.indexType,e.firstPrimitive.instanceCount)}};var o_=new Map;function a_(e){return void 0!==e.metadata}var l_={attribMap:{vertexPos:0,vertexNormal:5,vertexUV:4,vertexColor:7,vertexColorId:2},defines:{}},d_=l_,h_={attribMap:d_.attribMap,defines:g(f({},d_.defines),{YV_COLOR_ID:1})},c_={attribMap:g(f({},l_.attribMap),{vertexTransform:12,vertexColorStyle:9,vertexModelStyle:8}),defines:g(f({},l_.defines),{INSTANCING:1})},u_={attribMap:c_.attribMap,defines:g(f({},c_.defines),{YV_COLOR_ID:1})},__=new D({depthTest:!0,cullFace:!0,cullFaceMode:1029}),p_=C,m_=Td(0,0,0,0),f_=De(),g_=class{constructor(e,t,i={},r){this._onRenderUnitUpdate=()=>{this._onUpdate.fire()},this._onUpdate=new wt;let s={onUpdate:e.onUpdate,get primitives(){return qe(e.primitives,v_)}},n={onUpdate:e.onUpdate,get primitives(){return qe(e.primitives,y_)}};this._basicRenderer=new s_(s,t,i,r,d_,h_),this._instancedRenderer=new n_(n,t,i,r,c_,u_),this._basicRenderer.onUpdate.addListener(this._onRenderUnitUpdate),this._instancedRenderer.onUpdate.addListener(this._onRenderUnitUpdate)}get onUpdate(){return this._onUpdate}destroy(){this._basicRenderer.onUpdate.removeListener(this._onRenderUnitUpdate),this._instancedRenderer.onUpdate.removeListener(this._onRenderUnitUpdate),this._basicRenderer.destroy(),this._instancedRenderer.destroy()}render(e,t,i){this._basicRenderer.render(e,t,i),this._instancedRenderer.render(e,t,i)}renderHitTestBuffer(e,t,i){this._basicRenderer.renderHitTestBuffer(e,t,i),this._instancedRenderer.renderHitTestBuffer(e,t,i)}};function v_(e){return void 0===e.instanceCount}function y_(e){return void 0!==e.instanceCount}function x_(e,t){return t?Ne(e,t):e}var b_=.2125,T_=.7154,w_=.0721;function C_(e){let t,{color:i,lightness:r,opacity:s,saturation:n}=e;if(void 0!==i){let e=function({r:e,g:t,b:i,a:r}){return[0,0,0,e,0,0,0,t,0,0,0,i,0,0,0,r]}(i);return He(e,e)}return void 0!==r&&(t=x_(function(e){let t=1-Math.abs(e),i=Math.max(0,e);return[t,0,0,i,0,t,0,i,0,0,t,i,0,0,0,1]}(r),t)),void 0!==n&&(t=x_(function(e){let t=(1-e)*b_,i=(1-e)*T_,r=(1-e)*w_;return[t+e,i,r,0,t,i+e,r,0,t,i,r+e,0,0,0,0,1]}(n+1),t)),void 0!==s&&(t=x_(function(e){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,e]}(s),t)),t?He(t,t):ze(Oe)}var P_=class{constructor(e,t,i){this._onViewportUpdate=()=>{let e=function(e){return!e[Symbol.iterator]().next().done}(this._viewport.getModels());e!==this._isAppearing&&(this._isAppearing=e,this._lastAnimationTick=Tr(),this._renderLoop.update())},this._onBeforeRender=()=>{if(void 0!==this._lastAnimationTick){let e=Tr(),t=(e-this._lastAnimationTick)/this._duration;this._heightFactor=this._isAppearing?vt(this._heightFactor+t,0,1):0,this._lastAnimationTick=this._isAppearing&&this._heightFactor<1?e:void 0,this._renderLoop.update()}},this._viewport=e,this._renderLoop=t,this._duration=i,this._isAppearing=!1,this._lastAnimationTick=void 0,this._heightFactor=0,this.heightProvider=()=>this._heightFactor,this._viewport.onUpdate.addListener(this._onViewportUpdate),this._renderLoop.onBeforeRender.addListener(this._onBeforeRender),this._onViewportUpdate()}destroy(){this._renderLoop.onBeforeRender.removeListener(this._onBeforeRender),this._viewport.onUpdate.removeListener(this._onViewportUpdate)}},S_=new D(O),M_=class extends jr{constructor(e,t,i){super(),this._onSceneUpdate=()=>{this._onUpdate.fire()},this._context=e,this._scene=t,this._portionPrimitiveProvider=i,this._pool=new class{constructor(e,t){this.capacity=e,this._factory=t,this._usedObjs=new Set,this._freeObjs=[]}destroy(){Ss(0===this._usedObjs.size,"Tried to destroy a pool while objects are in use");for(let e of this._freeObjs)e.destroy()}acquire(){let e=this._freeObjs.pop()||this._factory();return this._usedObjs.add(e),e}release(e){this._usedObjs.delete(e)?this._freeObjs.length<this.capacity?(this._freeObjs.push(e),e.reset&&e.reset()):e.destroy():Ss(!1,"Tried to release an unused object")}}(4,(()=>this._createFramebuffer())),this._program=e.createProgram(Uu,"#version 100\nuniform sampler2D texture;uniform lowp float opacity;varying mediump vec2 uv;void main(){gl_FragColor=texture2D(texture,uv)*opacity;}",{attribMap:{vertexPosition:0,vertexUv:4}}),this._scene.onUpdate.addListener(this._onSceneUpdate)}destroy(){this._scene.onUpdate.removeListener(this._onSceneUpdate),this._program.destroy(),this._pool.destroy()}render(e,...t){let{root:i}=this._scene;i&&this._renderGroup(i,e,...t)}renderHitTestBuffer(e,...t){let{root:i}=this._scene;i&&this._renderGroupHitTest(i,e,...t)}_onSubRenderUnitUpdate(){}_renderGroupChildren(e,t,...i){for(let r of e.batchedChildren)1===r.type?this._renderGroup(r,t,...i):(this._portionPrimitiveProvider.setPortion(r.content),super.render(t,...i))}_renderGroup(e,t,...i){if(e.opacity<1){let r=this._pool.acquire();this._resizeIfNeeded(r),this._context.bindRenderTarget(r.framebuffer),this._context.clearCurrentTarget(16384),this._renderGroupChildren(e,r.framebuffer,...i),this._renderTexture(r.color,e.opacity,t),this._pool.release(r)}else this._renderGroupChildren(e,t,...i)}_renderGroupHitTest(e,t,...i){for(let r of e.batchedChildren)1===r.type?this._renderGroupHitTest(r,t,...i):(this._portionPrimitiveProvider.setPortion(r.content),super.renderHitTestBuffer(t,...i))}_renderTexture(e,t,i){this._context.bindProgram(this._program),this._context.bindTextureUnit(0),this._context.bindTexture(e),this._program.setIntScalarUniform("texture",0),this._program.setScalarUniform("opacity",t),this._context.bindRenderState(S_),this._context.bindRenderTarget(i),this._context.bindQuadVao(),this._context.drawQuad()}_createFramebuffer(){let{width:e,height:t}=this._context.getDefaultRenderTarget().size,i=this._context.createEmpty2DTexture(e,t,6408,5121),r=this._context.createFramebuffer({color:i});return{framebuffer:r,color:i,destroy:()=>{r.destroy(),i.destroy()}}}_resizeIfNeeded(e){let{color:t}=e,{size:i}=this._context.getDefaultRenderTarget();(i.width!==t.getWidth()||i.height!==t.getHeight())&&(e.framebuffer.destroy(),this._context.resizeTexture(t,i),e.framebuffer=this._context.createFramebuffer({color:t}))}},R_=class{constructor(){this._currentPortion={primitives:{}},this._onUpdate=new wt}setPortion(e){this._currentPortion=e,this._onUpdate.fire()}getProvider(e){let t=this,i={get primitives(){return t._currentPortion.primitives[e]||I_},get visiblePrimitives(){return i.primitives},onUpdate:this._onUpdate};return i}},I_=[],L_=class{constructor(e,t){this._type=e,this._scene=t,this.onUpdate=new wt}get primitives(){let e=this._scene,t=this._type;return{*[Symbol.iterator](){let i=e.root?[e.root]:[];for(;i.length>0;){let e=i.pop();for(let r of e.batchedChildren)0===r.type?yield*r.content.primitives[t]:i.push(r)}}}}get visiblePrimitives(){return this.primitives}},E_={attribMap:{vertexPosition:0,vertexUv:4}},A_=class{constructor(e,t,i){this._makeRenderState=Ut(D_),this._context=e,this._camera=t,this._onUpdate=new wt,e.enableFragDepthExtension(),this._renderer=new i(e.gl,{requestRender:()=>this._onUpdate.fire()}),this._program=e.createProgram(Uu,"#version 100\n#extension GL_EXT_frag_depth : enable\nprecision mediump float;uniform sampler2D texture;uniform sampler2D depth;varying mediump vec2 uv;void main(){gl_FragColor=texture2D(texture,uv);gl_FragDepthEXT=texture2D(depth,uv).x;}",E_)}get onUpdate(){return this._onUpdate}destroy(){this._renderer.destroy(),this._program.destroy()}renderHitTestBuffer(){}render(e,t,i){let r=this._render(e,t,i),s=V_(this._context,r.color,U_),n=V_(this._context,r.depth||null,O_);this._context.bindRenderTarget(e),this._context.bindQuadVao(),this._context.bindProgram(this._program),this._setRenderState(r),this._context.bindTextureUnit(0),this._context.bindTexture(s),this._context.bindTextureUnit(1),this._context.bindTexture(n),this._program.setIntScalarUniform("texture",0),this._program.setIntScalarUniform("depth",1),this._context.drawQuad()}_render(e,t,i){this._context.resetContext();try{return this._renderer.render({size:e.size,worlds:i.map((({lookAt:e})=>({camera:this._camera,lookAt:e,viewProjMatrix:t})))})}finally{this._context.resetContext()}}_setRenderState(e){let t=this._makeRenderState(!!e.depth,e.premultipliedAlphaBlend,e.clearDepthValue);this._context.bindRenderState(t),void 0!==e.clearDepthValue&&this._context.clearCurrentTarget(256)}},U_={},O_={};function V_(e,t,i){return(!i.texture||i.texture.handle!==t)&&(i.texture=e.wrapExternalTexture(t)),i.texture}function D_(e,t,i){return new D(t?O:U,{depthTest:e,clearDepth:i})}var z_=At((e=>2/(256*Math.pow(2,e)))),B_="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexNormal;attribute vec4 vertexDisplacement;attribute vec2 vertexUv;attribute vec4 vertexIconLocation;attribute float vertexScale;attribute vec4 vertexId;attribute vec2 vertexZoomRelatedData;attribute float vertexZIndex;attribute vec2 vertexCurrentAndSegmentLength;varying highp vec2 textureCoordinates;varying highp vec4 iconLocation;varying vec4 id;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform highp float worldToPxFactor;uniform float zoom;uniform float zoomScaleFactor;uniform float snapGeometryToNearestZoom;const float MAX_DISPLACEMENT_STROKE_WIDTH=8192.0;const float MAX_TEXTURE_COORDINATE_PX=2048.0;const float MAX_ZOOM=64.0;const float MAX_TEXTURE_DISPLACEMENT=8192.0;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}void main(){float vertexZoom=mix(vertexZoomRelatedData[0]*MAX_ZOOM,floor(zoom+0.5),snapGeometryToNearestZoom);float vertexZoomTextureUScale=vertexZoomRelatedData[1]*MAX_TEXTURE_DISPLACEMENT;float zoomGeometryScale=pow(2.0,(zoom-vertexZoom)*zoomScaleFactor);float zoomScaledWorldToPxFactor=worldToPxFactor*zoomGeometryScale;float zoomScaledPxSegmentLength=vertexCurrentAndSegmentLength.y/zoomScaledWorldToPxFactor;vec2 direction=vec2(vertexNormal.y,-vertexNormal.x);vec2 position=(YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N;vec4 displacement=vertexDisplacement*MAX_DISPLACEMENT_STROKE_WIDTH;vec2 offset=min(abs(displacement.x),zoomScaledPxSegmentLength)*sign(displacement.x)*direction+displacement.y*vertexNormal+displacement.zw;gl_Position=viewProjMatrix*vec4(position+offset*zoomScaledWorldToPxFactor,0,1);gl_Position.z=gl_Position.w*vertexZIndex;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);\n#ifndef YV_COLOR_ID\ntextureCoordinates=vertexUv*MAX_TEXTURE_COORDINATE_PX*vertexScale;iconLocation=vertexIconLocation;float zoomUDisplacementScale=pow(2.0,vertexZoom-zoom)*zoomGeometryScale;float vertexWorldToPxFactor=worldToPxFactor*pow(2.0,zoom-vertexZoom);float pxCurrentLength=vertexCurrentAndSegmentLength.x/vertexWorldToPxFactor;float uDisplacement=min(abs(vertexZoomTextureUScale),zoomScaledPxSegmentLength)*sign(vertexZoomTextureUScale);textureCoordinates.x+=(pxCurrentLength+uDisplacement*zoomUDisplacementScale)*vertexScale;\n#else\nid=vertexId;\n#endif\n}",F_={depthTest:!0,depthMask:!1,depthFunc:518},N_=new D(O),k_={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexNormal:5,vertexDisplacement:6,vertexZIndex:10,vertexUv:4,vertexIconLocation:12,vertexScale:13,vertexZoomRelatedData:14,vertexCurrentAndSegmentLength:15,vertexColor:11}},H_={attribMap:k_.attribMap,defines:{YV_COLOR_ID:1}},j_=g(f({},Qu),{maxZoomWithTilesLoading:1/0,snapGeometryToNearestZoom:!1,renderState:N_,depthTest:!0}),G_=class extends $u{constructor(e,t,i,r,s){let n=wu(j_,s),o=new D(n.renderState,n.depthTest?F_:{}),a=t.createProgram(B_,"#version 100\nprecision mediump float;varying highp vec2 textureCoordinates;varying highp vec4 iconLocation;uniform sampler2D atlas;uniform vec2 atlasSize;uniform float alphaThreshold;uniform float opacity;void main(){vec2 iconSize=iconLocation.yw-iconLocation.xz;highp vec2 texCoordinates=textureCoordinates;texCoordinates.x=mod(texCoordinates.x,iconSize.x);vec2 uv=iconLocation.xz+texCoordinates;vec4 color=texture2D(atlas,uv/atlasSize);if(color.a<alphaThreshold){discard;}gl_FragColor=color*opacity;}",k_),l=n.hitTest?t.createProgram(B_,wr,H_):void 0;super(e,t,o,a,new D(V),l,r),this._camera=i,this._atlasSizeUniform=B(0,0),this._maxZoomWithTilesLoading=n.maxZoomWithTilesLoading,this._snapGeometryToNearestZoom=n.snapGeometryToNearestZoom}_prepareProgram(e,t,i,...r){super._prepareProgram(e,t,i,...r),this._prepareProgramState(e)}_prepareHitTestProgram(e,t,i,...r){super._prepareHitTestProgram(e,t,i,...r),this._prepareProgramState(e)}_renderBatch(e,t){let i=e.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),t.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._context.bindTextureUnit(0),this._context.bindTexture(i,9729,9729),super._renderBatch(e,t)}_canBatchAdjacentPrimitives(e,t){return super._canBatchAdjacentPrimitives(e,t)&&e.texture===t.texture}_prepareProgramState(e){let t=this._camera.zoom,i=vt((t-this._maxZoomWithTilesLoading)/2*.5+.5,.5,1);e.setScalarUniform("worldToPxFactor",z_(t)),e.setScalarUniform("zoom",t),e.setScalarUniform("zoomScaleFactor",i),e.setScalarUniform("snapGeometryToNearestZoom",Number(this._snapGeometryToNearestZoom))}},W_=class extends G_{constructor(e,t,i,r=Y_,s){super(e,t,i,r,g(f({},s),{renderState:q_})),this._stencilIdProvider=r.stencilId}_renderBatch(e,t){if(e.firstPrimitive.opacity>=1)return this._renderState.stencilTest=!1,this._context.bindRenderState(this._renderState),super._renderBatch(e,t);let i=this._stencilIdProvider();i.shouldClear&&this._context.clearCurrentTarget(1024),this._renderState.stencilTest=!0,this._renderState.stencilReference=i.id,this._context.bindRenderState(this._renderState),t.setScalarUniform("alphaThreshold",.9*e.firstPrimitive.opacity),super._renderBatch(e,t),t.setScalarUniform("alphaThreshold",0),super._renderBatch(e,t)}_canBatchAdjacentPrimitives(e,t){return(e.id===t.id||e.opacity>=1&&t.opacity>=1)&&super._canBatchAdjacentPrimitives(e,t)}},Y_={stencilId:()=>{throw new Error("stencilIdProvider is not provided")}},q_=new D(N_,{stencilTest:!0,stencilFrontFunc:517,stencilBackFunc:517,stencilFrontDepthPassOp:7681,stencilBackDepthPassOp:7681}),X_="#version 100\nattribute vec4 vertexCollidingId;attribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute float vertexHeight;attribute float vertexZPos;uniform float isOutlinePhase;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform float dpr;uniform vec4 highlightId;uniform mat4 highlightColorTransform;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;varying lowp vec4 id;const vec4 DISCARD_POSITION=vec4(2,2,2,1);vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);vec4 projectPointLabelVertex(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 posHigh,vec2 posLow,vec2 displacement,vec2 pxSize,float zPos){vec4 position=viewProjMatrix*vec4((YV_H*(posHigh-lookAtHigh)+(posLow-lookAtLow))*YV_N,zPos,1);return position+vec4(position.w*displacement*pxSize,0.0,0.0);}const float GLYPH_BASE_WEIGHT=0.755;const float OUTLINE_WEIGHT_DELTA_BASE=-0.25;float getGlyphWeight(float isOutline){return GLYPH_BASE_WEIGHT+mix(0.0,OUTLINE_WEIGHT_DELTA_BASE,isOutline);}const float GLYPH_BASE_SMOOTHNESS=0.25;const float GLYPH_SMOOTHNESS_HEIGHT_IMPACT=-0.125;const float EXTRA_SMOOTHNESS_HEIGHT_EDGE=9.0;const float EPS=1e-5;float getSmoothnessDelta(float height){return GLYPH_SMOOTHNESS_HEIGHT_IMPACT*step(EXTRA_SMOOTHNESS_HEIGHT_EDGE,height)*(1.0-(1.0/max(height-EXTRA_SMOOTHNESS_HEIGHT_EDGE+1.0,EPS)));}float getGlyphSmoothness(float height,float dpr){return(GLYPH_BASE_SMOOTHNESS+getSmoothnessDelta(height))/dpr;}void main(){float visibilityAlpha=texture2D(visibility,vertexCollidingId.xy/256.0+idHalfPxSize).a;if(visibilityAlpha!=0.0){gl_Position=projectPointLabelVertex(viewProjMatrix,lookAtHigh,lookAtLow,vertexPosHigh,vertexPosLow,vertexDisplacement,pixelSize,vertexZPos);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;weight=getGlyphWeight(isOutlinePhase);smoothness=getGlyphSmoothness(vertexHeight,dpr);vec4 inlineColor=maybeTransformColor(vertexColor,highlightColorTransform,vertexId==highlightId);vec4 outlineColor=vertexOutlineColor;outlineColor.a=maybeTransformColor(outlineColor,highlightColorTransform,vertexId==highlightId).a;color=mix(inlineColor,outlineColor,isOutlinePhase);color.a*=visibilityAlpha;\n#else\nid=vertexId/255.0;\n#endif\n}else{gl_Position=DISCARD_POSITION;}}",Z_="#version 100\nprecision mediump float;uniform sampler2D atlas;uniform float opacity;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;void main(){vec4 resultColor=color;float dist=texture2D(atlas,uv).a;float alpha=smoothstep(weight-smoothness,weight+smoothness,dist);gl_FragColor=vec4(resultColor.rgb,resultColor.a*alpha*opacity);}",$_=new D(U,{cullFace:!0,cullFaceMode:1028}),Q_=new D,K_=class extends $u{constructor(e,t,i,r,s,n){super(e,t,$_,r,Q_,s,n),this._camera=i,this._visibilityProvider=n.visibility,this._atlasSizeUniform=B(0,0)}_render(e,t){this._program.setScalarUniform("isOutlinePhase",1),super._render(e,t),this._program.setScalarUniform("isOutlinePhase",0),super._render(e,t)}_prepareProgram(e,t,i){let r=this._visibilityProvider();super._prepareProgram(e,t,i),this._prepareProgramState(e,r)}_prepareHitTestProgram(e,t,i){let r=this._visibilityProvider();super._prepareHitTestProgram(e,t,i),this._prepareProgramState(e,r)}_renderBatch(e,t){let i=e.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),t.setIntScalarUniform("atlas",1),t.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._context.bindTextureUnit(1),this._context.bindTexture(i),super._renderBatch(e,t)}_canBatchAdjacentPrimitives(e,t){return super._canBatchAdjacentPrimitives(e,t)&&e.texture===t.texture}_prepareProgramState(e,t){this._context.bindTextureUnit(0),this._context.bindTexture(t),e.setVector2Uniform("idHalfPxSize",t.getHalfPxSize()),e.setVector2Uniform("pixelSize",this._camera.pixelSize),e.setScalarUniform("dpr",gr())}},J_="#version 100\nattribute vec3 vWorldPos;attribute vec2 vTexCoords;attribute vec4 vId;attribute lowp vec4 vColor;attribute lowp vec4 vOutlineColor;attribute float vHeight;attribute float vAlpha;attribute float vScale;attribute vec3 vVertexOutlineWidthAndGlyphTexelExtent;attribute vec4 vCenterToGlyphCornerAndCenterWithOffset;uniform float isOutlinePhase;uniform mat4 vpTransform;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform vec4 highlightId;uniform mat4 highlightColorTransform;varying float glyphOutlineWidth;\n#ifndef YV_COLOR_ID\nvarying highp vec2 uv;varying lowp vec4 textColor;varying lowp vec4 outlineColor;\n#else\nvarying lowp vec4 id;\n#endif\nvec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const float sdfBorderRange=1.2;void main(){float vertexOutlineWidth=vVertexOutlineWidthAndGlyphTexelExtent.x;vec2 glyphTexelExtent=vVertexOutlineWidthAndGlyphTexelExtent.yz;vec2 centerToGlyphCornerOnScreen=vCenterToGlyphCornerAndCenterWithOffset.xy;vec2 centerWithOffsetOnScreen=vCenterToGlyphCornerAndCenterWithOffset.zw;float glyphToTexRatio=length(glyphTexelExtent/2.0)/(length(centerToGlyphCornerOnScreen));glyphOutlineWidth=mix(0.0,vertexOutlineWidth*glyphToTexRatio/10.0,isOutlinePhase);float scaleOffset=max(0.0,glyphOutlineWidth-sdfBorderRange)/length(glyphTexelExtent);float glyphScaleOnScreen=1.0+scaleOffset;gl_Position=vpTransform*vec4(vWorldPos,1.0);gl_Position.xy+=(centerWithOffsetOnScreen+centerToGlyphCornerOnScreen*glyphScaleOnScreen)*pixelSize*gl_Position.w*vScale;\n#ifndef YV_COLOR_ID\nuv=vTexCoords/atlasSize;if(isOutlinePhase==1.0){float outlineAlpha=maybeTransformColor(vOutlineColor,highlightColorTransform,vId==highlightId).a;outlineColor=vec4(vOutlineColor.xyz,outlineAlpha*vAlpha);textColor=outlineColor;}else{vec4 inlineColor=maybeTransformColor(vColor,highlightColorTransform,vId==highlightId);textColor=inlineColor;textColor.a*=vAlpha;outlineColor=vec4(0.0);}\n#else\nid=vId/255.0;\n#endif\n}",ep="#version 100\nprecision mediump float;uniform sampler2D atlas;uniform highp float isOutlinePhase;varying lowp vec4 textColor;varying lowp vec4 outlineColor;varying highp vec2 uv;varying float glyphOutlineWidth;const float textSdfBuffer=-0.5;const float textSdfGamma=0.2;const float outlineSdfBufferMax=0.7;const float outlineSdfGamma=0.1;const float sdfBorderRange=outlineSdfBufferMax-textSdfBuffer;void main(){float dist=1.0-2.0*texture2D(atlas,uv).a;float outlineSdfBuffer=textSdfBuffer+min(glyphOutlineWidth,sdfBorderRange);float alphaText=1.0-smoothstep(textSdfBuffer-textSdfGamma,textSdfBuffer+textSdfGamma,dist);if(isOutlinePhase==1.0){float alphaOutline=1.0-smoothstep(outlineSdfBuffer-outlineSdfGamma,outlineSdfBuffer+outlineSdfGamma,dist);gl_FragColor=vec4(outlineColor.rgb,outlineColor.a*max(alphaOutline,0.0));return;}gl_FragColor=vec4(textColor.rgb,textColor.a*alphaText);}",tp=new D(U,{cullFace:!0,cullFaceMode:1028}),ip=new D,rp={attribMap:{vWorldPos:0,vTexCoords:4,vId:2,vColor:7,vOutlineColor:8,vHeight:3,vAlpha:11,vScale:12,vVertexOutlineWidthAndGlyphTexelExtent:13,vCenterToGlyphCornerAndCenterWithOffset:14}},sp={defines:{YV_COLOR_ID:1},attribMap:rp.attribMap},np=class extends ft{constructor(e,t,i,r,s){let n=wu(Qu,s),o=t.createProgram(J_,ep,rp),a=n.hitTest?t.createProgram(J_,wr,sp):void 0;super(t,tp,o,ip,a),this._camera=i,this._colorTransformUniforms=new Xu(r),this._labelsProvider=e}_prepareProgram(e,t,i){super._prepareProgram(e,t,i),this._prepareProgramState(e,t)}_prepareHitTestProgram(e,t,i){super._prepareHitTestProgram(e,t,i),this._prepareProgramState(e,t)}_render(e,t){this._context.bindTextureUnit(0);let i=this._program;for(let{mesh:e,texture:t}of this._labelsProvider)op.x=t.getWidth(),op.y=t.getHeight(),i.setVector2Uniform("atlasSize",op),this._context.bindTexture(t),i.setScalarUniform("isOutlinePhase",1),e.draw(),i.setScalarUniform("isOutlinePhase",0),e.draw()}_renderHitTestBuffer(e,t){for(let{mesh:e}of this._labelsProvider)e.draw()}_prepareProgramState(e,t){e.setMatrix4Uniform("vpTransform",t),e.setVector2Uniform("pixelSize",this._camera.pixelSize),this._colorTransformUniforms.update(e)}},op=F(),ap={attribMap:{vertexCollidingId:10,vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexUV:4,vertexPriority:9,vertexColor:7,vertexOutlineColor:8,vertexHeight:3,vertexZPos:11}},lp={defines:{YV_COLOR_ID:1},attribMap:ap.attribMap},dp=class extends K_{constructor(e,t,i,r,s){let n=wu(Qu,s),o=t.createProgram(X_,Z_,ap),a=n.hitTest?t.createProgram(X_,wr,lp):void 0;super(e,t,i,o,a,r)}_getHitTestPrimitives(){return qe(super._getHitTestPrimitives(),(({metadata:e})=>!(null==e||!e.has("objectId"))))}},hp=class{constructor(e,t,i,r,s,n){this._legacyRenderUint=new dp(e,i,r,s,n),this._labelRenderer=new np(t,i,r,s,n),this._currentRenderer=this._legacyRenderUint,this.onUpdate=this._legacyRenderUint.onUpdate}destroy(){this._legacyRenderUint.destroy(),this._labelRenderer.destroy()}render(e,t,i){this._currentRenderer.render(e,t,i)}renderHitTestBuffer(e,t,i){this._currentRenderer.renderHitTestBuffer(e,t,i)}useExperimental(e){this._currentRenderer=e?this._labelRenderer:this._legacyRenderUint}},cp="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexOffset;attribute vec2 vertexUV;attribute vec4 vertexCollidingId;attribute vec4 vertexId;attribute float vertexPriority;attribute vec2 vertexBrightness;attribute float vertexZPos;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 extensionAndMinSize;uniform vec4 highlightId;varying vec2 uv;varying float alpha;varying vec4 id;varying float minBrightness;varying float maxBrightness;varying float isHighlighted;const float DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR=32.0;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const vec4 DISCARD_POSITION=vec4(2,2,2,1);void main(){float visibilityAlpha=texture2D(visibility,vertexCollidingId.xy/256.0+idHalfPxSize).a;if(visibilityAlpha!=0.0){vec4 position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,vertexZPos,1);vec2 displacement=vertexDisplacement/DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR;vec2 offset=vertexOffset/DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR;float extension=extensionAndMinSize.x;float minSize=extensionAndMinSize.y;vec2 totalDisplacement=max(vec2(minSize*0.5),extension+abs(displacement))*sign(displacement)+offset;gl_Position=position+vec4(position.w*totalDisplacement*pixelSize,0,0);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;alpha=visibilityAlpha;minBrightness=vertexBrightness[0];maxBrightness=vertexBrightness[1];isHighlighted=float(vertexId==highlightId);\n#else\nid=vertexId/255.0;\n#endif\n}else{gl_Position=DISCARD_POSITION;}}",up="#version 100\nprecision mediump float;uniform sampler2D atlas;uniform mat4 highlightColorTransform;uniform float opacity;varying vec2 uv;varying float alpha;varying float minBrightness;varying float maxBrightness;varying float isHighlighted;vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const vec3 BACKGROUND=vec3(1.);vec4 colorize(vec4 color,vec4 updatedColor){float originalBrightness=(0.2126*color.r+0.7152*color.g+0.0722*color.b)/(color.a+1e-5);float brightnessNormalized=clamp((originalBrightness-minBrightness)/(maxBrightness-minBrightness),0.,1.);vec3 correctedRgb=mix(updatedColor.rgb,BACKGROUND,brightnessNormalized);return vec4(correctedRgb*updatedColor.a,updatedColor.a);}void main(){vec4 color=texture2D(atlas,uv);gl_FragColor=mix(color,colorize(color,transformColor(color,highlightColorTransform)),isHighlighted)*alpha*opacity;}",_p=new D(O),pp=new D;var mp=class extends $u{constructor(e,t,i=function(e){return e.createProgram("#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexUV;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;varying vec2 uv;const float YV_H=1.999969482421875;const float YV_L=0.000030517112463712692;void main(){vec4 position=viewProjMatrix*vec4(YV_H*(vertexPosHigh-lookAtHigh)+YV_L*(vertexPosLow-lookAtLow),0,1);gl_Position=position;uv=vertexUV;}","#version 100\nprecision mediump float;uniform sampler2D atlas;uniform vec2 atlasSize;varying vec2 uv;void main(){gl_FragColor=texture2D(atlas,uv/atlasSize);if(gl_FragColor.a==0.0){discard;}}",{attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexUV:4}})}(t),r,s={}){super(e,t,_p,i,pp,r,s),this._atlasSizeUniform=B(0,0)}_renderBatch(e,t){let i=e.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),t.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._prepareTexture(i),super._renderBatch(e,t)}_prepareTexture(e){this._context.bindTextureUnit(0),this._context.bindTexture(e)}_canBatchAdjacentPrimitives(e,t){return super._canBatchAdjacentPrimitives(e,t)&&e.texture===t.texture}},fp="#version 100\nattribute vec3 vWorldPos;attribute vec2 vDisplacement;attribute vec2 vOffset;attribute vec2 vTexCoords;attribute vec4 vId;attribute vec2 vBrightness;attribute float vAlpha;attribute float vScale;uniform mat4 vpTransform;uniform vec2 pixelSize;\n#ifndef YV_COLOR_ID\nuniform vec2 atlasSize;uniform vec4 highlightId;varying vec2 uv;varying float minBrightness;varying float maxBrightness;varying float isHighlighted;varying float alpha;\n#else\nuniform vec2 extensionAndHalfMinSize;varying vec4 id;\n#endif\nvoid main(){\n#ifndef YV_COLOR_ID\nvec2 totalDisplacement=vDisplacement;\n#else\nvec2 extension=vec2(extensionAndHalfMinSize.x);vec2 minSize=vec2(extensionAndHalfMinSize.y);vec2 totalDisplacement=max(minSize,extension+abs(vDisplacement))*sign(vDisplacement);\n#endif\ngl_Position=vpTransform*vec4(vWorldPos,1.0);gl_Position.xy+=(vOffset+totalDisplacement)*pixelSize*gl_Position.w*vScale;\n#ifndef YV_COLOR_ID\nuv=vTexCoords/atlasSize;minBrightness=vBrightness[0];maxBrightness=vBrightness[1];isHighlighted=float(vId==highlightId);alpha=vAlpha;\n#else\nid=vId/255.0;\n#endif\n}",gp=new D(O),vp=new D,yp=g(f({},Qu),{iconHitTestField:0,iconHitTestMinSize:0}),xp={attribMap:{vWorldPos:0,vDisplacement:6,vOffset:11,vTexCoords:4,vId:2,vBrightness:12,vAlpha:13,vScale:14}},bp={attribMap:xp.attribMap,defines:{YV_COLOR_ID:1}},Tp=class extends ft{constructor(e,t,i,r,s){let n=wu(yp,s),o=t.createProgram(fp,up,xp),a=n.hitTest?t.createProgram(fp,wr,bp):void 0;super(t,gp,o,vp,a),this._camera=i,this._colorTransformUniforms=new Xu(r),this._iconsProvider=e,this._extensionAndHalfMinSizeForHitTest={x:n.iconHitTestField,y:n.iconHitTestMinSize/2}}_prepareProgram(e,t,i){super._prepareProgram(e,t,i),e.setMatrix4Uniform("vpTransform",t),e.setVector2Uniform("pixelSize",this._camera.pixelSize),this._colorTransformUniforms.update(e)}_prepareHitTestProgram(e,t,i){super._prepareHitTestProgram(e,t,i),e.setMatrix4Uniform("vpTransform",t),e.setVector2Uniform("pixelSize",this._camera.pixelSize),e.setVector2Uniform("extensionAndHalfMinSize",this._extensionAndHalfMinSizeForHitTest)}_render(e,t){this._context.bindTextureUnit(0);let i=this._program;for(let{mesh:e,texture:t}of this._iconsProvider)wp.x=t.getWidth(),wp.y=t.getHeight(),i.setVector2Uniform("atlasSize",wp),this._context.bindTexture(t),e.draw()}_renderHitTestBuffer(e,t){for(let{mesh:e}of this._iconsProvider)e.draw()}},wp=F(),Cp=g(f({},Qu),{iconHitTestField:0,iconHitTestMinSize:0}),Pp={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexOffset:11,vertexUV:4,vertexCollidingId:10,vertexId:2,vertexPriority:9,vertexBrightness:12,vertexZPos:13}},Sp={attribMap:Pp.attribMap,defines:{YV_COLOR_ID:1}},Mp=class extends mp{constructor(e,t,i,r,s){let n=wu(Cp,s),o=t.createProgram(cp,up,Pp),a=n.hitTest?t.createProgram(cp,wr,Sp):void 0;super(e,t,o,a,r),this._camera=i,this._visibilityProvider=r.visibility,this._extensionAndMinSize={x:n.iconHitTestField,y:n.iconHitTestMinSize}}_prepareProgram(e,t,i){let r=this._visibilityProvider();super._prepareProgram(e,t,i),this._prepareProgramState(e,r),e.setVector2Uniform("extensionAndMinSize",k)}_prepareHitTestProgram(e,t,i){let r=this._visibilityProvider();super._prepareHitTestProgram(e,t,i),this._prepareProgramState(e,r),e.setVector2Uniform("extensionAndMinSize",this._extensionAndMinSize)}_prepareTexture(e){this._context.bindTextureUnit(0);this._context.bindTexture(e,9729,9729)}_prepareProgramState(e,t){this._context.bindTextureUnit(1),this._context.bindTexture(t),e.setIntScalarUniform("visibility",1),e.setVector2Uniform("idHalfPxSize",t.getHalfPxSize()),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},Rp=class{constructor(e,t,i,r,s,n){this._legacyRenderUint=new Mp(e,i,r,s,n),this._iconRenderer=new Tp(t,i,r,s,n),this._currentRenderer=this._legacyRenderUint,this.onUpdate=this._legacyRenderUint.onUpdate}destroy(){this._legacyRenderUint.destroy(),this._iconRenderer.destroy()}render(e,t,i){this._currentRenderer.render(e,t,i)}renderHitTestBuffer(e,t,i){this._currentRenderer.renderHitTestBuffer(e,t,i)}useExperimental(e){this._currentRenderer=e?this._iconRenderer:this._legacyRenderUint}},Ip="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexColor;attribute float vertexZIndex;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec4 highlightId;uniform mat4 highlightColorTransform;uniform float opacity;varying vec4 id;varying vec4 color;vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);void main(){gl_Position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,0,1);gl_Position.z=gl_Position.w*vertexZIndex;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);\n#ifndef YV_COLOR_ID\ncolor=maybeTransformColor(vertexColor,highlightColorTransform,vertexId==highlightId);color.a*=opacity;\n#else\nid=vertexId/255.0;\n#endif\n}",Lp={},Ep={depthTest:!0,depthFunc:518},Ap={vertexPosHigh:0,vertexPosLow:1,vertexColor:7,vertexZIndex:10,vertexId:2},Up={attribMap:Ap},Op={attribMap:Ap,defines:{YV_COLOR_ID:1}},Vp=g(f({},Qu),{renderState:new D(Lp),depthTest:!0}),Dp=class extends $u{constructor(e,t,i,r){let s=wu(Vp,r),n=new D(s.renderState,s.depthTest?Ep:{}),o=t.createProgram(Ip,"#version 100\nvarying lowp vec4 color;void main(){gl_FragColor=color;}",Up),a=s.hitTest?t.createProgram(Ip,wr,Op):void 0;super(e,t,n,o,new D(V),a,i)}},zp=new D(Lp,{depthMask:!1},U),Bp=class extends Dp{constructor(e,t,i,r){super(e,t,i,g(f({},r),{renderState:zp}))}},Fp={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexUv:4,vertexZIndex:10}},Np=class extends ks{constructor(e,t,i=new D(f({},O))){super(e,t,i,t.createProgram("#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexUv;attribute vec2 vertexDisplacement;attribute float vertexZIndex;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;varying vec2 uv;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);void main(){gl_Position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,0,1);gl_Position.z=gl_Position.w*vertexZIndex;uv=vertexUv;}","#version 100\nprecision mediump float;uniform sampler2D atlas;varying vec2 uv;void main(){gl_FragColor=texture2D(atlas,uv);}",Fp))}_renderBatch(e,t){this._context.bindTextureUnit(0),this._context.bindTexture(e.firstPrimitive.texture),super._renderBatch(e,t)}_canBatchAdjacentPrimitives(e,t){return e.texture===t.texture}},kp=new D({depthTest:!0}),Hp={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexHeight:3,vertexColor:7,vertexId:2}},jp={attribMap:Hp.attribMap,defines:{YV_COLOR_ID:1}},Gp=()=>1,Wp=class extends $u{constructor(e,t,i,r,s,n){let o=wu(Qu,n),a=t.createProgram(i,r,Hp),l=o.hitTest?t.createProgram(i,wr,jp):void 0;super(e,t,kp,a,kp,l,s),this._heightFactorProvider=(null==s?void 0:s.heightFactor)||Gp}_prepareProgram(e,t,i,...r){super._prepareProgram(e,t,i,...r),e.setScalarUniform("zFactor",this._heightFactorProvider())}_prepareHitTestProgram(e,t,i,...r){super._prepareHitTestProgram(e,t,i,...r),e.setScalarUniform("zFactor",this._heightFactorProvider())}},Yp="#version 100\nprecision highp float;varying vec4 color;void main(){gl_FragColor=color;}",qp=class{constructor(e,t,i,r){this._onUpdate=new wt,this._onRenderUnitUpdate=()=>{this._onUpdate.fire()};let s={onUpdate:e.onUpdate,get primitives(){return qe(e.primitives,Zp)}},n={onUpdate:e.onUpdate,get primitives(){return qe(e.primitives,Xp)}};this._legacyModelRenderUnit=new Wp(s,t,"#version 100\nattribute vec3 vertexPosHigh;attribute vec3 vertexPosLow;attribute float vertexHeight;attribute vec4 vertexColor;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform float zFactor;uniform vec4 highlightId;uniform mat4 highlightColorTransform;uniform float opacity;varying vec4 color;varying vec4 id;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}void main(){vec4 globalPos=vec4((YV_H*(vertexPosHigh.xy-lookAtHigh)+(vertexPosLow.xy-lookAtLow))*YV_N,vertexHeight*zFactor,1);gl_Position=viewProjMatrix*globalPos;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);\n#ifndef YV_COLOR_ID\ncolor=maybeTransformColor(vertexColor,highlightColorTransform,vertexId==highlightId);color.a*=opacity;\n#else\nid=vertexId/255.0;\n#endif\n}",Yp,i,r),this._extrudedModelRenderUnit=new Wp(n,t,"#version 100\nattribute vec3 vertexPosHigh;attribute vec3 vertexPosLow;attribute float vertexHeight;attribute vec4 vertexColor;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform float zFactor;uniform vec4 highlightId;uniform mat4 highlightColorTransform;uniform float opacity;varying vec4 color;varying vec4 id;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);vec4 transformColor(vec4 color,mat4 transform){return transform*vec4(color.rgb,1)*vec4(1,1,1,color.a);}vec4 maybeTransformColor(vec4 color,mat4 transform,bool condition){return mix(color,transformColor(color,transform),float(condition));}const float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}void main(){vec4 globalPos=vec4((YV_H*(vertexPosHigh.xy-lookAtHigh)+(vertexPosLow.xy-lookAtLow))*YV_N,vertexHeight*zFactor,1);gl_Position=viewProjMatrix*globalPos;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);\n#ifndef YV_COLOR_ID\ncolor=maybeTransformColor(vertexColor,highlightColorTransform,vertexId==highlightId);color.a*=opacity;\n#else\nid=vertexId/255.0;\n#endif\n}",Yp,i,r),this._legacyModelRenderUnit.onUpdate.addListener(this._onRenderUnitUpdate),this._extrudedModelRenderUnit.onUpdate.addListener(this._onRenderUnitUpdate)}get onUpdate(){return this._onUpdate}destroy(){this._legacyModelRenderUnit.onUpdate.removeListener(this._onRenderUnitUpdate),this._extrudedModelRenderUnit.onUpdate.removeListener(this._onRenderUnitUpdate),this._legacyModelRenderUnit.destroy(),this._extrudedModelRenderUnit.destroy()}render(e,t,i){this._legacyModelRenderUnit.render(e,t,i),this._extrudedModelRenderUnit.render(e,t,i)}renderHitTestBuffer(e,t,i){this._legacyModelRenderUnit.renderHitTestBuffer(e,t,i),this._extrudedModelRenderUnit.renderHitTestBuffer(e,t,i)}};function Xp(e){return e.isExtruded}function Zp(e){return!e.isExtruded}var $p="#version 100\nattribute vec4 vertexCollidingId;attribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute vec2 vertexPolylineLengthDisplacement;attribute float vertexHeight;attribute vec4 vertexLeftPolylineRatios;attribute vec4 vertexLeftPolylineAngles;attribute vec4 vertexRightPolylineRatios;attribute vec4 vertexRightPolylineAngles;uniform float isOutlinePhase;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform float dpr;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;varying lowp vec4 id;const vec4 DISCARD_POSITION=vec4(2,2,2,1);const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float PI=3.1415927410125732;const int MAX_POLYLINE_POINTS=4;const float INFINITY=1000000.0;const float UBYTE_RATIO_EPSILON=1.0/256.0;vec2 project(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pixelSize,vec2 pointHigh,vec2 pointLow,vec2 delta){vec4 position=viewProjMatrix*vec4((YV_H*(pointHigh-lookAtHigh)+(pointLow-lookAtLow))*YV_N+delta,0,1);vec2 projected=position.xy/position.w;return projected/pixelSize;}vec2 decodePolylineDeltas(float ratio,float angle,float polylineLength){float a=angle*2.0*PI-PI;float len=ratio*polylineLength;return vec2(cos(a),sin(a))*len;}float value(vec4 a,int i){if(i==0)return a[0];if(i==1)return a[1];if(i==2)return a[2];return a[3];}vec4 projectPolylineLabelVertex(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pxSize,vec2 posHigh,vec2 posLow,vec2 displacement,float lineDisplacement,float polylineLength,vec4 leftPolylineRatios,vec4 leftPolylineAngles,vec4 rightPolylineRatios,vec4 rightPolylineAngles){vec2 position=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,vec2(0,0));vec2 deltas=decodePolylineDeltas(rightPolylineRatios[0],rightPolylineAngles[0],polylineLength);vec2 projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,deltas);bool isRightPart=lineDisplacement>0.0;bool isInverted=projectedPoint.x<position.x;float isLeftToRight=float(isRightPart ^^ isInverted);if(isRightPart==isInverted){deltas=mix(decodePolylineDeltas(leftPolylineRatios[0],leftPolylineAngles[0],polylineLength),decodePolylineDeltas(rightPolylineRatios[0],rightPolylineAngles[0],polylineLength),isLeftToRight);projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,deltas);}float remainingLength=abs(lineDisplacement);for(int i=1;i<=MAX_POLYLINE_POINTS;i++){vec2 segment=projectedPoint-position;float isLast=float(i==MAX_POLYLINE_POINTS||value(mix(leftPolylineRatios,rightPolylineRatios,isLeftToRight),i)<UBYTE_RATIO_EPSILON);float segmentLength=mix(length(segment),INFINITY,isLast);if(segmentLength>remainingLength){float signFactor=mix(-1.0,1.0,float(lineDisplacement>0.0));vec2 direction=normalize(segment);vec2 normal=vec2(-direction.y,direction.x);position+=direction*remainingLength;position+=signFactor*direction*displacement.x;position+=signFactor*normal*displacement.y;break;}else{remainingLength-=segmentLength;position+=segment;vec2 nextDeltas=mix(decodePolylineDeltas(value(leftPolylineRatios,i),value(leftPolylineAngles,i),polylineLength),decodePolylineDeltas(value(rightPolylineRatios,i),value(rightPolylineAngles,i),polylineLength),isLeftToRight);projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,nextDeltas);}}return vec4(position*pxSize,0.0,1.0);}const float GLYPH_BASE_WEIGHT=0.755;const float OUTLINE_WEIGHT_DELTA_BASE=-0.25;float getGlyphWeight(float isOutline){return GLYPH_BASE_WEIGHT+mix(0.0,OUTLINE_WEIGHT_DELTA_BASE,isOutline);}const float GLYPH_BASE_SMOOTHNESS=0.25;const float GLYPH_SMOOTHNESS_HEIGHT_IMPACT=-0.125;const float EXTRA_SMOOTHNESS_HEIGHT_EDGE=9.0;const float EPS=1e-5;float getSmoothnessDelta(float height){return GLYPH_SMOOTHNESS_HEIGHT_IMPACT*step(EXTRA_SMOOTHNESS_HEIGHT_EDGE,height)*(1.0-(1.0/max(height-EXTRA_SMOOTHNESS_HEIGHT_EDGE+1.0,EPS)));}float getGlyphSmoothness(float height,float dpr){return(GLYPH_BASE_SMOOTHNESS+getSmoothnessDelta(height))/dpr;}void main(){float visibilityAlpha=texture2D(visibility,vertexCollidingId.xy/256.0+idHalfPxSize).a;if(visibilityAlpha!=0.0){float vertexLineLength=vertexPolylineLengthDisplacement.x;float vertexLineDisplacement=vertexPolylineLengthDisplacement.y;gl_Position=projectPolylineLabelVertex(viewProjMatrix,lookAtHigh,lookAtLow,pixelSize,vertexPosHigh,vertexPosLow,vertexDisplacement,vertexLineDisplacement,vertexLineLength,vertexLeftPolylineRatios,vertexLeftPolylineAngles,vertexRightPolylineRatios,vertexRightPolylineAngles);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;weight=getGlyphWeight(isOutlinePhase);smoothness=getGlyphSmoothness(vertexHeight,dpr);color=mix(vertexColor,vertexOutlineColor,isOutlinePhase);color.a*=visibilityAlpha;\n#else\nid=vertexId/255.0;\n#endif\n}else{gl_Position=DISCARD_POSITION;}}",Qp="#version 100\nattribute vec2 vNdcCenterToGlyphCornerOnScreen;attribute vec2 vTexCoords;attribute vec4 vId;attribute lowp vec4 vColor;attribute lowp vec4 vOutlineColor;attribute float vHeight;attribute vec3 vVertexOutlineWidthAndGlyphTexelExtent;attribute vec3 vNdcCenterWithOffsetOnScreenAndGlyphToTexRatio;uniform float isOutlinePhase;uniform vec2 atlasSize;varying float glyphOutlineWidth;\n#ifndef YV_COLOR_ID\nvarying highp vec2 uv;varying lowp vec4 textColor;varying lowp vec4 outlineColor;\n#else\nvarying lowp vec4 id;\n#endif\nconst float sdfBorderRange=1.2;void main(){float vertexOutlineWidth=vVertexOutlineWidthAndGlyphTexelExtent.x;vec2 glyphTexelExtent=vVertexOutlineWidthAndGlyphTexelExtent.yz;vec2 centerWithOffsetOnScreen=vNdcCenterWithOffsetOnScreenAndGlyphToTexRatio.xy;float glyphToTexRatio=vNdcCenterWithOffsetOnScreenAndGlyphToTexRatio.z;glyphOutlineWidth=mix(0.0,vertexOutlineWidth*glyphToTexRatio/10.0,isOutlinePhase);float scaleOffset=max(0.0,glyphOutlineWidth-sdfBorderRange)/length(glyphTexelExtent);float glyphScaleOnScreen=1.0+scaleOffset;gl_Position=vec4(centerWithOffsetOnScreen+vNdcCenterToGlyphCornerOnScreen*glyphScaleOnScreen,0.0,1.0);\n#ifndef YV_COLOR_ID\nuv=vTexCoords/atlasSize;if(isOutlinePhase==1.0){outlineColor=vOutlineColor;textColor=outlineColor;}else{textColor=vColor;outlineColor=vec4(0.0);}\n#else\nid=vec4(vId.xy/255.0,0,0);\n#endif\n}",Kp=new D(U,{cullFace:!0,cullFaceMode:1028}),Jp=new D,em={attribMap:{vNdcCenterToGlyphCornerOnScreen:0,vTexCoords:4,vId:2,vColor:7,vOutlineColor:8,vHeight:3,vVertexOutlineWidthAndGlyphTexelExtent:11,vNdcCenterWithOffsetOnScreenAndGlyphToTexRatio:12}},tm={defines:{YV_COLOR_ID:1},attribMap:em.attribMap},im=class extends ft{constructor(e,t,i,r){let s=wu(Qu,r),n=t.createProgram(Qp,ep,em),o=s.hitTest?t.createProgram(Qp,wr,tm):void 0;super(t,Kp,n,Jp,o),this._opacityProvider=i.opacity||(()=>1),this._labelsProvider=e}_prepareProgram(e,t,i){super._prepareProgram(e,t,i),e.setScalarUniform("opacity",this._opacityProvider())}_render(e,t){this._context.bindTextureUnit(0);let i=this._program;for(let{mesh:e,texture:t}of this._labelsProvider)rm.x=t.getWidth(),rm.y=t.getHeight(),i.setVector2Uniform("atlasSize",rm),this._context.bindTexture(t),i.setScalarUniform("isOutlinePhase",1),e.draw(),i.setScalarUniform("isOutlinePhase",0),e.draw()}_renderHitTestBuffer(e,t){for(let{mesh:e}of this._labelsProvider)e.draw()}},rm=F(),sm={attribMap:{vertexCollidingId:10,vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexUV:4,vertexColor:7,vertexOutlineColor:8,vertexPriority:9,vertexLeftPolylineRatios:12,vertexLeftPolylineAngles:13,vertexRightPolylineRatios:14,vertexRightPolylineAngles:15,vertexPolylineLengthDisplacement:11,vertexHeight:3}},nm={defines:{YV_COLOR_ID:1},attribMap:sm.attribMap},om=class extends K_{constructor(e,t,i,r,s){let n=wu(Qu,s),o=t.createProgram($p,Z_,sm),a=n.hitTest?t.createProgram($p,wr,nm):void 0;super(e,t,i,o,a,r)}},am=class{constructor(e,t,i,r,s,n){this._legacyRenderUint=new om(e,i,r,s,n),this._labelRenderer=new im(t,i,s,n),this._currentRenderer=this._legacyRenderUint,this.onUpdate=this._legacyRenderUint.onUpdate}destroy(){this._legacyRenderUint.destroy(),this._labelRenderer.destroy()}render(e,t,i){this._currentRenderer.render(e,t,i)}renderHitTestBuffer(e,t,i){this._currentRenderer.renderHitTestBuffer(e,t,i)}useExperimental(e){this._currentRenderer=e?this._labelRenderer:this._legacyRenderUint}},lm={vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6},dm=class extends ks{constructor(e,t,i,r=new D){super(e,t,r,t.createProgram(Vs,wr,{attribMap:lm})),this._camera=i}_prepareProgram(e,t,i){super._prepareProgram(e,t,i),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},hm=class{constructor(e,t,i){this._onPrimitivesUpdate=()=>{this._onUpdate.fire()},this._primitiveProvider=e,this._portionPrimitiveProvider=t,this._renderUnits=i,this._onUpdate=new wt,this._typeToRenderUnit={0:this._renderUnits.opaquePolygon,1:this._renderUnits.transparentPolygon,2:this._renderUnits.texPolygonRenderUnit,5:this._renderUnits.polyline},this._primitiveProvider.onUpdate.addListener(this._onPrimitivesUpdate)}get onUpdate(){return this._onUpdate}destroy(){this._primitiveProvider.onUpdate.removeListener(this._onPrimitivesUpdate)}render(e,...t){var i;for(let{type:r,portion:s}of cm(this._primitiveProvider.primitives))this._portionPrimitiveProvider.setPortion(s),null==(i=this._typeToRenderUnit[r])||i.render(e,...t)}renderHitTestBuffer(e,...t){var i;for(let{type:r,portion:s}of cm(this._primitiveProvider.primitives))this._portionPrimitiveProvider.setPortion(s),null==(i=this._typeToRenderUnit[r])||i.renderHitTestBuffer(e,...t)}};function*cm(e){let t=[];for(let i of e)0===t.length||t[0].type===i.type?t.push(i):(yield um(t),t=[i]);t.length>0&&(yield um(t))}function um(e){let t=e[0].type;return{type:t,portion:{primitives:{[t]:e}}}}var _m=class extends js{constructor(e,t,i,r,s){super(e,t,i,s),this._camera=r}_prepareProgram(e,t,i,r,s,n,o,a,l,d,h){super._prepareProgram(e,t,i,r,s,n,o,a,l,d,h),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},pm=class extends _m{constructor(e,t,i){super(e,t,t.createProgram("#version 100\nattribute vec4 vertexCollidingId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute float vertexZPos;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying lowp vec4 id;const vec4 DISCARD_POSITION=vec4(2,2,2,1);const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);vec4 projectPointLabelVertex(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 posHigh,vec2 posLow,vec2 displacement,vec2 pxSize,float zPos){vec4 position=viewProjMatrix*vec4((YV_H*(posHigh-lookAtHigh)+(posLow-lookAtLow))*YV_N,zPos,1);return position+vec4(position.w*displacement*pxSize,0.0,0.0);}const vec4 EMPTY_PRIMITIVE=vec4(0,0,0,0);const vec2 NO_ID=vec2(0,0);const float ID_RENORMALIZATION=255.0/256.0;const float ZOOM_THRESHOLD=0.05;const float TILT_THRESHOLD=0.15;const float AZIMUTH_THRESHOLD=0.02;bool isOverlapperStillVisible(vec2 idTexCoordinate,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 overlapId=texture2D(overlap,idTexCoordinate).rg;return overlapId!=NO_ID&&texture2D(scene,overlapId*ID_RENORMALIZATION+idHalfPxSize)!=EMPTY_PRIMITIVE;}float getVisibility(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 idTexCoordinate=id/256.0+idHalfPxSize;vec4 visibilityValue=texture2D(visibility,idTexCoordinate);float overlapZoom=visibilityValue.b;float overlapTilt=visibilityValue.r;float overlapAzimuth=visibilityValue.g;float zoomDiff=overlapZoom-currentZoom;float tiltDiff=abs(overlapTilt-currentTilt);float azimuthDiff=abs(overlapAzimuth-currentAzimuth);if((zoomDiff>ZOOM_THRESHOLD||(abs(zoomDiff)<=ZOOM_THRESHOLD&&tiltDiff<TILT_THRESHOLD&&azimuthDiff<AZIMUTH_THRESHOLD))&&isOverlapperStillVisible(idTexCoordinate,idHalfPxSize,overlap,scene)){return-1.0;}return visibilityValue.a;}void main(){float alpha=getVisibility(vertexCollidingId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(alpha<0.0){gl_Position=DISCARD_POSITION;}else{vec4 pos=projectPointLabelVertex(viewProjMatrix,lookAtHigh,lookAtLow,vertexPosHigh,vertexPosLow,vertexDisplacement.xy+vertexDisplacement.zw,pixelSize,vertexZPos);pos.xy+=shift*pos.w;pos.z=vertexPriority*pos.w;gl_Position=pos;id=vec4(vertexCollidingId.xy/255.0,0,alpha);}}",wr,ap),i)}},mm=new Map;function fm(e,t){let i=t.firstPrimitive,r=i.page.layout.vertexByteSize,s=function(e){return 4*e<=255?4:2*e<=255?2:1}(r)*r,n=i.vao,o=mm.get(n);return o||(o=e.createVao([{attributeMapping:i.page.layout,buffer:i.page.vertexBuffer,stride:s}]),mm.set(n,o),n.onDestroy.addListener((()=>{mm.get(n).destroy(),mm.delete(n)}))),{vao:o,stride:s}}var gm=class extends qs{_render(){let e=this._primitiveProvider.primitives;for(let t of Fs(e,void 0,Bs)){let{vao:e,stride:i}=fm(this._context,t);this._context.bindVao(e),this._context.drawMesh(t.vertexByteOffset/i,t.vertexByteLength/i,0)}}},vm=class extends _m{constructor(e,t,i){super(e,t,t.createProgram("#version 100\nattribute vec2 vertexCollidingId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute vec2 vertexPolylineLengthDisplacement;attribute vec4 vertexLeftPolylineRatios;attribute vec4 vertexLeftPolylineAngles;attribute vec4 vertexRightPolylineRatios;attribute vec4 vertexRightPolylineAngles;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying lowp vec4 id;const vec4 DISCARD_POSITION=vec4(2,2,2,1);const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float PI=3.1415927410125732;const int MAX_POLYLINE_POINTS=4;const float INFINITY=1000000.0;const float UBYTE_RATIO_EPSILON=1.0/256.0;vec2 project(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pixelSize,vec2 pointHigh,vec2 pointLow,vec2 delta){vec4 position=viewProjMatrix*vec4((YV_H*(pointHigh-lookAtHigh)+(pointLow-lookAtLow))*YV_N+delta,0,1);vec2 projected=position.xy/position.w;return projected/pixelSize;}vec2 decodePolylineDeltas(float ratio,float angle,float polylineLength){float a=angle*2.0*PI-PI;float len=ratio*polylineLength;return vec2(cos(a),sin(a))*len;}float value(vec4 a,int i){if(i==0)return a[0];if(i==1)return a[1];if(i==2)return a[2];return a[3];}vec4 projectPolylineLabelVertex(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pxSize,vec2 posHigh,vec2 posLow,vec2 displacement,float lineDisplacement,float polylineLength,vec4 leftPolylineRatios,vec4 leftPolylineAngles,vec4 rightPolylineRatios,vec4 rightPolylineAngles){vec2 position=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,vec2(0,0));vec2 deltas=decodePolylineDeltas(rightPolylineRatios[0],rightPolylineAngles[0],polylineLength);vec2 projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,deltas);bool isRightPart=lineDisplacement>0.0;bool isInverted=projectedPoint.x<position.x;float isLeftToRight=float(isRightPart ^^ isInverted);if(isRightPart==isInverted){deltas=mix(decodePolylineDeltas(leftPolylineRatios[0],leftPolylineAngles[0],polylineLength),decodePolylineDeltas(rightPolylineRatios[0],rightPolylineAngles[0],polylineLength),isLeftToRight);projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,deltas);}float remainingLength=abs(lineDisplacement);for(int i=1;i<=MAX_POLYLINE_POINTS;i++){vec2 segment=projectedPoint-position;float isLast=float(i==MAX_POLYLINE_POINTS||value(mix(leftPolylineRatios,rightPolylineRatios,isLeftToRight),i)<UBYTE_RATIO_EPSILON);float segmentLength=mix(length(segment),INFINITY,isLast);if(segmentLength>remainingLength){float signFactor=mix(-1.0,1.0,float(lineDisplacement>0.0));vec2 direction=normalize(segment);vec2 normal=vec2(-direction.y,direction.x);position+=direction*remainingLength;position+=signFactor*direction*displacement.x;position+=signFactor*normal*displacement.y;break;}else{remainingLength-=segmentLength;position+=segment;vec2 nextDeltas=mix(decodePolylineDeltas(value(leftPolylineRatios,i),value(leftPolylineAngles,i),polylineLength),decodePolylineDeltas(value(rightPolylineRatios,i),value(rightPolylineAngles,i),polylineLength),isLeftToRight);projectedPoint=project(viewProjMatrix,lookAtHigh,lookAtLow,pxSize,posHigh,posLow,nextDeltas);}}return vec4(position*pxSize,0.0,1.0);}const vec4 EMPTY_PRIMITIVE=vec4(0,0,0,0);const vec2 NO_ID=vec2(0,0);const float ID_RENORMALIZATION=255.0/256.0;const float ZOOM_THRESHOLD=0.05;const float TILT_THRESHOLD=0.15;const float AZIMUTH_THRESHOLD=0.02;bool isOverlapperStillVisible(vec2 idTexCoordinate,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 overlapId=texture2D(overlap,idTexCoordinate).rg;return overlapId!=NO_ID&&texture2D(scene,overlapId*ID_RENORMALIZATION+idHalfPxSize)!=EMPTY_PRIMITIVE;}float getVisibility(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 idTexCoordinate=id/256.0+idHalfPxSize;vec4 visibilityValue=texture2D(visibility,idTexCoordinate);float overlapZoom=visibilityValue.b;float overlapTilt=visibilityValue.r;float overlapAzimuth=visibilityValue.g;float zoomDiff=overlapZoom-currentZoom;float tiltDiff=abs(overlapTilt-currentTilt);float azimuthDiff=abs(overlapAzimuth-currentAzimuth);if((zoomDiff>ZOOM_THRESHOLD||(abs(zoomDiff)<=ZOOM_THRESHOLD&&tiltDiff<TILT_THRESHOLD&&azimuthDiff<AZIMUTH_THRESHOLD))&&isOverlapperStillVisible(idTexCoordinate,idHalfPxSize,overlap,scene)){return-1.0;}return visibilityValue.a;}void main(){float alpha=getVisibility(vertexCollidingId,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(alpha<0.0){gl_Position=DISCARD_POSITION;}else{float vertexLineLength=vertexPolylineLengthDisplacement.x;float vertexLineDisplacement=vertexPolylineLengthDisplacement.y;gl_Position=projectPolylineLabelVertex(viewProjMatrix,lookAtHigh,lookAtLow,pixelSize,vertexPosHigh,vertexPosLow,vertexDisplacement.xy+vertexDisplacement.zw,vertexLineDisplacement,vertexLineLength,vertexLeftPolylineRatios,vertexLeftPolylineAngles,vertexRightPolylineRatios,vertexRightPolylineAngles);gl_Position.xy+=shift;gl_Position.z=vertexPriority;id=vec4(vertexCollidingId/255.0,0,alpha);}}",wr,sm),i)}},ym=class extends js{constructor(e,t,i,r){super(e,t,t.createProgram("#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexDisplacement;attribute vec2 vertexOffset;attribute vec4 vertexCollidingId;attribute float vertexPriority;attribute float vertexZPos;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 shift;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying vec4 id;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR=32.0;const vec4 DISCARD_POSITION=vec4(2,2,2,1);const vec4 EMPTY_PRIMITIVE=vec4(0,0,0,0);const vec2 NO_ID=vec2(0,0);const float ID_RENORMALIZATION=255.0/256.0;const float ZOOM_THRESHOLD=0.05;const float TILT_THRESHOLD=0.15;const float AZIMUTH_THRESHOLD=0.02;bool isOverlapperStillVisible(vec2 idTexCoordinate,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 overlapId=texture2D(overlap,idTexCoordinate).rg;return overlapId!=NO_ID&&texture2D(scene,overlapId*ID_RENORMALIZATION+idHalfPxSize)!=EMPTY_PRIMITIVE;}float getVisibility(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 idTexCoordinate=id/256.0+idHalfPxSize;vec4 visibilityValue=texture2D(visibility,idTexCoordinate);float overlapZoom=visibilityValue.b;float overlapTilt=visibilityValue.r;float overlapAzimuth=visibilityValue.g;float zoomDiff=overlapZoom-currentZoom;float tiltDiff=abs(overlapTilt-currentTilt);float azimuthDiff=abs(overlapAzimuth-currentAzimuth);if((zoomDiff>ZOOM_THRESHOLD||(abs(zoomDiff)<=ZOOM_THRESHOLD&&tiltDiff<TILT_THRESHOLD&&azimuthDiff<AZIMUTH_THRESHOLD))&&isOverlapperStillVisible(idTexCoordinate,idHalfPxSize,overlap,scene)){return-1.0;}return visibilityValue.a;}void main(){float alpha=getVisibility(vertexCollidingId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(alpha<0.0){gl_Position=DISCARD_POSITION;}else{vec4 position=viewProjMatrix*vec4((YV_H*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*YV_N,vertexZPos,1);vec2 displacement=vertexDisplacement.xy+vertexDisplacement.zw;vec2 totalDisplacement=(displacement+vertexOffset)/DISPLACEMENT_FIXED_POINT_FRACTION_FACTOR;position.xy+=position.w*(shift+totalDisplacement*pixelSize);position.z=position.w*vertexPriority;gl_Position=position;id=vec4(vertexCollidingId.xy/255.0,0,alpha);}}",wr,Pp),r),this._camera=i}_prepareProgram(e,t,i,r,s,n,o,a,l,d,h){super._prepareProgram(e,t,i,r,s,n,o,a,l,d,h),e.setVector2Uniform("pixelSize",this._camera.pixelSize)}},xm=class extends Hs{constructor(e,t,i=(()=>1),r=1){let s=t.createProgram("#version 100\nattribute vec3 vertexPos;attribute vec2 vertexUV;uniform mat4 viewProjMatrix;uniform mat4 modelMatrix;uniform vec2 collidingId;uniform float zFactor;varying lowp vec4 id;const float YV_H=pow(2.0,16.0);const float YV_N=pow(2.0,-30.0);const float MAX_PRIORITY=1.0-pow(2.0,-24.0);const float ADJUSTING_FACTOR=pow(2.0,10.0);vec4 applyImprecisePerspectiveDivisionFix(vec4 position){return position*ADJUSTING_FACTOR;}void main(){vec4 position=modelMatrix*vec4(vertexPos,1);position.z*=zFactor*position.w;gl_Position=viewProjMatrix*position;gl_Position.z=MAX_PRIORITY*gl_Position.w;gl_Position=applyImprecisePerspectiveDivisionFix(gl_Position);id=vec4(collidingId/255.0,0.0,1.0);}",wr,l_);s.setScalarUniform("priority",r),super(e,t,s),this._heightFactorProvider=i}_getPrimitives(){return qe(super._getPrimitives(),bm)}_render(e,t){let i=this._program;for(let r of t)for(let t of Fs(this._getPrimitives(),this._canBatchPredicate)){let s=Ju(t.firstPrimitive,e,r.lookAt,wm);i.setMatrix4Uniform("viewProjMatrix",s),i.setMatrix4Uniform("modelMatrix",t.firstPrimitive.matrix),this._renderBatch(t,i)}}_renderBatch(e,t){let{legacyCollidingId:i}=e.firstPrimitive;Tm.x=255&i,Tm.y=i>>8&255,t.setVector2Uniform("collidingId",Tm),super._renderBatch(e,t)}_prepareProgram(e,t,i,r,s,n,o,a,l,d,h){super._prepareProgram(e,t,i,r,s,n,o,a,l,d,h),e.setScalarUniform("zFactor",this._heightFactorProvider())}};function bm(e){return void 0===e.instanceCount}var Tm=B(0,0),wm=De(),Cm=class extends qs{_render(){}},Pm=class extends ft{constructor(e,t){let i=t.createProgram("#version 100\nattribute vec2 vertexCollidingId;attribute vec2 vertexCollidingFriendId;uniform vec2 idHalfPxSize;varying vec4 id;void main(){vec2 idTexCoordinates=vertexCollidingId/256.0+idHalfPxSize;vec4 idWindowCoordinates=vec4(idTexCoordinates*2.0-1.0,0,1);id=vec4(vertexCollidingFriendId/255.0,0,0);gl_Position=idWindowCoordinates;gl_PointSize=1.0;}",wr,{attribMap:{vertexCollidingId:10,vertexCollidingFriendId:15}});super(t,new D,i),this._primitiveProvider=e}_render(){let e=this._primitiveProvider.primitives;for(let t of Fs(e))this._context.bindVao(t.firstPrimitive.vao),this._context.drawIndexedMesh(t.indexByteOffset,Ds(t.indexByteLength,t.indexType),0,t.indexType)}_prepareProgram(e,t){super._prepareProgram(e,t),e.setVector2Uniform("idHalfPxSize",t)}},Sm=class extends Pm{_render(){let e=this._primitiveProvider.primitives;for(let t of Fs(e,void 0,Bs)){let{vao:e,stride:i}=fm(this._context,t);this._context.bindVao(e),this._context.drawMesh(t.vertexByteOffset/i,t.vertexByteLength/i,0)}}},Mm=w},78916:(e,t,i)=>{"use strict";i.r(t),i.d(t,{getContentProviderWorker:()=>X,getRichModelDecoderWorkerUrl:()=>$,vector:()=>s(),vectorMapEngineFactory:()=>G});var r=i(26259),s=i.n(r),n=i(48244),o=i(57032),a=i(35185),l=i(46900),d=i(16145),h=i(92830),c=i(1239),u=i(61497);class _{constructor(e,t){this.source=e,this.FD2_plan=t}getId(){return this.FD2_plan.id}getBounds(){const e=this.FD2_plan.bbox;return[[e.lowerCorner.lon,e.lowerCorner.lat],[e.upperCorner.lon,e.upperCorner.lat]]}isVisible(){return this.FD2_plan.isVisible}setVisible(e){this.FD2_plan.isVisible=e}getLevels(){return this.FD2_plan.levels}getDefaultLevel(){return this.FD2_plan.defaultLevel}getActiveLevel(){return this.FD2_plan.activeLevel}setActiveLevel(e){this.FD2_plan.setActiveLevel(e)}getOpacity(){return this.FD2_plan.opacity}setOpacity(e){this.FD2_plan.opacity=e}}var p=i(33106),m=i(90401),f=i(81703),g=i(27284),v=i(86607),y=i(54142),x=i(11779);function b(e){return{feature:T(e),style:w(e)}}function T(e){const{id:t,feature:i,style:r}=e;switch(i.geometry.type){case"Point":return function(e,t,i){return{type:"Feature",geometry:t.geometry,properties:{style:C(i),metadata:R(e,i)}}}(t,i,r);case"LineString":case"MultiLineString":return function(e,t,i){const{geometry:r}=t,s=[];for(let t=i.stroke.length-1;t>=0;t--){const n=i.stroke[t];if("MultiLineString"===r.type)s.push({type:"Feature",geometry:{type:"MultiLineString",coordinates:r.coordinates},properties:{style:S(n,0),metadata:R(e,i)}});else{const t=M(r.coordinates,i.paletteColorStops);for(let r=t.length-1;r>=0;r--)s.push({type:"Feature",geometry:{type:"LineString",coordinates:t[r]},properties:{style:S(n,r),metadata:R(e,i)}})}}return{type:"FeatureCollection",features:s}}(t,i,r);case"Polygon":case"MultiPolygon":return function(e,t,i){return{type:"Feature",geometry:t.geometry,properties:{style:P(i),metadata:R(e,i)}}}(t,i,r);default:(0,y._y)(new Error(`Unexpected geometry type: ${i.geometry.type}`))}}function w(e){return{zIndex:e.style.zIndex,simplificationRate:"Point"===e.feature.geometry.type?0:e.style.simplificationRate}}function C(e){return{"icon-image":e.icon.url,"icon-offset":e.icon.offset,"icon-scale":e.icon.scale}}function P(e){const t=e.stroke[0];return{"fill-color":e.fill,"fill-opacity":e.fillOpacity,"fill-rule":e.fillRule,"fill-contour-width":null==t?void 0:t.width,"fill-contour-color":null==t?void 0:t.color,"fill-contour-opacity":null==t?void 0:t.opacity,"fill-contour-dasharray":I(t.dash),"fill-contour-join":"round"}}function S(e,t){return{"line-color":e.paletteColors.length>0?e.paletteColors[t]:e.color,"line-width":e.width,"line-opacity":e.opacity,"line-dasharray":I(e.dash),"line-join":"round","line-cap":"round"}}function M(e,t){if(0===t.length)return[e];const i=[];let r=0;for(const s of t)i.push(e.slice(r,s+1)),r=s;return i}function R(e,t){return t.interactive?{objectId:e}:void 0}function I(e){return e&&1===e.length?[e[0],e[0]]:e}class L{constructor(e,t){this.EA2_destroyed=!1,this.onBeforeRender=new e.EventTrigger,this.onRender=new e.EventTrigger,this.onAfterRender=new e.EventTrigger,this.FF3_renderLoop=t,this.A1C_renderLoopSubscription=this.FF3_renderLoop.on("beforeRender",(()=>this.onBeforeRender.fire())).on("render",(()=>this.onRender.fire())).on("afterRender",(()=>this.onAfterRender.fire()))}get isActive(){return this.FF3_renderLoop.isActive}update(){this.EA2_destroyed||this.FF3_renderLoop.update()}destroy(){this.EA2_destroyed=!0,this.A1C_renderLoopSubscription.offAll()}}var E=i(87459);function A(e){const t=null==e?void 0:e.opacity;return"number"==typeof t?(0,E.q)(t,0,1):1}const U=e=>(t,i,r,{parentLayer:s}={},n)=>{const o=[];ymaps3.strictMode&&(0,g.h)(null!=e,"You should defined ExternalRendererConstructor");class a extends t.ExternalRendererRenderUnit{constructor(){super(...arguments),this.FDC_originalBindRenderState=void 0,this.D9A_patchedBindRenderState=e=>{var t;null===(t=this.FDC_originalBindRenderState)||void 0===t||t.call(this._context,Object.assign(Object.assign({},e),{blendFuncSrcRgb:1}))}}render(...e){var t;this.FDC_originalBindRenderState=null===(t=this._context)||void 0===t?void 0:t.bindRenderState,this._context.bindRenderState=this.D9A_patchedBindRenderState;try{super.render(...e)}finally{this._context.bindRenderState=this.FDC_originalBindRenderState}}}const l=new((null==s?void 0:s.rootRenderUnit)instanceof t.BuildingsRenderUnit?a:t.ExternalRendererRenderUnit)(i.context,i.camera,(d=e,class extends d{constructor(e,t){super(e,{requestRender:t.requestRender}),this.C59__implGl=e,this.FF0__vaoExt=e.getExtension("OES_vertex_array_object")}render({size:e,worlds:t}){const{camera:i}=t[0];var r,s,n;return r=this.C59__implGl,s=this.FF0__vaoExt,(n=null)||(n=function(e){return{cullFace:!1,cullFaceSide:e.BACK,frontFace:e.CCW,pixelStoreUnpack:4,pixelStoreUnpackPremultiplyAlpha:!1,pixelStoreUnpackFlipY:!1,stencilTest:!1,stencilFunc:e.ALWAYS,stencilRef:0,stencilMask:255,stencilFail:e.KEEP,stencilPassDepthFail:e.KEEP,stencilPassDepthPass:e.KEEP,depthTest:!0,depthFunc:e.LESS,depthMask:!0,depthRange:[0,1],dither:!0,polygonOffsetFill:!1,blend:!1,blendSrc:e.ONE,blendDst:e.ZERO,blendEquation:e.FUNC_ADD,arrayBuffer:null,elementArrayBuffer:null,frameBuffer:null,renderBuffer:null,texture:null,vertexArray:null,program:null,activeTexture:e.TEXTURE0,clearColor:[0,0,0,0],clearDepth:1,clearStencil:0,viewport:[0,0,e.drawingBufferWidth,e.drawingBufferHeight],scissorBox:[0,0,1,1]}}(r)),n.cullFace?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),r.cullFace(n.cullFaceSide),r.frontFace(n.frontFace),r.pixelStorei(r.UNPACK_ALIGNMENT,n.pixelStoreUnpack),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.pixelStoreUnpackPremultiplyAlpha),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,n.pixelStoreUnpackFlipY),n.stencilTest?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),r.stencilFunc(n.stencilFunc,n.stencilRef,n.stencilMask),r.stencilMask(n.stencilMask),r.stencilOp(n.stencilFail,n.stencilPassDepthFail,n.stencilPassDepthPass),n.depthTest?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.depthFunc(n.depthFunc),r.depthMask(n.depthMask),r.depthRange(n.depthRange[0],n.depthRange[1]),n.dither?r.enable(r.DITHER):r.disable(r.DITHER),n.polygonOffsetFill?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),n.blend?r.enable(r.BLEND):r.disable(r.BLEND),r.blendFunc(n.blendSrc,n.blendDst),r.blendEquation(n.blendEquation),r.bindBuffer(r.ARRAY_BUFFER,n.arrayBuffer),r.bindFramebuffer(r.FRAMEBUFFER,n.frameBuffer),r.bindRenderbuffer(r.RENDERBUFFER,n.renderBuffer),r.bindTexture(r.TEXTURE_2D,n.texture),s&&s.bindVertexArrayOES(s.isVertexArrayOES(n.vertexArray)?n.vertexArray:null),r.useProgram(n.program),r.activeTexture(n.activeTexture),r.clearColor(n.clearColor[0],n.clearColor[1],n.clearColor[2],n.clearColor[3]),r.clearDepth(n.clearDepth),r.clearStencil(n.clearStencil),r.viewport(n.viewport[0],n.viewport[1],n.viewport[2],n.viewport[3]),r.scissor(n.scissorBox[0],n.scissorBox[1],n.scissorBox[2],n.scissorBox[3]),super.render({size:{x:e.width,y:e.height},camera:{azimuth:i.azimuth,zoom:i.zoom,tilt:i.tilt,worldCenter:{x:i.center.x,y:i.center.y},fov:i.fov},get worlds(){return t.map((({lookAt:e,viewProjMatrix:t})=>({lookAt:e,viewProjMatrix:t})))}})}}));var d;let h=null==s?void 0:s.rootRenderUnit;return h?h.addRenderUnit(l):o.push(l),{collidingPrimitives:[],renderUnits:o,destroyables:[{destroy:()=>{h&&h.removeRenderUnit(l),l.destroy()}}]}};const O={ground:function(e,t,i,{highlightProvider:r,opacityProvider:s}={},n){if(i instanceof e.Vmap3ContentProvider)return function(e,t,i,{highlightProvider:r,opacityProvider:s}={},n){const{context:o,camera:a}=t,{scene:l}=i,d=new e.ContentPortionPrimitiveProvider,h=A(n),c=h<1?e.TransparentPolygonRenderUnit:e.PolygonRenderUnit,u=new c(d.getProvider(0),o,{colorTransform:r,opacity:s},{hitTest:!0,depthTest:!1}),_=new e.TransparentPolygonRenderUnit(d.getProvider(1),o,{colorTransform:r,opacity:s},{hitTest:!0,depthTest:!1}),p=new e.PolylineRenderUnit(d.getProvider(5),o,a,{opacity:s},{hitTest:!0,depthTest:!1}),m=new e.GroundCompositeRenderUnit(l[100],d,{opaquePolygon:u,transparentPolygon:_,polyline:p});return{renderUnits:[m],collidingPrimitives:[],destroyables:[u,_,p]}}(e,t,i);const{context:o,camera:a}=t,{scene:l}=i;return{renderUnits:[new e.LayerRenderUnit(o,1),new(A(n)<1?e.TransparentPolygonRenderUnit:e.PolygonRenderUnit)(l[0],o,{colorTransform:r,opacity:s},{hitTest:!0}),new e.TransparentPolygonRenderUnit(l[1],o,{colorTransform:r,opacity:s},{hitTest:!0}),new e.PolylineRenderUnit(l[5],o,a,{opacity:s},{hitTest:!0})],collidingPrimitives:[],destroyables:[]}},buildings:function(e,t,i,r={},s){if(i instanceof e.Tile3DContentProvider)return function(e,t,i,{highlightProvider:r,opacityProvider:s,parentLayer:n}={},o){const{context:a,renderLoop:l}=t,{scene:d,collidingScene:h}=i,c=(null==o?void 0:o.modelsAppearingAnimation)?new e.ModelsAnimationManager({onUpdate:i.viewport.onUpdate,getModels:()=>i.viewport.visibleRenderableTiles()},t.renderLoop,o.modelsAppearingAnimation.duration):void 0,u=new e.GlTFPrimitiveRenderUnit(d,a,{diffuseColor:()=>i.modelColor,materialFactor:e=>i.getModelAppearingProgress(e),colorTransform:r,opacity:s,lightParams:i.lightProvider},{hitTest:!0,forceUnlit:!0}),_=[],p=[];let m=null==n?void 0:n.rootRenderUnit;if(!m){const t=new e.FxaaRenderUnit(a,l),i=new e.BuildingsRenderUnit(a);t.addRenderUnit(i),_.push(t),p.push(i),m=i}m.addRenderUnit(u);const f=new e.ColorIdGltfRenderer(h,a),g=new e.GltfResetRemovedRenderer(h,a);p.push({destroy:()=>{m&&m.removeRenderUnit(u),u.destroy()}}),c&&p.push(c);return{renderUnits:_,destroyables:p,collidingPrimitives:[{provider:h,renderers:{colorId:f,resetRemoved:g}}]}}(e,t,i,r,s);const n=i.scene[3],o=(null==s?void 0:s.modelsAppearingAnimation)?new e.ModelsAnimationManager({getModels:()=>n.primitives,onUpdate:n.onUpdate},t.renderLoop,s.modelsAppearingAnimation.duration):void 0,a=new e.ModelRenderUnit(n,t.context,{heightFactor:null==o?void 0:o.heightProvider,colorTransform:r.highlightProvider,opacity:r.opacityProvider},{hitTest:!0}),l=new e.FxaaRenderUnit(t.context,t.renderLoop),d=new e.BuildingsRenderUnit(t.context);d.addRenderUnit(a),l.addRenderUnit(d);const h=[l],c=[],u=[a,d];if(o&&u.push(o),i.options.richModelEnabled||i.options.richPointEnabled){const n=function(e,t,i,r,s={},n){const o=i.scene[4],a=(null==s?void 0:s.modelsAppearingAnimation)?new e.ModelsAnimationManager({onUpdate:o.onUpdate,getModels:()=>o.primitives},t.renderLoop,s.modelsAppearingAnimation.duration):void 0,l=new e.GlTFPrimitiveRenderUnit(o,t.context,{colorTransform:r.highlightProvider,heightFactor:null==a?void 0:a.heightProvider,opacity:r.opacityProvider,lightParams:i.lightProvider},{hitTest:!0}),d=new e.ColorIdGltfRenderer(o,t.context),h=new e.GltfResetRemovedRenderer(o,t.context);n.addRenderUnit(l);const c=[{destroy:()=>{n.removeRenderUnit(l)}},l];a&&c.push(a);return{renderUnits:[],collidingPrimitives:[{phaseIndex:1,provider:o,renderers:{colorId:d,resetRemoved:h}}],destroyables:c}}(e,t,i,r,s,d);h.push(...n.renderUnits),c.push(...n.collidingPrimitives),u.push(...n.destroyables)}return{destroyables:u,renderUnits:h,collidingPrimitives:c,rootRenderUnit:d}},icons:function(e,t,i,{highlightProvider:r,opacityProvider:s,useExperimentalColliding:n},o){var a,l;const d=new e.IconRenderUnit(i.scene[8],i.scene[120],t.context,t.camera,{visibility:t.visibilityTextureProvider,colorTransform:r,opacity:s},{hitTest:!0,iconHitTestField:null===(a=null==o?void 0:o.iconsInteractiveArea)||void 0===a?void 0:a.field,iconHitTestMinSize:null===(l=null==o?void 0:o.iconsInteractiveArea)||void 0===l?void 0:l.minSize});n&&d.useExperimental(!0);const h=new e.ColorIdIconRenderer(i.scene[8],t.context,t.camera,{clearDepth:null==o?void 0:o.isolateObjectsColliding}),c=new e.CollidingPrimitivesResetRemovedRenderer(i.scene[8],t.context),u=new e.CollidingFriendIdRenderer(i.scene[8],t.context);return{renderUnits:[d],collidingPrimitives:[{provider:i.scene[8],renderers:{colorId:h,resetRemoved:c,friendId:u}}],destroyables:[h,c,u]}},labels:function(e,t,i,{highlightProvider:r,opacityProvider:s,useExperimentalColliding:n}={},o){const{context:a,camera:l}=t,{scene:d}=i,h=new e.PointLabelRenderUnit(d[6],d[121],a,l,{visibility:t.visibilityTextureProvider,colorTransform:r,opacity:s},{hitTest:!0}),c=new e.PolylineLabelRenderUnit(d[7],d[122],a,l,{visibility:t.visibilityTextureProvider,opacity:s});n&&(h.useExperimental(!0),c.useExperimental(!0));const u=new e.ColorIdPolylineLabelRenderer(d[7],t.context,t.camera),_=new e.LabelResetRemovedRenderer(d[7],t.context),p=new e.ColorIdPointLabelRenderer(d[6],t.context,t.camera),m=new e.LabelResetRemovedRenderer(d[6],t.context),f=new e.LabelCollidingFriendIdRenderer(d[6],t.context);return{renderUnits:[c,h],collidingPrimitives:[{provider:d[7],renderers:{colorId:u,resetRemoved:_}},{provider:d[6],renderers:{colorId:p,resetRemoved:m,friendId:f}}],destroyables:[u,p,_,m,f]}},graphics:function(e,t,i,{opacityProvider:r}={},s){const{context:n,camera:o,visibilityManager:a,visibilityTextureProvider:l}=t,{scene:d}=i,h=[],c=()=>a.noCollidingVisibilityTexture,u=new e.ContentPortionPrimitiveProvider,_=A(s),p=new e.GraphicsRenderUnit(n,d,u),m=new(_<1?e.TransparentPolygonRenderUnit:e.PolygonRenderUnit)(u.getProvider(0),n,{opacity:r},{hitTest:!0}),f=new e.TransparentPolygonRenderUnit(u.getProvider(1),n,{opacity:r},{hitTest:!0}),g=i.options.accurateGeometryLines?new e.GraphicsPolylineRenderUnit(u.getProvider(5),n,o,{stencilId:t.stencilIdProvider,opacity:r},{hitTest:!0,snapGeometryToNearestZoom:!0}):new e.PolylineRenderUnit(u.getProvider(5),n,o,{opacity:r},{hitTest:!0,snapGeometryToNearestZoom:!0}),v=new e.IconRenderUnit(u.getProvider(8),[],n,o,{visibility:c,opacity:r},{hitTest:!0}),y=new e.LayerRenderUnit(n,1);return p.addRenderUnit(m),p.addRenderUnit(f),p.addRenderUnit(g),p.addRenderUnit(v),{renderUnits:[y,p],collidingPrimitives:h,destroyables:[m,f,g,v]}}};var V=i(46184);class D extends((0,a.GA)().with()){constructor(e,t,i){super(),this.B2D_tiles=new Map,this.D8E_cesiumTilesByUris=new Map,this.C58_tileUrisByModelId=new Map,this.B3C_visibleTileUris=new Set,this.EA3_onTileProcessingError=(e,t)=>{t.message=`Tile3d: ${t.message}`,this._emit("tile3dProcessingError",t)},this.A13_onViewportUpdate=()=>{z.clear();const e=this.DA0_contentProvider.viewport.visibleRenderableTiles()[Symbol.iterator]();for(let t=e.next();!t.done;t=e.next()){const e=void 0!==t.value.modelId&&this.C58_tileUrisByModelId.get(t.value.modelId);e&&z.add(e)}this.B3C_visibleTileUris.forEach((e=>{z.has(e)||(this.B3C_visibleTileUris.delete(e),this.AF0_onModelVisibilityChanged(e,!1))})),z.forEach((e=>{this.B3C_visibleTileUris.has(e)||(this.B3C_visibleTileUris.add(e),this.AF0_onModelVisibilityChanged(e,!0))}))},this.D88_vector=e,this.DA0_contentProvider=t,this.B2E_dataSource=i,this.D8C_sourceSubscription=this.B2E_dataSource.on("rootTileAdded",(e=>this.FCE_onRootTileAdded(e))).on("rootTileReplaced",(e=>this.A6E_onRootTileReplaced(e))).on("rootTileRemoved",(e=>this.B3A_onRootTileRemoved(e))).on("rootTileShown",(e=>this.FEC_onRootTileShown(e))).on("rootTileHidden",(e=>this.B4B_onRootTileHidden(e))).on("rootTileTexturesChanged",(({id:e,tier:t})=>this.C5E_onRootTileTexturesChanged(e,t))),this.DA0_contentProvider.contentManager.onTileProcessingError.addListener(this.EA3_onTileProcessingError),this.DA0_contentProvider.viewport.onUpdate.addListener(this.A13_onViewportUpdate),this.B2E_dataSource.rootTiles.forEach((e=>this.FCE_onRootTileAdded(e)))}destroy(){this.B2D_tiles.forEach((e=>this.C5A_stopLoading(e.currentTile))),this.DA0_contentProvider.viewport.onUpdate.removeListener(this.A13_onViewportUpdate),this.DA0_contentProvider.contentManager.onTileProcessingError.removeListener(this.EA3_onTileProcessingError),this.D8C_sourceSubscription.offAll()}getTile3dState(e){const t=this.D8E_cesiumTilesByUris.get(e);return t?this.D88_vector.isTile3DRenderable(t)?"ready":t.isLoaded?"loaded":t.isLoading?"loading":null:null}FCE_onRootTileAdded(e){ymaps3.strictMode&&(0,g.h)(!this.B2D_tiles.has(e.id),`Root tile with id ${e.id} already exists`);const t={rootTile:e,cachedCesiumTilesByUri:new Map,currentTile:this.C5A_createVectorTile(e)};this.B2D_tiles.set(e.id,t),this.FE3_startLoading(t.currentTile)}A6E_onRootTileReplaced(e){const t=this.EA8_getExistingEntry(e.id);this.C5A_stopLoading(t.currentTile),t.cachedCesiumTilesByUri.set(t.currentTile.uri,t.currentTile);const i=t.cachedCesiumTilesByUri.get(e.uri);t.currentTile=i||this.C5A_createVectorTile(e),this.FE3_startLoading(t.currentTile)}B3A_onRootTileRemoved(e){const t=this.EA8_getExistingEntry(e);this.C5A_stopLoading(t.currentTile),this.D7B_removeTile(t.currentTile),t.cachedCesiumTilesByUri.forEach((e=>this.D7B_removeTile(e))),this.B2D_tiles.delete(e)}FEC_onRootTileShown(e){const t=this.EA8_getExistingEntry(e);t.currentTile.isHidden=!1,this.DA0_contentProvider.showRootTile(t.currentTile.cesiumTile)}B4B_onRootTileHidden(e){const t=this.EA8_getExistingEntry(e);t.currentTile.isHidden=!0,this.DA0_contentProvider.hideRootTile(t.currentTile.cesiumTile)}C5E_onRootTileTexturesChanged(e,t){const i=this.EA8_getExistingEntry(e);this.DA0_contentProvider.changeRootTileTextures(i.currentTile.cesiumTile,t)}AF0_onModelVisibilityChanged(e,t){this._emit("tile3dVisibilityChange",{uri:e,isVisible:t})}EA8_getExistingEntry(e){const t=this.B2D_tiles.get(e);return ymaps3.strictMode&&(0,g.h)(void 0!==t,`Tile with id ${e} does not exist`),t}C5A_createVectorTile(e){const{id:t,uri:i,tile:r,detalizationFactor:s,collidingTileUri:n,modelId:o}=e,a=new this.D88_vector.VerboseCesium3DTileSet(i,r,o,s),l=n?new this.D88_vector.Cesium3DTileSet(n,r,a.modelId,s):void 0,d=Boolean(e.isHidden);return this.D8E_cesiumTilesByUris.set(i,a),this.C58_tileUrisByModelId.set(a.modelId,i),{id:t,cesiumTile:a,collidingCesiumTile:l,uri:i,isHidden:d,onLoadingStarted:()=>this.B50_onTileStateChanged(t),onLoadingFinished:()=>{this.B2E_dataSource.setRootTileTexturesTiers(t,[...a.getTexturesTiers()]),this.B50_onTileStateChanged(t)},onUpdate:()=>this.EC6_onTileUpdate(t)}}D7B_removeTile(e){this.D8E_cesiumTilesByUris.delete(e.uri),this.C58_tileUrisByModelId.delete(e.cesiumTile.modelId),this.B2E_dataSource.setRootTileTexturesTiers(e.id,null),this.DA0_contentProvider.removeRootTile(e.cesiumTile)}FE3_startLoading(e){const{cesiumTile:t,onLoadingStarted:i,onLoadingFinished:r,onUpdate:s}=e;t.onLoadingStarted.addListener(i),t.onLoadingFinished.addListener(r),t.onUpdate.addListener(s),this.DA0_contentProvider.contentManager.preload(t),s()}C5A_stopLoading(e){const{cesiumTile:t,onLoadingStarted:i,onLoadingFinished:r,onUpdate:s}=e;t.onLoadingStarted.removeListener(i),t.onLoadingFinished.removeListener(r),t.onUpdate.removeListener(s),this.DA0_contentProvider.contentManager.cancelPreload(t)}B50_onTileStateChanged(e){this._emit("tile3dChanged",e)}EC6_onTileUpdate(e){const t=this.EA8_getExistingEntry(e);if(this.D88_vector.isTile3DRenderable(t.currentTile.cesiumTile)){this.B50_onTileStateChanged(e);const{buildingObjectIds:i}=t.rootTile,{cesiumTile:r,collidingCesiumTile:s,isHidden:n}=t.currentTile;this.DA0_contentProvider.addRootTile(r,i,s),n&&this.DA0_contentProvider.hideRootTile(r),t.cachedCesiumTilesByUri.forEach((e=>{e!==t.currentTile&&this.DA0_contentProvider.hideRootTile(e.cesiumTile,0)}))}}}const z=new Set;var B=i(23771),F=i(39559);const N=[],k=e=>{const t=Math.floor(e);return e-t<.5?t:t+1};class H extends((0,a.GA)().with()){constructor(e,t,i,r,s,o,a,l,d,c,_){super(),this.D7A_processingQueue=new p.$7(p.fv),this.FD6_contentProvidersBySource=new Map,this.A1B_layersById=new Map,this.EAC_layerDescriptions=[],this.D94_dataSources={},this.B42_filters=new Map,this.C5C_tileContentClippingGeometries=new Map,this.FED_onVisibleObjectsChanged=()=>{this._emit("visibleObjectsChanged")},this.B2E_finalizeSetLayers=(e,t,i)=>{this.A1B_layersById.forEach((e=>{for(const t of e.renderUnits)this.AD2_engine.renderer.removeRenderUnit(t)})),this.FD6_contentProvidersBySource=i,this.EAC_layerDescriptions=e,this.A1B_layersById=t,this.A1B_layersById.forEach((e=>{for(const t of e.renderUnits)this.AD2_engine.renderer.addRenderUnit(t)})),this.FD6_contentProvidersBySource.forEach((e=>{this.C6D_updateDataSourceZoomRange(e,this.C55_camera)})),this.AB7_applyBackgroundColor(),this.EB8_asyncSetLayersAbortController=void 0,this._emit("indoorPlansChanged")},this.FDD_createContentProvider=({source:e,sourceName:t})=>{var i;if(e instanceof x.m5)return this.A1E_createGraphicsContentProvider(e,t);if(e instanceof u.N)return this.FEA_createTile3dContentProvider(e,t);if(e instanceof B.m)return this.C53_createNoneContentProvider(e,t);const r=e.vectorSourceDescription,s="vmap3"===r.tileFormat?7:r.indoorPlanUrl?3:r.iconsOnlyTiles?1:0,o=7===s;let a=!1,l=N;r.customization&&((0,n.N)(r.customization)?(l=r.customization.style,a="off"===r.customization["render-3d"]):l=r.customization);const d={iconUrlTemplate:r.imageUrl,glyphRangeUrlTemplate:r.glyphRangeUrl,tileUrlTemplate:r.tileUrl,meshUrlTemplate:r.meshUrl,styleUrlTemplate:o?r.styleUrl:void 0,fontListUrlTemplate:o?r.fontListUrl:void 0,fontObjectUrlTemplate:o?r.fontObjectUrl:void 0,indoorPlanUrlTemplate:r.indoorPlanUrl,richModelUrlTemplate:r.richModelUrl,richModelEnabled:r.richModelEnabled,richPointEnabled:r.richPointEnabled,tileSize:this.EB4_getVectorTileSize(r.requestTileSize||"X1"),preloadedTilesBeltWidth:r.tileBeltSize||0,useLowPrecisionBeltTiles:r.lowPrecisionBeltTiles,tileCacheSize:r.tileCacheSize||100,richModelCacheSize:r.richModelCacheSize,basePriority:this.EC1_getVectorContentProviderPriority(r.priority),objectsCollisionPriority:this.A64_getVectorCollisionPriority(null!==(i=r.collisionPriority)&&void 0!==i?i:"medium"),customizationConfig:l,disable3d:a,tileRequestWithCredentials:r.tileRequestWithCredentials,iconRequestWithCredentials:r.imageRequestWithCredentials,glyphRequestWithCredentials:r.glyphRequestWithCredentials,meshRequestWithCredentials:r.meshRequestWithCredentials,richModelRequestWithCredentials:r.richModelRequestWithCredentials,indoorPlanRequestWithCredentials:r.indoorPlanRequestWithCredentials,styleRequestWithCredentials:r.styleRequestWithCredentials,fontListRequestWithCredentials:r.fontListRequestWithCredentials,fontObjectRequestWithCredentials:r.fontObjectRequestWithCredentials,tileRequestHeaders:r.tileRequestHeaders,iconRequestHeaders:r.iconRequestHeaders,glyphRequestHeaders:r.glyphRequestHeaders,meshRequestHeaders:r.meshRequestHeaders,richModelRequestHeaders:r.richModelRequestHeaders,indoorPlanRequestHeaders:r.indoorPlanRequestHeaders,styleRequestHeaders:r.styleRequestHeaders,fontListRequestHeaders:r.fontListRequestHeaders,fontObjectRequestHeaders:r.fontObjectRequestHeaders,mapMode:"dark"===r.theme?1:0,hdModeEnabled:o&&r.hdModeEnabled,mapType:o?this.FCB_getVectorMapType(r.mapType):void 0,allObjectsInteractive:r.allObjectsInteractive,computeIconBrightnessRange:!0,enableTileContentColliding:o&&!this.A1F_disableTileColliding,richModelDecoderWorkerUrl:r.richModelDecoderWorkerUrl,cameraIdleThrottling:r.cameraIdleThrottling},h=this.B3C_contentProdiver.initContentProvider(s,t,d);if(h instanceof this.vector.IndoorContentProvider&&h.onPlansChanged.addListener(this.EB7_onPlansChanged),3!==s){const{coveredByIndoorFilter:e,buildingsFilters:t}=this.B3C_contentProdiver;this.A1B_toggleVisibilityFilter(h,e,!0,[8,6,3,4,110]),this.A1B_toggleVisibilityFilter(h,t.idFilter,!0,[3])}h instanceof this.vector.Vmap3ContentProvider&&h.backgroundController.onBackgroundSet.addListener(this.C79_onProviderBackgroundSet);const c=e.group().on("changed",(()=>{var t;const{options:i}=h,r=null!==(t=e.vectorSourceDescription.customization)&&void 0!==t?t:N;r!==i.customizationConfig&&h.updateCustomizationConfig(r);const{tileUrl:s,imageUrl:n,glyphRangeUrl:o,meshUrl:a,richModelUrl:l,indoorPlanUrl:d,styleUrl:c,fontListUrl:u,fontObjectUrl:_}=e.vectorSourceDescription,p={};s!==i.tileUrlTemplate&&(p.tileUrlTemplate=s),n!==i.iconUrlTemplate&&(p.iconUrlTemplate=n),o!==i.glyphRangeUrlTemplate&&(p.glyphRangeUrlTemplate=o),a!==i.meshUrlTemplate&&(p.meshUrlTemplate=a),l!==i.richModelUrlTemplate&&(p.richModelUrlTemplate=l),d!==i.indoorPlanUrlTemplate&&(p.indoorPlanUrlTemplate=d),c!==i.styleUrlTemplate&&(p.styleUrlTemplate=c),u!==i.fontListUrlTemplate&&(p.fontListUrlTemplate=u),_!==i.fontObjectUrlTemplate&&(p.fontObjectUrlTemplate=_),s!==i.tileUrlTemplate&&(p.tileUrlTemplate=s),0!==Object.keys(p).length&&h.updateUrlTemplates(p),this.D9E_applyMapTheme(h,e.vectorSourceDescription.theme)}));h.visibilityManager.onViewportStateChanged.addListener(this.EC3_onViewportStateChanged),h.onVisibleObjectsChanged.addListener(this.FED_onVisibleObjectsChanged),this.B42_filters.forEach((e=>{this.A1B_toggleVisibilityFilter(h,e,!0)}));const _=this.C5C_tileContentClippingGeometries.get(t);return _&&h.addTileContentClipperGeometry(_.geometry),{contentProvider:h,source:e,sourceSubscription:c,type:"tile"}},this.A1C_destroyContentProvider=e=>{"tile"===e.type?(e.contentProvider.visibilityManager.onViewportStateChanged.removeListener(this.EC3_onViewportStateChanged),e.contentProvider.onVisibleObjectsChanged.removeListener(this.FED_onVisibleObjectsChanged),e.contentProvider instanceof this.vector.IndoorContentProvider&&e.contentProvider.onPlansChanged.removeListener(this.EB7_onPlansChanged),e.contentProvider instanceof this.vector.Vmap3ContentProvider&&e.contentProvider.backgroundController.onBackgroundSet.removeListener(this.C79_onProviderBackgroundSet)):"graphics"===e.type?e.contentProvider.visibilityManager.onStateChanged.removeListener(this.C5B_onGraphicsStateChanged):"tile3d"===e.type&&(e.controller.destroy(),e.controllerSubscription.offAll()),e.sourceSubscription.offAll(),this.B3C_contentProdiver.destroyContentProvider(e.contentProvider)},this.C79_onProviderBackgroundSet=()=>{this.AB7_applyBackgroundColor()},this.EB7_onPlansChanged=()=>this._emit("indoorPlansChanged"),this.EC3_onViewportStateChanged=()=>{this.C5B_onGraphicsStateChanged(),this.D8F_areTilesReady()&&(this._emit("tilesLoaded"),this._emit("tilesReady"))},this.C5B_onGraphicsStateChanged=()=>{this._emit("stateChanged")},this.D80_createLayerImplementation=(e,t,i)=>{const r="graphics"===t.type?"graphics":e.type;let s=O[r];if(!s){const t=e.implementation({source:e.source,type:e.type,effectiveMode:"vector"});s=U(t)}const n=e.options.vector,o=Object.assign(s(this.vector,this.AD2_engine,t.contentProvider,{parentLayer:i,useExperimentalColliding:this.C5B_useExperimentalColliding,highlightProvider:this.C60_objectHighlight.provider,opacityProvider:()=>o.opacity},n),{sourceImplementation:t,sourceSubscription:this.D94_dataSources[e.source].group(),parentLayerId:e.grouppedWith,opacity:A(n),isolateObjectsColliding:n.isolateObjectsColliding,iconsInteractiveArea:n.iconsInteractiveArea&&Object.assign({},n.iconsInteractiveArea),modelsAppearingAnimation:n.modelsAppearingAnimation&&Object.assign({},n.modelsAppearingAnimation)});this.EC1_setupHotspotLayer(o,e),o.sourceSubscription.on("changed",(()=>{this.C5E_teardownHotspotLayer(o),this.EC1_setupHotspotLayer(o,e)}));for(const{provider:e,renderers:t,phaseIndex:i}of o.collidingPrimitives)this.AD2_engine.visibilityManager.registerCollidingPrimitives(e,t,i);return o},this.B46_destroyLayerImplementation=e=>{e.sourceSubscription.offAll(),this.C5E_teardownHotspotLayer(e);for(let t=e.collidingPrimitives.length-1;t>=0;t--){const{provider:i,renderers:r}=e.collidingPrimitives[t];this.AD2_engine.visibilityManager.deregisterCollidingPrimitives(i,r)}for(let t=e.renderUnits.length-1;t>=0;t--){const i=e.renderUnits[t];this.AD2_engine.renderer.removeRenderUnit(i),i.destroy&&i.destroy()}for(const t of e.destroyables)t.destroy()},this.renderLoop=l,this.vector=e,this.worldOptions=d,this.C51_tiltRange=c,this.A65_metricsTransport=r,this.D7C_applyDataSources(a),this.element=i.canvas,this.element.style.width="100%",this.element.style.height="100%",this.C56_context=new this.vector.Context(i),this.C5B_vectorRenderLoop=new L(this.vector,l),this.D9B_size=s,this.A1C_renderLoopSubscription=l.on("render",(e=>{this.A1B_layersById.forEach((({hotspotLayer:t})=>t&&t.render(e)))})).on("beforeRender",(()=>{(!this.C70_renderedSize&&Boolean(this.D9B_size)||!h.wy(this.D9B_size,this.C70_renderedSize))&&this.C59_doResize()})),this.A1F_disableTileColliding=_.disableTileColliding,this.AD2_engine=new this.vector.Engine(this.C56_context,new this.vector.Camera({wrapModeX:this.A63_getWorldWrapOption(d.cycledX),wrapModeY:this.A63_getWorldWrapOption(d.cycledY),minTilt:this.C51_tiltRange.min-this.C51_tiltRange.expansion,maxTilt:this.C51_tiltRange.max+this.C51_tiltRange.expansion}),this.C5B_vectorRenderLoop,void 0,_.useCpuConflictResolver),this.AD2_engine.cpuVisibilityManager&&(this.AD2_engine.cpuVisibilityManager.isActive=!0,_.useExperimentalColliding&&(this.AD2_engine.cpuVisibilityManager.enableExperimentalMode(!0),this.AD2_engine.cpuVisibilityManager.enableCandidates(Boolean(_.useCollidingCandidates)),this.AD2_engine.cpuVisibilityManager.enableTextOptional(Boolean(_.useCollidingTextOptional)),this.C5B_useExperimentalColliding=!0)),this.B2B_backgroundRenderUnit=new this.vector.BackgroundRenderUnit(this.C56_context),this.AD2_engine.renderer.addRenderUnit(this.B2B_backgroundRenderUnit),this.AD2_engine.onInternalError.addListener((e=>this._emit("internalError",e))),this.C65_updateRenderLoop=this.renderLoop.update.bind(this.renderLoop),this.B3C_contentProdiver=new this.vector.MainContentProvider(t,this.AD2_engine.camera,this.AD2_engine.context,this.AD2_engine.renderLoop,this.A65_metricsTransport,this.AD2_engine.cpuVisibilityManager),this.B3C_contentProdiver.onInternalError.addListener((e=>this._emit("internalError",e))),this.B3C_contentProdiver.onContentError.addListener((e=>this._emit("contentError",e))),this.C60_objectHighlight={provider:()=>this.C60_objectHighlight.transform,transform:void 0},this.update(o)}getLayerReadyState(e,t){var i;const r=null===(i=this.A1B_layersById.get(e))||void 0===i?void 0:i.sourceImplementation;if(!r||t&&r.type!==t)return;const s={tilesReady:0,tilesLoaded:0,tilesTotal:0,graphicsReady:0,graphicsTotal:0};if("graphics"===r.type&&(s.graphicsReady=r.contentProvider.visibilityManager.state.objectsVisible,s.graphicsTotal=r.contentProvider.visibilityManager.state.objectsTotal),"tile"===r.type){const e=r.contentProvider.visibilityManager.viewportState.visibleTileNumber,t=r.contentProvider.visibilityManager.viewportState.visualizableTileNumber;s.tilesReady=t,s.tilesLoaded=t,s.tilesTotal=e}return s}getTile3dState(e,t){var i;const r=null===(i=this.A1B_layersById.get(e))||void 0===i?void 0:i.sourceImplementation;return r&&"tile3d"===r.type?r.controller.getTile3dState(t):null}destroy(){this.setLayers([]),this.B2B_backgroundRenderUnit.destroy(),this.A1C_renderLoopSubscription.offAll(),this.AD2_engine.destroy(),this.C56_context.destroy(),this.C5B_vectorRenderLoop.destroy(),this.B3C_contentProdiver.destructor(),this.EB8_asyncSetLayersAbortController&&(this.EB8_asyncSetLayersAbortController.abort(),this.EB8_asyncSetLayersAbortController=void 0)}setDataSources(e){this.D7C_applyDataSources(e),this.setLayers(this.EAC_layerDescriptions)}update(e){this.C55_camera=e,this.AD2_engine.camera.zoom=e.zoom,this.AD2_engine.camera.center.x=e.worldCenter.x,this.AD2_engine.camera.center.y=e.worldCenter.y,this.AD2_engine.camera.azimuth=e.azimuth,this.AD2_engine.camera.tilt=e.tilt,this.AD2_engine.camera.flushUpdates(),this.A1B_layersById.forEach((({hotspotLayer:t})=>t&&t.update(e,this.fov))),this.FD6_contentProvidersBySource.forEach((t=>this.C6D_updateDataSourceZoomRange(t,e)))}resize(e){this.D9B_size=e}setLayers(e){this.FD2_abortAndCleanupAsyncLayersInitIfInProgress();const t=new Map,i=new Map;for(const r of e){const e=this.D94_dataSources[r.source];e instanceof c.Nt&&!e.vectorSourceDescription&&(0,y._y)(new Error(`${r.id} does not have vector source`)),t.set(r.id,r),i.set(r.source,{source:e,sourceName:r.source})}const r=(0,d.B)(this.FD6_contentProvidersBySource,i,this.FDD_createContentProvider,this.A1C_destroyContentProvider,(()=>{}),(()=>!0)).result,s=new Map,n=(0,d.B)(this.A1B_layersById,t,(e=>{const t=r.get(e.source),{grouppedWith:i}=e,n=i?s.get(i):void 0,o=this.D80_createLayerImplementation(e,t,n);return s.set(e.id,o),o}),this.B46_destroyLayerImplementation,((e,t)=>{s.set(t.id,e),e.opacity=A(t.options.vector)}),((e,t)=>{var i,r,s,n,o,a;const l=t.options.vector;return e.sourceImplementation.source===this.D94_dataSources[t.source]&&e.parentLayerId===t.grouppedWith&&(null===(i=e.iconsInteractiveArea)||void 0===i?void 0:i.field)===(null===(r=l.iconsInteractiveArea)||void 0===r?void 0:r.field)&&(null===(s=e.iconsInteractiveArea)||void 0===s?void 0:s.minSize)===(null===(n=l.iconsInteractiveArea)||void 0===n?void 0:n.minSize)&&e.isolateObjectsColliding===l.isolateObjectsColliding&&(null===(o=e.modelsAppearingAnimation)||void 0===o?void 0:o.duration)===(null===(a=l.modelsAppearingAnimation)||void 0===a?void 0:a.duration)&&e.opacity<1==A(t.options.vector)<1}));this.B2E_finalizeSetLayers(e,n.result,r)}initLayersAsync(e,t){var i;if(ymaps3.strictMode&&(0,g.h)(0===this.A1B_layersById.size,"There are already some layers in map engine. Can't run async init."),ymaps3.strictMode&&(0,g.h)(void 0===this.EB8_asyncSetLayersAbortController,"Async init was already started."),t.aborted)return Promise.reject((0,f.o)());this.EB8_asyncSetLayersAbortController=new AbortController;const r=this.EB8_asyncSetLayersAbortController.signal,s=()=>{t.removeEventListener("abort",s),this.FD2_abortAndCleanupAsyncLayersInitIfInProgress()};t.addEventListener("abort",s);const n=new Map,o=new Map,a=[];for(const t of e){const e=this.D94_dataSources[t.source];e instanceof c.Nt&&!e.vectorSourceDescription&&(0,y._y)(new Error(`${t.id} does not have vector source.`));const s=null!==(i=n.get(t.source))&&void 0!==i?i:this.FDD_createContentProvider({source:e,sourceName:t.source});n.set(t.source,s);const l=()=>{if(!r.aborted){const{grouppedWith:e}=t,i=e?o.get(e):void 0,r=this.D80_createLayerImplementation(t,s,i);o.set(t.id,r)}};a.push(new Promise((e=>setTimeout(e))).then(l))}return new Promise(((e,t)=>{r.addEventListener("abort",(()=>{n.forEach(this.A1C_destroyContentProvider),t((0,f.o)())})),Promise.all(a).then((()=>e())).catch((e=>{(0,y.H)(e),t(e)}))})).then((()=>{r.aborted||this.B2E_finalizeSetLayers(e,o,n)})).finally((()=>{t.removeEventListener("abort",s),this.EB8_asyncSetLayersAbortController&&(this.EB8_asyncSetLayersAbortController=void 0)}))}preloadHotspotsInPoint(e){this.A1B_layersById.forEach((t=>{t.hotspotLayer&&t.hotspotLayer.preloadHotspotsInPoint(e)}))}preloadHotspotsForViewport(){this.A1B_layersById.forEach((e=>{e.hotspotLayer&&e.hotspotLayer.preloadHotspotsForViewport()}))}setObjectFilters(e){const t=(0,d.B)(this.B42_filters,e,(e=>{const t=new this.vector.EventTrigger,i=e.on("update",(()=>t.fire()));return{filter:e,onUpdate:t,subscription:i,test:t=>e.test(t)}}),(e=>{e.subscription.offAll()}));for(const e of t.removed)this.FD6_contentProvidersBySource.forEach((t=>{"tile"===t.type&&this.A1B_toggleVisibilityFilter(t.contentProvider,e,!1)}));for(const e of t.created)this.FD6_contentProvidersBySource.forEach((t=>{"tile"===t.type&&this.A1B_toggleVisibilityFilter(t.contentProvider,e,!0)}));this.B42_filters=t.result}setInvisibleCollidingPrimitives(e){const t=this.AD2_engine.invisibleCollidingPrimitiveManager,i=[];e.forEach((e=>i.push(e))),t.clear(),t.addPrimitives(...i)}getIndoorPlans(){const e=[];if(this.FD6_contentProvidersBySource.forEach((({contentProvider:t},i)=>{t instanceof this.vector.IndoorContentProvider&&e.push([t,i])})),0===e.length)return null;const t=[];for(const[i,r]of e)if(!i.isPaused)for(const e of i.plans)t.push(new _(r,e));return t}getVisibleObjects(e){const t=this.FD6_contentProvidersBySource.get(e);return t?"graphics"===t.type||"tile3d"===t.type||"none"===t.type?null:t.contentProvider.getVisibleObjects():null}setTileContentClippingGeometry(e){const t=new Map;e.forEach(((e,i)=>t.set(i,{dataSourceId:i,geometry:e})));const{removed:i,created:r,result:s}=(0,d.B)(this.C5C_tileContentClippingGeometries,t,(e=>e),void 0,void 0,(()=>!1));for(const{dataSourceId:e,geometry:t}of i){const i=this.FD6_contentProvidersBySource.get(e);i&&"tile"===i.type&&i.contentProvider.removeTileContentClipperGeometry(t)}for(const{dataSourceId:e,geometry:t}of r){const i=this.FD6_contentProvidersBySource.get(e);i&&"tile"===i.type&&i.contentProvider.addTileContentClipperGeometry(t)}this.C5C_tileContentClippingGeometries=s}A63_getWorldWrapOption(e){return e?2:0}FD2_abortAndCleanupAsyncLayersInitIfInProgress(){this.EB8_asyncSetLayersAbortController&&(this.EB8_asyncSetLayersAbortController.abort(),this.EB8_asyncSetLayersAbortController=void 0)}D7C_applyDataSources(e){this.D94_dataSources={};for(const t of Object.keys(e)){const i=e[t];(i instanceof c.Nt&&i.vectorSourceDescription||i instanceof x.m5||i instanceof u.N||i instanceof B.m)&&(this.D94_dataSources[t]=i)}}C6D_updateDataSourceZoomRange(e,t){const{source:i,contentProvider:r}=e;if(i instanceof c.Nt&&i.zoomRange){const e=t.zoom>=i.zoomRange.min&&t.zoom<=i.zoomRange.max;this.FD1_setContentProviderActive(r,e)}}FD1_setContentProviderActive(e,t){let i=!1;t&&e.isPaused?(e.resume(),i=!0):t||e.isPaused||(e.pause(),i=!0),i&&e instanceof this.vector.IndoorContentProvider&&this.EB7_onPlansChanged()}D9E_applyMapTheme(e,t){if(this.AB7_applyBackgroundColor(),e instanceof this.vector.Tile3DContentProvider){const i="dark"===t?this.vector.TILE3D_MODEL_COLOR_NIGHT:this.vector.TILE3D_MODEL_COLOR_DAY;e.setModelColor(i)}else{const i="dark"===t?1:0;e.setMapMode(i)}}AB7_applyBackgroundColor(){const{LIGHT:e,DARK:t}=this.vector.BackgroundColor;let i,r=!1;this.FD6_contentProvidersBySource.forEach((({source:e,contentProvider:t})=>{var s;i||(t instanceof this.vector.Vmap3ContentProvider&&t.backgroundController.background&&(i=t.backgroundController.background),e instanceof c.Nt&&"dark"===(null===(s=e.vectorSourceDescription)||void 0===s?void 0:s.theme)&&(r=!0))}));const s=r?t:e;this.B2B_backgroundRenderUnit.setColor(i?i.color:s)}C59_doResize(){const e=Math.max(this.D9B_size.x,1),t=Math.max(this.D9B_size.y,1),i=(0,l.x)();this.AD2_engine.camera.screenSize.width=e,this.AD2_engine.camera.screenSize.height=t,this.AD2_engine.camera.flushUpdates(),this.AD2_engine.setRenderTargetSize({width:e*i,height:t*i}),this.A1B_layersById.forEach((({hotspotLayer:e})=>e&&e.resize(this.D9B_size))),this.C70_renderedSize=this.D9B_size}C53_createNoneContentProvider(e,t){return{contentProvider:{name:t,memoryUsage:0,onMemoryUsageChanged:{addListener(){},removeListener(){}},isPaused:!1,destructor(){},pause(){},resume(){},getObjectMetadata(){}},source:e,sourceSubscription:e.group(),type:"none"}}A1E_createGraphicsContentProvider(e,t){const i=this.B3C_contentProdiver.initContentProvider(4,t,{basePriority:100,objectsCollisionPriority:2,accurateGeometryLines:!0});i.visibilityManager.onStateChanged.addListener(this.C5B_onGraphicsStateChanged);const r=t=>{const r=e.features.get(t);if((0,x.uT)(r))return;const{feature:s,style:n}=b(r);i.addObject(s,n,j(r.parentGroupId),t)},s=e=>{i.removeObject(e)},n=t=>{const r=e.groups.get(t);i.addGroup({opacity:r.style.opacity,zIndex:r.style.zIndex},j(r.parentGroupId),t)},o=e.on("featureAdded",r).on("featureRemoved",s).on("featureUpdated",(t=>{const r=e.features.get(t);if((0,x.uT)(r))return;const{feature:s,style:n}=b(r);i.updateObject(t,s,n)})).on("groupAdded",n).on("groupRemoved",(({id:e})=>{i.removeGroupAndChildren(e)})).on("featureMovedToGroup",(e=>{s(e),r(e)})),a=e=>{n(e.id);for(const t of e.children)"feature"===t.type?r(t.id):a(t)};return a(e.groups.get(x.oR)),{contentProvider:i,source:e,sourceSubscription:o,type:"graphics"}}FEA_createTile3dContentProvider(e,t){const i=this.B3C_contentProdiver.initContentProvider(6,t,{basePriority:this.EC1_getVectorContentProviderPriority(e.priority),gltfDecoderWorkerUrl:e.workerUrl}),r=new D(this.vector,i,e),s=r.on("tile3dChanged",(e=>this._emit("tile3dChanged",e))).on("tile3dVisibilityChange",(e=>this._emit("tile3dVisibilityChange",e))).on("tile3dProcessingError",(e=>(0,y.H)(e))),n=e.on("changed",(()=>{this.D9E_applyMapTheme(i,e.theme)}));return this.D9E_applyMapTheme(i,e.theme),{type:"tile3d",source:e,sourceSubscription:n,contentProvider:i,controller:r,controllerSubscription:s}}EC1_getVectorContentProviderPriority(e){return{low:100,medium:200,high:300}[e]}EB4_getVectorTileSize(e){return{X1:0,X4:1,X16:2}[e]}A64_getVectorCollisionPriority(e){return{low:0,medium:1,high:2,ultra:3}[e]}FCB_getVectorMapType(e){if(void 0===e)return;return{admin:this.vector.MapType.ADMIN,driving:this.vector.MapType.DRIVING,map:this.vector.MapType.MAP,transit:this.vector.MapType.TRANSIT,"future-map":this.vector.MapType.FUTURE_MAP}[e]}EC1_setupHotspotLayer(e,t){const i=this.D94_dataSources[t.source];if(!(i instanceof c.Nt))return;const r=(i.vectorSourceDescription.hotspots||{})[t.type];if("function"!=typeof r)return;const s=(0,F.E)("ymaps3x0--layer ymaps3x0--graphics-layer"),n=new m.K({element:s,size:this.D9B_size,camera:this.C55_camera,dataSource:{fetchHotspots:r,hotspotAbortRadius:i.hotspotAbortRadius,tileSize:i.tileSize,zoomRange:i.zoomRange,inset:o.zw,padding:0},processingQueue:this.D7A_processingQueue,worldOptions:this.worldOptions,zoomRoundingRule:k,tiltRange:this.C51_tiltRange});n.on("requestRender",this.C65_updateRenderLoop),e.hotspotLayer=n}C5E_teardownHotspotLayer(e){e.hotspotLayer&&(e.hotspotLayer.offSingle("requestRender",this.C65_updateRenderLoop),e.hotspotLayer.destroy())}D8F_areTilesReady(){let e=!0;return this.FD6_contentProvidersBySource.forEach((t=>{if("tile"===t.type){const{viewportState:i}=t.contentProvider.visibilityManager;e=e&&i.visibleTileNumber===i.visualizableTileNumber}})),e}findObjectInPosition(e){const t=(0,v.k6)(e,Object.assign(Object.assign({},this.C55_camera),{fov:this.fov,size:{x:this.AD2_engine.camera.screenSize.width,y:this.AD2_engine.camera.screenSize.height}})),i=this.AD2_engine.getObjectIdAt(h.Sm(t,(0,l.x)())),r=this.B3C_contentProdiver.getObjectMetadata(i);if(!r)return this.B3A_findRasterHotspotObjectAbove(e,void 0);const s=r.get("uri"),n=r.get("position"),o=r.get("objectId"),a=n?n.split(",").map(Number):void 0,d=(r.get("tags")||r.get("eventTags")||r.get("group")||"").split(",").filter(Boolean),u=r.get(this.vector.VECTOR_METADATA_PREFIX+"layerName"),_=this.D7D_findLayerForMetadata(d,u),p=this.B3A_findRasterHotspotObjectAbove(e,_);if(p)return p;if(!_)return null;const m=this.D94_dataSources[u],f=m instanceof c.Nt&&m.vectorSourceDescription.hotspots;return f&&!this.EB0_areHotspotsEnabled(f[_.type])||"footprint"===r.get(this.vector.VECTOR_METADATA_PREFIX+"richModel")?null:m instanceof x.m5?o&&m.hasFeatureWithId(o)?{type:"feature",feature:m.getFeatureById(o),layer:_.id,source:u}:null:{type:"hotspot",layer:_.id,source:u,feature:{type:"Feature",id:o||s||n||"",geometry:a&&{type:"Point",coordinates:{x:a[0],y:a[1]}},properties:{[V.u]:{name:r.get("name")},uri:s,tags:d,name:r.get("name"),selectedIconUrl:r.get(this.vector.VECTOR_METADATA_PREFIX+"selectedIconUrl"),vectorMetadata:r,vectorId:i}}}}findObjectInPositionEx(e){const t=this.findObjectInPosition(e);let i=this.EAC_layerDescriptions.slice().reverse();const r=i.findIndex((e=>e.id===(null==t?void 0:t.layer)));r>=0&&(i=i.slice(0,r));const s={layers:[]};return s.layers.push(...i.map((e=>({layer:e.id,object:null})))),t&&s.layers.push({layer:t.layer,object:t}),s}setObjectHighlight(e){const t=null==e?void 0:e.object.properties.vectorId;this.C60_objectHighlight.transform=e&&void 0!==t?{transform:this.vector.createColorTransform(e.color),objectId:t}:void 0,this.C5B_vectorRenderLoop.update()}B3A_findRasterHotspotObjectAbove(e,t){for(const i of this.EAC_layerDescriptions.slice().reverse()){const r=this.A1B_layersById.get(i.id);if(r.hotspotLayer){const t=r.hotspotLayer.findObjectInPosition(e);if(t)return Object.assign(Object.assign({},t),{layer:i.id,source:i.source})}if(i===t)return null}return null}D7D_findLayerForMetadata(e,t){const i=-1!==e.indexOf("building");for(const e of this.EAC_layerDescriptions)if(e.source===t&&(i&&"buildings"===e.type||"icons"===e.type))return e;return this.EAC_layerDescriptions.find((e=>e.source===t))}EB0_areHotspotsEnabled(e){return"object"==typeof e?void 0===e.minZoom||this.AD2_engine.camera.zoom>=e.minZoom:void 0===e||!0===e}A1B_toggleVisibilityFilter(e,t,i,r=[8,6,110]){const s=i?"addVisibilityFilter":"removeVisibilityFilter";for(const i of r)e[s](i,t)}get fov(){return this.vector.getPhonyFov(this.AD2_engine.camera)}}function j(e){return e===x.oR||null===e?void 0:e}function G(e,t,i){return(...r)=>new H(t,i,e,{submit:()=>{}},...r)}function W(e,t){let i=`\ntry {\n    importScripts('${e}');\n    postMessage({loaded: true});\n} catch(e) {\n    postMessage({loaded: false, error: e});\n}`;const r="blob"===t?URL.createObjectURL(new Blob([i])):`data:application/javascript,${encodeURIComponent(i)}`;return new Promise(((e,t)=>{const i=new Worker(r),s=e=>{URL.revokeObjectURL(r),i.removeEventListener("error",s),t(e.error)},n=s=>{if(URL.revokeObjectURL(r),i.removeEventListener("message",n),s.data.loaded)return e(i);t(s.data.error)};i.addEventListener("error",s),i.addEventListener("message",n)}))}function Y(e,t){var i;return`${e}/${(null===(i=t.match(/[^/]*$/))||void 0===i?void 0:i[0])||""}`}const q=new URL(i(32448),i.b).pathname;function X(e){if(!e)throw new Error("Config not specified");const t=Y(e.src.base,q);return W(t,"data").catch((()=>W(t,"blob"))).catch((()=>fetch(t).then((e=>e.blob())).then(URL.createObjectURL).then((e=>{const t=new Worker(e);return URL.revokeObjectURL(e),t}))))}const Z=new URL(i(1367),i.b).pathname;function $(e){if(!e)throw new Error("Config not specified");const t=Y(e.src.base,Z),i=`importScripts('${t}');`;return W(t,"data").then((e=>(e.terminate(),`data:application/javascript,${encodeURIComponent(i)}`))).catch((()=>W(t,"blob").then((e=>{e.terminate();const t=new Blob([i],{type:"application/javascript"});return URL.createObjectURL(t)}))))}},32448:(e,t,i)=>{"use strict";e.exports=i.p+"content_provider.worker.js"},1367:(e,t,i)=>{"use strict";e.exports=i.p+"gltf_decoder.worker.js"}},e=>{e.O(0,[175],(()=>{return t=78916,e(e.s=t);var t}));var t=e.O();self["@yandex/ymaps3-vector"]=t}]);